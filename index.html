<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Activity Explorer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tg-bg': 'var(--tg-color-bg)',
                        'tg-secondary-bg': 'var(--tg-color-secondary-bg)',
                        'tg-text': 'var(--tg-color-text)',
                        'tg-hint': 'var(--tg-color-hint)',
                        'tg-link': 'var(--tg-color-link)',
                        'tg-button': 'var(--tg-color-button)',
                        'tg-button-text': 'var(--tg-color-button-text)',
                        'tg-header-bg': 'var(--tg-color-header-bg)',
                        'tg-section-bg': 'var(--tg-color-section-bg)',
                        'tg-section-separator': 'var(--tg-color-section-separator)',
                        'primary': '#5D5CDE',
                    },
                    fontFamily: {
                        'system': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                        'bounce-soft': 'bounceSoft 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' }
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --tg-color-bg: #ffffff;
            --tg-color-secondary-bg: #f8f9fa;
            --tg-color-text: #000000;
            --tg-color-hint: #6c757d;
            --tg-color-link: #007bff;
            --tg-color-button: #5D5CDE;
            --tg-color-button-text: #ffffff;
            --tg-color-header-bg: #ffffff;
            --tg-color-section-bg: #ffffff;
            --tg-color-section-separator: #e9ecef;
        }

        .dark {
            --tg-color-bg: #181818;
            --tg-color-secondary-bg: #2a2a2a;
            --tg-color-text: #ffffff;
            --tg-color-hint: #8e8e93;
            --tg-color-link: #64a9ff;
            --tg-color-button: #5D5CDE;
            --tg-color-button-text: #ffffff;
            --tg-color-header-bg: #1f1f1f;
            --tg-color-section-bg: #2a2a2a;
            --tg-color-section-separator: #3a3a3a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-color-bg);
            color: var(--tg-color-text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .haptic-feedback {
            transition: transform 0.1s ease;
        }

        .haptic-feedback:active {
            transform: scale(0.98);
        }

        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .section-card {
            background: var(--tg-color-section-bg);
            border-radius: 12px;
            border: 1px solid var(--tg-color-section-separator);
        }

        .activity-card {
            background: var(--tg-color-section-bg);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .dark .activity-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }

        .activity-card:active {
            transform: scale(0.98);
        }

        .floating-button {
            background: var(--tg-color-button);
            box-shadow: 0 4px 16px rgba(93, 92, 222, 0.3);
            transition: all 0.2s ease;
        }

        .floating-button:active {
            transform: scale(0.95);
        }

        .tab-indicator {
            background: var(--tg-color-button);
            height: 2px;
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .rating-star {
            color: #ffc107;
            font-size: 1.2em;
        }

        .distance-badge {
            background: rgba(93, 92, 222, 0.1);
            color: var(--tg-color-button);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .category-chip {
            background: var(--tg-color-secondary-bg);
            color: var(--tg-color-text);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid var(--tg-color-section-separator);
        }

        .category-chip.active {
            background: var(--tg-color-button);
            color: var(--tg-color-button-text);
            border-color: var(--tg-color-button);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-color-bg: #181818;
                --tg-color-secondary-bg: #2a2a2a;
                --tg-color-text: #ffffff;
                --tg-color-hint: #8e8e93;
                --tg-color-link: #64a9ff;
                --tg-color-button: #5D5CDE;
                --tg-color-button-text: #ffffff;
                --tg-color-header-bg: #1f1f1f;
                --tg-color-section-bg: #2a2a2a;
                --tg-color-section-separator: #3a3a3a;
            }
        }
    </style>
</head>
<body class="bg-tg-bg text-tg-text">
    <!-- Header -->
    <header class="bg-tg-header-bg border-b border-tg-section-separator fixed top-0 left-0 right-0 z-50 safe-area-top">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center space-x-3">
                <button id="backButton" class="w-8 h-8 flex items-center justify-center rounded-full haptic-feedback opacity-0 pointer-events-none transition-opacity duration-200">
                    <svg class="w-5 h-5 text-tg-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h1 id="headerTitle" class="text-lg font-semibold text-tg-text">Activity Explorer</h1>
            </div>
            <div class="flex items-center space-x-2">
                <button id="scanQRButton" class="w-8 h-8 flex items-center justify-center rounded-full haptic-feedback">
                    <svg class="w-5 h-5 text-tg-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                </button>
                <button id="profileButton" class="w-8 h-8 rounded-full bg-primary flex items-center justify-center haptic-feedback">
                    <span id="profileInitial" class="text-white text-sm font-medium">?</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-16 pb-20 safe-area-bottom">
        <!-- Home Tab -->
        <div id="homeTab" class="tab-content">
            <!-- Location Banner -->
            <div id="locationBanner" class="mx-4 mt-4 p-4 section-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-tg-text">Current Location</p>
                            <p id="locationText" class="text-xs text-tg-hint">Detecting location...</p>
                        </div>
                    </div>
                    <button id="refreshLocationButton" class="haptic-feedback p-2 rounded-full">
                        <svg class="w-4 h-4 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mx-4 mt-4">
                <div class="relative">
                    <input type="text" id="searchInput" 
                           class="w-full px-4 py-3 pl-10 bg-tg-secondary-bg text-tg-text rounded-xl border border-tg-section-separator focus:outline-none focus:ring-2 focus:ring-primary/30 text-base"
                           placeholder="Search activities...">
                    <svg class="w-5 h-5 text-tg-hint absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="mt-4 px-4">
                <div id="categoryFilter" class="flex space-x-2 overflow-x-auto pb-2">
                    <button class="category-chip active haptic-feedback" data-category="all">All</button>
                    <button class="category-chip haptic-feedback" data-category="outdoor">Outdoor</button>
                    <button class="category-chip haptic-feedback" data-category="indoor">Indoor</button>
                    <button class="category-chip haptic-feedback" data-category="sports">Sports</button>
                    <button class="category-chip haptic-feedback" data-category="cultural">Cultural</button>
                    <button class="category-chip haptic-feedback" data-category="food">Food</button>
                </div>
            </div>

            <!-- Activity Feed -->
            <div id="activityFeed" class="mt-6 px-4 space-y-4">
                <!-- Activities will be dynamically loaded here -->
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="mt-6 px-4 space-y-4">
                <div class="activity-card p-4">
                    <div class="flex space-x-3">
                        <div class="w-16 h-16 bg-gray-300 rounded-xl skeleton"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-4 bg-gray-300 rounded skeleton"></div>
                            <div class="h-3 bg-gray-300 rounded w-3/4 skeleton"></div>
                            <div class="h-3 bg-gray-300 rounded w-1/2 skeleton"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Activities Tab -->
        <div id="myActivitiesTab" class="tab-content hidden">
            <div class="px-4 py-6">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-tg-text mb-2">My Activities</h2>
                    <p class="text-tg-hint">Share your experiences with the community</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="section-card p-4 text-center">
                        <div class="text-2xl font-bold text-primary" id="userActivitiesCount">0</div>
                        <div class="text-sm text-tg-hint">Activities</div>
                    </div>
                    <div class="section-card p-4 text-center">
                        <div class="text-2xl font-bold text-primary" id="userRating">0.0</div>
                        <div class="text-sm text-tg-hint">Avg Rating</div>
                    </div>
                </div>

                <!-- User Activities List -->
                <div id="userActivitiesList" class="space-y-4">
                    <!-- User activities will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyActivitiesState" class="text-center py-12">
                    <div class="w-20 h-20 bg-tg-secondary-bg rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-tg-text mb-2">No Activities Yet</h3>
                    <p class="text-tg-hint mb-6">Start by adding your first activity experience!</p>
                    <button id="addFirstActivityButton" class="bg-primary text-white px-6 py-3 rounded-xl haptic-feedback">
                        Add Activity
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content hidden">
            <div class="px-4 py-6">
                <!-- Profile Header -->
                <div class="section-card p-6 text-center mb-6">
                    <div id="profileAvatar" class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                        <span id="profileAvatarText" class="text-white text-2xl font-medium">?</span>
                    </div>
                    <h2 id="profileName" class="text-xl font-bold text-tg-text mb-1">Loading...</h2>
                    <p id="profileUsername" class="text-tg-hint">@username</p>
                </div>

                <!-- Profile Stats -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="section-card p-4 text-center">
                        <div class="text-lg font-bold text-primary" id="profileActivitiesCount">0</div>
                        <div class="text-xs text-tg-hint">Activities</div>
                    </div>
                    <div class="section-card p-4 text-center">
                        <div class="text-lg font-bold text-primary" id="profileReviewsCount">0</div>
                        <div class="text-xs text-tg-hint">Reviews</div>
                    </div>
                    <div class="section-card p-4 text-center">
                        <div class="text-lg font-bold text-primary" id="profileRating">0.0</div>
                        <div class="text-xs text-tg-hint">Rating</div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="space-y-4">
                    <div class="section-card">
                        <button class="w-full px-4 py-3 flex items-center justify-between haptic-feedback" id="editProfileButton">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                <span class="text-tg-text">Edit Profile</span>
                            </div>
                            <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <div class="section-card">
                        <button class="w-full px-4 py-3 flex items-center justify-between haptic-feedback" id="notificationButton">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 18h1.09c.07-.3.2-.58.4-.82L16 13.5V10a6 6 0 10-12 0v3.5l3.51 3.68c.2.24.33.52.4.82H9c.5 0 1 .5 1 1z"/>
                                </svg>
                                <span class="text-tg-text">Notifications</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-primary">On</span>
                                <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </div>
                        </button>
                    </div>

                    <div class="section-card">
                        <button class="w-full px-4 py-3 flex items-center justify-between haptic-feedback" id="shareAppButton">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                                </svg>
                                <span class="text-tg-text">Share App</span>
                            </div>
                            <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <div class="section-card">
                        <button class="w-full px-4 py-3 flex items-center justify-between haptic-feedback" id="aboutButton">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-tg-text">About</span>
                            </div>
                            <svg class="w-5 h-5 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-tg-header-bg border-t border-tg-section-separator safe-area-bottom">
        <div class="flex">
            <button class="tab-button flex-1 py-2 px-4 flex flex-col items-center space-y-1 haptic-feedback" data-tab="home">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v0a2 2 0 002 2h0a2 2 0 002 2v0a2 2 0 00-2 2h0a2 2 0 00-2 2v0a2 2 0 01-2 2h-4a2 2 0 01-2-2v0a2 2 0 00-2-2h0a2 2 0 00-2-2v0a2 2 0 002-2h0a2 2 0 002-2z"/>
                </svg>
                <span class="text-xs">Discover</span>
                <div class="tab-indicator w-12 opacity-100"></div>
            </button>
            <button class="tab-button flex-1 py-2 px-4 flex flex-col items-center space-y-1 haptic-feedback" data-tab="myActivities">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <span class="text-xs">My Activities</span>
                <div class="tab-indicator w-12 opacity-0"></div>
            </button>
            <button class="tab-button flex-1 py-2 px-4 flex flex-col items-center space-y-1 haptic-feedback" data-tab="profile">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-xs">Profile</span>
                <div class="tab-indicator w-12 opacity-0"></div>
            </button>
        </div>
    </nav>

    <!-- Floating Action Button -->
    <button id="fabButton" class="floating-button fixed bottom-24 right-4 w-14 h-14 rounded-full flex items-center justify-center haptic-feedback z-40">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
    </button>

    <!-- Modals and Overlays -->
    <div id="addActivityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 hidden">
        <div class="bg-tg-bg rounded-t-3xl w-full max-w-md animate-slide-up safe-area-bottom">
            <div class="p-6">
                <div class="w-12 h-1 bg-tg-hint rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-tg-text mb-6">Add New Activity</h3>
                
                <form id="addActivityForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-tg-text mb-2">Activity Name</label>
                        <input type="text" id="activityName" class="w-full px-4 py-3 bg-tg-secondary-bg text-tg-text rounded-xl border border-tg-section-separator focus:outline-none focus:ring-2 focus:ring-primary/30 text-base" placeholder="What did you do?">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-tg-text mb-2">Category</label>
                        <select id="activityCategory" class="w-full px-4 py-3 bg-tg-secondary-bg text-tg-text rounded-xl border border-tg-section-separator focus:outline-none focus:ring-2 focus:ring-primary/30 text-base">
                            <option value="outdoor">Outdoor</option>
                            <option value="indoor">Indoor</option>
                            <option value="sports">Sports</option>
                            <option value="cultural">Cultural</option>
                            <option value="food">Food</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-tg-text mb-2">Rating</label>
                        <div class="flex space-x-2">
                            <button type="button" class="rating-btn w-10 h-10 rounded-full border-2 border-tg-section-separator flex items-center justify-center haptic-feedback" data-rating="1">
                                <span class="rating-star">★</span>
                            </button>
                            <button type="button" class="rating-btn w-10 h-10 rounded-full border-2 border-tg-section-separator flex items-center justify-center haptic-feedback" data-rating="2">
                                <span class="rating-star">★</span>
                            </button>
                            <button type="button" class="rating-btn w-10 h-10 rounded-full border-2 border-tg-section-separator flex items-center justify-center haptic-feedback" data-rating="3">
                                <span class="rating-star">★</span>
                            </button>
                            <button type="button" class="rating-btn w-10 h-10 rounded-full border-2 border-tg-section-separator flex items-center justify-center haptic-feedback" data-rating="4">
                                <span class="rating-star">★</span>
                            </button>
                            <button type="button" class="rating-btn w-10 h-10 rounded-full border-2 border-tg-section-separator flex items-center justify-center haptic-feedback" data-rating="5">
                                <span class="rating-star">★</span>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-tg-text mb-2">Description</label>
                        <textarea id="activityDescription" rows="3" class="w-full px-4 py-3 bg-tg-secondary-bg text-tg-text rounded-xl border border-tg-section-separator focus:outline-none focus:ring-2 focus:ring-primary/30 text-base resize-none" placeholder="Tell us about your experience..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelAddActivity" class="flex-1 py-3 px-4 bg-tg-secondary-bg text-tg-text rounded-xl haptic-feedback">Cancel</button>
                        <button type="submit" class="flex-1 py-3 px-4 bg-primary text-white rounded-xl haptic-feedback">Add Activity</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App Integration
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // App State Management
        class AppState {
            constructor() {
                this.currentUser = null;
                this.userLocation = null;
                this.activities = [];
                this.userActivities = [];
                this.currentTab = 'home';
                this.selectedCategory = 'all';
                this.searchQuery = '';
                this.navigationStack = [];
                this.init();
            }

            init() {
                this.setupTelegramIntegration();
                this.loadSampleData();
                this.setupEventListeners();
                this.setupTheme();
                this.requestLocation();
                this.loadUserData();
            }

            setupTelegramIntegration() {
                // Theme detection
                if (tg.colorScheme === 'dark') {
                    document.documentElement.classList.add('dark');
                }

                // BackButton handling
                tg.BackButton.onClick(() => {
                    if (this.navigationStack.length > 0) {
                        const prevState = this.navigationStack.pop();
                        this.navigateBack(prevState);
                    } else {
                        tg.close();
                    }
                });

                // MainButton configuration
                tg.MainButton.text = "Share Experience";
                tg.MainButton.color = "#5D5CDE";

                // Haptic feedback setup
                this.hapticFeedback = tg.HapticFeedback;

                // User data from Telegram
                if (tg.initDataUnsafe?.user) {
                    this.currentUser = {
                        id: tg.initDataUnsafe.user.id,
                        firstName: tg.initDataUnsafe.user.first_name,
                        lastName: tg.initDataUnsafe.user.last_name || '',
                        username: tg.initDataUnsafe.user.username || '',
                        languageCode: tg.initDataUnsafe.user.language_code || 'en',
                        photoUrl: tg.initDataUnsafe.user.photo_url || null
                    };
                }
            }

            setupTheme() {
                // Auto theme detection
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }

            loadSampleData() {
                // Sample activities data
                this.activities = [
                    {
                        id: 1,
                        name: "Sunset Hike at Eagle Peak",
                        category: "outdoor",
                        description: "Amazing 360° views of the city. Perfect spot for photography and meditation. Trail is moderate difficulty.",
                        rating: 4.8,
                        reviewCount: 127,
                        location: { lat: 37.7749, lng: -122.4194, name: "Eagle Peak Trail" },
                        distance: 2.3,
                        userId: 12345,
                        userName: "AdventureSeeker",
                        createdAt: new Date('2024-01-15'),
                        images: ["https://picsum.photos/400/300?random=1"],
                        tags: ["hiking", "sunset", "photography", "nature"]
                    },
                    {
                        id: 2,
                        name: "Underground Jazz Club",
                        category: "cultural",
                        description: "Hidden gem with live jazz every Friday. Intimate setting with craft cocktails and amazing acoustics.",
                        rating: 4.6,
                        reviewCount: 89,
                        location: { lat: 37.7849, lng: -122.4094, name: "The Blue Note" },
                        distance: 1.8,
                        userId: 67890,
                        userName: "MusicLover",
                        createdAt: new Date('2024-01-14'),
                        images: ["https://picsum.photos/400/300?random=2"],
                        tags: ["jazz", "music", "nightlife", "cocktails"]
                    },
                    {
                        id: 3,
                        name: "Rooftop Rock Climbing",
                        category: "sports",
                        description: "Urban climbing gym with outdoor walls and city views. Great for beginners and experienced climbers.",
                        rating: 4.5,
                        reviewCount: 156,
                        location: { lat: 37.7649, lng: -122.4294, name: "Vertical Adventures" },
                        distance: 3.1,
                        userId: 54321,
                        userName: "ClimbMaster",
                        createdAt: new Date('2024-01-13'),
                        images: ["https://picsum.photos/400/300?random=3"],
                        tags: ["climbing", "fitness", "urban", "outdoor"]
                    },
                    {
                        id: 4,
                        name: "Artisanal Coffee Tasting",
                        category: "food",
                        description: "Cozy café offering cupping sessions every Saturday. Learn about different bean origins and brewing methods.",
                        rating: 4.7,
                        reviewCount: 203,
                        location: { lat: 37.7549, lng: -122.4394, name: "Bean & Brew" },
                        distance: 0.9,
                        userId: 98765,
                        userName: "CoffeeConnoisseur",
                        createdAt: new Date('2024-01-12'),
                        images: ["https://picsum.photos/400/300?random=4"],
                        tags: ["coffee", "tasting", "education", "cozy"]
                    },
                    {
                        id: 5,
                        name: "Indoor Skydiving Experience",
                        category: "indoor",
                        description: "Thrilling wind tunnel experience. Perfect for first-time flyers and adrenaline junkies alike.",
                        rating: 4.9,
                        reviewCount: 312,
                        location: { lat: 37.7449, lng: -122.4494, name: "SkyFly Center" },
                        distance: 4.2,
                        userId: 11111,
                        userName: "ThrillSeeker",
                        createdAt: new Date('2024-01-11'),
                        images: ["https://picsum.photos/400/300?random=5"],
                        tags: ["extreme", "indoor", "flying", "adrenaline"]
                    }
                ];

                // User's activities (if user is logged in)
                if (this.currentUser) {
                    this.userActivities = this.activities.filter(activity => 
                        activity.userId === this.currentUser.id
                    );
                }
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.triggerHaptic('impact', 'light');
                        const tab = e.currentTarget.dataset.tab;
                        this.switchTab(tab);
                    });
                });

                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.filterAndRenderActivities();
                });

                // Category filtering
                document.getElementById('categoryFilter').addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-chip')) {
                        this.triggerHaptic('impact', 'light');
                        document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
                        e.target.classList.add('active');
                        this.selectedCategory = e.target.dataset.category;
                        this.filterAndRenderActivities();
                    }
                });

                // FAB button
                document.getElementById('fabButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'medium');
                    this.showAddActivityModal();
                });

                // Location refresh
                document.getElementById('refreshLocationButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.requestLocation();
                });

                // Profile button
                document.getElementById('profileButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.switchTab('profile');
                });

                // QR Scanner
                document.getElementById('scanQRButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.scanQRCode();
                });

                // Modal handlers
                this.setupModalHandlers();

                // Profile actions
                this.setupProfileActions();

                // Back button
                document.getElementById('backButton').addEventListener('click', () => {
                    if (this.navigationStack.length > 0) {
                        const prevState = this.navigationStack.pop();
                        this.navigateBack(prevState);
                    }
                });
            }

            setupModalHandlers() {
                const modal = document.getElementById('addActivityModal');
                const form = document.getElementById('addActivityForm');
                const cancelBtn = document.getElementById('cancelAddActivity');

                cancelBtn.addEventListener('click', () => {
                    this.hideAddActivityModal();
                });

                // Rating buttons
                document.querySelectorAll('.rating-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.triggerHaptic('impact', 'light');
                        const rating = parseInt(e.currentTarget.dataset.rating);
                        this.selectRating(rating);
                    });
                });

                // Form submission
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitActivity();
                });

                // Click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.hideAddActivityModal();
                    }
                });
            }

            setupProfileActions() {
                document.getElementById('editProfileButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.showEditProfile();
                });

                document.getElementById('shareAppButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.shareApp();
                });

                document.getElementById('aboutButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.showAbout();
                });

                document.getElementById('notificationButton').addEventListener('click', () => {
                    this.triggerHaptic('impact', 'light');
                    this.toggleNotifications();
                });
            }

            requestLocation() {
                const locationText = document.getElementById('locationText');
                locationText.textContent = 'Detecting location...';

                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            this.updateLocationDisplay();
                            this.calculateDistances();
                            this.filterAndRenderActivities();
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            locationText.textContent = 'Location unavailable';
                            // Use default location (San Francisco)
                            this.userLocation = { lat: 37.7749, lng: -122.4194 };
                            this.calculateDistances();
                            this.filterAndRenderActivities();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                } else {
                    locationText.textContent = 'Location not supported';
                }
            }

            updateLocationDisplay() {
                const locationText = document.getElementById('locationText');
                if (this.userLocation) {
                    // Reverse geocoding would typically happen here
                    locationText.textContent = `${this.userLocation.lat.toFixed(4)}, ${this.userLocation.lng.toFixed(4)}`;
                }
            }

            calculateDistances() {
                if (!this.userLocation) return;

                this.activities.forEach(activity => {
                    activity.distance = this.calculateDistance(
                        this.userLocation.lat,
                        this.userLocation.lng,
                        activity.location.lat,
                        activity.location.lng
                    );
                });

                // Sort by distance
                this.activities.sort((a, b) => a.distance - b.distance);
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the Earth in kilometers
                const dLat = this.degToRad(lat2 - lat1);
                const dLon = this.degToRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.degToRad(lat1)) * Math.cos(this.degToRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            degToRad(deg) {
                return deg * (Math.PI/180);
            }

            loadUserData() {
                if (this.currentUser) {
                    // Update profile display
                    const profileName = document.getElementById('profileName');
                    const profileUsername = document.getElementById('profileUsername');
                    const profileInitial = document.getElementById('profileInitial');
                    const profileAvatarText = document.getElementById('profileAvatarText');

                    const fullName = `${this.currentUser.firstName} ${this.currentUser.lastName}`.trim();
                    profileName.textContent = fullName || 'User';
                    profileUsername.textContent = this.currentUser.username ? `@${this.currentUser.username}` : '';
                    
                    const initial = this.currentUser.firstName ? this.currentUser.firstName[0].toUpperCase() : '?';
                    profileInitial.textContent = initial;
                    profileAvatarText.textContent = initial;

                    // Update stats
                    this.updateUserStats();
                }
            }

            updateUserStats() {
                const userActivitiesCount = this.userActivities.length;
                const userReviewsCount = this.userActivities.reduce((sum, activity) => sum + activity.reviewCount, 0);
                const userRating = userActivitiesCount > 0 ? 
                    (this.userActivities.reduce((sum, activity) => sum + activity.rating, 0) / userActivitiesCount).toFixed(1) : 
                    '0.0';

                document.getElementById('userActivitiesCount').textContent = userActivitiesCount;
                document.getElementById('profileActivitiesCount').textContent = userActivitiesCount;
                document.getElementById('profileReviewsCount').textContent = userReviewsCount;
                document.getElementById('profileRating').textContent = userRating;
                document.getElementById('userRating').textContent = userRating;
            }

            switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // Show selected tab
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');

                // Update tab indicators
                document.querySelectorAll('.tab-button').forEach(button => {
                    const indicator = button.querySelector('.tab-indicator');
                    if (button.dataset.tab === tabName) {
                        button.classList.add('text-primary');
                        indicator.classList.remove('opacity-0');
                        indicator.classList.add('opacity-100');
                    } else {
                        button.classList.remove('text-primary');
                        indicator.classList.add('opacity-0');
                        indicator.classList.remove('opacity-100');
                    }
                });

                this.currentTab = tabName;

                // Update header and navigation
                this.updateHeader(tabName);

                // Load tab-specific content
                if (tabName === 'home') {
                    this.filterAndRenderActivities();
                } else if (tabName === 'myActivities') {
                    this.renderUserActivities();
                }
            }

            updateHeader(tabName) {
                const headerTitle = document.getElementById('headerTitle');
                const backButton = document.getElementById('backButton');

                switch (tabName) {
                    case 'home':
                        headerTitle.textContent = 'Activity Explorer';
                        this.hideBackButton();
                        break;
                    case 'myActivities':
                        headerTitle.textContent = 'My Activities';
                        this.hideBackButton();
                        break;
                    case 'profile':
                        headerTitle.textContent = 'Profile';
                        this.hideBackButton();
                        break;
                }
            }

            showBackButton() {
                const backButton = document.getElementById('backButton');
                backButton.classList.remove('opacity-0', 'pointer-events-none');
                backButton.classList.add('opacity-100');
                tg.BackButton.show();
            }

            hideBackButton() {
                const backButton = document.getElementById('backButton');
                backButton.classList.add('opacity-0', 'pointer-events-none');
                backButton.classList.remove('opacity-100');
                tg.BackButton.hide();
            }

            filterAndRenderActivities() {
                let filteredActivities = [...this.activities];

                // Filter by category
                if (this.selectedCategory !== 'all') {
                    filteredActivities = filteredActivities.filter(activity => 
                        activity.category === this.selectedCategory
                    );
                }

                // Filter by search query
                if (this.searchQuery) {
                    filteredActivities = filteredActivities.filter(activity =>
                        activity.name.toLowerCase().includes(this.searchQuery) ||
                        activity.description.toLowerCase().includes(this.searchQuery) ||
                        activity.tags.some(tag => tag.toLowerCase().includes(this.searchQuery))
                    );
                }

                this.renderActivities(filteredActivities);
            }

            renderActivities(activities) {
                const feed = document.getElementById('activityFeed');
                const loadingState = document.getElementById('loadingState');

                loadingState.classList.add('hidden');
                feed.innerHTML = '';

                if (activities.length === 0) {
                    feed.innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-tg-secondary-bg rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47.901-6.06 2.379l-.179.192C4.889 17.343 4 16.596 4 15.601V4a1 1 0 011-1h14a1 1 0 011 1v11.601c0 .995-.889 1.742-1.761 1.97l-.179-.192z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-tg-text mb-2">No Activities Found</h3>
                            <p class="text-tg-hint">Try adjusting your search or filters</p>
                        </div>
                    `;
                    return;
                }

                activities.forEach(activity => {
                    const activityCard = this.createActivityCard(activity);
                    feed.appendChild(activityCard);
                });
            }

            createActivityCard(activity) {
                const card = document.createElement('div');
                card.className = 'activity-card p-4 haptic-feedback';
                card.setAttribute('data-activity-id', activity.id);

                const stars = '★'.repeat(Math.floor(activity.rating)) + '☆'.repeat(5 - Math.floor(activity.rating));
                const timeAgo = this.getTimeAgo(activity.createdAt);

                card.innerHTML = `
                    <div class="flex space-x-3 mb-3">
                        <div class="w-16 h-16 bg-gray-200 rounded-xl overflow-hidden flex-shrink-0">
                            <img src="${activity.images[0]}" alt="${activity.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-tg-text mb-1 truncate">${activity.name}</h3>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-yellow-500 text-sm">${stars}</span>
                                <span class="text-xs text-tg-hint">${activity.rating} (${activity.reviewCount})</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="distance-badge">${activity.distance.toFixed(1)} km</span>
                                <span class="category-chip text-xs">${activity.category}</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-tg-hint mb-3 line-clamp-2">${activity.description}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-primary rounded-full flex items-center justify-center">
                                <span class="text-white text-xs font-medium">${activity.userName[0]}</span>
                            </div>
                            <span class="text-xs text-tg-hint">${activity.userName} • ${timeAgo}</span>
                        </div>
                        <button class="share-btn text-tg-hint hover:text-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                            </svg>
                        </button>
                    </div>
                `;

                // Add click handlers
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.share-btn')) {
                        this.triggerHaptic('impact', 'light');
                        this.showActivityDetail(activity);
                    }
                });

                card.querySelector('.share-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.triggerHaptic('impact', 'light');
                    this.shareActivity(activity);
                });

                return card;
            }

            renderUserActivities() {
                const list = document.getElementById('userActivitiesList');
                const emptyState = document.getElementById('emptyActivitiesState');

                if (this.userActivities.length === 0) {
                    list.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                list.classList.remove('hidden');
                emptyState.classList.add('hidden');
                list.innerHTML = '';

                this.userActivities.forEach(activity => {
                    const card = this.createUserActivityCard(activity);
                    list.appendChild(card);
                });
            }

            createUserActivityCard(activity) {
                const card = document.createElement('div');
                card.className = 'activity-card p-4 haptic-feedback';

                const stars = '★'.repeat(Math.floor(activity.rating)) + '☆'.repeat(5 - Math.floor(activity.rating));

                card.innerHTML = `
                    <div class="flex space-x-3 mb-3">
                        <div class="w-12 h-12 bg-gray-200 rounded-lg overflow-hidden">
                            <img src="${activity.images[0]}" alt="${activity.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-tg-text mb-1">${activity.name}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-yellow-500 text-sm">${stars}</span>
                                <span class="text-xs text-tg-hint">${activity.reviewCount} reviews</span>
                            </div>
                        </div>
                        <button class="edit-activity-btn text-tg-hint hover:text-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-tg-hint mb-3">${activity.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="category-chip text-xs">${activity.category}</span>
                        <span class="text-xs text-tg-hint">${this.getTimeAgo(activity.createdAt)}</span>
                    </div>
                `;

                return card;
            }

            showAddActivityModal() {
                const modal = document.getElementById('addActivityModal');
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Reset form
                document.getElementById('addActivityForm').reset();
                this.selectRating(0);
            }

            hideAddActivityModal() {
                const modal = document.getElementById('addActivityModal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            selectRating(rating) {
                document.querySelectorAll('.rating-btn').forEach((btn, index) => {
                    if (index < rating) {
                        btn.classList.add('border-yellow-500', 'bg-yellow-50');
                        btn.classList.remove('border-tg-section-separator');
                    } else {
                        btn.classList.remove('border-yellow-500', 'bg-yellow-50');
                        btn.classList.add('border-tg-section-separator');
                    }
                });
                this.selectedRating = rating;
            }

            submitActivity() {
                const form = document.getElementById('addActivityForm');
                const formData = new FormData(form);

                const activityData = {
                    id: Date.now(),
                    name: document.getElementById('activityName').value,
                    category: document.getElementById('activityCategory').value,
                    description: document.getElementById('activityDescription').value,
                    rating: this.selectedRating || 5,
                    reviewCount: 0,
                    location: this.userLocation || { lat: 37.7749, lng: -122.4194, name: "Current Location" },
                    distance: 0,
                    userId: this.currentUser?.id || Date.now(),
                    userName: this.currentUser ? `${this.currentUser.firstName} ${this.currentUser.lastName}`.trim() : 'Anonymous User',
                    createdAt: new Date(),
                    images: [`https://picsum.photos/400/300?random=${Date.now()}`],
                    tags: [document.getElementById('activityCategory').value]
                };

                // Add to activities
                this.activities.unshift(activityData);
                this.userActivities.unshift(activityData);

                // Update stats
                this.updateUserStats();

                // Close modal and refresh view
                this.hideAddActivityModal();
                this.triggerHaptic('notification', 'success');
                this.showToast('Activity added successfully!');

                // Refresh current view
                if (this.currentTab === 'home') {
                    this.filterAndRenderActivities();
                } else if (this.currentTab === 'myActivities') {
                    this.renderUserActivities();
                }
            }

            showActivityDetail(activity) {
                // Implementation for activity detail view
                this.navigationStack.push({ tab: this.currentTab });
                this.showBackButton();
                
                // Here you would typically show a detailed view
                // For now, we'll show a Telegram popup
                tg.showAlert(`${activity.name}\n\n${activity.description}\n\nRating: ${activity.rating}/5\nDistance: ${activity.distance.toFixed(1)} km`);
            }

            shareActivity(activity) {
                const shareText = `🎯 ${activity.name}\n⭐ ${activity.rating}/5 (${activity.reviewCount} reviews)\n📍 ${activity.distance.toFixed(1)} km away\n\n${activity.description}\n\nDiscover more activities on Activity Explorer!`;
                
                if (tg.isVersionAtLeast('6.1')) {
                    tg.shareToStory('https://t.me/your_bot_username', {
                        text: shareText,
                        widget_link: {
                            url: 'https://t.me/your_bot_username/activity_explorer',
                            name: 'Open Activity Explorer'
                        }
                    });
                } else {
                    // Fallback for older versions
                    navigator.clipboard?.writeText(shareText).then(() => {
                        this.showToast('Activity details copied to clipboard!');
                    });
                }
            }

            scanQRCode() {
                if (tg.isVersionAtLeast('6.4')) {
                    tg.showScanQrPopup({
                        text: 'Scan QR code to discover activity'
                    }, (data) => {
                        if (data) {
                            this.showToast(`QR Code scanned: ${data}`);
                            // Handle QR code data here
                        }
                    });
                } else {
                    this.showToast('QR scanner not available');
                }
            }

            showEditProfile() {
                // Implementation for profile editing
                tg.showPopup({
                    title: 'Edit Profile',
                    message: 'This feature will allow you to edit your profile information.',
                    buttons: [
                        { type: 'ok', text: 'OK' }
                    ]
                });
            }

            shareApp() {
                const shareText = '🎯 Discover amazing activities near you with Activity Explorer!\n\nJoin me and explore local experiences, share reviews, and find your next adventure!\n\nhttps://t.me/your_bot_username/activity_explorer';
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Activity Explorer',
                        text: shareText,
                        url: 'https://t.me/your_bot_username/activity_explorer'
                    });
                } else {
                    navigator.clipboard?.writeText(shareText).then(() => {
                        this.showToast('Share link copied to clipboard!');
                    });
                }
            }

            showAbout() {
                tg.showPopup({
                    title: 'About Activity Explorer',
                    message: 'Version 1.0.0\n\nDiscover and share amazing activities in your area. Connect with fellow explorers and make every day an adventure!\n\nBuilt with ❤️ for Telegram',
                    buttons: [
                        { type: 'ok', text: 'OK' }
                    ]
                });
            }

            toggleNotifications() {
                // Implementation for notification toggle
                this.showToast('Notification settings updated');
            }

            navigateBack(state) {
                if (state.tab) {
                    this.switchTab(state.tab);
                }
                
                if (this.navigationStack.length === 0) {
                    this.hideBackButton();
                }
            }

            triggerHaptic(type, intensity) {
                if (this.hapticFeedback) {
                    try {
                        if (type === 'impact') {
                            this.hapticFeedback.impactOccurred(intensity || 'medium');
                        } else if (type === 'notification') {
                            this.hapticFeedback.notificationOccurred(intensity || 'success');
                        } else if (type === 'selection') {
                            this.hapticFeedback.selectionChanged();
                        }
                    } catch (e) {
                        console.log('Haptic feedback not available');
                    }
                }
            }

            showToast(message) {
                tg.showAlert(message);
            }

            getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            }
        }

        // Initialize the app
        const app = new AppState();

        // Handle viewport changes
        function handleViewportChange() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', handleViewportChange);
        handleViewportChange();

        // Service Worker Registration (for PWA features)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            app.showToast('Connection restored');
        });

        window.addEventListener('offline', () => {
            app.showToast('You are offline');
        });

        // Prevent zoom on iOS
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });

        // Handle safe area insets
        if (CSS.supports('padding-top: env(safe-area-inset-top)')) {
            document.documentElement.classList.add('safe-area-supported');
        }
    </script>
</body>
</html>
