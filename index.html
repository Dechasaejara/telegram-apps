<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Addis Events - Discover & Sell Event Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'tg-theme-bg': 'var(--tg-theme-bg-color, #ffffff)',
                        'tg-theme-text': 'var(--tg-theme-text-color, #000000)',
                        'tg-theme-hint': 'var(--tg-theme-hint-color, #999999)',
                        'tg-theme-link': 'var(--tg-theme-link-color, #5D5CDE)',
                        'tg-theme-button': 'var(--tg-theme-button-color, #5D5CDE)',
                        'tg-theme-button-text': 'var(--tg-theme-button-text-color, #ffffff)',
                        'tg-theme-secondary-bg': 'var(--tg-theme-secondary-bg-color, #f5f5f5)',
                        'primary': '#5D5CDE',
                    },
                    animation: {
                        'pulse-subtle': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            },
        };
    </script>
    <style>
        /* Optimize for Telegram Web App */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overscroll-behavior: none;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Custom Animations */
        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }
            100% {
                background-position: 468px 0;
            }
        }

        .skeleton {
            background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%);
            background-size: 800px 104px;
            animation: shimmer 1.5s infinite linear;
        }

        .dark .skeleton {
            background: linear-gradient(to right, #2a2a2a 8%, #3a3a3a 18%, #2a2a2a 33%);
            background-size: 800px 104px;
            animation: shimmer 1.5s infinite linear;
        }

        /* Hide scrollbar for specific elements */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animation for tab indicators */
        .tab-indicator {
            transition: transform 0.3s ease;
        }

        /* Animation for page transitions */
        .page-transition {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        /* Card hover effects */
        .event-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .event-card:active {
            transform: scale(0.98);
        }

        /* Custom styling for inputs */
        input, select, textarea {
            font-size: 16px !important; /* Prevent zoom on mobile */
        }

        /* Native-like bottom sheet */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }

        /* Map placeholder styling */
        .map-placeholder {
            background: linear-gradient(120deg, #e5e7eb 40%, #f3f4f6 50%, #e5e7eb 60%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        
        .dark .map-placeholder {
            background: linear-gradient(120deg, #374151 40%, #4b5563 50%, #374151 60%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        /* QR code styling */
        .qr-container {
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            max-width: 200px;
            margin: 0 auto;
        }

        /* Custom switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--tg-theme-button-color, #5D5CDE);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .dark input:not(:checked) + .toggle-slider {
            background-color: #4b5563;
        }

        /* Date picker custom styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: var(--tg-theme-text-color, #000000) === '#000000' ? invert(0) : invert(1);
            cursor: pointer;
        }
    </style>
    <!-- Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-tg-theme-bg text-tg-theme-text flex flex-col h-full overflow-hidden">
    <!-- App Container -->
    <div id="app" class="flex flex-col h-full relative">
        <!-- Header -->
        <header id="header" class="fixed top-0 left-0 right-0 z-30 bg-tg-theme-bg border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center px-4 h-14">
                <div class="flex items-center space-x-2">
                    <button id="backButton" class="hidden p-2 -ml-2 rounded-full hover:bg-tg-theme-secondary-bg active:bg-tg-theme-secondary-bg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 id="pageTitle" class="text-lg font-bold">Discover Events</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="searchButton" class="p-2 rounded-full hover:bg-tg-theme-secondary-bg active:bg-tg-theme-secondary-bg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    <button id="userMenuButton" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 overflow-hidden">
                        <!-- User avatar will be set by JS -->
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="flex-1 overflow-hidden pt-14 pb-16">
            <!-- All pages will be rendered here -->

            <!-- Discover Page -->
            <div id="discoverPage" class="h-full overflow-y-auto page-transition">
                <!-- Categories -->
                <div class="px-4 pt-4">
                    <div class="overflow-x-auto hide-scrollbar">
                        <div class="flex space-x-2 pb-2">
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-button text-tg-theme-button-text rounded-full text-sm font-medium">
                                All
                            </button>
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Music
                            </button>
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Cultural
                            </button>
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Sports
                            </button>
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Food
                            </button>
                            <button class="category-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Workshops
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Featured Events -->
                <div class="px-4 mt-4">
                    <h2 class="text-lg font-bold mb-3">Featured Events</h2>
                    <div class="relative overflow-hidden">
                        <div class="featured-events-container overflow-x-auto hide-scrollbar">
                            <div class="flex space-x-4 pb-2">
                                <!-- Featured Event Cards will be inserted here by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events Near You -->
                <div class="px-4 mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold">Events Near You</h2>
                        <button id="locationBtn" class="text-tg-theme-link text-sm font-medium">
                            Update Location
                        </button>
                    </div>
                    <div class="mb-4 rounded-xl overflow-hidden">
                        <div id="map" class="map-placeholder h-40 w-full rounded-xl"></div>
                    </div>
                    <div class="nearby-events-container">
                        <!-- Nearby Event Cards will be inserted here by JS -->
                    </div>
                </div>

                <!-- Upcoming Events -->
                <div class="px-4 mt-6 pb-6">
                    <h2 class="text-lg font-bold mb-3">Upcoming Events</h2>
                    <div class="upcoming-events-container">
                        <!-- Upcoming Event Cards will be inserted here by JS -->
                    </div>
                </div>
            </div>

            <!-- My Tickets Page -->
            <div id="myTicketsPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Ticket Filters -->
                <div class="px-4 pt-4">
                    <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-2">
                        <button class="ticket-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-button text-tg-theme-button-text rounded-full text-sm font-medium">
                            Upcoming
                        </button>
                        <button class="ticket-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                            Past
                        </button>
                    </div>
                </div>

                <!-- Tickets List -->
                <div class="tickets-container px-4 py-4">
                    <!-- Tickets will be inserted here by JS -->
                </div>

                <!-- Empty State -->
                <div id="emptyTicketsState" class="hidden flex flex-col items-center justify-center px-4 py-10">
                    <div class="w-24 h-24 mb-4 rounded-full bg-tg-theme-secondary-bg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold mb-2">No tickets yet</h3>
                    <p class="text-tg-theme-hint text-center mb-4">Explore events and purchase tickets to see them here</p>
                    <button id="exploreEventsBtn" class="px-6 py-2 bg-tg-theme-button text-tg-theme-button-text rounded-full text-sm font-medium">
                        Explore Events
                    </button>
                </div>
            </div>

            <!-- Create/Manage Events Page -->
            <div id="manageEventsPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Organizer Dashboard -->
                <div class="px-4 pt-4">
                    <div class="flex flex-col items-center justify-center py-4">
                        <div id="organizerStats" class="w-full grid grid-cols-2 gap-4">
                            <div class="bg-tg-theme-secondary-bg rounded-xl p-4">
                                <h3 class="text-tg-theme-hint text-sm mb-1">Active Events</h3>
                                <p class="text-2xl font-bold">0</p>
                            </div>
                            <div class="bg-tg-theme-secondary-bg rounded-xl p-4">
                                <h3 class="text-tg-theme-hint text-sm mb-1">Tickets Sold</h3>
                                <p class="text-2xl font-bold">0</p>
                            </div>
                        </div>

                        <button id="createEventBtn" class="mt-6 w-full px-6 py-3 bg-tg-theme-button text-tg-theme-button-text rounded-xl text-base font-medium flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Create New Event
                        </button>
                    </div>
                </div>

                <!-- Events Tabs -->
                <div class="px-4 mt-2">
                    <div class="flex border-b border-gray-200 dark:border-gray-700">
                        <button class="event-tab-btn flex-1 py-3 font-medium text-center text-tg-theme-button border-b-2 border-tg-theme-button">
                            Active
                        </button>
                        <button class="event-tab-btn flex-1 py-3 font-medium text-center text-tg-theme-hint">
                            Draft
                        </button>
                        <button class="event-tab-btn flex-1 py-3 font-medium text-center text-tg-theme-hint">
                            Past
                        </button>
                    </div>
                </div>

                <!-- Events List -->
                <div class="managed-events-container px-4 py-4">
                    <!-- Events will be inserted here by JS -->
                </div>

                <!-- Empty State -->
                <div id="emptyEventsState" class="flex flex-col items-center justify-center px-4 py-10">
                    <div class="w-24 h-24 mb-4 rounded-full bg-tg-theme-secondary-bg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold mb-2">No events yet</h3>
                    <p class="text-tg-theme-hint text-center mb-4">Create your first event to start selling tickets</p>
                    <button id="createFirstEventBtn" class="px-6 py-2 bg-tg-theme-button text-tg-theme-button-text rounded-full text-sm font-medium">
                        Create Event
                    </button>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="h-full overflow-y-auto hidden page-transition">
                <!-- User Info -->
                <div class="px-4 pt-6 pb-4 flex items-center">
                    <div id="profileAvatar" class="w-16 h-16 rounded-full bg-gray-300 dark:bg-gray-600 overflow-hidden">
                        <!-- Avatar will be set by JS -->
                    </div>
                    <div class="ml-4">
                        <h2 id="profileName" class="text-xl font-bold">User Name</h2>
                        <p id="profileUsername" class="text-tg-theme-hint">@username</p>
                    </div>
                </div>

                <!-- Settings Sections -->
                <div class="px-4 py-2">
                    <h3 class="text-sm text-tg-theme-hint uppercase tracking-wide font-medium mb-2">Preferences</h3>
                    
                    <div class="bg-tg-theme-secondary-bg rounded-xl overflow-hidden">
                        <div class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Preferences -->
                            <div class="flex items-center justify-between p-4">
                                <div>
                                    <h4 class="font-medium">Event Categories</h4>
                                    <p class="text-sm text-tg-theme-hint">Select your interests</p>
                                </div>
                                <button id="editCategoriesBtn" class="text-tg-theme-link">Edit</button>
                            </div>
                            
                            <div class="flex items-center justify-between p-4">
                                <div>
                                    <h4 class="font-medium">Notifications</h4>
                                    <p class="text-sm text-tg-theme-hint">Event reminders and updates</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="notificationsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4">
                                <div>
                                    <h4 class="font-medium">Location</h4>
                                    <p class="text-sm text-tg-theme-hint">Use current location for events</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="locationToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="px-4 py-2">
                    <h3 class="text-sm text-tg-theme-hint uppercase tracking-wide font-medium mb-2">Account</h3>
                    
                    <div class="bg-tg-theme-secondary-bg rounded-xl overflow-hidden">
                        <div class="divide-y divide-gray-200 dark:divide-gray-700">
                            <div class="flex items-center justify-between p-4">
                                <div>
                                    <h4 class="font-medium">Language</h4>
                                    <p class="text-sm text-tg-theme-hint">English</p>
                                </div>
                                <button id="changeLanguageBtn" class="text-tg-theme-link">Change</button>
                            </div>
                            
                            <div class="flex items-center justify-between p-4">
                                <div>
                                    <h4 class="font-medium">Payment Methods</h4>
                                    <p class="text-sm text-tg-theme-hint">Manage your payment options</p>
                                </div>
                                <button id="paymentMethodsBtn" class="text-tg-theme-link">Manage</button>
                            </div>
                            
                            <button id="switchAccountTypeBtn" class="w-full flex items-center justify-between p-4 text-left">
                                <div>
                                    <h4 class="font-medium">Account Type</h4>
                                    <p class="text-sm text-tg-theme-hint">Switch between attendee and organizer</p>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- About Section -->
                <div class="px-4 py-2 mb-8">
                    <h3 class="text-sm text-tg-theme-hint uppercase tracking-wide font-medium mb-2">About</h3>
                    
                    <div class="bg-tg-theme-secondary-bg rounded-xl overflow-hidden">
                        <div class="divide-y divide-gray-200 dark:divide-gray-700">
                            <button id="helpSupportBtn" class="w-full flex items-center justify-between p-4 text-left">
                                <h4 class="font-medium">Help & Support</h4>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                            
                            <button id="aboutAppBtn" class="w-full flex items-center justify-between p-4 text-left">
                                <h4 class="font-medium">About This App</h4>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Details Page (initially hidden) -->
            <div id="eventDetailsPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Content will be added dynamically -->
            </div>

            <!-- Create Event Page (initially hidden) -->
            <div id="createEventPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Content will be added dynamically -->
            </div>

            <!-- Ticket Details Page (initially hidden) -->
            <div id="ticketDetailsPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Content will be added dynamically -->
            </div>

            <!-- Search Page (initially hidden) -->
            <div id="searchPage" class="h-full overflow-y-auto hidden page-transition">
                <!-- Content will be added dynamically -->
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 z-30 bg-tg-theme-bg border-t border-gray-200 dark:border-gray-700">
            <div class="flex justify-around items-center h-16">
                <button class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-tg-theme-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span class="text-xs mt-1">Discover</span>
                </button>
                <button class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-tg-theme-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                    </svg>
                    <span class="text-xs mt-1">My Tickets</span>
                </button>
                <button class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-tg-theme-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-xs mt-1">My Events</span>
                </button>
                <button class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-tg-theme-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-xs mt-1">Profile</span>
                </button>
            </div>
        </nav>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                <div class="w-12 h-12 border-t-2 border-b-2 border-tg-theme-button rounded-full animate-spin"></div>
                <p class="mt-3 text-center" id="loadingText">Loading...</p>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toastNotification" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 hidden">
            <p id="toastMessage">Notification message</p>
        </div>
    </div>

    <!-- Main Script -->
    <script>
        // Initialize Telegram WebApp
        const webApp = window.Telegram.WebApp;
        webApp.expand();
        webApp.ready();

        // App state and configuration
        const appState = {
            currentPage: 'discoverPage',
            navigationHistory: [],
            user: null,
            events: [],
            tickets: [],
            categories: ['All', 'Music', 'Cultural', 'Sports', 'Food', 'Workshops'],
            locations: {
                addisAbaba: { lat: 9.0222, lng: 38.7468 }, // Coordinates for Addis Ababa
                userLocation: null
            },
            preferences: {
                selectedCategories: [],
                notifications: true,
                useLocation: true,
                language: 'English'
            },
            accountType: 'attendee', // 'attendee' or 'organizer'
            paymentMethods: [],
            isLoading: false
        };

        // DOM Elements
        const elements = {
            pages: {
                discover: document.getElementById('discoverPage'),
                myTickets: document.getElementById('myTicketsPage'),
                manageEvents: document.getElementById('manageEventsPage'),
                profile: document.getElementById('profilePage'),
                eventDetails: document.getElementById('eventDetailsPage'),
                createEvent: document.getElementById('createEventPage'),
                ticketDetails: document.getElementById('ticketDetailsPage'),
                search: document.getElementById('searchPage')
            },
            header: {
                title: document.getElementById('pageTitle'),
                backButton: document.getElementById('backButton'),
                searchButton: document.getElementById('searchButton'),
                userMenuButton: document.getElementById('userMenuButton')
            },
            navigation: {
                navButtons: document.querySelectorAll('.nav-btn')
            },
            ui: {
                loadingOverlay: document.getElementById('loadingOverlay'),
                loadingText: document.getElementById('loadingText'),
                toastNotification: document.getElementById('toastNotification'),
                toastMessage: document.getElementById('toastMessage'),
                emptyTicketsState: document.getElementById('emptyTicketsState'),
                emptyEventsState: document.getElementById('emptyEventsState')
            },
            containers: {
                featuredEvents: document.querySelector('.featured-events-container .flex'),
                nearbyEvents: document.querySelector('.nearby-events-container'),
                upcomingEvents: document.querySelector('.upcoming-events-container'),
                tickets: document.querySelector('.tickets-container'),
                managedEvents: document.querySelector('.managed-events-container')
            },
            buttons: {
                createEvent: document.getElementById('createEventBtn'),
                createFirstEvent: document.getElementById('createFirstEventBtn'),
                exploreEvents: document.getElementById('exploreEventsBtn'),
                location: document.getElementById('locationBtn')
            }
        };

        // Sample data for testing
        const sampleData = {
            events: [
                {
                    id: 'event1',
                    title: 'Addis Jazz Festival',
                    description: 'Experience the best of Ethiopian jazz with top local and international artists.',
                    date: '2023-10-15',
                    time: '19:00',
                    endTime: '23:00',
                    venue: 'Ghion Hotel',
                    address: 'Ras Desta Damtew St, Addis Ababa',
                    location: { lat: 9.0252, lng: 38.7585 },
                    category: 'Music',
                    price: {
                        currency: 'ETB',
                        min: 500,
                        max: 1500
                    },
                    capacity: 500,
                    remaining: 320,
                    organizer: 'Addis Music Association',
                    imageUrl: generateEventImage('Addis Jazz Festival', 'Music'),
                    featured: true,
                    ticketTypes: [
                        { id: 'ticket1', name: 'General Admission', price: 500, remaining: 200 },
                        { id: 'ticket2', name: 'VIP', price: 1500, remaining: 120 }
                    ]
                },
                {
                    id: 'event2',
                    title: 'Ethiopian Coffee Ceremony',
                    description: 'Learn about the traditional Ethiopian coffee ceremony and sample some of the finest coffee in the world.',
                    date: '2023-10-20',
                    time: '14:00',
                    endTime: '16:00',
                    venue: 'National Museum of Ethiopia',
                    address: 'King George VI St, Addis Ababa',
                    location: { lat: 9.0379, lng: 38.7611 },
                    category: 'Cultural',
                    price: {
                        currency: 'ETB',
                        min: 300,
                        max: 300
                    },
                    capacity: 50,
                    remaining: 25,
                    organizer: 'Ethiopian Tourism Board',
                    imageUrl: generateEventImage('Ethiopian Coffee Ceremony', 'Cultural'),
                    featured: true,
                    ticketTypes: [
                        { id: 'ticket3', name: 'Standard Entry', price: 300, remaining: 25 }
                    ]
                },
                {
                    id: 'event3',
                    title: 'Merkato Market Tour',
                    description: 'Guided tour of Africa\'s largest open-air market with local food tasting.',
                    date: '2023-10-22',
                    time: '09:00',
                    endTime: '12:00',
                    venue: 'Merkato',
                    address: 'Addis Ketema, Addis Ababa',
                    location: { lat: 9.0360, lng: 38.7365 },
                    category: 'Cultural',
                    price: {
                        currency: 'ETB',
                        min: 250,
                        max: 250
                    },
                    capacity: 30,
                    remaining: 12,
                    organizer: 'Addis Tour Guides',
                    imageUrl: generateEventImage('Merkato Market Tour', 'Cultural'),
                    featured: false,
                    ticketTypes: [
                        { id: 'ticket4', name: 'Tour Ticket', price: 250, remaining: 12 }
                    ]
                },
                {
                    id: 'event4',
                    title: 'Ethiopia Premier League: St. George vs. Fasil Kenema',
                    description: 'Exciting football match between two of Ethiopia\'s top teams.',
                    date: '2023-10-25',
                    time: '16:00',
                    endTime: '18:00',
                    venue: 'Addis Ababa Stadium',
                    address: 'Churchill Ave, Addis Ababa',
                    location: { lat: 9.0277, lng: 38.7564 },
                    category: 'Sports',
                    price: {
                        currency: 'ETB',
                        min: 100,
                        max: 800
                    },
                    capacity: 35000,
                    remaining: 15000,
                    organizer: 'Ethiopian Football Federation',
                    imageUrl: generateEventImage('Ethiopia Premier League', 'Sports'),
                    featured: true,
                    ticketTypes: [
                        { id: 'ticket5', name: 'General Admission', price: 100, remaining: 10000 },
                        { id: 'ticket6', name: 'VIP', price: 800, remaining: 5000 }
                    ]
                },
                {
                    id: 'event5',
                    title: 'Amharic Language Workshop',
                    description: 'Beginner-friendly workshop to learn the basics of Amharic language.',
                    date: '2023-11-05',
                    time: '10:00',
                    endTime: '13:00',
                    venue: 'Alliance Ethio-Française',
                    address: 'Amist Kilo, Addis Ababa',
                    location: { lat: 9.0378, lng: 38.7637 },
                    category: 'Workshops',
                    price: {
                        currency: 'ETB',
                        min: 400,
                        max: 400
                    },
                    capacity: 40,
                    remaining: 22,
                    organizer: 'Ethiopian Language Institute',
                    imageUrl: generateEventImage('Amharic Language Workshop', 'Workshops'),
                    featured: false,
                    ticketTypes: [
                        { id: 'ticket7', name: 'Workshop Entry', price: 400, remaining: 22 }
                    ]
                }
            ],
            tickets: [
                {
                    id: 'purchase1',
                    eventId: 'event1',
                    ticketType: 'General Admission',
                    price: 500,
                    currency: 'ETB',
                    purchaseDate: '2023-09-25',
                    status: 'active',
                    qrCode: generateQRCodeUrl('event1-ticket1-' + Math.random().toString(36).substring(7))
                },
                {
                    id: 'purchase2',
                    eventId: 'event3',
                    ticketType: 'Tour Ticket',
                    price: 250,
                    currency: 'ETB',
                    purchaseDate: '2023-09-20',
                    status: 'active',
                    qrCode: generateQRCodeUrl('event3-ticket4-' + Math.random().toString(36).substring(7))
                }
            ]
        };

        // Initialize the app
        function initializeApp() {
            // Set up user from Telegram WebApp
            setupUser();
            
            // Load sample data (in a real app, this would be fetched from an API)
            loadSampleData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize the UI
            updateUI();
            
            // Setup Telegram MainButton
            setupTelegramMainButton();
        }

        // Setup user from Telegram WebApp
        function setupUser() {
            if (webApp.initDataUnsafe && webApp.initDataUnsafe.user) {
                appState.user = {
                    id: webApp.initDataUnsafe.user.id,
                    firstName: webApp.initDataUnsafe.user.first_name,
                    lastName: webApp.initDataUnsafe.user.last_name || '',
                    username: webApp.initDataUnsafe.user.username || '',
                    languageCode: webApp.initDataUnsafe.user.language_code || 'en',
                    photoUrl: webApp.initDataUnsafe.user.photo_url || ''
                };
            } else {
                // Fallback for testing outside Telegram
                appState.user = {
                    id: 123456789,
                    firstName: 'Test',
                    lastName: 'User',
                    username: 'testuser',
                    languageCode: 'en',
                    photoUrl: ''
                };
            }

            // Update UI with user info
            updateUserInterface();
        }

        // Update user interface with user info
        function updateUserInterface() {
            // Set user avatar if available
            const avatarElements = [elements.header.userMenuButton, document.getElementById('profileAvatar')];
            avatarElements.forEach(element => {
                if (element) {
                    if (appState.user.photoUrl) {
                        element.innerHTML = `<img src="${appState.user.photoUrl}" alt="${appState.user.firstName}" class="w-full h-full object-cover">`;
                    } else {
                        element.innerHTML = `<div class="w-full h-full flex items-center justify-center text-tg-theme-button-text font-bold bg-tg-theme-button">${appState.user.firstName.charAt(0)}</div>`;
                    }
                }
            });

            // Set user name in profile
            const profileNameElement = document.getElementById('profileName');
            const profileUsernameElement = document.getElementById('profileUsername');
            
            if (profileNameElement) {
                profileNameElement.textContent = `${appState.user.firstName} ${appState.user.lastName}`.trim();
            }
            
            if (profileUsernameElement && appState.user.username) {
                profileUsernameElement.textContent = `@${appState.user.username}`;
            } else if (profileUsernameElement) {
                profileUsernameElement.textContent = '';
            }
        }

        // Load sample data
        function loadSampleData() {
            appState.events = sampleData.events;
            appState.tickets = sampleData.tickets;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation buttons
            elements.navigation.navButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    navigateToTab(index);
                });
            });

            // Back button
            elements.header.backButton.addEventListener('click', () => {
                navigateBack();
            });

            // Search button
            elements.header.searchButton.addEventListener('click', () => {
                showSearchPage();
            });

            // Create event buttons
            elements.buttons.createEvent.addEventListener('click', () => {
                showCreateEventPage();
            });

            elements.buttons.createFirstEvent.addEventListener('click', () => {
                showCreateEventPage();
            });

            // Explore events button
            elements.buttons.exploreEvents.addEventListener('click', () => {
                navigateToTab(0); // Go to discover tab
            });

            // Location button
            elements.buttons.location.addEventListener('click', () => {
                requestLocation();
            });

            // Handle Telegram BackButton
            webApp.BackButton.onClick(() => {
                navigateBack();
            });
        }

        // Navigate to a specific tab
        function navigateToTab(tabIndex) {
            const tabs = ['discoverPage', 'myTicketsPage', 'manageEventsPage', 'profilePage'];
            const titles = ['Discover Events', 'My Tickets', 'My Events', 'Profile'];
            
            if (tabIndex >= 0 && tabIndex < tabs.length) {
                // Reset navigation history when switching tabs
                appState.navigationHistory = [];
                
                // Navigate to the new page
                navigateToPage(tabs[tabIndex], titles[tabIndex]);
                
                // Update active tab
                elements.navigation.navButtons.forEach((btn, idx) => {
                    if (idx === tabIndex) {
                        btn.classList.remove('text-tg-theme-hint');
                        btn.classList.add('text-tg-theme-button');
                    } else {
                        btn.classList.remove('text-tg-theme-button');
                        btn.classList.add('text-tg-theme-hint');
                    }
                });
            }
        }

        // Navigate to a specific page
        function navigateToPage(pageId, pageTitle) {
            if (pageId === appState.currentPage) return;
            
            // Add current page to history if we're not going back
            if (appState.currentPage) {
                appState.navigationHistory.push({
                    pageId: appState.currentPage,
                    pageTitle: elements.header.title.textContent
                });
            }
            
            // Hide all pages
            Object.values(elements.pages).forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('opacity-100');
                page.classList.add('opacity-0');
            });
            
            // Show the target page with animation
            const targetPage = elements.pages[pageId];
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                // Trigger reflow to ensure animation works
                void targetPage.offsetWidth;
                
                targetPage.classList.remove('opacity-0');
                targetPage.classList.add('opacity-100');
                
                // Update state
                appState.currentPage = pageId;
                elements.header.title.textContent = pageTitle;
                
                // Show or hide back button
                if (appState.navigationHistory.length > 0) {
                    elements.header.backButton.classList.remove('hidden');
                    webApp.BackButton.show();
                } else {
                    elements.header.backButton.classList.add('hidden');
                    webApp.BackButton.hide();
                }
                
                // Update main button based on the current page
                updateMainButton();
            }
        }

        // Navigate back to the previous page
        function navigateBack() {
            if (appState.navigationHistory.length > 0) {
                const previousPage = appState.navigationHistory.pop();
                navigateToPage(previousPage.pageId, previousPage.pageTitle);
                
                // This is a direct navigation, not a tab switch, so we don't reset the history
                appState.navigationHistory.pop(); // Remove the entry we just added in navigateToPage
            }
        }

        // Show event details page
        function showEventDetails(eventId) {
            const event = appState.events.find(e => e.id === eventId);
            if (!event) return;
            
            // Update the event details page with content
            const eventDetailsPage = elements.pages.eventDetails;
            eventDetailsPage.innerHTML = `
                <div class="relative">
                    <div class="h-56 bg-gray-300 dark:bg-gray-700 relative">
                        <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                            <div class="text-white">
                                <span class="inline-block px-2 py-1 bg-tg-theme-button text-tg-theme-button-text text-xs font-medium rounded-full mb-2">${event.category}</span>
                                <h1 class="text-2xl font-bold">${event.title}</h1>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4">
                    <div class="flex items-center mb-4">
                        <div class="flex-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div>
                                <p class="font-medium">${formatDate(event.date)}</p>
                                <p class="text-sm text-tg-theme-hint">${event.time} - ${event.endTime}</p>
                            </div>
                        </div>
                        <button class="save-event-btn p-2 rounded-full bg-tg-theme-secondary-bg" data-event-id="${event.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div>
                            <p class="font-medium">${event.venue}</p>
                            <p class="text-sm text-tg-theme-hint">${event.address}</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div id="eventMap" class="map-placeholder h-40 w-full rounded-xl"></div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-lg font-bold mb-2">About This Event</h2>
                        <p class="text-tg-theme-text">${event.description}</p>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-lg font-bold mb-2">Organized by</h2>
                        <p class="text-tg-theme-text">${event.organizer}</p>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-lg font-bold mb-4">Available Tickets</h2>
                        <div class="ticket-options space-y-3">
                            ${event.ticketTypes.map(ticket => `
                                <div class="ticket-option flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <div>
                                        <h3 class="font-medium">${ticket.name}</h3>
                                        <p class="text-sm text-tg-theme-hint">${ticket.remaining} remaining</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">${ticket.price} ${event.price.currency}</p>
                                        <button class="select-ticket-btn mt-1 px-3 py-1 bg-tg-theme-button text-tg-theme-button-text rounded-lg text-sm" 
                                                data-ticket-id="${ticket.id}" data-event-id="${event.id}">
                                            Select
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to ticket buttons
            const ticketButtons = eventDetailsPage.querySelectorAll('.select-ticket-btn');
            ticketButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const ticketId = button.getAttribute('data-ticket-id');
                    const eventId = button.getAttribute('data-event-id');
                    showTicketPurchasePage(eventId, ticketId);
                });
            });
            
            // Add event listener to save button
            const saveButton = eventDetailsPage.querySelector('.save-event-btn');
            saveButton.addEventListener('click', () => {
                saveButton.classList.toggle('saved');
                if (saveButton.classList.contains('saved')) {
                    saveButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-tg-theme-button" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                    `;
                    showToast('Event saved');
                } else {
                    saveButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-tg-theme-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                    `;
                    showToast('Event removed from saved');
                }
            });
            
            // Navigate to the event details page
            navigateToPage('eventDetails', 'Event Details');
        }

        // Show ticket purchase page
        function showTicketPurchasePage(eventId, ticketId) {
            const event = appState.events.find(e => e.id === eventId);
            const ticket = event.ticketTypes.find(t => t.id === ticketId);
            
            if (!event || !ticket) return;
            
            // Set the main button for purchase
            webApp.MainButton.setParams({
                text: `Pay ${ticket.price} ${event.price.currency}`,
                color: webApp.themeParams.button_color || '#5D5CDE'
            });
            
            webApp.MainButton.onClick(() => {
                purchaseTicket(eventId, ticketId);
            });
            
            webApp.MainButton.show();
        }

        // Purchase a ticket
        function purchaseTicket(eventId, ticketId) {
            showLoading('Processing payment...');
            
            // Simulate payment processing
            setTimeout(() => {
                const event = appState.events.find(e => e.id === eventId);
                const ticket = event.ticketTypes.find(t => t.id === ticketId);
                
                // Create new ticket
                const newTicket = {
                    id: 'purchase' + Date.now(),
                    eventId: eventId,
                    ticketType: ticket.name,
                    price: ticket.price,
                    currency: event.price.currency,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    status: 'active',
                    qrCode: generateQRCodeUrl(eventId + '-' + ticketId + '-' + Math.random().toString(36).substring(7))
                };
                
                // Add to tickets
                appState.tickets.push(newTicket);
                
                // Update ticket count
                ticket.remaining--;
                
                hideLoading();
                showToast('Ticket purchased successfully!');
                
                // Navigate to the ticket details
                showTicketDetails(newTicket.id);
            }, 2000);
        }

        // Show ticket details
        function showTicketDetails(ticketId) {
            const ticket = appState.tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            const event = appState.events.find(e => e.id === ticket.eventId);
            if (!event) return;
            
            // Update the ticket details page
            const ticketDetailsPage = elements.pages.ticketDetails;
            ticketDetailsPage.innerHTML = `
                <div class="p-4">
                    <div class="bg-tg-theme-secondary-bg rounded-xl overflow-hidden">
                        <div class="p-4 bg-tg-theme-button text-tg-theme-button-text">
                            <h2 class="text-lg font-bold">${event.title}</h2>
                            <p class="text-sm opacity-90">${formatDate(event.date)} • ${event.time}</p>
                        </div>
                        
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-medium">Ticket Type</h3>
                                    <p class="text-sm text-tg-theme-hint">${ticket.ticketType}</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="font-medium">Price</h3>
                                    <p class="text-sm text-tg-theme-hint">${ticket.price} ${ticket.currency}</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h3 class="font-medium mb-1">Venue</h3>
                                <p class="text-sm text-tg-theme-hint">${event.venue}, ${event.address}</p>
                            </div>

                            <div class="border-t border-b border-gray-200 dark:border-gray-700 py-4 my-4">
                                <div class="qr-container">
                                    <img src="${ticket.qrCode}" alt="Ticket QR Code" class="w-full h-auto">
                                </div>
                                <p class="text-center text-xs text-tg-theme-hint mt-2">Scan at the event entrance</p>
                            </div>
                            
                            <div class="text-center">
                                <button id="shareTicketBtn" class="px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-lg text-sm font-medium flex items-center justify-center mx-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                    </svg>
                                    Share Ticket
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-bold mb-2">Event Details</h3>
                        <p class="mb-4">${event.description}</p>

                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div>
                                <p class="font-medium">${formatDate(event.date)}</p>
                                <p class="text-sm text-tg-theme-hint">${event.time} - ${event.endTime}</p>
                            </div>
                        </div>

                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <div>
                                <p class="font-medium">${event.venue}</p>
                                <p class="text-sm text-tg-theme-hint">${event.address}</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="map-placeholder h-40 w-full rounded-xl"></div>
                        </div>
                    </div>

                    <div class="mt-6 mb-8">
                        <h3 class="text-lg font-bold mb-2">Organizer</h3>
                        <p>${event.organizer}</p>
                    </div>
                </div>
            `;
            
            // Add event listener to share button
            const shareButton = ticketDetailsPage.querySelector('#shareTicketBtn');
            shareButton.addEventListener('click', () => {
                // In a real app, we would implement sharing functionality
                // For now, just show a toast
                showToast('Sharing is not available in the demo');
            });
            
            // Navigate to the ticket details page
            navigateToPage('ticketDetails', 'Ticket Details');
        }

        // Show create event page
        function showCreateEventPage() {
            // Update the create event page with form
            const createEventPage = elements.pages.createEvent;
            createEventPage.innerHTML = `
                <div class="p-4">
                    <form id="createEventForm" class="space-y-6">
                        <div>
                            <label for="eventTitle" class="block text-sm font-medium mb-1">Event Title *</label>
                            <input type="text" id="eventTitle" name="title" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                        
                        <div>
                            <label for="eventCategory" class="block text-sm font-medium mb-1">Category *</label>
                            <select id="eventCategory" name="category" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                                <option value="">Select a category</option>
                                ${appState.categories.slice(1).map(category => 
                                    `<option value="${category}">${category}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label for="eventDate" class="block text-sm font-medium mb-1">Date *</label>
                            <input type="date" id="eventDate" name="date" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="eventStartTime" class="block text-sm font-medium mb-1">Start Time *</label>
                                <input type="time" id="eventStartTime" name="startTime" required 
                                    class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                            </div>
                            <div>
                                <label for="eventEndTime" class="block text-sm font-medium mb-1">End Time *</label>
                                <input type="time" id="eventEndTime" name="endTime" required 
                                    class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                            </div>
                        </div>
                        
                        <div>
                            <label for="eventVenue" class="block text-sm font-medium mb-1">Venue *</label>
                            <input type="text" id="eventVenue" name="venue" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                        
                        <div>
                            <label for="eventAddress" class="block text-sm font-medium mb-1">Address *</label>
                            <input type="text" id="eventAddress" name="address" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Location on Map</label>
                            <div class="mb-2 map-placeholder h-40 w-full rounded-lg"></div>
                            <button type="button" id="setLocationBtn" class="text-tg-theme-link text-sm">
                                Set Current Location
                            </button>
                        </div>
                        
                        <div>
                            <label for="eventDescription" class="block text-sm font-medium mb-1">Description *</label>
                            <textarea id="eventDescription" name="description" rows="4" required 
                                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-3">Add Event Image</label>
                            <div id="imageUploadArea" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="mt-2 text-sm text-tg-theme-hint">Click to upload image</p>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-bold mb-3">Ticket Information</h3>
                            
                            <div id="ticketTypes" class="space-y-4">
                                <div class="ticket-type p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-medium">Ticket Type 1</h4>
                                        <button type="button" class="text-red-500 text-sm" disabled>Remove</button>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Name *</label>
                                            <input type="text" name="ticket_name_0" placeholder="e.g. General Admission" required 
                                                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Price (ETB) *</label>
                                                <input type="number" name="ticket_price_0" min="0" required 
                                                    class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Quantity *</label>
                                                <input type="number" name="ticket_quantity_0" min="1" required 
                                                    class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" id="addTicketTypeBtn" class="mt-3 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg text-tg-theme-link flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add Another Ticket Type
                            </button>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="button" id="saveAsDraftBtn" class="flex-1 py-3 bg-tg-theme-secondary-bg text-tg-theme-text rounded-lg font-medium">
                                Save as Draft
                            </button>
                            <button type="submit" id="publishEventBtn" class="flex-1 py-3 bg-tg-theme-button text-tg-theme-button-text rounded-lg font-medium">
                                Publish Event
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Add event listeners
            const form = createEventPage.querySelector('#createEventForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                createEvent(form, 'published');
            });
            
            const saveAsDraftBtn = createEventPage.querySelector('#saveAsDraftBtn');
            saveAsDraftBtn.addEventListener('click', () => {
                createEvent(form, 'draft');
            });
            
            const addTicketTypeBtn = createEventPage.querySelector('#addTicketTypeBtn');
            addTicketTypeBtn.addEventListener('click', () => {
                addTicketType();
            });
            
            const setLocationBtn = createEventPage.querySelector('#setLocationBtn');
            setLocationBtn.addEventListener('click', () => {
                requestLocation();
            });
            
            // Navigate to the create event page
            navigateToPage('createEvent', 'Create Event');
        }

        // Add a new ticket type to the form
        function addTicketType() {
            const ticketTypes = document.getElementById('ticketTypes');
            const ticketCount = ticketTypes.children.length;
            
            const newTicketType = document.createElement('div');
            newTicketType.className = 'ticket-type p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
            newTicketType.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium">Ticket Type ${ticketCount + 1}</h4>
                    <button type="button" class="remove-ticket-btn text-red-500 text-sm">Remove</button>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Name *</label>
                        <input type="text" name="ticket_name_${ticketCount}" placeholder="e.g. VIP" required 
                            class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Price (ETB) *</label>
                            <input type="number" name="ticket_price_${ticketCount}" min="0" required 
                                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Quantity *</label>
                            <input type="number" name="ticket_quantity_${ticketCount}" min="1" required 
                                class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        </div>
                    </div>
                </div>
            `;
            
            ticketTypes.appendChild(newTicketType);
            
            // Add event listener to remove button
            const removeBtn = newTicketType.querySelector('.remove-ticket-btn');
            removeBtn.addEventListener('click', () => {
                ticketTypes.removeChild(newTicketType);
                // Update the ticket type numbers
                updateTicketTypeNumbers();
            });
        }

        // Update the ticket type numbers after removing a ticket type
        function updateTicketTypeNumbers() {
            const ticketTypes = document.querySelectorAll('.ticket-type');
            ticketTypes.forEach((ticketType, index) => {
                ticketType.querySelector('h4').textContent = `Ticket Type ${index + 1}`;
            });
        }

        // Create a new event
        function createEvent(form, status) {
            showLoading('Creating event...');
            
            // Simulate event creation
            setTimeout(() => {
                const formData = new FormData(form);
                
                // Generate a new event ID
                const eventId = 'event' + Date.now();
                
                // Extract ticket types
                const ticketTypes = [];
                const ticketTypeCount = document.querySelectorAll('.ticket-type').length;
                
                for (let i = 0; i < ticketTypeCount; i++) {
                    const name = formData.get(`ticket_name_${i}`);
                    const price = parseInt(formData.get(`ticket_price_${i}`));
                    const quantity = parseInt(formData.get(`ticket_quantity_${i}`));
                    
                    ticketTypes.push({
                        id: 'ticket' + Date.now() + i,
                        name: name,
                        price: price,
                        remaining: quantity
                    });
                }
                
                // Create new event
                const newEvent = {
                    id: eventId,
                    title: formData.get('title'),
                    description: formData.get('description'),
                    date: formData.get('date'),
                    time: formData.get('startTime'),
                    endTime: formData.get('endTime'),
                    venue: formData.get('venue'),
                    address: formData.get('address'),
                    location: appState.locations.userLocation || appState.locations.addisAbaba,
                    category: formData.get('category'),
                    price: {
                        currency: 'ETB',
                        min: Math.min(...ticketTypes.map(t => t.price)),
                        max: Math.max(...ticketTypes.map(t => t.price))
                    },
                    capacity: ticketTypes.reduce((total, t) => total + t.remaining, 0),
                    remaining: ticketTypes.reduce((total, t) => total + t.remaining, 0),
                    organizer: `${appState.user.firstName} ${appState.user.lastName}`.trim(),
                    imageUrl: generateEventImage(formData.get('title'), formData.get('category')),
                    featured: false,
                    ticketTypes: ticketTypes,
                    status: status
                };
                
                // Add to events
                appState.events.push(newEvent);
                
                hideLoading();
                showToast(status === 'published' ? 'Event published successfully!' : 'Event saved as draft');
                
                // Navigate back to manage events page
                navigateToTab(2);
                
                // Update the events list
                updateUI();
            }, 2000);
        }

        // Show search page
        function showSearchPage() {
            // Update the search page
            const searchPage = elements.pages.search;
            searchPage.innerHTML = `
                <div class="p-4">
                    <div class="relative mb-4">
                        <input type="text" id="searchInput" placeholder="Search events, venues..." 
                            class="w-full p-3 pl-10 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-base">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-tg-theme-hint absolute left-3 top-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    
                    <div class="overflow-x-auto hide-scrollbar">
                        <div class="flex space-x-2 pb-2">
                            <button class="search-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-button text-tg-theme-button-text rounded-full text-sm font-medium">
                                All
                            </button>
                            <button class="search-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                This Week
                            </button>
                            <button class="search-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                This Month
                            </button>
                            <button class="search-filter-btn flex-shrink-0 px-4 py-2 bg-tg-theme-secondary-bg text-tg-theme-text rounded-full text-sm font-medium">
                                Free
                            </button>
                        </div>
                    </div>
                    
                    <div id="searchResults" class="mt-4">
                        <p class="text-center text-tg-theme-hint py-4">Search for events, venues, or categories</p>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const searchInput = searchPage.querySelector('#searchInput');
            searchInput.addEventListener('input', () => {
                searchEvents(searchInput.value);
            });
            
            const filterButtons = searchPage.querySelectorAll('.search-filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => {
                        btn.classList.remove('bg-tg-theme-button', 'text-tg-theme-button-text');
                        btn.classList.add('bg-tg-theme-secondary-bg', 'text-tg-theme-text');
                    });
                    button.classList.remove('bg-tg-theme-secondary-bg', 'text-tg-theme-text');
                    button.classList.add('bg-tg-theme-button', 'text-tg-theme-button-text');
                    
                    searchEvents(searchInput.value, button.textContent.trim());
                });
            });
            
            // Auto-focus the search input
            setTimeout(() => {
                searchInput.focus();
            }, 300);
            
            // Navigate to the search page
            navigateToPage('search', 'Search');
        }

        // Search events
        function searchEvents(query, filter = 'All') {
            if (!query) {
                document.getElementById('searchResults').innerHTML = `
                    <p class="text-center text-tg-theme-hint py-4">Search for events, venues, or categories</p>
                `;
                return;
            }
            
            query = query.toLowerCase();
            
            let filteredEvents = appState.events.filter(event => {
                return event.title.toLowerCase().includes(query) || 
                       event.description.toLowerCase().includes(query) || 
                       event.venue.toLowerCase().includes(query) || 
                       event.category.toLowerCase().includes(query);
            });
            
            // Apply additional filters
            if (filter === 'This Week') {
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate >= today && eventDate <= nextWeek;
                });
            } else if (filter === 'This Month') {
                const today = new Date();
                const nextMonth = new Date();
                nextMonth.setMonth(today.getMonth() + 1);
                
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate >= today && eventDate <= nextMonth;
                });
            } else if (filter === 'Free') {
                filteredEvents = filteredEvents.filter(event => {
                    return event.price.min === 0;
                });
            }
            
            // Update search results
            const searchResults = document.getElementById('searchResults');
            
            if (filteredEvents.length === 0) {
                searchResults.innerHTML = `
                    <p class="text-center text-tg-theme-hint py-4">No results found</p>
                `;
                return;
            }
            
            searchResults.innerHTML = `
                <h3 class="text-sm font-medium text-tg-theme-hint mb-2">${filteredEvents.length} results found</h3>
                <div class="space-y-4">
                    ${filteredEvents.map(event => `
                        <div class="event-card p-3 bg-tg-theme-secondary-bg rounded-xl flex" data-event-id="${event.id}">
                            <div class="w-20 h-20 bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden">
                                <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                            </div>
                            <div class="ml-3 flex-1">
                                <span class="inline-block px-2 py-0.5 bg-gray-200 dark:bg-gray-600 text-xs rounded-full mb-1">${event.category}</span>
                                <h3 class="font-medium leading-tight">${event.title}</h3>
                                <p class="text-xs text-tg-theme-hint mt-1">${formatDate(event.date)} • ${event.time}</p>
                                <p class="text-xs text-tg-theme-hint mt-1">${event.venue}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Add event listeners to event cards
            const eventCards = searchResults.querySelectorAll('.event-card');
            eventCards.forEach(card => {
                card.addEventListener('click', () => {
                    const eventId = card.getAttribute('data-event-id');
                    showEventDetails(eventId);
                });
            });
        }

        // Update the main UI
        function updateUI() {
            // Update event lists
            updateEventsList();
            
            // Update tickets list
            updateTicketsList();
            
            // Update managed events list
            updateManagedEventsList();
        }

        // Update the events list
        function updateEventsList() {
            // Featured events
            if (elements.containers.featuredEvents) {
                const featuredEvents = appState.events.filter(event => event.featured);
                elements.containers.featuredEvents.innerHTML = featuredEvents.map(event => `
                    <div class="event-card flex-shrink-0 w-64 bg-tg-theme-secondary-bg rounded-xl overflow-hidden" data-event-id="${event.id}">
                        <div class="h-32 bg-gray-300 dark:bg-gray-700 relative">
                            <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                            <span class="absolute top-2 left-2 px-2 py-1 bg-tg-theme-button text-tg-theme-button-text text-xs font-medium rounded-full">
                                ${event.category}
                            </span>
                        </div>
                        <div class="p-3">
                            <h3 class="font-medium mb-1 line-clamp-2">${event.title}</h3>
                            <p class="text-xs text-tg-theme-hint mb-1">${formatDate(event.date)} • ${event.time}</p>
                            <p class="text-xs text-tg-theme-hint">${event.venue}</p>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-sm font-medium">${event.price.min === event.price.max ? 
                                    `${event.price.min} ${event.price.currency}` : 
                                    `${event.price.min}-${event.price.max} ${event.price.currency}`}
                                </p>
                                <span class="text-xs text-tg-theme-hint">${event.remaining} tickets left</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to event cards
                const eventCards = elements.containers.featuredEvents.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const eventId = card.getAttribute('data-event-id');
                        showEventDetails(eventId);
                    });
                });
            }
            
            // Nearby events
            if (elements.containers.nearbyEvents) {
                // Sort events by distance (simplified version)
                const nearbyEvents = [...appState.events].sort((a, b) => {
                    return Math.random() - 0.5; // Random sort for the demo
                }).slice(0, 3);
                
                elements.containers.nearbyEvents.innerHTML = nearbyEvents.map(event => `
                    <div class="event-card mb-4 p-3 bg-tg-theme-secondary-bg rounded-xl flex" data-event-id="${event.id}">
                        <div class="w-20 h-20 bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden">
                            <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="ml-3 flex-1">
                            <span class="inline-block px-2 py-0.5 bg-gray-200 dark:bg-gray-600 text-xs rounded-full mb-1">${event.category}</span>
                            <h3 class="font-medium leading-tight">${event.title}</h3>
                            <p class="text-xs text-tg-theme-hint mt-1">${formatDate(event.date)} • ${event.time}</p>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-xs text-tg-theme-hint">${event.venue}</p>
                                <p class="text-xs font-medium">${event.price.min} ${event.price.currency}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to event cards
                const eventCards = elements.containers.nearbyEvents.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const eventId = card.getAttribute('data-event-id');
                        showEventDetails(eventId);
                    });
                });
            }
            
            // Upcoming events
            if (elements.containers.upcomingEvents) {
                // Sort events by date
                const upcomingEvents = [...appState.events].sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });
                
                elements.containers.upcomingEvents.innerHTML = upcomingEvents.map(event => `
                    <div class="event-card mb-4 p-3 bg-tg-theme-secondary-bg rounded-xl flex" data-event-id="${event.id}">
                        <div class="w-20 h-20 bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden">
                            <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="ml-3 flex-1">
                            <span class="inline-block px-2 py-0.5 bg-gray-200 dark:bg-gray-600 text-xs rounded-full mb-1">${event.category}</span>
                            <h3 class="font-medium leading-tight">${event.title}</h3>
                            <p class="text-xs text-tg-theme-hint mt-1">${formatDate(event.date)} • ${event.time}</p>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-xs text-tg-theme-hint">${event.venue}</p>
                                <p class="text-xs font-medium">${event.price.min} ${event.price.currency}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to event cards
                const eventCards = elements.containers.upcomingEvents.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const eventId = card.getAttribute('data-event-id');
                        showEventDetails(eventId);
                    });
                });
            }
        }

        // Update the tickets list
        function updateTicketsList() {
            if (elements.containers.tickets) {
                if (appState.tickets.length === 0) {
                    elements.ui.emptyTicketsState.classList.remove('hidden');
                    elements.containers.tickets.classList.add('hidden');
                } else {
                    elements.ui.emptyTicketsState.classList.add('hidden');
                    elements.containers.tickets.classList.remove('hidden');
                    
                    elements.containers.tickets.innerHTML = appState.tickets.map(ticket => {
                        const event = appState.events.find(e => e.id === ticket.eventId);
                        if (!event) return '';
                        
                        return `
                            <div class="ticket-card mb-4 bg-tg-theme-secondary-bg rounded-xl overflow-hidden" data-ticket-id="${ticket.id}">
                                <div class="p-3 bg-tg-theme-button text-tg-theme-button-text">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-medium">${event.title}</h3>
                                        <span class="text-xs opacity-90">#${ticket.id.substring(ticket.id.length - 4)}</span>
                                    </div>
                                    <p class="text-xs opacity-90">${formatDate(event.date)} • ${event.time}</p>
                                </div>
                                <div class="p-3">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-sm">${ticket.ticketType}</p>
                                            <p class="text-xs text-tg-theme-hint">${event.venue}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium">${ticket.price} ${ticket.currency}</p>
                                            <p class="text-xs text-tg-theme-hint">Purchased on ${formatDate(ticket.purchaseDate)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Add event listeners to ticket cards
                    const ticketCards = elements.containers.tickets.querySelectorAll('.ticket-card');
                    ticketCards.forEach(card => {
                        card.addEventListener('click', () => {
                            const ticketId = card.getAttribute('data-ticket-id');
                            showTicketDetails(ticketId);
                        });
                    });
                }
            }
        }

        // Update the managed events list
        function updateManagedEventsList() {
            if (elements.containers.managedEvents) {
                // In a real app, we would filter by user-created events
                // For the demo, we'll just use the sample events
                
                if (appState.events.length === 0) {
                    elements.ui.emptyEventsState.classList.remove('hidden');
                    elements.containers.managedEvents.classList.add('hidden');
                } else {
                    elements.ui.emptyEventsState.classList.add('hidden');
                    elements.containers.managedEvents.classList.remove('hidden');
                    
                    elements.containers.managedEvents.innerHTML = appState.events.map(event => `
                        <div class="managed-event-card mb-4 p-3 bg-tg-theme-secondary-bg rounded-xl" data-event-id="${event.id}">
                            <div class="flex">
                                <div class="w-20 h-20 bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden">
                                    <img src="${event.imageUrl}" alt="${event.title}" class="w-full h-full object-cover">
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex justify-between">
                                        <span class="inline-block px-2 py-0.5 bg-gray-200 dark:bg-gray-600 text-xs rounded-full">${event.category}</span>
                                        <span class="inline-block px-2 py-0.5 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 text-xs rounded-full">Active</span>
                                    </div>
                                    <h3 class="font-medium mt-1">${event.title}</h3>
                                    <p class="text-xs text-tg-theme-hint">${formatDate(event.date)} • ${event.time}</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-between">
                                    <div>
                                        <p class="text-xs text-tg-theme-hint">Sold</p>
                                        <p class="font-medium">${event.capacity - event.remaining}/${event.capacity}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-tg-theme-hint">Revenue</p>
                                        <p class="font-medium">${(event.capacity - event.remaining) * event.price.min} ${event.price.currency}</p>
                                    </div>
                                    <div>
                                        <button class="px-3 py-1 bg-tg-theme-button text-tg-theme-button-text rounded-lg text-sm manage-event-btn" data-event-id="${event.id}">
                                            Manage
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners to manage buttons
                    const manageButtons = elements.containers.managedEvents.querySelectorAll('.manage-event-btn');
                    manageButtons.forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const eventId = button.getAttribute('data-event-id');
                            showEventManagement(eventId);
                        });
                    });
                    
                    // Add event listeners to event cards
                    const eventCards = elements.containers.managedEvents.querySelectorAll('.managed-event-card');
                    eventCards.forEach(card => {
                        card.addEventListener('click', () => {
                            const eventId = card.getAttribute('data-event-id');
                            showEventDetails(eventId);
                        });
                    });
                }
            }
        }

        // Show event management page
        function showEventManagement(eventId) {
            // In a real app, we would navigate to an event management page
            // For the demo, we'll just show a toast
            showToast('Event management not available in the demo');
        }

        // Setup Telegram MainButton
        function setupTelegramMainButton() {
            webApp.MainButton.setParams({
                text: 'Discover Events',
                color: webApp.themeParams.button_color || '#5D5CDE',
                text_color: webApp.themeParams.button_text_color || '#ffffff'
            });
            
            webApp.MainButton.onClick(() => {
                handleMainButtonClick();
            });
        }

        // Update the MainButton based on the current page
        function updateMainButton() {
            switch (appState.currentPage) {
                case 'discoverPage':
                    webApp.MainButton.setText('Explore Events');
                    webApp.MainButton.show();
                    break;
                case 'myTicketsPage':
                    if (appState.tickets.length === 0) {
                        webApp.MainButton.setText('Find Events');
                        webApp.MainButton.show();
                    } else {
                        webApp.MainButton.hide();
                    }
                    break;
                case 'manageEventsPage':
                    webApp.MainButton.setText('Create Event');
                    webApp.MainButton.show();
                    break;
                case 'profilePage':
                    webApp.MainButton.hide();
                    break;
                case 'eventDetails':
                    webApp.MainButton.setText('Buy Tickets');
                    webApp.MainButton.show();
                    break;
                case 'createEvent':
                    webApp.MainButton.hide();
                    break;
                default:
                    webApp.MainButton.hide();
                    break;
            }
        }

        // Handle MainButton click based on the current page
        function handleMainButtonClick() {
            switch (appState.currentPage) {
                case 'discoverPage':
                case 'myTicketsPage':
                    if (appState.tickets.length === 0) {
                        navigateToTab(0); // Go to discover tab
                    }
                    break;
                case 'manageEventsPage':
                    showCreateEventPage();
                    break;
                case 'eventDetails':
                    // Scroll to the tickets section
                    const ticketsSection = document.querySelector('.ticket-options');
                    if (ticketsSection) {
                        ticketsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    break;
                default:
                    break;
            }
        }

        // Show loading overlay
        function showLoading(text = 'Loading...') {
            elements.ui.loadingText.textContent = text;
            elements.ui.loadingOverlay.classList.remove('hidden');
            appState.isLoading = true;
        }

        // Hide loading overlay
        function hideLoading() {
            elements.ui.loadingOverlay.classList.add('hidden');
            appState.isLoading = false;
        }

        // Show toast notification
        function showToast(message, duration = 3000) {
            elements.ui.toastMessage.textContent = message;
            elements.ui.toastNotification.classList.remove('hidden');
            
            // Trigger haptic feedback
            if (webApp.HapticFeedback) {
                webApp.HapticFeedback.notificationOccurred('success');
            }
            
            setTimeout(() => {
                elements.ui.toastNotification.classList.add('hidden');
            }, duration);
        }

        // Request location access
        function requestLocation() {
            if (navigator.geolocation) {
                showLoading('Getting location...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        appState.locations.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        hideLoading();
                        showToast('Location updated');
                        
                        // Update nearby events
                        updateEventsList();
                    },
                    (error) => {
                        hideLoading();
                        showToast('Could not get location: ' + error.message);
                        console.error(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showToast('Geolocation is not supported by this browser');
            }
        }

        // Generate a placeholder event image based on title and category
        function generateEventImage(title, category) {
            // For the demo, we'll use a placeholder image
            // In a real app, this would be replaced with real event images
            const colors = {
                'Music': 'F28B82',
                'Cultural': 'F6BF26',
                'Sports': '5D5CDE',
                'Food': '34A853',
                'Workshops': 'F7CA4C'
            };
            
            const color = colors[category] || '5D5CDE';
            return `https://placehold.co/600x400/${color}/FFFFFF?text=${encodeURIComponent(title.substring(0, 20))}`;
        }

        // Generate a placeholder QR code URL
        function generateQRCodeUrl(text) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(text)}`;
        }

        // Format date to a readable string
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Initialize the app on load
        window.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // Handle dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>
</html>
