
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Connect App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: 'var(--tg-theme-button-color, #5D5CDE)',
            'primary-text': 'var(--tg-theme-button-text-color, #ffffff)',
            bg: 'var(--tg-theme-bg-color, #ffffff)',
            text: 'var(--tg-theme-text-color, #222222)',
            hint: 'var(--tg-theme-hint-color, #999999)',
            link: 'var(--tg-theme-link-color, #2678b6)',
            'section-bg': 'var(--tg-theme-secondary-bg-color, #f0f0f0)',
            'section-header-bg': 'var(--tg-theme-header-bg-color, #ffffff)',
            'section-header-text': 'var(--tg-theme-header-text-color, #222222)',
          },
          fontFamily: {
            sans: ['system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-light': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
        },
      },
    };
  </script>
  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }

    body {
      padding-top: var(--safe-area-inset-top);
      padding-right: var(--safe-area-inset-right);
      padding-bottom: calc(var(--safe-area-inset-bottom) + 64px); /* Add space for bottom navigation */
      padding-left: var(--safe-area-inset-left);
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #222222);
      font-family: system-ui, sans-serif;
      touch-action: manipulation;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      max-width: 100vw;
      overflow-x: hidden;
    }

    .hidden {
      display: none !important;
    }

    .page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateX(100%);
      opacity: 0;
      z-index: 10;
      padding-top: calc(var(--safe-area-inset-top) + 56px); /* Header height */
      padding-bottom: 64px; /* Nav height */
      overflow-y: auto;
      background-color: var(--tg-theme-bg-color, #ffffff);
    }

    .page.active {
      transform: translateX(0);
      opacity: 1;
      z-index: 20;
    }

    .page-content {
      padding-bottom: 80px;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 64px;
      background-color: var(--tg-theme-bg-color, #ffffff);
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 50;
      padding-bottom: var(--safe-area-inset-bottom);
    }

    .skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      background-color: var(--tg-theme-hint-color, #999999);
      opacity: 0.2;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.2;
      }
      50% {
        opacity: 0.5;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      width: 90%;
      max-width: 400px;
      background-color: var(--tg-theme-bg-color, #ffffff);
      border-radius: 12px;
      padding: 20px;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    /* Card swipe animation */
    .card-container {
      position: relative;
      width: 100%;
      height: 400px;
      max-width: 360px;
      margin: 0 auto;
    }

    .card {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-origin: center;
      transition: transform 0.3s ease, opacity 0.3s ease;
      cursor: grab;
      overflow: hidden;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .card.swiped-left {
      transform: translateX(-150%) rotate(-20deg);
      opacity: 0;
    }

    .card.swiped-right {
      transform: translateX(150%) rotate(20deg);
      opacity: 0;
    }

    /* Custom slider styles */
    .custom-range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      outline: none;
    }

    .custom-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--tg-theme-button-color, #5D5CDE);
      cursor: pointer;
    }

    .custom-range::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--tg-theme-button-color, #5D5CDE);
      cursor: pointer;
      border: none;
    }

    /* Chat bubbles */
    .chat-bubble {
      position: relative;
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      margin-bottom: 8px;
    }

    .chat-bubble.sent {
      background-color: var(--tg-theme-button-color, #5D5CDE);
      color: var(--tg-theme-button-text-color, #ffffff);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.received {
      background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #222222);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .chat-bubble .time {
      font-size: 0.7rem;
      opacity: 0.7;
      position: absolute;
      bottom: 5px;
      right: 10px;
    }

    /* Badge styles */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 12px;
      background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
    }

    .badge-primary {
      background-color: var(--tg-theme-button-color, #5D5CDE);
      color: var(--tg-theme-button-text-color, #ffffff);
    }

    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--tg-theme-hint-color, #999999);
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--tg-theme-bg-color, #ffffff);
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--tg-theme-button-color, #5D5CDE);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-bg z-50">
    <div class="flex flex-col items-center">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-text">Loading Connect App...</p>
    </div>
  </div>

  <!-- Header Component -->
  <header class="fixed top-0 left-0 w-full bg-section-header-bg text-section-header-text z-40 border-b border-section-bg" style="padding-top: var(--safe-area-inset-top);">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="text-lg font-semibold" id="header-title">Connect</div>
      <div class="flex items-center">
        <button id="header-action" class="hidden p-2 rounded-full hover:bg-section-bg transition-colors ml-2">
          <i class="fas fa-sliders-h"></i>
        </button>
        <button id="header-filter" class="hidden p-2 rounded-full hover:bg-section-bg transition-colors ml-2">
          <i class="fas fa-filter"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Home Page -->
  <div id="home-page" class="page active">
    <div class="page-content px-4">
      <!-- Welcome Section -->
      <div id="user-greeting" class="flex items-center my-4">
        <div id="user-avatar" class="w-12 h-12 rounded-full bg-section-bg overflow-hidden flex-shrink-0 skeleton"></div>
        <div class="ml-3 flex-1">
          <div id="user-name" class="font-medium text-lg skeleton h-6 w-32 rounded"></div>
          <div id="user-status" class="text-hint text-sm skeleton h-4 w-48 mt-1 rounded"></div>
        </div>
      </div>

      <!-- Categories Section -->
      <div class="mb-6">
        <h2 class="font-semibold text-lg mb-3">Connect By Category</h2>
        <div class="grid grid-cols-3 gap-3">
          <div data-category="dating" class="category-card bg-section-bg p-4 rounded-xl flex flex-col items-center cursor-pointer hover:bg-opacity-80 transition-colors">
            <div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center text-primary mb-2">
              <i class="fas fa-heart"></i>
            </div>
            <div class="font-medium text-center">Dating</div>
          </div>
          <div data-category="friendship" class="category-card bg-section-bg p-4 rounded-xl flex flex-col items-center cursor-pointer hover:bg-opacity-80 transition-colors">
            <div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center text-primary mb-2">
              <i class="fas fa-user-friends"></i>
            </div>
            <div class="font-medium text-center">Friendship</div>
          </div>
          <div data-category="networking" class="category-card bg-section-bg p-4 rounded-xl flex flex-col items-center cursor-pointer hover:bg-opacity-80 transition-colors">
            <div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center text-primary mb-2">
              <i class="fas fa-briefcase"></i>
            </div>
            <div class="font-medium text-center">Networking</div>
          </div>
        </div>
      </div>

      <!-- Recent Connections -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-semibold text-lg">Recent Connections</h2>
          <button id="view-all-connections" class="text-primary text-sm">See All</button>
        </div>
        <div id="recent-connections" class="space-y-2">
          <div class="skeleton h-16 rounded-lg"></div>
          <div class="skeleton h-16 rounded-lg"></div>
          <div class="skeleton h-16 rounded-lg"></div>
        </div>
        <div id="no-connections" class="hidden py-6 text-center text-hint">
          <i class="fas fa-user-friends text-3xl mb-2"></i>
          <p>No connections yet</p>
          <p class="text-sm mt-1">Start discovering people to connect</p>
        </div>
      </div>

      <!-- Nearby People -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-semibold text-lg">People Nearby</h2>
          <button id="refresh-nearby" class="text-primary text-sm flex items-center">
            <i class="fas fa-sync-alt mr-1 text-xs"></i> Refresh
          </button>
        </div>
        <div id="location-permission-required" class="hidden bg-section-bg rounded-lg p-4 text-center">
          <i class="fas fa-map-marker-alt text-primary text-2xl mb-2"></i>
          <p class="font-medium">Location access required</p>
          <p class="text-hint text-sm mb-3">Enable location to see people near you</p>
          <button id="enable-location-btn" class="bg-primary text-primary-text py-2 px-4 rounded-lg text-sm">Enable Location</button>
        </div>
        <div id="nearby-people" class="grid grid-cols-2 gap-3">
          <div class="skeleton h-48 rounded-lg"></div>
          <div class="skeleton h-48 rounded-lg"></div>
          <div class="skeleton h-48 rounded-lg"></div>
          <div class="skeleton h-48 rounded-lg"></div>
        </div>
        <div id="no-nearby" class="hidden py-6 text-center text-hint">
          <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
          <p>No one nearby right now</p>
          <p class="text-sm mt-1">Try again later or expand your search radius</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Discover Page -->
  <div id="discover-page" class="page">
    <div class="page-content px-4">
      <!-- Category Title -->
      <div class="flex items-center justify-between mb-4">
        <h2 id="discover-category-title" class="font-semibold text-xl">Discovery</h2>
        <div class="flex items-center">
          <span id="current-location" class="text-hint text-sm mr-2">
            <i class="fas fa-location-dot"></i> <span id="location-text">Location...</span>
          </span>
          <button id="discovery-filter-btn" class="p-2 rounded-full bg-section-bg">
            <i class="fas fa-sliders-h"></i>
          </button>
        </div>
      </div>

      <!-- Card Swipe Interface -->
      <div class="card-container mb-6" id="card-container">
        <div class="flex items-center justify-center h-full text-hint" id="loading-cards">
          <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin mb-2"></div>
            <p>Loading profiles...</p>
          </div>
        </div>
        <div class="hidden flex flex-col items-center justify-center h-full text-hint" id="no-more-profiles">
          <i class="fas fa-users text-4xl mb-3 text-primary/50"></i>
          <p class="font-medium mb-1">No more profiles</p>
          <p class="text-sm text-center mb-4">We'll notify you when new people join</p>
          <button id="reload-profiles-btn" class="bg-primary text-primary-text py-2 px-6 rounded-lg">
            <i class="fas fa-sync-alt mr-2"></i> Refresh
          </button>
        </div>
        <!-- Profile cards will be inserted here -->
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-center space-x-4">
        <button id="dislike-btn" class="w-14 h-14 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-times text-xl"></i>
        </button>
        <button id="like-btn" class="w-14 h-14 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-heart text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Matches Page -->
  <div id="matches-page" class="page">
    <div class="page-content px-4">
      <!-- Tabs -->
      <div class="flex border-b border-section-bg mb-4">
        <button class="match-tab py-3 px-4 font-medium border-b-2 border-primary" data-tab="connections">Connections</button>
        <button class="match-tab py-3 px-4 font-medium border-b-2 border-transparent text-hint" data-tab="requests">Requests</button>
      </div>

      <!-- Search Bar -->
      <div class="relative mb-4">
        <input type="text" id="search-connections" placeholder="Search connections..." class="w-full bg-section-bg text-text rounded-lg py-2 pl-10 pr-4 text-base">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-hint"></i>
      </div>

      <!-- Connections Tab Content -->
      <div id="connections-tab" class="tab-content">
        <div id="connections-list" class="space-y-3">
          <div class="skeleton h-16 rounded-lg"></div>
          <div class="skeleton h-16 rounded-lg"></div>
          <div class="skeleton h-16 rounded-lg"></div>
          <div class="skeleton h-16 rounded-lg"></div>
        </div>
        <div id="no-connections-tab" class="hidden py-8 text-center text-hint">
          <i class="fas fa-user-friends text-4xl mb-3"></i>
          <p class="font-medium mb-1">No connections yet</p>
          <p class="text-sm mb-4">Start discovering people to connect</p>
          <button id="start-discovering-btn" class="bg-primary text-primary-text py-2 px-6 rounded-lg">Start Discovering</button>
        </div>
      </div>

      <!-- Requests Tab Content -->
      <div id="requests-tab" class="tab-content hidden">
        <div id="requests-list" class="space-y-3">
          <!-- Connection requests will be inserted here -->
        </div>
        <div id="no-requests" class="hidden py-8 text-center text-hint">
          <i class="fas fa-user-clock text-4xl mb-3"></i>
          <p class="font-medium mb-1">No pending requests</p>
          <p class="text-sm">When someone wants to connect, you'll see it here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Page -->
  <div id="profile-page" class="page">
    <div class="page-content">
      <!-- Profile Header -->
      <div class="flex flex-col items-center pt-4 pb-6 px-4 border-b border-section-bg">
        <div id="profile-avatar" class="w-24 h-24 rounded-full bg-section-bg overflow-hidden mb-3 skeleton"></div>
        <h2 id="profile-name" class="text-xl font-semibold skeleton h-7 w-40 rounded mb-1"></h2>
        <p id="profile-username" class="text-hint skeleton h-5 w-32 rounded mb-3"></p>
        <button id="edit-profile-btn" class="bg-primary text-primary-text py-2 px-6 rounded-lg text-sm hidden">
          Edit Profile
        </button>
      </div>

      <!-- Profile Info -->
      <div class="px-4 py-4 border-b border-section-bg">
        <h3 class="font-medium mb-3">About Me</h3>
        <p id="profile-bio" class="text-sm text-hint mb-4 skeleton h-16 rounded"></p>
        
        <div class="grid grid-cols-2 gap-4 mb-2">
          <div class="flex items-center">
            <i class="fas fa-map-marker-alt text-primary mr-2"></i>
            <span id="profile-location" class="text-sm skeleton h-4 w-20 rounded"></span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-calendar-alt text-primary mr-2"></i>
            <span id="profile-age" class="text-sm skeleton h-4 w-16 rounded"></span>
          </div>
        </div>
      </div>

      <!-- Interests -->
      <div class="px-4 py-4 border-b border-section-bg">
        <h3 class="font-medium mb-3">Interests</h3>
        <div id="profile-interests" class="flex flex-wrap gap-2">
          <div class="skeleton h-8 w-16 rounded-full"></div>
          <div class="skeleton h-8 w-20 rounded-full"></div>
          <div class="skeleton h-8 w-16 rounded-full"></div>
          <div class="skeleton h-8 w-24 rounded-full"></div>
          <div class="skeleton h-8 w-20 rounded-full"></div>
        </div>
      </div>

      <!-- Looking For -->
      <div class="px-4 py-4 border-b border-section-bg">
        <h3 class="font-medium mb-3">Looking For</h3>
        <div id="profile-looking-for" class="flex flex-wrap gap-2">
          <div class="skeleton h-8 w-24 rounded-full"></div>
          <div class="skeleton h-8 w-20 rounded-full"></div>
        </div>
      </div>

      <!-- Settings -->
      <div class="px-4 py-4">
        <h3 class="font-medium mb-3">Settings</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">Location Sharing</div>
              <div class="text-hint text-sm">Allow others to see your location</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="location-sharing-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">Profile Visibility</div>
              <div class="text-hint text-sm">Show your profile in discovery</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="profile-visibility-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">Notifications</div>
              <div class="text-hint text-sm">Receive match and message alerts</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="notifications-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="pt-2">
            <button id="privacy-policy-btn" class="w-full py-3 text-left font-medium">
              Privacy Policy
            </button>
            <button id="terms-service-btn" class="w-full py-3 text-left font-medium">
              Terms of Service
            </button>
            <button id="help-support-btn" class="w-full py-3 text-left font-medium">
              Help & Support
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Page -->
  <div id="chat-page" class="page">
    <div class="flex flex-col h-full">
      <!-- Chat Header -->
      <div class="flex items-center px-4 py-3 border-b border-section-bg">
        <button id="back-to-matches" class="p-2 -ml-2">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div id="chat-avatar" class="w-10 h-10 rounded-full bg-section-bg overflow-hidden mx-2"></div>
        <div>
          <div id="chat-name" class="font-medium"></div>
          <div id="chat-status" class="text-hint text-sm"></div>
        </div>
        <div class="ml-auto">
          <button id="chat-info-btn" class="p-2">
            <i class="fas fa-info-circle"></i>
          </button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2">
        <div class="text-center text-hint text-sm py-2">
          <span id="chat-start-date">Today</span>
        </div>
        <!-- Messages will be inserted here -->
      </div>

      <!-- Chat Input -->
      <div class="p-3 border-t border-section-bg">
        <div class="flex items-center">
          <button id="chat-attachment-btn" class="p-2 text-hint">
            <i class="fas fa-paperclip"></i>
          </button>
          <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-section-bg text-text rounded-lg py-2 px-4 mx-2 text-base">
          <button id="chat-send-btn" class="p-2 text-primary">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-edit-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-start mb-4">
        <h3 class="font-semibold text-lg">Edit Profile</h3>
        <button id="close-profile-edit" class="p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="mb-4 flex flex-col items-center">
        <div class="relative mb-3">
          <div id="edit-avatar" class="w-20 h-20 rounded-full bg-section-bg overflow-hidden"></div>
          <button id="change-avatar-btn" class="absolute bottom-0 right-0 w-8 h-8 bg-primary text-primary-text rounded-full flex items-center justify-center">
            <i class="fas fa-camera"></i>
          </button>
        </div>
      </div>
      
      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-medium mb-1">Name</label>
          <input type="text" id="edit-name" class="w-full bg-section-bg text-text rounded-lg py-2 px-3 text-base">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Age</label>
          <input type="number" id="edit-age" min="18" max="120" class="w-full bg-section-bg text-text rounded-lg py-2 px-3 text-base">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Bio</label>
          <textarea id="edit-bio" rows="3" class="w-full bg-section-bg text-text rounded-lg py-2 px-3 text-base"></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Interests</label>
          <div id="edit-interests" class="flex flex-wrap gap-2 mb-2">
            <!-- Interest tags will be inserted here -->
          </div>
          <div class="flex">
            <input type="text" id="new-interest" placeholder="Add interest..." class="flex-1 bg-section-bg text-text rounded-lg py-2 px-3 text-base">
            <button id="add-interest-btn" class="ml-2 bg-primary text-primary-text py-2 px-4 rounded-lg">Add</button>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Looking For (select all that apply)</label>
          <div class="flex flex-wrap gap-3">
            <label class="flex items-center">
              <input type="checkbox" id="looking-dating" class="mr-2">
              <span>Dating</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="looking-friendship" class="mr-2">
              <span>Friendship</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="looking-networking" class="mr-2">
              <span>Networking</span>
            </label>
          </div>
        </div>
      </div>
      
      <button id="save-profile-btn" class="w-full bg-primary text-primary-text py-3 rounded-lg font-medium">Save Changes</button>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filter-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-start mb-4">
        <h3 class="font-semibold text-lg">Filters</h3>
        <button id="close-filter" class="p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-5 mb-6">
        <div>
          <label class="block text-sm font-medium mb-2">Age Range</label>
          <div class="flex items-center justify-between mb-1">
            <span id="min-age-display">18</span>
            <span id="max-age-display">50+</span>
          </div>
          <div class="flex space-x-3">
            <input type="range" id="min-age-filter" min="18" max="65" value="18" class="custom-range">
            <input type="range" id="max-age-filter" min="18" max="65" value="65" class="custom-range">
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Distance (km)</label>
          <div class="flex items-center justify-between mb-1">
            <span>0 km</span>
            <span id="distance-display">50+ km</span>
          </div>
          <input type="range" id="distance-filter" min="1" max="100" value="50" class="custom-range">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Show me people looking for</label>
          <div class="flex flex-wrap gap-3">
            <label class="flex items-center">
              <input type="checkbox" id="filter-dating" class="mr-2" checked>
              <span>Dating</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="filter-friendship" class="mr-2" checked>
              <span>Friendship</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" id="filter-networking" class="mr-2" checked>
              <span>Networking</span>
            </label>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Interests (select to filter)</label>
          <div id="filter-interests" class="flex flex-wrap gap-2">
            <!-- Interest filters will be inserted here -->
          </div>
        </div>
      </div>
      
      <div class="flex space-x-3">
        <button id="reset-filters-btn" class="flex-1 bg-section-bg text-text py-3 rounded-lg font-medium">Reset</button>
        <button id="apply-filters-btn" class="flex-1 bg-primary text-primary-text py-3 rounded-lg font-medium">Apply</button>
      </div>
    </div>
  </div>

  <!-- Match Modal -->
  <div id="match-modal" class="modal">
    <div class="modal-content bg-primary text-primary-text text-center">
      <div class="py-3">
        <i class="fas fa-heart text-4xl mb-3"></i>
        <h3 class="font-bold text-2xl mb-2">It's a Match!</h3>
        <p class="mb-4">You and <span id="match-name"></span> both liked each other</p>
      </div>
      
      <div class="flex -mx-3 mb-4">
        <div class="w-1/2 px-3">
          <div id="match-user-avatar" class="w-24 h-24 rounded-full overflow-hidden mx-auto border-4 border-primary-text"></div>
          <p class="mt-2">You</p>
        </div>
        <div class="w-1/2 px-3">
          <div id="match-other-avatar" class="w-24 h-24 rounded-full overflow-hidden mx-auto border-4 border-primary-text"></div>
          <p id="match-other-name" class="mt-2"></p>
        </div>
      </div>
      
      <div class="flex space-x-3">
        <button id="match-keep-browsing" class="flex-1 bg-primary-text text-primary py-3 rounded-lg font-medium">Keep Browsing</button>
        <button id="match-send-message" class="flex-1 border border-primary-text py-3 rounded-lg font-medium">Send Message</button>
      </div>
    </div>
  </div>

  <!-- Location Permission Modal -->
  <div id="location-permission-modal" class="modal">
    <div class="modal-content text-center">
      <div class="mb-4">
        <i class="fas fa-map-marker-alt text-primary text-4xl"></i>
        <h3 class="font-semibold text-lg mt-2 mb-1">Enable Location</h3>
        <p class="text-hint text-sm">Connect needs access to your location to find people nearby</p>
      </div>
      
      <div class="space-y-3 mb-4 text-left">
        <div class="flex items-start">
          <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center text-primary mr-3 flex-shrink-0">
            <i class="fas fa-users"></i>
          </div>
          <div>
            <p class="font-medium">Find people nearby</p>
            <p class="text-hint text-sm">See profiles of people in your area</p>
          </div>
        </div>
        <div class="flex items-start">
          <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center text-primary mr-3 flex-shrink-0">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div>
            <p class="font-medium">Privacy protected</p>
            <p class="text-hint text-sm">Your exact location is never shown to others</p>
          </div>
        </div>
      </div>
      
      <div class="flex space-x-3">
        <button id="location-later-btn" class="flex-1 bg-section-bg text-text py-3 rounded-lg font-medium">Later</button>
        <button id="location-allow-btn" class="flex-1 bg-primary text-primary-text py-3 rounded-lg font-medium">Allow</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button id="nav-home" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-primary">
      <i class="fas fa-home text-xl"></i>
      <span class="text-xs mt-1">Home</span>
    </button>
    <button id="nav-discover" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <i class="fas fa-compass text-xl"></i>
      <span class="text-xs mt-1">Discover</span>
    </button>
    <button id="nav-matches" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <i class="fas fa-heart text-xl"></i>
      <span class="text-xs mt-1">Matches</span>
    </button>
    <button id="nav-profile" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <i class="fas fa-user text-xl"></i>
      <span class="text-xs mt-1">Profile</span>
    </button>
  </nav>

  <script>
    // Main App
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize Telegram Web App
      const tgApp = window.Telegram?.WebApp;
      let userLocation = null;
      let activeCategory = null;
      let currentUserProfile = null;
      let currentCardIndex = 0;
      let currentFilter = {
        minAge: 18,
        maxAge: 65,
        distance: 50,
        lookingFor: ['dating', 'friendship', 'networking'],
        interests: []
      };
      let activeChat = null;
      
      // App state
      const appState = {
        navigationHistory: ['home-page'],
        lastPage: 'home-page',
        userLocation: null
      };

      // Sample data for user profiles
      const userProfiles = [
        {
          id: 1,
          name: 'Emma Johnson',
          age: 28,
          location: 'San Francisco',
          distance: 3.2,
          bio: 'Coffee enthusiast, amateur photographer, and hiking lover. Looking for someone to share adventures with!',
          images: [generateAvatar('Emma Johnson', '#FFB6C1'), generateImagePlaceholder('hiking')],
          interests: ['Photography', 'Hiking', 'Coffee', 'Travel', 'Dogs'],
          lookingFor: ['dating', 'friendship'],
          lastActive: 'Just now'
        },
        {
          id: 2,
          name: 'James Wilson',
          age: 32,
          location: 'San Francisco',
          distance: 1.8,
          bio: 'Software engineer who loves rock climbing and craft beer. Always looking to try new restaurants and meet interesting people.',
          images: [generateAvatar('James Wilson', '#87CEEB'), generateImagePlaceholder('climbing')],
          interests: ['Climbing', 'Coding', 'Craft Beer', 'Food', 'Music'],
          lookingFor: ['friendship', 'networking'],
          lastActive: '2 hours ago'
        },
        {
          id: 3,
          name: 'Sophia Chen',
          age: 26,
          location: 'Oakland',
          distance: 5.7,
          bio: 'Graphic designer with a passion for art and yoga. Love exploring new coffee shops and reading in parks.',
          images: [generateAvatar('Sophia Chen', '#98FB98'), generateImagePlaceholder('art')],
          interests: ['Art', 'Yoga', 'Reading', 'Coffee', 'Design'],
          lookingFor: ['dating', 'friendship'],
          lastActive: '1 hour ago'
        },
        {
          id: 4,
          name: 'Michael Brown',
          age: 30,
          location: 'San Jose',
          distance: 12.3,
          bio: 'Marketing professional who loves basketball and playing guitar. Always up for a good conversation over drinks.',
          images: [generateAvatar('Michael Brown', '#FFA07A'), generateImagePlaceholder('basketball')],
          interests: ['Basketball', 'Guitar', 'Marketing', 'Fitness', 'Movies'],
          lookingFor: ['networking', 'friendship'],
          lastActive: '30 minutes ago'
        },
        {
          id: 5,
          name: 'Olivia Davis',
          age: 27,
          location: 'Berkeley',
          distance: 8.5,
          bio: 'PhD student studying environmental science. Love hiking, camping, and anything outdoors. Looking for adventure buddies!',
          images: [generateAvatar('Olivia Davis', '#FFDAB9'), generateImagePlaceholder('hiking')],
          interests: ['Environment', 'Hiking', 'Camping', 'Science', 'Dogs'],
          lookingFor: ['dating', 'friendship'],
          lastActive: '3 hours ago'
        },
        {
          id: 6,
          name: 'Ethan Miller',
          age: 31,
          location: 'San Francisco',
          distance: 2.1,
          bio: 'Chef by profession, foodie by heart. Love trying new recipes and sharing them with others. Also enjoy cycling and photography.',
          images: [generateAvatar('Ethan Miller', '#ADD8E6'), generateImagePlaceholder('cooking')],
          interests: ['Cooking', 'Food', 'Cycling', 'Photography', 'Travel'],
          lookingFor: ['dating', 'friendship', 'networking'],
          lastActive: '15 minutes ago'
        }
      ];

      // Sample data for matches and connections
      let connections = [
        {
          id: 2,
          unreadCount: 0,
          matched: true,
          lastMessage: {
            text: "That sounds great! When are you free?",
            timestamp: Date.now() - 5 * 60 * 1000,
            sender: 2
          },
          profile: userProfiles.find(p => p.id === 2)
        },
        {
          id: 3,
          unreadCount: 2,
          matched: true,
          lastMessage: {
            text: "Have you been to that new art gallery downtown?",
            timestamp: Date.now() - 3 * 60 * 60 * 1000,
            sender: 3
          },
          profile: userProfiles.find(p => p.id === 3)
        }
      ];

      // Sample data for connection requests
      let connectionRequests = [
        {
          id: 5,
          timestamp: Date.now() - 1 * 60 * 60 * 1000,
          profile: userProfiles.find(p => p.id === 5)
        }
      ];

      // Sample data for chat messages
      const chatMessages = {
        2: [
          {
            id: 1,
            text: "Hey James! I saw that you're into rock climbing. Any good spots you'd recommend?",
            timestamp: Date.now() - 1 * 24 * 60 * 60 * 1000,
            sender: "user"
          },
          {
            id: 2,
            text: "Hi there! Yes, I go to Mission Cliffs a lot. Have you been climbing long?",
            timestamp: Date.now() - 1 * 24 * 60 * 60 * 1000 + 15 * 60 * 1000,
            sender: 2
          },
          {
            id: 3,
            text: "I'm actually just getting started! Would love some tips if you don't mind sharing.",
            timestamp: Date.now() - 8 * 60 * 60 * 1000,
            sender: "user"
          },
          {
            id: 4,
            text: "Absolutely! I'd be happy to show you some basics sometime. Maybe we could meet up at the gym?",
            timestamp: Date.now() - 7 * 60 * 60 * 1000,
            sender: 2
          },
          {
            id: 5,
            text: "That would be awesome. How about this weekend?",
            timestamp: Date.now() - 30 * 60 * 1000,
            sender: "user"
          },
          {
            id: 6,
            text: "That sounds great! When are you free?",
            timestamp: Date.now() - 5 * 60 * 1000,
            sender: 2
          }
        ],
        3: [
          {
            id: 1,
            text: "Hi Sophia! I love your artwork that you shared in your profile!",
            timestamp: Date.now() - 2 * 24 * 60 * 60 * 1000,
            sender: "user"
          },
          {
            id: 2,
            text: "Thank you so much! I'm really passionate about graphic design.",
            timestamp: Date.now() - 2 * 24 * 60 * 60 * 1000 + 20 * 60 * 1000,
            sender: 3
          },
          {
            id: 3,
            text: "Do you have any exhibits coming up? I'd love to see more of your work.",
            timestamp: Date.now() - 1 * 24 * 60 * 60 * 1000,
            sender: "user"
          },
          {
            id: 4,
            text: "I'm actually part of a group show next month! I'll send you the details.",
            timestamp: Date.now() - 23 * 60 * 60 * 1000,
            sender: 3
          },
          {
            id: 5,
            text: "Have you been to that new art gallery downtown?",
            timestamp: Date.now() - 3 * 60 * 60 * 1000,
            sender: 3
          }
        ]
      };

      // Initialize the app
      if (tgApp) {
        console.log("Telegram WebApp is available");
        tgApp.ready();
        initTelegramApp();
      } else {
        console.log("Telegram WebApp not available, running in standalone mode");
        setTimeout(() => {
          document.getElementById('loading-screen').classList.add('hidden');
          initStandaloneApp();
        }, 1500);
      }

      // Set up user profile from Telegram or create a demo one
      function initUserProfile() {
        // Create a demo profile if we don't have user data
        if (!currentUserProfile) {
          currentUserProfile = {
            id: 'user',
            name: tgApp?.initDataUnsafe?.user?.first_name || 'Alex',
            lastName: tgApp?.initDataUnsafe?.user?.last_name || 'Taylor',
            username: tgApp?.initDataUnsafe?.user?.username || 'alex_taylor',
            photo_url: tgApp?.initDataUnsafe?.user?.photo_url || generateAvatar('Alex Taylor', '#5D5CDE'),
            age: 29,
            location: 'San Francisco',
            bio: 'Adventurous spirit looking to connect with like-minded people. Love hiking, photography, and trying new restaurants.',
            interests: ['Travel', 'Photography', 'Food', 'Hiking', 'Movies'],
            lookingFor: ['dating', 'friendship']
          };
        }

        // Update the UI with profile data
        updateUserProfileUI();
      }

      // Initialize Telegram Web App integration
      function initTelegramApp() {
        // Configure app theme based on Telegram theme
        document.body.style.backgroundColor = tgApp.themeParams.bg_color || '#ffffff';
        document.body.style.color = tgApp.themeParams.text_color || '#222222';

        // Get user data from Telegram
        if (tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
          const user = tgApp.initDataUnsafe.user;
          updateUserInfo(user);
        }

        // Initialize BackButton
        tgApp.BackButton.onClick(() => {
          handleBackNavigation();
        });

        // Initialize MainButton
        tgApp.MainButton.setParams({
          text: 'Start Connecting',
          color: tgApp.themeParams.button_color || '#5D5CDE',
          text_color: tgApp.themeParams.button_text_color || '#ffffff'
        });

        tgApp.MainButton.onClick(() => {
          if (activeCategory) {
            openPage('discover-page');
            tgApp.MainButton.hide();
          }
        });

        // Hide loading screen
        setTimeout(() => {
          document.getElementById('loading-screen').classList.add('hidden');
          initUserProfile();
        }, 1500);

        // Enable haptic feedback
        if (tgApp.HapticFeedback) {
          setupHapticFeedback();
        }
      }

      // Initialize standalone app (without Telegram WebApp)
      function initStandaloneApp() {
        // Simulate user data
        const mockUser = {
          first_name: 'Alex',
          last_name: 'Taylor',
          username: 'alex_taylor',
          photo_url: generateAvatar('Alex Taylor', '#5D5CDE')
        };
        updateUserInfo(mockUser);
        initUserProfile();
      }

      // Update user information from Telegram user data
      function updateUserInfo(user) {
        // Update user greeting
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userStatus = document.getElementById('user-status');

        userAvatar.style.backgroundImage = user.photo_url ? `url(${user.photo_url})` : `url(${generateAvatar(user.first_name, '#5D5CDE')})`;
        userAvatar.classList.remove('skeleton');
        userName.textContent = `Hi, ${user.first_name}!`;
        userName.classList.remove('skeleton');
        userStatus.textContent = `Let's find your perfect connection`;
        userStatus.classList.remove('skeleton');

        // Also update edit profile modal with this info
        document.getElementById('edit-name').value = `${user.first_name} ${user.last_name || ''}`.trim();
        document.getElementById('edit-avatar').style.backgroundImage = user.photo_url ? `url(${user.photo_url})` : `url(${generateAvatar(user.first_name, '#5D5CDE')})`;
      }

      // Update user profile UI elements
      function updateUserProfileUI() {
        if (!currentUserProfile) return;

        // Update profile page
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileUsername = document.getElementById('profile-username');
        const profileBio = document.getElementById('profile-bio');
        const profileLocation = document.getElementById('profile-location');
        const profileAge = document.getElementById('profile-age');
        const profileInterests = document.getElementById('profile-interests');
        const profileLookingFor = document.getElementById('profile-looking-for');
        const editProfileBtn = document.getElementById('edit-profile-btn');

        // Set values and remove skeleton loaders
        profileAvatar.style.backgroundImage = `url(${currentUserProfile.photo_url})`;
        profileAvatar.classList.remove('skeleton');

        profileName.textContent = `${currentUserProfile.name} ${currentUserProfile.lastName || ''}`.trim();
        profileName.classList.remove('skeleton');

        profileUsername.textContent = currentUserProfile.username ? `@${currentUserProfile.username}` : '';
        profileUsername.classList.remove('skeleton');

        profileBio.textContent = currentUserProfile.bio || 'No bio yet';
        profileBio.classList.remove('skeleton');

        profileLocation.textContent = currentUserProfile.location || 'Location not set';
        profileLocation.classList.remove('skeleton');

        profileAge.textContent = currentUserProfile.age ? `${currentUserProfile.age} years old` : 'Age not set';
        profileAge.classList.remove('skeleton');

        // Show edit profile button
        editProfileBtn.classList.remove('hidden');

        // Update interests
        profileInterests.innerHTML = '';
        if (currentUserProfile.interests && currentUserProfile.interests.length > 0) {
          currentUserProfile.interests.forEach(interest => {
            const badge = document.createElement('div');
            badge.className = 'bg-primary/10 text-primary px-3 py-1 rounded-full text-sm';
            badge.textContent = interest;
            profileInterests.appendChild(badge);
          });
        } else {
          const emptyText = document.createElement('p');
          emptyText.className = 'text-hint text-sm';
          emptyText.textContent = 'No interests added yet';
          profileInterests.appendChild(emptyText);
        }

        // Update looking for
        profileLookingFor.innerHTML = '';
        if (currentUserProfile.lookingFor && currentUserProfile.lookingFor.length > 0) {
          currentUserProfile.lookingFor.forEach(type => {
            const badge = document.createElement('div');
            badge.className = 'bg-primary/10 text-primary px-3 py-1 rounded-full text-sm';
            badge.textContent = capitalizeFirstLetter(type);
            profileLookingFor.appendChild(badge);
          });
        } else {
          const emptyText = document.createElement('p');
          emptyText.className = 'text-hint text-sm';
          emptyText.textContent = 'Not specified';
          profileLookingFor.appendChild(emptyText);
        }

        // Update edit form fields
        document.getElementById('edit-name').value = `${currentUserProfile.name} ${currentUserProfile.lastName || ''}`.trim();
        document.getElementById('edit-age').value = currentUserProfile.age || '';
        document.getElementById('edit-bio').value = currentUserProfile.bio || '';
        
        // Update checkboxes for looking for
        document.getElementById('looking-dating').checked = currentUserProfile.lookingFor?.includes('dating') || false;
        document.getElementById('looking-friendship').checked = currentUserProfile.lookingFor?.includes('friendship') || false;
        document.getElementById('looking-networking').checked = currentUserProfile.lookingFor?.includes('networking') || false;

        // Update interests in edit form
        const editInterests = document.getElementById('edit-interests');
        editInterests.innerHTML = '';
        if (currentUserProfile.interests && currentUserProfile.interests.length > 0) {
          currentUserProfile.interests.forEach(interest => {
            const badge = document.createElement('div');
            badge.className = 'bg-section-bg text-text px-3 py-1 rounded-full text-sm flex items-center';
            badge.innerHTML = `
              ${interest}
              <button class="ml-2 remove-interest" data-interest="${interest}">
                <i class="fas fa-times text-xs"></i>
              </button>
            `;
            editInterests.appendChild(badge);
          });

          // Add event listeners to remove buttons
          document.querySelectorAll('.remove-interest').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const interest = e.currentTarget.dataset.interest;
              currentUserProfile.interests = currentUserProfile.interests.filter(i => i !== interest);
              updateUserProfileUI();
              triggerHapticFeedback('light');
            });
          });
        }

        // Update match modal user avatar
        document.getElementById('match-user-avatar').style.backgroundImage = `url(${currentUserProfile.photo_url})`;
      }

      // Initialize the application
      async function initApp() {
        // Set up event listeners
        setupEventListeners();

        // Request location permission after a short delay
        setTimeout(() => {
          requestLocationPermission();
        }, 2000);

        // Load connections and update UI
        updateConnectionsList();
        updateRequestsList();
        updateRecentConnections();
        
        // Update nearby people section
        updateNearbyPeople();
      }

      // Request location permission
      function requestLocationPermission() {
        // Check if we already have permission
        if (userLocation) {
          return;
        }

        // Show location permission modal
        showModal('location-permission-modal');
      }

      // Get user location
      function getUserLocation() {
        if (navigator.geolocation) {
          document.getElementById('location-permission-required').classList.add('hidden');
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              userLocation = { lat: latitude, lng: longitude };
              appState.userLocation = userLocation;
              
              // Update UI elements with location
              updateLocationBasedUI();
              
              // Hide location permission UI elements
              document.getElementById('location-permission-required').classList.add('hidden');
              document.getElementById('nearby-people').classList.remove('hidden');
              
              // Get nearby city name
              getCityFromCoordinates(latitude, longitude);
            },
            (error) => {
              console.log("Error getting location:", error);
              showLocationError();
            }
          );
        } else {
          console.log("Geolocation is not supported by this browser.");
          showLocationError();
        }
      }

      // Show location error UI
      function showLocationError() {
        document.getElementById('nearby-people').classList.add('hidden');
        document.getElementById('location-permission-required').classList.remove('hidden');
      }

      // Get city name from coordinates (mock implementation)
      function getCityFromCoordinates(lat, lng) {
        // In a real app, you would make a reverse geocoding API call
        // For demo purposes, we'll just use "San Francisco"
        document.getElementById('location-text').textContent = 'San Francisco';
      }

      // Update UI elements that depend on location
      function updateLocationBasedUI() {
        // Update nearby people section
        updateNearbyPeople();
      }

      // Update nearby people section
      function updateNearbyPeople() {
        const nearbyContainer = document.getElementById('nearby-people');
        const noNearby = document.getElementById('no-nearby');
        
        // If no location permission, show appropriate UI
        if (!userLocation) {
          nearbyContainer.classList.add('hidden');
          document.getElementById('location-permission-required').classList.remove('hidden');
          noNearby.classList.add('hidden');
          return;
        }
        
        // Show nearby container, hide location permission message
        nearbyContainer.classList.remove('hidden');
        document.getElementById('location-permission-required').classList.add('hidden');
        
        // Filter profiles by distance
        const nearbyProfiles = userProfiles.filter(profile => 
          profile.distance <= 10 && !connections.some(c => c.id === profile.id)
        ).sort((a, b) => a.distance - b.distance).slice(0, 4);
        
        if (nearbyProfiles.length === 0) {
          nearbyContainer.classList.add('hidden');
          noNearby.classList.remove('hidden');
          return;
        }
        
        // Show profiles, hide no nearby message
        nearbyContainer.classList.remove('hidden');
        noNearby.classList.add('hidden');
        
        // Populate nearby profiles
        nearbyContainer.innerHTML = '';
        nearbyProfiles.forEach(profile => {
          const profileCard = document.createElement('div');
          profileCard.className = 'bg-section-bg rounded-lg overflow-hidden shadow-sm';
          profileCard.innerHTML = `
            <div class="aspect-square bg-cover bg-center" style="background-image: url('${profile.images[0]}')"></div>
            <div class="p-3">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-medium">${profile.name}, ${profile.age}</h3>
                  <p class="text-hint text-xs flex items-center">
                    <i class="fas fa-map-marker-alt mr-1"></i> ${profile.distance.toFixed(1)} km away
                  </p>
                </div>
                <span class="badge badge-primary text-xs">${capitalizeFirstLetter(profile.lookingFor[0])}</span>
              </div>
            </div>
          `;
          
          profileCard.addEventListener('click', () => {
            viewProfile(profile);
          });
          
          nearbyContainer.appendChild(profileCard);
        });
      }

      // Update recent connections section on home page
      function updateRecentConnections() {
        const recentContainer = document.getElementById('recent-connections');
        const noConnections = document.getElementById('no-connections');
        
        if (connections.length === 0) {
          recentContainer.classList.add('hidden');
          noConnections.classList.remove('hidden');
          return;
        }
        
        recentContainer.classList.remove('hidden');
        noConnections.classList.add('hidden');
        
        // Sort connections by last message timestamp
        const sortedConnections = [...connections].sort((a, b) => {
          const aTime = a.lastMessage?.timestamp || 0;
          const bTime = b.lastMessage?.timestamp || 0;
          return bTime - aTime;
        }).slice(0, 3);
        
        recentContainer.innerHTML = '';
        sortedConnections.forEach(connection => {
          const profile = connection.profile;
          const lastMessageTime = connection.lastMessage ? formatTimestamp(connection.lastMessage.timestamp) : '';
          
          const connectionItem = document.createElement('div');
          connectionItem.className = 'flex items-center bg-section-bg rounded-lg p-3';
          connectionItem.innerHTML = `
            <div class="w-12 h-12 rounded-full bg-cover bg-center mr-3" style="background-image: url('${profile.images[0]}')"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <h3 class="font-medium truncate">${profile.name}</h3>
                <span class="text-hint text-xs">${lastMessageTime}</span>
              </div>
              <p class="text-hint text-sm truncate">
                ${connection.lastMessage ? connection.lastMessage.text : 'New match!'}
              </p>
            </div>
            ${connection.unreadCount > 0 ? `<div class="ml-2 w-5 h-5 bg-primary rounded-full text-primary-text text-xs flex items-center justify-center">${connection.unreadCount}</div>` : ''}
          `;
          
          connectionItem.addEventListener('click', () => {
            openChat(connection);
          });
          
          recentContainer.appendChild(connectionItem);
        });
      }

      // Update connections list in the matches tab
      function updateConnectionsList() {
        const connectionsContainer = document.getElementById('connections-list');
        const noConnectionsTab = document.getElementById('no-connections-tab');
        
        if (connections.length === 0) {
          connectionsContainer.classList.add('hidden');
          noConnectionsTab.classList.remove('hidden');
          return;
        }
        
        connectionsContainer.classList.remove('hidden');
        noConnectionsTab.classList.add('hidden');
        
        // Sort connections by last message timestamp
        const sortedConnections = [...connections].sort((a, b) => {
          const aTime = a.lastMessage?.timestamp || 0;
          const bTime = b.lastMessage?.timestamp || 0;
          return bTime - aTime;
        });
        
        connectionsContainer.innerHTML = '';
        sortedConnections.forEach(connection => {
          const profile = connection.profile;
          const lastMessageTime = connection.lastMessage ? formatTimestamp(connection.lastMessage.timestamp) : '';
          
          const connectionItem = document.createElement('div');
          connectionItem.className = 'flex items-center bg-section-bg rounded-lg p-3';
          connectionItem.innerHTML = `
            <div class="w-12 h-12 rounded-full bg-cover bg-center mr-3" style="background-image: url('${profile.images[0]}')"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <h3 class="font-medium truncate">${profile.name}</h3>
                <span class="text-hint text-xs">${lastMessageTime}</span>
              </div>
              <p class="text-hint text-sm truncate">
                ${connection.lastMessage ? connection.lastMessage.text : 'New match!'}
              </p>
            </div>
            ${connection.unreadCount > 0 ? `<div class="ml-2 w-5 h-5 bg-primary rounded-full text-primary-text text-xs flex items-center justify-center">${connection.unreadCount}</div>` : ''}
          `;
          
          connectionItem.addEventListener('click', () => {
            openChat(connection);
          });
          
          connectionsContainer.appendChild(connectionItem);
        });
      }

      // Update connection requests list in the requests tab
      function updateRequestsList() {
        const requestsContainer = document.getElementById('requests-list');
        const noRequests = document.getElementById('no-requests');
        
        if (connectionRequests.length === 0) {
          requestsContainer.classList.add('hidden');
          noRequests.classList.remove('hidden');
          return;
        }
        
        requestsContainer.classList.remove('hidden');
        noRequests.classList.add('hidden');
        
        // Sort requests by timestamp
        const sortedRequests = [...connectionRequests].sort((a, b) => b.timestamp - a.timestamp);
        
        requestsContainer.innerHTML = '';
        sortedRequests.forEach(request => {
          const profile = request.profile;
          const requestTime = formatTimestamp(request.timestamp);
          
          const requestItem = document.createElement('div');
          requestItem.className = 'flex items-center bg-section-bg rounded-lg p-3';
          requestItem.innerHTML = `
            <div class="w-12 h-12 rounded-full bg-cover bg-center mr-3" style="background-image: url('${profile.images[0]}')"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <h3 class="font-medium truncate">${profile.name}, ${profile.age}</h3>
                <span class="text-hint text-xs">${requestTime}</span>
              </div>
              <p class="text-hint text-sm truncate">
                Wants to connect for ${profile.lookingFor.map(capitalizeFirstLetter).join(', ')}
              </p>
            </div>
            <div class="flex ml-2">
              <button class="decline-request w-8 h-8 bg-section-bg rounded-full flex items-center justify-center mr-2" data-id="${profile.id}">
                <i class="fas fa-times text-red-500"></i>
              </button>
              <button class="accept-request w-8 h-8 bg-primary rounded-full flex items-center justify-center text-primary-text" data-id="${profile.id}">
                <i class="fas fa-check"></i>
              </button>
            </div>
          `;
          
          requestsContainer.appendChild(requestItem);
        });
        
        // Add event listeners to accept/decline buttons
        document.querySelectorAll('.accept-request').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const requestId = parseInt(e.currentTarget.dataset.id);
            acceptConnectionRequest(requestId);
            triggerHapticFeedback('medium');
          });
        });
        
        document.querySelectorAll('.decline-request').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const requestId = parseInt(e.currentTarget.dataset.id);
            declineConnectionRequest(requestId);
            triggerHapticFeedback('light');
          });
        });
      }

      // Accept a connection request
      function acceptConnectionRequest(requestId) {
        // Find the request
        const requestIndex = connectionRequests.findIndex(r => r.id === requestId);
        if (requestIndex === -1) return;
        
        const request = connectionRequests[requestIndex];
        
        // Add to connections
        connections.push({
          id: request.profile.id,
          unreadCount: 0,
          matched: true,
          lastMessage: null,
          profile: request.profile
        });
        
        // Remove from requests
        connectionRequests.splice(requestIndex, 1);
        
        // Update UI
        updateConnectionsList();
        updateRequestsList();
        updateRecentConnections();
        
        // Show match notification
        showToast('Connection request accepted!');
      }

      // Decline a connection request
      function declineConnectionRequest(requestId) {
        // Find the request
        const requestIndex = connectionRequests.findIndex(r => r.id === requestId);
        if (requestIndex === -1) return;
        
        // Remove from requests
        connectionRequests.splice(requestIndex, 1);
        
        // Update UI
        updateRequestsList();
        
        // Show toast
        showToast('Connection request declined');
      }

      // Open chat with a connection
      function openChat(connection) {
        // Set active chat
        activeChat = connection;
        
        // Reset unread count
        connection.unreadCount = 0;
        
        // Update UI
        const chatAvatar = document.getElementById('chat-avatar');
        const chatName = document.getElementById('chat-name');
        const chatStatus = document.getElementById('chat-status');
        
        chatAvatar.style.backgroundImage = `url('${connection.profile.images[0]}')`;
        chatName.textContent = connection.profile.name;
        chatStatus.textContent = connection.profile.lastActive;
        
        // Load chat messages
        loadChatMessages(connection.id);
        
        // Navigate to chat page
        openPage('chat-page');
        
        // Update connections list (to reflect read messages)
        updateConnectionsList();
        updateRecentConnections();
      }

      // Load chat messages for a conversation
      function loadChatMessages(chatId) {
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '';
        
        // Set date header
        document.getElementById('chat-start-date').textContent = 'Today';
        
        // Get messages for this chat
        const messages = chatMessages[chatId] || [];
        
        // Render messages
        messages.forEach(message => {
          const isSent = message.sender === 'user';
          const messageEl = document.createElement('div');
          messageEl.className = `chat-bubble ${isSent ? 'sent' : 'received'}`;
          
          messageEl.innerHTML = `
            ${message.text}
            <div class="time">${formatChatTime(message.timestamp)}</div>
          `;
          
          messagesContainer.appendChild(messageEl);
        });
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Send a chat message
      function sendChatMessage() {
        if (!activeChat) return;
        
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        // Clear input
        input.value = '';
        
        // Create new message
        const newMessage = {
          id: Date.now(),
          text: text,
          timestamp: Date.now(),
          sender: 'user'
        };
        
        // Add to chat messages
        if (!chatMessages[activeChat.id]) {
          chatMessages[activeChat.id] = [];
        }
        chatMessages[activeChat.id].push(newMessage);
        
        // Update last message
        activeChat.lastMessage = {
          text: text,
          timestamp: Date.now(),
          sender: 'user'
        };
        
        // Add message to UI
        const messagesContainer = document.getElementById('chat-messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'chat-bubble sent';
        
        messageEl.innerHTML = `
          ${text}
          <div class="time">${formatChatTime(Date.now())}</div>
        `;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Simulate response after a delay
        setTimeout(() => {
          if (activeChat) {
            simulateChatResponse(activeChat.id);
          }
        }, 1000 + Math.random() * 2000);
        
        // Trigger haptic feedback
        triggerHapticFeedback('light');
      }

      // Simulate a chat response
      function simulateChatResponse(chatId) {
        // Sample responses
        const responses = [
          "That sounds great!",
          "Thanks for sharing that with me.",
          "I'd love to learn more about that.",
          "I've been thinking about trying that too.",
          "What a coincidence! I was just talking about that yesterday.",
          "That's interesting! Tell me more.",
          "I've never thought about it that way before.",
          "Would you like to meet up sometime to discuss this more?",
          "Have you been doing that for long?",
          "I completely agree with you on that."
        ];
        
        // Pick a random response
        const responseText = responses[Math.floor(Math.random() * responses.length)];
        
        // Create new message
        const newMessage = {
          id: Date.now(),
          text: responseText,
          timestamp: Date.now(),
          sender: chatId
        };
        
        // Add to chat messages
        chatMessages[chatId].push(newMessage);
        
        // Update last message for the connection
        const connection = connections.find(c => c.id === chatId);
        if (connection) {
          connection.lastMessage = {
            text: responseText,
            timestamp: Date.now(),
            sender: chatId
          };
          
          // Only increment unread count if not in this chat
          if (activeChat && activeChat.id === chatId) {
            // Add message to UI if we're in this chat
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-bubble received';
            
            messageEl.innerHTML = `
              ${responseText}
              <div class="time">${formatChatTime(Date.now())}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          } else {
            connection.unreadCount = (connection.unreadCount || 0) + 1;
          }
        }
        
        // Update connections list
        updateConnectionsList();
        updateRecentConnections();
      }

      // Set up profile card swipe functionality
      function setupCardSwipe() {
        const container = document.getElementById('card-container');
        
        // Reset container
        container.querySelectorAll('.card').forEach(card => card.remove());
        document.getElementById('loading-cards').classList.remove('hidden');
        document.getElementById('no-more-profiles').classList.add('hidden');
        
        // Load profiles for current category
        setTimeout(() => {
          loadProfileCards();
        }, 1000);
      }

      // Load profile cards for swiping
      function loadProfileCards() {
        const container = document.getElementById('card-container');
        document.getElementById('loading-cards').classList.add('hidden');
        
        // Filter profiles by current category and other filters
        let filteredProfiles = [...userProfiles].filter(profile => {
          // Skip profiles that are already connections
          if (connections.some(c => c.id === profile.id)) return false;
          
          // Filter by category if active
          if (activeCategory && !profile.lookingFor.includes(activeCategory)) return false;
          
          // Apply age filter
          if (profile.age < currentFilter.minAge || profile.age > currentFilter.maxAge) return false;
          
          // Apply distance filter
          if (profile.distance > currentFilter.distance) return false;
          
          // Filter by "looking for" preferences
          if (!profile.lookingFor.some(type => currentFilter.lookingFor.includes(type))) return false;
          
          // Filter by interests if any are selected
          if (currentFilter.interests.length > 0) {
            if (!profile.interests.some(interest => currentFilter.interests.includes(interest))) return false;
          }
          
          return true;
        });
        
        // Shuffle profiles
        filteredProfiles = shuffleArray(filteredProfiles);
        
        if (filteredProfiles.length === 0) {
          document.getElementById('no-more-profiles').classList.remove('hidden');
          return;
        }
        
        // Create cards
        filteredProfiles.forEach((profile, index) => {
          const card = createProfileCard(profile);
          card.style.zIndex = 1000 - index;
          
          if (index > 0) {
            card.style.transform = 'scale(0.95) translateY(15px)';
            card.style.opacity = '0.7';
          }
          
          container.appendChild(card);
        });
        
        // Set up the first card for swiping
        if (filteredProfiles.length > 0) {
          setupCardForSwiping(container.querySelector('.card'));
        }
      }

      // Create a profile card
      function createProfileCard(profile) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.profileId = profile.id;
        
        card.innerHTML = `
          <div class="relative h-full bg-section-bg overflow-hidden rounded-lg">
            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${profile.images[0]}')"></div>
            <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-white text-xl font-bold">${profile.name}, ${profile.age}</h3>
                  <p class="text-white/80 flex items-center text-sm">
                    <i class="fas fa-map-marker-alt mr-1"></i> ${profile.distance.toFixed(1)} km away
                  </p>
                </div>
                <button class="info-btn w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white" data-profile-id="${profile.id}">
                  <i class="fas fa-info"></i>
                </button>
              </div>
              <div class="mt-2 flex flex-wrap gap-2">
                ${profile.interests.slice(0, 3).map(interest => 
                  `<span class="bg-white/20 text-white px-2 py-1 rounded-full text-xs">${interest}</span>`
                ).join('')}
                ${profile.interests.length > 3 ? `<span class="bg-white/20 text-white px-2 py-1 rounded-full text-xs">+${profile.interests.length - 3} more</span>` : ''}
              </div>
            </div>
          </div>
        `;
        
        // Add info button listener
        card.querySelector('.info-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          const profileId = parseInt(e.currentTarget.dataset.profileId);
          const profile = userProfiles.find(p => p.id === profileId);
          if (profile) {
            viewProfile(profile);
          }
        });
        
        return card;
      }

      // Set up a card for swiping
      function setupCardForSwiping(card) {
        if (!card) return;
        
        let startX = 0;
        let currentX = 0;
        let isSwiping = false;
        
        // Touch events
        card.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          isSwiping = true;
          card.style.transition = 'none';
        });
        
        card.addEventListener('touchmove', (e) => {
          if (!isSwiping) return;
          
          currentX = e.touches[0].clientX;
          const deltaX = currentX - startX;
          
          // Limit rotation to a reasonable amount
          const rotation = deltaX * 0.03;
          const rotationLimited = Math.max(Math.min(rotation, 20), -20);
          
          card.style.transform = `translateX(${deltaX}px) rotate(${rotationLimited}deg)`;
          
          // Change background color based on swipe direction
          if (deltaX > 50) {
            card.style.boxShadow = '0 0 10px 2px rgba(0, 255, 0, 0.2)';
          } else if (deltaX < -50) {
            card.style.boxShadow = '0 0 10px 2px rgba(255, 0, 0, 0.2)';
          } else {
            card.style.boxShadow = 'none';
          }
        });
        
        card.addEventListener('touchend', () => {
          if (!isSwiping) return;
          isSwiping = false;
          
          const deltaX = currentX - startX;
          card.style.transition = 'transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease';
          card.style.boxShadow = 'none';
          
          if (deltaX > 100) {
            // Swiped right (like)
            card.classList.add('swiped-right');
            handleSwipe(card, 'right');
          } else if (deltaX < -100) {
            // Swiped left (dislike)
            card.classList.add('swiped-left');
            handleSwipe(card, 'left');
          } else {
            // Return to center
            card.style.transform = '';
          }
        });
        
        // Mouse events for desktop testing
        card.addEventListener('mousedown', (e) => {
          startX = e.clientX;
          isSwiping = true;
          card.style.transition = 'none';
        });
        
        card.addEventListener('mousemove', (e) => {
          if (!isSwiping) return;
          
          currentX = e.clientX;
          const deltaX = currentX - startX;
          
          // Limit rotation to a reasonable amount
          const rotation = deltaX * 0.03;
          const rotationLimited = Math.max(Math.min(rotation, 20), -20);
          
          card.style.transform = `translateX(${deltaX}px) rotate(${rotationLimited}deg)`;
          
          // Change background color based on swipe direction
          if (deltaX > 50) {
            card.style.boxShadow = '0 0 10px 2px rgba(0, 255, 0, 0.2)';
          } else if (deltaX < -50) {
            card.style.boxShadow = '0 0 10px 2px rgba(255, 0, 0, 0.2)';
          } else {
            card.style.boxShadow = 'none';
          }
        });
        
        card.addEventListener('mouseup', () => {
          if (!isSwiping) return;
          isSwiping = false;
          
          const deltaX = currentX - startX;
          card.style.transition = 'transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease';
          card.style.boxShadow = 'none';
          
          if (deltaX > 100) {
            // Swiped right (like)
            card.classList.add('swiped-right');
            handleSwipe(card, 'right');
          } else if (deltaX < -100) {
            // Swiped left (dislike)
            card.classList.add('swiped-left');
            handleSwipe(card, 'left');
          } else {
            // Return to center
            card.style.transform = '';
          }
        });
        
        card.addEventListener('mouseleave', () => {
          if (isSwiping) {
            isSwiping = false;
            card.style.transition = 'transform 0.3s ease';
            card.style.transform = '';
            card.style.boxShadow = 'none';
          }
        });
      }

      // Handle card swipe
      function handleSwipe(card, direction) {
        const profileId = parseInt(card.dataset.profileId);
        const profile = userProfiles.find(p => p.id === profileId);
        
        if (!profile) return;
        
        setTimeout(() => {
          // Remove card
          card.remove();
          
          // Check for match if swiped right
          if (direction === 'right') {
            // For demo purposes, 30% chance of a match
            const isMatch = Math.random() < 0.3;
            
            if (isMatch) {
              createMatch(profile);
            }
          }
          
          // Set up next card
          const nextCard = document.querySelector('.card');
          if (nextCard) {
            nextCard.style.transform = '';
            nextCard.style.opacity = '1';
            setupCardForSwiping(nextCard);
          } else {
            // No more cards
            document.getElementById('no-more-profiles').classList.remove('hidden');
          }
        }, 300);
        
        // Trigger haptic feedback
        if (direction === 'right') {
          triggerHapticFeedback('medium');
        } else {
          triggerHapticFeedback('light');
        }
      }

      // Create a match
      function createMatch(profile) {
        // Add to connections
        connections.push({
          id: profile.id,
          unreadCount: 0,
          matched: true,
          lastMessage: null,
          profile: profile
        });
        
        // Update UI
        updateConnectionsList();
        updateRecentConnections();
        
        // Show match modal
        document.getElementById('match-name').textContent = profile.name;
        document.getElementById('match-other-name').textContent = profile.name;
        document.getElementById('match-other-avatar').style.backgroundImage = `url('${profile.images[0]}')`;
        showModal('match-modal');
        
        // Trigger haptic feedback
        triggerHapticFeedback('heavy');
      }

      // View a profile
      function viewProfile(profile) {
        // Open profile details in a modal
        // In a real app, you would have a profile details modal or page
        showToast(`Viewing ${profile.name}'s profile`);
      }

      // Set up event listeners
      function setupEventListeners() {
        // Navigation buttons
        document.getElementById('nav-home').addEventListener('click', () => navigateTo('home-page'));
        document.getElementById('nav-discover').addEventListener('click', () => navigateTo('discover-page'));
        document.getElementById('nav-matches').addEventListener('click', () => navigateTo('matches-page'));
        document.getElementById('nav-profile').addEventListener('click', () => navigateTo('profile-page'));

        // Category cards
        document.querySelectorAll('.category-card').forEach(card => {
          card.addEventListener('click', (e) => {
            const category = e.currentTarget.dataset.category;
            activeCategory = category;
            document.getElementById('discover-category-title').textContent = capitalizeFirstLetter(category);
            navigateTo('discover-page');
            setupCardSwipe();
            triggerHapticFeedback('medium');
          });
        });

        // View all connections
        document.getElementById('view-all-connections').addEventListener('click', () => {
          navigateTo('matches-page');
        });

        // Refresh nearby
        document.getElementById('refresh-nearby').addEventListener('click', () => {
          updateNearbyPeople();
          triggerHapticFeedback('light');
          showToast('Refreshing nearby people...');
        });

        // Enable location button
        document.getElementById('enable-location-btn').addEventListener('click', () => {
          requestLocationPermission();
        });

        // Match tabs
        document.querySelectorAll('.match-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.currentTarget.dataset.tab;
            
            // Update tab appearance
            document.querySelectorAll('.match-tab').forEach(t => {
              t.classList.remove('border-primary');
              t.classList.add('border-transparent', 'text-hint');
            });
            e.currentTarget.classList.add('border-primary');
            e.currentTarget.classList.remove('border-transparent', 'text-hint');
            
            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            triggerHapticFeedback('light');
          });
        });

        // Search connections
        document.getElementById('search-connections').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const connectionItems = document.querySelectorAll('#connections-list > div');
          
          connectionItems.forEach(item => {
            const name = item.querySelector('h3').textContent.toLowerCase();
            if (name.includes(searchTerm)) {
              item.classList.remove('hidden');
            } else {
              item.classList.add('hidden');
            }
          });
        });

        // Start discovering button
        document.getElementById('start-discovering-btn').addEventListener('click', () => {
          navigateTo('discover-page');
          setupCardSwipe();
        });

        // Discovery filter button
        document.getElementById('discovery-filter-btn').addEventListener('click', () => {
          showModal('filter-modal');
        });

        // Header filter button
        document.getElementById('header-filter').addEventListener('click', () => {
          showModal('filter-modal');
        });

        // Like/dislike buttons
        document.getElementById('like-btn').addEventListener('click', () => {
          const currentCard = document.querySelector('.card');
          if (currentCard) {
            currentCard.classList.add('swiped-right');
            handleSwipe(currentCard, 'right');
          }
        });

        document.getElementById('dislike-btn').addEventListener('click', () => {
          const currentCard = document.querySelector('.card');
          if (currentCard) {
            currentCard.classList.add('swiped-left');
            handleSwipe(currentCard, 'left');
          }
        });

        // Reload profiles button
        document.getElementById('reload-profiles-btn').addEventListener('click', () => {
          setupCardSwipe();
          triggerHapticFeedback('medium');
        });

        // Edit profile button
        document.getElementById('edit-profile-btn').addEventListener('click', () => {
          showModal('profile-edit-modal');
        });

        // Save profile button
        document.getElementById('save-profile-btn').addEventListener('click', () => {
          saveProfileChanges();
        });

        // Close profile edit modal
        document.getElementById('close-profile-edit').addEventListener('click', () => {
          hideModal('profile-edit-modal');
        });

        // Add interest button
        document.getElementById('add-interest-btn').addEventListener('click', () => {
          addInterest();
        });

        document.getElementById('new-interest').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addInterest();
          }
        });

        // Filter modal events
        document.getElementById('close-filter').addEventListener('click', () => {
          hideModal('filter-modal');
        });

        document.getElementById('apply-filters-btn').addEventListener('click', () => {
          applyFilters();
          hideModal('filter-modal');
        });

        document.getElementById('reset-filters-btn').addEventListener('click', () => {
          resetFilters();
        });

        // Set up filter range inputs
        document.getElementById('min-age-filter').addEventListener('input', (e) => {
          const minAge = parseInt(e.target.value);
          document.getElementById('min-age-display').textContent = minAge;
          
          // Make sure max is not less than min
          const maxAgeInput = document.getElementById('max-age-filter');
          if (parseInt(maxAgeInput.value) < minAge) {
            maxAgeInput.value = minAge;
            document.getElementById('max-age-display').textContent = minAge === 65 ? '50+' : minAge;
          }
        });

        document.getElementById('max-age-filter').addEventListener('input', (e) => {
          const maxAge = parseInt(e.target.value);
          document.getElementById('max-age-display').textContent = maxAge === 65 ? '50+' : maxAge;
          
          // Make sure min is not more than max
          const minAgeInput = document.getElementById('min-age-filter');
          if (parseInt(minAgeInput.value) > maxAge) {
            minAgeInput.value = maxAge;
            document.getElementById('min-age-display').textContent = maxAge;
          }
        });

        document.getElementById('distance-filter').addEventListener('input', (e) => {
          const distance = parseInt(e.target.value);
          document.getElementById('distance-display').textContent = distance === 100 ? '50+ km' : `${distance} km`;
        });

        // Match modal buttons
        document.getElementById('match-keep-browsing').addEventListener('click', () => {
          hideModal('match-modal');
        });

        document.getElementById('match-send-message').addEventListener('click', () => {
          hideModal('match-modal');
          
          // Open chat with the newly matched person
          const lastMatchId = connections[connections.length - 1].id;
          const matchedConnection = connections.find(c => c.id === lastMatchId);
          if (matchedConnection) {
            openChat(matchedConnection);
          }
        });

        // Location permission modal
        document.getElementById('location-later-btn').addEventListener('click', () => {
          hideModal('location-permission-modal');
        });

        document.getElementById('location-allow-btn').addEventListener('click', () => {
          hideModal('location-permission-modal');
          getUserLocation();
        });

        // Settings toggles
        document.getElementById('location-sharing-toggle').addEventListener('change', (e) => {
          // In a real app, you would update user settings
          showToast(e.target.checked ? 'Location sharing enabled' : 'Location sharing disabled');
          triggerHapticFeedback('light');
        });

        document.getElementById('profile-visibility-toggle').addEventListener('change', (e) => {
          showToast(e.target.checked ? 'Profile is now visible' : 'Profile is now hidden');
          triggerHapticFeedback('light');
        });

        document.getElementById('notifications-toggle').addEventListener('change', (e) => {
          showToast(e.target.checked ? 'Notifications enabled' : 'Notifications disabled');
          triggerHapticFeedback('light');
        });

        // Settings buttons
        document.getElementById('privacy-policy-btn').addEventListener('click', () => {
          // In a real app, you would open the privacy policy
          showToast('Privacy Policy would open here');
        });

        document.getElementById('terms-service-btn').addEventListener('click', () => {
          showToast('Terms of Service would open here');
        });

        document.getElementById('help-support-btn').addEventListener('click', () => {
          showToast('Help & Support would open here');
        });

        // Chat page
        document.getElementById('back-to-matches').addEventListener('click', () => {
          navigateTo('matches-page');
          activeChat = null;
        });

        document.getElementById('chat-info-btn').addEventListener('click', () => {
          if (activeChat) {
            viewProfile(activeChat.profile);
          }
        });

        document.getElementById('chat-send-btn').addEventListener('click', () => {
          sendChatMessage();
        });

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendChatMessage();
          }
        });

        document.getElementById('chat-attachment-btn').addEventListener('click', () => {
          showToast('Attachments feature coming soon');
        });
      }

      // Navigate to a page
      function navigateTo(pageId) {
        const currentPage = document.querySelector('.page.active');
        const targetPage = document.getElementById(pageId);
        
        if (currentPage.id === pageId) return;
        
        if (currentPage) {
          currentPage.classList.remove('active');
        }
        
        targetPage.classList.add('active');
        
        // Update header title and actions
        updateHeader(pageId);
        
        // Update navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('text-primary');
          btn.classList.add('text-hint');
        });
        
        // Highlight active nav button
        const buttonId = 'nav-' + pageId.split('-')[0];
        document.getElementById(buttonId).classList.remove('text-hint');
        document.getElementById(buttonId).classList.add('text-primary');
        
        // Update Telegram back button
        updateBackButton(pageId);
        
        // Update navigation history
        appState.lastPage = appState.navigationHistory[appState.navigationHistory.length - 1];
        appState.navigationHistory.push(pageId);
        
        // Special handling for discover page
        if (pageId === 'discover-page' && !document.querySelector('.card')) {
          setupCardSwipe();
        }
        
        triggerHapticFeedback('medium');
      }

      // Update header based on current page
      function updateHeader(pageId) {
        const headerTitle = document.getElementById('header-title');
        const headerAction = document.getElementById('header-action');
        const headerFilter = document.getElementById('header-filter');
        
        // Hide action buttons by default
        headerAction.classList.add('hidden');
        headerFilter.classList.add('hidden');
        
        switch(pageId) {
          case 'home-page':
            headerTitle.textContent = 'Connect';
            break;
          case 'discover-page':
            headerTitle.textContent = activeCategory ? capitalizeFirstLetter(activeCategory) : 'Discover';
            headerFilter.classList.remove('hidden');
            break;
          case 'matches-page':
            headerTitle.textContent = 'Matches';
            break;
          case 'profile-page':
            headerTitle.textContent = 'Profile';
            headerAction.classList.remove('hidden');
            break;
          case 'chat-page':
            // Chat page has its own header
            break;
        }
      }

      // Update Telegram back button
      function updateBackButton(pageId) {
        if (!tgApp) return;
        
        if (pageId === 'home-page') {
          tgApp.BackButton.hide();
        } else {
          tgApp.BackButton.show();
        }
      }

      // Handle back navigation
      function handleBackNavigation() {
        // Pop current page from history
        appState.navigationHistory.pop();
        
        // Navigate to previous page
        const previousPage = appState.navigationHistory[appState.navigationHistory.length - 1] || 'home-page';
        navigateTo(previousPage);
      }

      // Show modal
      function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('active');
        triggerHapticFeedback('light');
      }

      // Hide modal
      function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('active');
        triggerHapticFeedback('light');
      }

      // Add a new interest to the user profile
      function addInterest() {
        const input = document.getElementById('new-interest');
        const interest = input.value.trim();
        
        if (!interest) return;
        
        // Check if interest already exists
        if (currentUserProfile.interests.includes(interest)) {
          showToast('Interest already added');
          input.value = '';
          return;
        }
        
        // Add interest to profile
        currentUserProfile.interests.push(interest);
        
        // Update UI
        updateUserProfileUI();
        
        // Clear input
        input.value = '';
        
        triggerHapticFeedback('light');
      }

      // Save profile changes
      function saveProfileChanges() {
        const nameInput = document.getElementById('edit-name');
        const ageInput = document.getElementById('edit-age');
        const bioInput = document.getElementById('edit-bio');
        
        // Get values
        const fullName = nameInput.value.trim();
        const nameParts = fullName.split(' ');
        const firstName = nameParts[0];
        const lastName = nameParts.slice(1).join(' ');
        
        const age = parseInt(ageInput.value);
        const bio = bioInput.value.trim();
        
        // Get looking for values
        const lookingFor = [];
        if (document.getElementById('looking-dating').checked) lookingFor.push('dating');
        if (document.getElementById('looking-friendship').checked) lookingFor.push('friendship');
        if (document.getElementById('looking-networking').checked) lookingFor.push('networking');
        
        // Validate inputs
        if (!firstName) {
          showToast('Please enter your name');
          return;
        }
        
        if (!age || age < 18) {
          showToast('Please enter a valid age (18+)');
          return;
        }
        
        if (lookingFor.length === 0) {
          showToast('Please select at least one connection type');
          return;
        }
        
        // Update profile
        currentUserProfile.name = firstName;
        currentUserProfile.lastName = lastName;
        currentUserProfile.age = age;
        currentUserProfile.bio = bio;
        currentUserProfile.lookingFor = lookingFor;
        
        // Update UI
        updateUserProfileUI();
        
        // Close modal
        hideModal('profile-edit-modal');
        
        // Show confirmation
        showToast('Profile updated successfully');
        
        triggerHapticFeedback('medium');
      }

      // Apply filters
      function applyFilters() {
        const minAge = parseInt(document.getElementById('min-age-filter').value);
        const maxAge = parseInt(document.getElementById('max-age-filter').value);
        const distance = parseInt(document.getElementById('distance-filter').value);
        
        // Get looking for values
        const lookingFor = [];
        if (document.getElementById('filter-dating').checked) lookingFor.push('dating');
        if (document.getElementById('filter-friendship').checked) lookingFor.push('friendship');
        if (document.getElementById('filter-networking').checked) lookingFor.push('networking');
        
        // Update filter
        currentFilter.minAge = minAge;
        currentFilter.maxAge = maxAge;
        currentFilter.distance = distance;
        currentFilter.lookingFor = lookingFor;
        
        // Reload profiles
        setupCardSwipe();
        
        // Show confirmation
        showToast('Filters applied');
        
        triggerHapticFeedback('medium');
      }

      // Reset filters
      function resetFilters() {
        // Reset filter values
        document.getElementById('min-age-filter').value = 18;
        document.getElementById('max-age-filter').value = 65;
        document.getElementById('distance-filter').value = 50;
        document.getElementById('filter-dating').checked = true;
        document.getElementById('filter-friendship').checked = true;
        document.getElementById('filter-networking').checked = true;
        
        // Update displays
        document.getElementById('min-age-display').textContent = '18';
        document.getElementById('max-age-display').textContent = '50+';
        document.getElementById('distance-display').textContent = '50+ km';
        
        // Reset filter object
        currentFilter = {
          minAge: 18,
          maxAge: 65,
          distance: 50,
          lookingFor: ['dating', 'friendship', 'networking'],
          interests: []
        };
        
        triggerHapticFeedback('light');
        showToast('Filters reset');
      }

      // Set up haptic feedback
      function setupHapticFeedback() {
        if (!tgApp || !tgApp.HapticFeedback) return;
        
        // Add haptic feedback to all buttons
        document.querySelectorAll('button:not(.nav-btn)').forEach(btn => {
          btn.addEventListener('click', () => {
            triggerHapticFeedback('light');
          });
        });
      }

      // Trigger haptic feedback
      function triggerHapticFeedback(type) {
        if (!tgApp || !tgApp.HapticFeedback) return;
        
        switch (type) {
          case 'light':
            tgApp.HapticFeedback.impactOccurred('light');
            break;
          case 'medium':
            tgApp.HapticFeedback.impactOccurred('medium');
            break;
          case 'heavy':
            tgApp.HapticFeedback.impactOccurred('heavy');
            break;
        }
      }

      // Show toast notification
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-20 left-0 right-0 mx-auto w-4/5 max-w-sm bg-section-bg text-text py-2 px-4 rounded-lg shadow-lg z-50 flex items-center opacity-0 transition-opacity';
        toast.style.textAlign = 'center';
        toast.innerHTML = message;
        
        document.body.appendChild(toast);
        
        // Fade in
        setTimeout(() => {
          toast.style.opacity = '1';
        }, 10);
        
        // Fade out and remove
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 2500);
      }

      // Generate avatar (for demo purposes)
      function generateAvatar(name, color = '#5D5CDE') {
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        
        // Background
        ctx.fillStyle = color;
        ctx.fillRect(0, 0, 200, 200);
        
        // Initials
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 80px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(initials, 100, 100);
        
        return canvas.toDataURL();
      }

      // Generate placeholder image for profile
      function generateImagePlaceholder(keyword) {
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 400;
        const ctx = canvas.getContext('2d');
        
        // Map keywords to colors and patterns
        const colorMap = {
          'hiking': ['#4CAF50', '#81C784'],
          'climbing': ['#FF9800', '#FFB74D'],
          'art': ['#9C27B0', '#CE93D8'],
          'basketball': ['#F44336', '#EF9A9A'],
          'cooking': ['#795548', '#A1887F']
        };
        
        const colors = colorMap[keyword] || ['#3F51B5', '#7986CB'];
        
        // Background gradient
        const gradient = ctx.createLinearGradient(0, 0, 400, 400);
        gradient.addColorStop(0, colors[0]);
        gradient.addColorStop(1, colors[1]);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 400);
        
        // Pattern
        if (keyword === 'hiking') {
          // Mountains
          ctx.fillStyle = '#2E7D32';
          ctx.beginPath();
          ctx.moveTo(0, 300);
          ctx.lineTo(150, 150);
          ctx.lineTo(250, 220);
          ctx.lineTo(400, 100);
          ctx.lineTo(400, 400);
          ctx.lineTo(0, 400);
          ctx.closePath();
          ctx.fill();
        } else if (keyword === 'climbing') {
          // Rocks
          ctx.fillStyle = '#E65100';
          for (let i = 0; i < 10; i++) {
            ctx.beginPath();
            ctx.moveTo(Math.random() * 400, Math.random() * 400);
            ctx.lineTo(Math.random() * 400, Math.random() * 400);
            ctx.lineTo(Math.random() * 400, Math.random() * 400);
            ctx.closePath();
            ctx.fill();
          }
        } else if (keyword === 'art') {
          // Abstract shapes
          for (let i = 0; i < 20; i++) {
            ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5})`;
            ctx.beginPath();
            ctx.arc(Math.random() * 400, Math.random() * 400, Math.random() * 50 + 10, 0, Math.PI * 2);
            ctx.fill();
          }
        } else if (keyword === 'basketball') {
          // Court lines
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(200, 200, 100, 0, Math.PI * 2);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(100, 100);
          ctx.lineTo(300, 100);
          ctx.lineTo(300, 300);
          ctx.lineTo(100, 300);
          ctx.closePath();
          ctx.stroke();
        } else if (keyword === 'cooking') {
          // Utensils
          ctx.fillStyle = '#ffffff';
          ctx.beginPath();
          ctx.arc(150, 150, 50, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillRect(200, 100, 100, 20);
          ctx.fillRect(240, 120, 20, 100);
        }
        
        return canvas.toDataURL();
      }

      // Format timestamp for chat/connections display
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) return 'Just now';
        if (diffMin < 60) return `${diffMin}m ago`;
        if (diffHour < 24) return `${diffHour}h ago`;
        if (diffDay < 7) return `${diffDay}d ago`;
        
        return date.toLocaleDateString();
      }

      // Format timestamp for chat messages
      function formatChatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Capitalize first letter of a string
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      // Shuffle array
      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      // Initialize the app
      initApp();
    });
  </script>
</body>
</html>
