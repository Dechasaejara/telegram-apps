<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haute Cuisine Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as a placeholder for a luxury font */
            overscroll-behavior: none; /* Prevents pull-to-refresh issues in webview */
        }
        /* Custom scrollbar for a more refined look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4b5fd; /* A muted, luxurious purple */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }
        .luxury-gradient-bg {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%); /* Deep indigo to royal blue */
        }
        .luxury-accent-bg {
            background-color: #facc15; /* Gold accent */
        }
        .luxury-accent-text {
            color: #facc15; /* Gold accent text */
        }
        .luxury-button {
            @apply px-6 py-3 rounded-lg shadow-md transition-all duration-300 ease-in-out text-white font-semibold;
            background: linear-gradient(135deg, #c5a059, #e6c270); /* Gold gradient */
            border: 1px solid #b08d4a;
        }
        .luxury-button:hover {
            @apply shadow-lg;
            filter: brightness(1.1);
        }
        .luxury-input {
            @apply w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-300 bg-white shadow-sm;
        }
        .luxury-card {
            @apply bg-white rounded-xl shadow-xl overflow-hidden transition-all duration-300 ease-in-out hover:shadow-2xl;
        }
        .badge {
            @apply px-3 py-1 text-xs font-semibold rounded-full;
        }
        .badge-gold {
            @apply bg-yellow-400 text-yellow-800;
        }
        .badge-silver {
            @apply bg-gray-300 text-gray-700;
        }
        .badge-bronze {
            @apply bg-orange-300 text-orange-700;
        }
        .tab {
            @apply px-4 py-2 cursor-pointer text-gray-600 hover:text-yellow-600 border-b-2 border-transparent hover:border-yellow-500 transition-all duration-300;
        }
        .tab.active {
            @apply text-yellow-600 border-yellow-500 font-semibold;
        }
        #map { height: 300px; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Custom modal styling */
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-11/12 max-w-lg transform transition-all duration-300 scale-95 opacity-0;
        }
        .modal.open .modal-content {
            @apply scale-100 opacity-100;
        }
        .modal.open {
            @apply opacity-100;
        }
        .close-button {
            @apply absolute top-4 right-4 text-gray-500 hover:text-red-600 transition-colors;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="min-h-screen">

        <div id="loading-screen" class="fixed inset-0 luxury-gradient-bg flex flex-col items-center justify-center z-[100]">
            <i class="fas fa-utensils fa-spin fa-3x text-yellow-400 mb-4"></i>
            <h1 class="text-3xl font-bold text-white">Haute Cuisine Finder</h1>
            <p class="text-yellow-300 mt-2">Discovering culinary excellence...</p>
        </div>

        <header id="app-header" class="luxury-gradient-bg text-white p-4 shadow-lg sticky top-0 z-40 hidden">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold tracking-tight">Haute Cuisine</h1>
                <div class="flex items-center space-x-3">
                    <button id="user-profile-btn" class="focus:outline-none">
                        <i class="fas fa-user-circle fa-2x hover:text-yellow-300 transition-colors"></i>
                    </button>
                    <button id="manage-business-nav-btn" class="text-sm luxury-accent-text hover:underline">Manage My Business</button>
                </div>
            </div>
        </header>

        <main id="screens-container" class="container mx-auto p-4 pb-20">
            <div id="home-screen" class="screen hidden">
                <div class="mb-6 p-4 bg-white rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Find Your Next Exquisite Meal</h2>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="search-query" placeholder="Search by name, cuisine..." class="luxury-input flex-grow">
                        <button id="filter-btn" class="p-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>

                <div id="map" class="mb-6"></div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Categories</h3>
                    <div id="category-tabs" class="flex space-x-1 sm:space-x-2 overflow-x-auto pb-2">
                        </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Nearby Establishments</h3>
                    <div id="business-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                    <p id="no-results-message" class="text-center text-gray-500 mt-8 hidden">No establishments found matching your criteria.</p>
                </div>
            </div>

            <div id="business-detail-screen" class="screen hidden">
                <button class="back-to-home mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to List</button>
                <div class="luxury-card p-6">
                    <img id="business-detail-img" src="https://placehold.co/600x300/e2e8f0/333333?text=Restaurant+Image" alt="Business Image" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
                    <h2 id="business-detail-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                    <p id="business-detail-cuisine" class="text-yellow-600 font-semibold mb-1"></p>
                    <p id="business-detail-address" class="text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-2 text-yellow-500"></i></p>
                    <div class="flex items-center mb-3">
                        <div id="business-detail-rating" class="text-yellow-500 mr-2">
                            </div>
                        <span id="business-detail-review-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="business-detail-badges" class="flex space-x-2 mb-4">
                        </div>
                    <p id="business-detail-description" class="text-gray-700 mb-6"></p>

                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Menu Highlights</h3>
                    <div id="business-detail-menu-list" class="space-y-3">
                        </div>
                    <button id="view-full-menu-btn" class="mt-4 luxury-button w-full">View Full Menu</button>

                    <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-3">Reviews</h3>
                    <div id="business-detail-reviews" class="space-y-4">
                        </div>
                    <button id="add-review-btn" data-business-id="" class="mt-6 luxury-button w-full"><i class="fas fa-plus mr-2"></i>Add Your Review</button>
                </div>
            </div>

            <div id="menu-item-detail-screen" class="screen hidden">
                <button class="back-to-business-detail mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Menu</button>
                <div class="luxury-card p-6">
                    <img id="menu-item-detail-img" src="https://placehold.co/400x300/e2e8f0/333333?text=Dish+Image" alt="Menu Item Image" class="w-full h-40 object-cover rounded-lg mb-4 shadow-md">
                    <h2 id="menu-item-detail-name" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                    <p id="menu-item-detail-price" class="text-xl text-yellow-600 font-semibold mb-3"></p>
                    <p id="menu-item-detail-description" class="text-gray-700 mb-4"></p>
                    <div class="flex items-center mb-3">
                        <div id="menu-item-detail-rating" class="text-yellow-500 mr-2">
                            </div>
                        <span id="menu-item-detail-review-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="menu-item-detail-badges" class="flex space-x-2 mb-4">
                        </div>
                    </div>
            </div>

            <div id="add-edit-business-screen" class="screen hidden">
                <button class="back-to-manage-business mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to My Businesses</button>
                <h2 id="business-form-title" class="text-2xl font-bold text-gray-800 mb-6">Manage Your Business</h2>
                <form id="business-form" class="space-y-6 bg-white p-8 rounded-lg shadow-xl">
                    <input type="hidden" id="business-form-id">
                    <div>
                        <label for="business-name" class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                        <input type="text" id="business-name" class="luxury-input" required>
                    </div>
                    <div>
                        <label for="business-cuisine" class="block text-sm font-medium text-gray-700 mb-1">Cuisine Type (e.g., Italian, Fine Dining)</label>
                        <input type="text" id="business-cuisine" class="luxury-input" required>
                    </div>
                    <div>
                        <label for="business-address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input type="text" id="business-address" class="luxury-input" required>
                    </div>
                    <div>
                        <label for="business-latitude" class="block text-sm font-medium text-gray-700 mb-1">Latitude (auto-filled if possible)</label>
                        <input type="text" id="business-latitude" class="luxury-input" placeholder="e.g., 40.7128">
                    </div>
                    <div>
                        <label for="business-longitude" class="block text-sm font-medium text-gray-700 mb-1">Longitude (auto-filled if possible)</label>
                        <input type="text" id="business-longitude" class="luxury-input" placeholder="e.g., -74.0060">
                    </div>
                    <div>
                        <label for="business-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="business-description" rows="4" class="luxury-input"></textarea>
                    </div>
                    <div>
                        <label for="business-image-url" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                        <input type="url" id="business-image-url" class="luxury-input" placeholder="https://example.com/image.jpg">
                    </div>
                    <div>
                        <label for="business-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="business-category" class="luxury-input">
                            <option value="fine-dining">Fine Dining</option>
                            <option value="casual-dining">Casual Dining</option>
                            <option value="cafe">Café</option>
                            <option value="bistro">Bistro</option>
                            <option value="specialty">Specialty Food</option>
                        </select>
                    </div>
                    <button type="submit" class="luxury-button w-full">Save Business Details</button>
                </form>
            </div>

            <div id="manage-my-business-screen" class="screen hidden">
                <button class="back-to-home mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Finder</button>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">My Establishments</h2>
                    <button id="add-new-business-btn" class="luxury-button"><i class="fas fa-plus mr-2"></i>Add New Business</button>
                </div>
                <div id="my-business-list" class="space-y-4">
                    <!-- Example:
                    <div class="luxury-card p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">My Restaurant Name</h3>
                            <p class="text-sm text-gray-500">123 Main St</p>
                        </div>
                        <div class="space-x-2">
                            <button class="text-blue-500 hover:underline edit-my-business-btn" data-business-id="1">Edit Info</button>
                            <button class="text-green-500 hover:underline manage-my-menu-btn" data-business-id="1">Manage Menu</button>
                            <button class="text-red-500 hover:underline delete-my-business-btn" data-business-id="1">Delete</button>
                        </div>
                    </div>
                    -->
                </div>
                <p id="no-my-businesses-message" class="text-center text-gray-500 mt-8 hidden">You haven't added any businesses yet.</p>
            </div>

            <div id="manage-menu-screen" class="screen hidden">
                <button class="back-to-manage-business-overview mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to My Businesses</button>
                <div class="flex justify-between items-center mb-6">
                    <h2 id="manage-menu-business-name" class="text-2xl font-bold text-gray-800">Manage Menu for [Business Name]</h2>
                    <button id="add-new-menu-item-btn" class="luxury-button"><i class="fas fa-plus mr-2"></i>Add Menu Item</button>
                </div>
                <div id="menu-item-list-management" class="space-y-4">
                    </div>
                <p id="no-menu-items-message" class="text-center text-gray-500 mt-8 hidden">This menu is currently empty.</p>
            </div>

            <div id="add-edit-menu-item-screen" class="screen hidden">
                <button class="back-to-manage-menu mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Menu Management</button>
                <h2 id="menu-item-form-title" class="text-2xl font-bold text-gray-800 mb-6">Add/Edit Menu Item</h2>
                <form id="menu-item-form" class="space-y-6 bg-white p-8 rounded-lg shadow-xl">
                    <input type="hidden" id="menu-item-form-id">
                    <input type="hidden" id="menu-item-form-business-id">
                    <div>
                        <label for="menu-item-name" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                        <input type="text" id="menu-item-name" class="luxury-input" required>
                    </div>
                    <div>
                        <label for="menu-item-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="menu-item-description" rows="3" class="luxury-input"></textarea>
                    </div>
                    <div>
                        <label for="menu-item-price" class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                        <input type="number" id="menu-item-price" step="0.01" class="luxury-input" required>
                    </div>
                    <div>
                        <label for="menu-item-category" class="block text-sm font-medium text-gray-700 mb-1">Category (e.g., Appetizer, Main Course)</label>
                        <input type="text" id="menu-item-category" class="luxury-input">
                    </div>
                    <div>
                        <label for="menu-item-image-url" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                        <input type="url" id="menu-item-image-url" class="luxury-input" placeholder="https://example.com/dish.jpg">
                    </div>
                    <button type="submit" class="luxury-button w-full">Save Menu Item</button>
                </form>
            </div>

            <div id="submit-review-screen" class="screen hidden">
                <button class="back-to-business-from-review mb-4 text-yellow-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Business</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Submit Your Review for <span id="review-business-name" class="text-yellow-600"></span></h2>
                <form id="review-form" class="space-y-6 bg-white p-8 rounded-lg shadow-xl">
                    <input type="hidden" id="review-form-business-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Your Rating</label>
                        <div id="review-stars" class="flex space-x-1 text-3xl text-gray-300">
                            <i class="fas fa-star cursor-pointer" data-value="1"></i>
                            <i class="fas fa-star cursor-pointer" data-value="2"></i>
                            <i class="fas fa-star cursor-pointer" data-value="3"></i>
                            <i class="fas fa-star cursor-pointer" data-value="4"></i>
                            <i class="fas fa-star cursor-pointer" data-value="5"></i>
                        </div>
                        <input type="hidden" id="review-rating-value" required>
                    </div>
                    <div>
                        <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-1">Your Comments</label>
                        <textarea id="review-comment" rows="4" class="luxury-input" placeholder="Share your experience..."></textarea>
                    </div>
                    <button type="submit" class="luxury-button w-full">Submit Review</button>
                </form>
            </div>

        </main>

        <div id="filter-modal" class="modal opacity-0 pointer-events-none">
            <div class="modal-content">
                <button id="close-filter-modal-btn" class="close-button"><i class="fas fa-times fa-lg"></i></button>
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Filter Options</h3>
                <div class="space-y-6">
                    <div>
                        <label for="filter-rating" class="block text-sm font-medium text-gray-700 mb-1">Minimum Rating</label>
                        <select id="filter-rating" class="luxury-input">
                            <option value="0">Any</option>
                            <option value="1">1 Star & Up</option>
                            <option value="2">2 Stars & Up</option>
                            <option value="3">3 Stars & Up</option>
                            <option value="4">4 Stars & Up</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-price" class="block text-sm font-medium text-gray-700 mb-1">Price Range</label>
                        <select id="filter-price" class="luxury-input">
                            <option value="any">Any</option>
                            <option value="budget">$ (Budget)</option>
                            <option value="mid">$$ (Mid-range)</option>
                            <option value="premium">$$$ (Premium)</option>
                            <option value="luxury">$$$$ (Luxury)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Badges</label>
                        <div id="filter-badges" class="space-y-2">
                            <label class="flex items-center space-x-2"><input type="checkbox" value="top-rated" class="form-checkbox rounded text-yellow-500"><span>Top Rated</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" value="community-favorite" class="form-checkbox rounded text-yellow-500"><span>Community Favorite</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" value="new-gem" class="form-checkbox rounded text-yellow-500"><span>New Gem</span></label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button id="reset-filters-btn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition">Reset</button>
                    <button id="apply-filters-btn" class="luxury-button">Apply Filters</button>
                </div>
            </div>
        </div>

        <div id="message-modal" class="modal opacity-0 pointer-events-none">
            <div class="modal-content max-w-sm text-center">
                <button id="close-message-modal-btn" class="close-button"><i class="fas fa-times fa-lg"></i></button>
                <div id="message-modal-icon" class="text-4xl mb-4"></div>
                <h3 id="message-modal-title" class="text-xl font-semibold text-gray-800 mb-2"></h3>
                <p id="message-modal-text" class="text-gray-600 mb-6"></p>
                <button id="message-modal-ok-btn" class="luxury-button w-full">OK</button>
            </div>
        </div>

    </div>

    <script>
        // --- Telegram Mini App Initialization ---
        const tg = window.Telegram.WebApp;
        tg.ready(); // Inform Telegram that the app is ready
        tg.expand(); // Expand the webview to full height

        // --- Global State & Mock Data ---
        let map;
        let userLocation = null; // { lat: ..., lng: ... }
        let currentScreen = 'loading-screen';
        let currentBusinessId = null; // For detail views
        let currentMenuItemId = null; // For menu item detail/edit
        let currentManagingBusinessId = null; // For managing a specific business's menu

        // Mock data (replace with API calls)
        let mockBusinesses = [
            { id: 'b1', name: 'The Gilded Spoon', cuisine: 'Modern European, Fine Dining', address: '123 Elegance Ave, Gourmet City', lat: 9.02195, lng: 38.75771, rating: 4.8, reviewCount: 150, description: 'An exquisite dining experience with a focus on seasonal ingredients and artistic presentation. Perfect for special occasions.', imageUrl: 'https://placehold.co/600x300/d1c4e9/4527a0?text=The+Gilded+Spoon', category: 'fine-dining', priceRange: '$$$$', badges: ['top-rated', 'luxury-pick'] },
            { id: 'b2', name: 'Bella Vista Trattoria', cuisine: 'Authentic Italian', address: '45 Market Plaza, Gourmet City', lat: 9.02500, lng: 38.76000, rating: 4.5, reviewCount: 230, description: 'Classic Italian dishes served in a warm, inviting atmosphere. Features a curated wine list.', imageUrl: 'https://placehold.co/600x300/ffcc80/e65100?text=Bella+Vista', category: 'casual-dining', priceRange: '$$$', badges: ['community-favorite'] },
            { id: 'b3', name: 'Zen Garden Sushi', cuisine: 'Japanese, Sushi', address: '78 Serenity Blvd, Gourmet City', lat: 9.01980, lng: 38.75120, rating: 4.6, reviewCount: 180, description: 'Masterfully crafted sushi and sashimi using the freshest seafood. Tranquil ambiance.', imageUrl: 'https://placehold.co/600x300/a5d6a7/2e7d32?text=Zen+Garden', category: 'specialty', priceRange: '$$$', badges: ['new-gem'] },
            { id: 'b4', name: 'Le Petit Café', cuisine: 'French Patisserie, Coffee', address: '90 Artisan Alley, Gourmet City', lat: 9.02880, lng: 38.76550, rating: 4.3, reviewCount: 95, description: 'Charming café offering delightful pastries, artisanal coffee, and light lunches.', imageUrl: 'https://placehold.co/600x300/f8bbd0/c2185b?text=Le+Petit+Café', category: 'cafe', priceRange: '$$', badges: [] },
        ];

        let mockMenus = {
            'b1': [
                { id: 'm1-1', name: 'Seared Scallops with Saffron Risotto', description: 'Pan-seared jumbo scallops served on a bed of creamy saffron risotto.', price: 32.00, category: 'Main Course', imageUrl: 'https://placehold.co/200x150/e1bee7/6a1b9a?text=Scallops', rating: 4.9, reviewCount: 25, badges: ['chef-special'] },
                { id: 'm1-2', name: 'Filet Mignon with Truffle Jus', description: 'Prime cut filet mignon, perfectly cooked, with a rich truffle reduction.', price: 45.00, category: 'Main Course', imageUrl: 'https://placehold.co/200x150/d7ccc8/4e342e?text=Filet+Mignon', rating: 4.7, reviewCount: 30, badges: [] },
                { id: 'm1-3', name: 'Lavender Crème brûlée', description: 'Classic crème brûlée infused with a hint of lavender.', price: 15.00, category: 'Dessert', imageUrl: 'https://placehold.co/200x150/fff9c4/f57f17?text=Crème+Brûlée', rating: 4.8, reviewCount: 18, badges: [] },
            ],
            'b2': [
                { id: 'm2-1', name: 'Margherita Pizza Classica', description: 'Traditional Neapolitan pizza with San Marzano tomatoes, fresh mozzarella, and basil.', price: 18.00, category: 'Pizza', imageUrl: 'https://placehold.co/200x150/ffcdd2/c62828?text=Margherita', rating: 4.6, reviewCount: 50, badges: ['best-seller'] },
                { id: 'm2-2', name: 'Lasagna Bolognese', description: 'Layers of fresh pasta, rich meat sauce, béchamel, and Parmesan cheese.', price: 22.00, category: 'Pasta', imageUrl: 'https://placehold.co/200x150/ffecb3/ff8f00?text=Lasagna', rating: 4.7, reviewCount: 40, badges: [] },
            ],
            // Add more menus for b3, b4 if needed
        };

        let mockReviews = {
            'b1': [
                { id: 'r1-1', userName: 'Alice Wonderland', rating: 5, comment: 'Absolutely divine! Every dish was a work of art. The service was impeccable.' },
                { id: 'r1-2', userName: 'Bob The Foodie', rating: 4, comment: 'A fantastic experience, though a bit pricey. The scallops were cooked to perfection.' },
            ],
            'b2': [
                { id: 'r2-1', userName: 'Charlie Brown', rating: 5, comment: 'Best Italian food in town! The lasagna reminds me of my nonna\'s cooking.' },
            ],
        };

        const categories = [
            { id: 'all', name: 'All', icon: 'fa-utensils' },
            { id: 'fine-dining', name: 'Fine Dining', icon: 'fa-tie' },
            { id: 'casual-dining', name: 'Casual Dining', icon: 'fa-hamburger' },
            { id: 'cafe', name: 'Cafés', icon: 'fa-coffee' },
            { id: 'specialty', name: 'Specialty', icon: 'fa-star' }, // e.g. sushi, bakery
            { id: 'fast-food', name: 'Quick Bites', icon: 'fa-bolt' }
        ];
        let activeCategory = 'all';
        let currentFilters = { rating: 0, price: 'any', badges: [] };

        // --- UI Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const appHeader = document.getElementById('app-header');
        const screens = {
            home: document.getElementById('home-screen'),
            businessDetail: document.getElementById('business-detail-screen'),
            menuItemDetail: document.getElementById('menu-item-detail-screen'),
            addEditBusiness: document.getElementById('add-edit-business-screen'),
            manageMyBusiness: document.getElementById('manage-my-business-screen'),
            manageMenu: document.getElementById('manage-menu-screen'),
            addEditMenuItem: document.getElementById('add-edit-menu-item-screen'),
            submitReview: document.getElementById('submit-review-screen'),
        };
        const businessListEl = document.getElementById('business-list');
        const categoryTabsEl = document.getElementById('category-tabs');
        const filterModal = document.getElementById('filter-modal');
        const messageModal = document.getElementById('message-modal');

        // --- Navigation ---
        function navigateTo(screenName, params = {}) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                currentScreen = screenName;
                window.scrollTo(0, 0); // Scroll to top on navigation

                // Handle specific screen setups
                if (screenName === 'businessDetail' && params.businessId) {
                    currentBusinessId = params.businessId;
                    renderBusinessDetail(params.businessId);
                } else if (screenName === 'addEditBusiness') {
                    setupBusinessForm(params.businessId); // businessId can be null for new
                } else if (screenName === 'manageMyBusiness') {
                    renderMyBusinessList();
                } else if (screenName === 'manageMenu' && params.businessId) {
                    currentManagingBusinessId = params.businessId;
                    renderMenuManagement(params.businessId);
                } else if (screenName === 'addEditMenuItem' && params.businessId) {
                    currentManagingBusinessId = params.businessId; // Keep track of parent business
                    setupMenuItemForm(params.menuItemId, params.businessId);
                } else if (screenName === 'submitReview' && params.businessId) {
                    currentBusinessId = params.businessId;
                    setupReviewForm(params.businessId);
                } else if (screenName === 'menuItemDetail' && params.menuItemId && params.businessId) {
                    currentBusinessId = params.businessId; // To go back
                    currentMenuItemId = params.menuItemId;
                    renderMenuItemDetail(params.menuItemId, params.businessId);
                }


            } else {
                console.error(`Screen "${screenName}" not found.`);
                screens.home.classList.remove('hidden'); // Fallback to home
                currentScreen = 'home';
            }
            tg.MainButton.hide(); // Hide main button by default, show contextually
        }

        // --- Rendering Functions ---
        function renderStarRating(rating, containerIdOrElement, interactive = false, sizeClass = 'text-xl') {
            const container = typeof containerIdOrElement === 'string' ? document.getElementById(containerIdOrElement) : containerIdOrElement;
            if (!container) return;
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.classList.add('fas', 'fa-star', sizeClass);
                if (i <= rating) {
                    star.classList.add('text-yellow-500');
                } else {
                    star.classList.add('text-gray-300');
                }
                if (interactive) {
                    star.classList.add('cursor-pointer');
                    star.dataset.value = i;
                }
                container.appendChild(star);
            }
        }

        function renderBadges(badgesArray, containerElement) {
            containerElement.innerHTML = '';
            if (!badgesArray || badgesArray.length === 0) return;

            const badgeStyles = {
                'top-rated': 'badge-gold',
                'community-favorite': 'badge-silver',
                'new-gem': 'badge-bronze',
                'luxury-pick': 'bg-purple-500 text-white',
                'chef-special': 'bg-red-500 text-white',
                'best-seller': 'bg-green-500 text-white'
            };

            badgesArray.forEach(badgeText => {
                const badgeEl = document.createElement('span');
                badgeEl.className = `badge ${badgeStyles[badgeText] || 'bg-gray-200 text-gray-800'}`;
                badgeEl.textContent = badgeText.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                containerElement.appendChild(badgeEl);
            });
        }

        function renderCategories() {
            categoryTabsEl.innerHTML = '';
            categories.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = `tab flex-shrink-0 ${cat.id === activeCategory ? 'active' : ''}`;
                tab.innerHTML = `<i class="fas ${cat.icon} mr-1 sm:mr-2"></i>${cat.name}`;
                tab.dataset.categoryId = cat.id;
                tab.addEventListener('click', () => {
                    activeCategory = cat.id;
                    renderCategories(); // Re-render to update active state
                    filterAndRenderBusinesses();
                });
                categoryTabsEl.appendChild(tab);
            });
        }

        function filterAndRenderBusinesses() {
            let filtered = mockBusinesses;

            // Category filter
            if (activeCategory !== 'all') {
                filtered = filtered.filter(b => b.category === activeCategory);
            }

            // Search query filter
            const query = document.getElementById('search-query').value.toLowerCase();
            if (query) {
                filtered = filtered.filter(b =>
                    b.name.toLowerCase().includes(query) ||
                    b.cuisine.toLowerCase().includes(query) ||
                    b.description.toLowerCase().includes(query)
                );
            }

            // Advanced filters (rating, price, badges)
            if (currentFilters.rating > 0) {
                filtered = filtered.filter(b => b.rating >= currentFilters.rating);
            }
            if (currentFilters.price !== 'any') {
                filtered = filtered.filter(b => b.priceRange === currentFilters.price);
            }
            if (currentFilters.badges.length > 0) {
                filtered = filtered.filter(b =>
                    currentFilters.badges.every(fb => b.badges.includes(fb))
                );
            }


            renderBusinessList(filtered);
        }


        function renderBusinessList(businessesToRender = mockBusinesses) {
            businessListEl.innerHTML = '';
            const noResultsMsg = document.getElementById('no-results-message');

            if (businessesToRender.length === 0) {
                noResultsMsg.classList.remove('hidden');
                return;
            }
            noResultsMsg.classList.add('hidden');

            businessesToRender.forEach(business => {
                const card = document.createElement('div');
                card.className = 'luxury-card cursor-pointer';
                card.dataset.businessId = business.id;
                card.innerHTML = `
                    <img src="${business.imageUrl || 'https://placehold.co/400x200/e2e8f0/333333?text=Restaurant'}" alt="${business.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h4 class="text-xl font-semibold text-gray-800 mb-1 truncate">${business.name}</h4>
                        <p class="text-sm text-yellow-600 mb-2 truncate">${business.cuisine}</p>
                        <div class="flex items-center text-sm mb-2">
                            <div class="stars-container text-yellow-500 mr-2"></div>
                            <span class="text-gray-500">(${business.reviewCount} reviews)</span>
                        </div>
                        <div class="badges-container flex space-x-1 mb-3"></div>
                        <p class="text-xs text-gray-500 truncate"><i class="fas fa-map-marker-alt mr-1 text-yellow-500"></i>${business.address}</p>
                    </div>
                `;
                renderStarRating(business.rating, card.querySelector('.stars-container'), false, 'text-base');
                renderBadges(business.badges, card.querySelector('.badges-container'));

                card.addEventListener('click', () => navigateTo('businessDetail', { businessId: business.id }));
                businessListEl.appendChild(card);
            });
            updateMapMarkers(businessesToRender);
        }

        function renderBusinessDetail(businessId) {
            const business = mockBusinesses.find(b => b.id === businessId);
            if (!business) {
                showModalMessage("Error", "Business not found.", "error");
                navigateTo('home');
                return;
            }

            document.getElementById('business-detail-img').src = business.imageUrl || 'https://placehold.co/600x300/e2e8f0/333333?text=Restaurant+Image';
            document.getElementById('business-detail-name').textContent = business.name;
            document.getElementById('business-detail-cuisine').textContent = business.cuisine;
            document.getElementById('business-detail-address').innerHTML = `<i class="fas fa-map-marker-alt mr-2 text-yellow-500"></i>${business.address}`;
            renderStarRating(business.rating, document.getElementById('business-detail-rating'));
            document.getElementById('business-detail-review-count').textContent = `(${business.reviewCount} reviews)`;
            renderBadges(business.badges, document.getElementById('business-detail-badges'));
            document.getElementById('business-detail-description').textContent = business.description;

            // Render menu highlights (e.g., first 3 items)
            const menuListEl = document.getElementById('business-detail-menu-list');
            menuListEl.innerHTML = '';
            const businessMenu = mockMenus[businessId] || [];
            businessMenu.slice(0, 3).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-50 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100';
                itemEl.innerHTML = `
                    <div>
                        <h5 class="font-semibold text-gray-700">${item.name}</h5>
                        <p class="text-sm text-gray-500">${item.description.substring(0,50)}...</p>
                    </div>
                    <span class="font-semibold text-yellow-600">$${item.price.toFixed(2)}</span>
                `;
                itemEl.addEventListener('click', () => navigateTo('menuItemDetail', { menuItemId: item.id, businessId: business.id }));
                menuListEl.appendChild(itemEl);
            });
            if (businessMenu.length === 0) {
                menuListEl.innerHTML = '<p class="text-gray-500">Menu not available yet.</p>';
            }

            document.getElementById('view-full-menu-btn').onclick = () => {
                // For now, this can lead to a dedicated menu management screen or expand inline
                // For simplicity, we'll just log. A full menu screen would be similar to manageMenuScreen but read-only.
                console.log("View Full Menu for", businessId);
                // Potentially navigateTo('fullMenuScreen', { businessId });
                showModalMessage("Info", "Full menu view is a premium feature coming soon!", "info");
            };


            // Render reviews
            const reviewsEl = document.getElementById('business-detail-reviews');
            reviewsEl.innerHTML = '';
            const businessReviews = mockReviews[businessId] || [];
            if (businessReviews.length > 0) {
                businessReviews.forEach(review => {
                    const reviewEl = document.createElement('div');
                    reviewEl.className = 'p-3 border-t border-gray-200';
                    reviewEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="font-semibold text-gray-700">${review.userName}</h5>
                            <div class="review-stars-container text-yellow-500"></div>
                        </div>
                        <p class="text-sm text-gray-600">${review.comment}</p>
                    `;
                    renderStarRating(review.rating, reviewEl.querySelector('.review-stars-container'), false, 'text-sm');
                    reviewsEl.appendChild(reviewEl);
                });
            } else {
                reviewsEl.innerHTML = '<p class="text-gray-500">No reviews yet. Be the first!</p>';
            }
            document.getElementById('add-review-btn').dataset.businessId = businessId;
        }

        function renderMenuItemDetail(menuItemId, businessId) {
            const businessMenu = mockMenus[businessId];
            if (!businessMenu) {
                showModalMessage("Error", "Menu not found for this business.", "error");
                navigateTo('businessDetail', { businessId });
                return;
            }
            const menuItem = businessMenu.find(item => item.id === menuItemId);
            if (!menuItem) {
                showModalMessage("Error", "Menu item not found.", "error");
                navigateTo('businessDetail', { businessId });
                return;
            }

            document.getElementById('menu-item-detail-img').src = menuItem.imageUrl || 'https://placehold.co/400x300/e2e8f0/333333?text=Dish+Image';
            document.getElementById('menu-item-detail-name').textContent = menuItem.name;
            document.getElementById('menu-item-detail-price').textContent = `$${menuItem.price.toFixed(2)}`;
            document.getElementById('menu-item-detail-description').textContent = menuItem.description;
            renderStarRating(menuItem.rating || 0, document.getElementById('menu-item-detail-rating'));
            document.getElementById('menu-item-detail-review-count').textContent = `(${(menuItem.reviewCount || 0)} reviews)`;
            renderBadges(menuItem.badges || [], document.getElementById('menu-item-detail-badges'));

            document.querySelector('#menu-item-detail-screen .back-to-business-detail').onclick = () => navigateTo('businessDetail', { businessId });
        }


        // --- Map Functionality (Leaflet) ---
        function initMap(lat, lng) {
            if (map) map.remove(); // Remove existing map if any
            map = L.map('map').setView([lat, lng], 14); // Higher zoom for city level
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
            }).addTo(map);

            // User marker
            L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-user-marker',
                    html: '<i class="fas fa-map-pin fa-2x text-red-500"></i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map).bindPopup("Your Location").openPopup();

            updateMapMarkers(mockBusinesses); // Initial marker population
        }

        let businessMarkers = [];
        function updateMapMarkers(businesses) {
            if (!map) return;
            // Clear existing business markers
            businessMarkers.forEach(marker => map.removeLayer(marker));
            businessMarkers = [];

            businesses.forEach(business => {
                if (business.lat && business.lng) {
                    const marker = L.marker([business.lat, business.lng], {
                        icon: L.divIcon({
                            className: 'custom-business-marker',
                            html: `<div class="p-1 bg-yellow-500 rounded-full shadow"><i class="fas fa-utensils text-white"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(map)
                        .bindPopup(`<b>${business.name}</b><br>${business.cuisine}<br><button class="view-details-map-btn" data-id="${business.id}">View Details</button>`);
                    businessMarkers.push(marker);
                }
            });
            // Add event listener for dynamically created buttons in popups
            map.on('popupopen', function(e) {
                const viewDetailsBtn = e.popup._container.querySelector('.view-details-map-btn');
                if (viewDetailsBtn) {
                    viewDetailsBtn.onclick = function() {
                        navigateTo('businessDetail', { businessId: this.dataset.id });
                    };
                }
            });
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    // For Addis Ababa testing:
                    // userLocation = { lat: 9.02497, lng: 38.74689 };
                    initMap(userLocation.lat, userLocation.lng);
                    filterAndRenderBusinesses(); // Render businesses based on default location
                    setTimeout(() => { // Simulate loading
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => loadingScreen.classList.add('hidden'), 300);
                        appHeader.classList.remove('hidden');
                        navigateTo('home');
                    }, 1500);
                }, error => {
                    console.error("Error getting location: ", error);
                    // Fallback to a default location (e.g., city center)
                    userLocation = { lat: 9.02497, lng: 38.74689 }; // Addis Ababa default
                    initMap(userLocation.lat, userLocation.lng);
                    filterAndRenderBusinesses();
                    showModalMessage("Location Error", "Could not get your location. Showing results for a default area.", "warning");
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => loadingScreen.classList.add('hidden'), 300);
                        appHeader.classList.remove('hidden');
                        navigateTo('home');
                    }, 1500);
                }, { enableHighAccuracy: true });
            } else {
                console.error("Geolocation is not supported by this browser.");
                userLocation = { lat: 9.02497, lng: 38.74689 }; // Addis Ababa default
                initMap(userLocation.lat, userLocation.lng);
                filterAndRenderBusinesses();
                showModalMessage("Location Error", "Geolocation is not supported. Showing results for a default area.", "warning");
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => loadingScreen.classList.add('hidden'), 300);
                    appHeader.classList.remove('hidden');
                    navigateTo('home');
                }, 1500);
            }
        }

        // --- CRUD Operations (Simulated) ---
        // Business CRUD
        function setupBusinessForm(businessId = null) {
            const form = document.getElementById('business-form');
            const titleEl = document.getElementById('business-form-title');
            form.reset();
            document.getElementById('business-form-id').value = '';

            if (businessId) {
                const business = mockBusinesses.find(b => b.id === businessId);
                if (business) {
                    titleEl.textContent = `Edit ${business.name}`;
                    document.getElementById('business-form-id').value = business.id;
                    document.getElementById('business-name').value = business.name;
                    document.getElementById('business-cuisine').value = business.cuisine;
                    document.getElementById('business-address').value = business.address;
                    document.getElementById('business-latitude').value = business.lat || '';
                    document.getElementById('business-longitude').value = business.lng || '';
                    document.getElementById('business-description').value = business.description;
                    document.getElementById('business-image-url').value = business.imageUrl || '';
                    document.getElementById('business-category').value = business.category || 'casual-dining';
                }
            } else {
                titleEl.textContent = 'Add New Business';
            }
        }

        document.getElementById('business-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('business-form-id').value;
            const businessData = {
                name: document.getElementById('business-name').value,
                cuisine: document.getElementById('business-cuisine').value,
                address: document.getElementById('business-address').value,
                lat: parseFloat(document.getElementById('business-latitude').value) || null,
                lng: parseFloat(document.getElementById('business-longitude').value) || null,
                description: document.getElementById('business-description').value,
                imageUrl: document.getElementById('business-image-url').value,
                category: document.getElementById('business-category').value,
                rating: id ? mockBusinesses.find(b=>b.id===id).rating : (Math.random() * 2 + 3).toFixed(1), // Keep existing or random for new
                reviewCount: id ? mockBusinesses.find(b=>b.id===id).reviewCount : Math.floor(Math.random() * 50),
                badges: id ? mockBusinesses.find(b=>b.id===id).badges : [], // Keep existing or empty for new
                priceRange: '$$$' // Default price range for new
            };

            // TODO: API call to save/update business (Drizzle ORM/SQLite on backend)
            if (id) { // Update
                const index = mockBusinesses.findIndex(b => b.id === id);
                if (index !== -1) {
                    mockBusinesses[index] = { ...mockBusinesses[index], ...businessData };
                    showModalMessage("Success", `${businessData.name} updated successfully.`, "success");
                }
            } else { // Create
                businessData.id = 'b' + (mockBusinesses.length + 1) + Date.now(); // Simple unique ID
                mockBusinesses.push(businessData);
                if (!mockMenus[businessData.id]) mockMenus[businessData.id] = []; // Initialize menu for new business
                showModalMessage("Success", `${businessData.name} added successfully.`, "success");
            }
            console.log('Saved Business:', businessData);
            navigateTo('manageMyBusiness');
        });

        function renderMyBusinessList() {
            const listEl = document.getElementById('my-business-list');
            const noResultsMsg = document.getElementById('no-my-businesses-message');
            listEl.innerHTML = '';

            // For now, assume all mock businesses are "mine". In reality, filter by owner ID.
            const myBusinesses = mockBusinesses; // Replace with actual owned businesses

            if (myBusinesses.length === 0) {
                noResultsMsg.classList.remove('hidden');
                return;
            }
            noResultsMsg.classList.add('hidden');

            myBusinesses.forEach(business => {
                const itemEl = document.createElement('div');
                itemEl.className = 'luxury-card p-4 flex flex-col sm:flex-row justify-between sm:items-center space-y-3 sm:space-y-0';
                itemEl.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${business.name}</h3>
                        <p class="text-sm text-gray-500">${business.address}</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="text-sm py-1 px-3 rounded bg-blue-500 text-white hover:bg-blue-600 edit-my-business-btn" data-business-id="${business.id}"><i class="fas fa-edit mr-1"></i>Edit Info</button>
                        <button class="text-sm py-1 px-3 rounded bg-green-500 text-white hover:bg-green-600 manage-my-menu-btn" data-business-id="${business.id}"><i class="fas fa-list-alt mr-1"></i>Manage Menu</button>
                        <button class="text-sm py-1 px-3 rounded bg-red-500 text-white hover:bg-red-600 delete-my-business-btn" data-business-id="${business.id}"><i class="fas fa-trash mr-1"></i>Delete</button>
                    </div>
                `;
                listEl.appendChild(itemEl);
            });

            // Add event listeners for action buttons
            listEl.querySelectorAll('.edit-my-business-btn').forEach(btn => {
                btn.addEventListener('click', (e) => navigateTo('addEditBusiness', { businessId: e.currentTarget.dataset.businessId }));
            });
            listEl.querySelectorAll('.manage-my-menu-btn').forEach(btn => {
                btn.addEventListener('click', (e) => navigateTo('manageMenu', { businessId: e.currentTarget.dataset.businessId }));
            });
            listEl.querySelectorAll('.delete-my-business-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteBusiness(e.currentTarget.dataset.businessId));
            });
        }

        function deleteBusiness(businessId) {
            // TODO: API call to delete business
            // Confirmation would be good here (using custom modal)
            const businessName = mockBusinesses.find(b => b.id === businessId)?.name || 'this business';
            showConfirmationModal(
                `Delete ${businessName}?`,
                "Are you sure you want to delete this business? This action cannot be undone.",
                () => {
                    mockBusinesses = mockBusinesses.filter(b => b.id !== businessId);
                    delete mockMenus[businessId]; // Also delete associated menu
                    delete mockReviews[businessId]; // And reviews
                    console.log('Deleted Business:', businessId);
                    renderMyBusinessList(); // Re-render the list
                    filterAndRenderBusinesses(); // Update home screen list if business was there
                    showModalMessage("Success", `${businessName} deleted successfully.`, "success");
                }
            );
        }

        // Menu Item CRUD
        function renderMenuManagement(businessId) {
            const business = mockBusinesses.find(b => b.id === businessId);
            if (!business) { navigateTo('manageMyBusiness'); return; }

            document.getElementById('manage-menu-business-name').textContent = `Manage Menu for ${business.name}`;
            const listEl = document.getElementById('menu-item-list-management');
            const noItemsMsg = document.getElementById('no-menu-items-message');
            listEl.innerHTML = '';
            const menu = mockMenus[businessId] || [];

            if (menu.length === 0) {
                noItemsMsg.classList.remove('hidden');
            } else {
                noItemsMsg.classList.add('hidden');
                menu.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'luxury-card p-3 flex flex-col sm:flex-row justify-between sm:items-center space-y-2 sm:space-y-0';
                    itemEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${item.imageUrl || 'https://placehold.co/80x60/e2e8f0/333333?text=Dish'}" alt="${item.name}" class="w-16 h-12 object-cover rounded">
                            <div>
                                <h4 class="font-semibold text-gray-700">${item.name}</h4>
                                <p class="text-sm text-yellow-600">$${item.price.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-sm py-1 px-2 rounded bg-blue-500 text-white hover:bg-blue-600 edit-menu-item-btn" data-item-id="${item.id}"><i class="fas fa-edit mr-1"></i>Edit</button>
                            <button class="text-sm py-1 px-2 rounded bg-red-500 text-white hover:bg-red-600 delete-menu-item-btn" data-item-id="${item.id}"><i class="fas fa-trash mr-1"></i>Delete</button>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            }

            // Add event listeners
            document.getElementById('add-new-menu-item-btn').onclick = () => navigateTo('addEditMenuItem', { businessId });
            listEl.querySelectorAll('.edit-menu-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => navigateTo('addEditMenuItem', { businessId, menuItemId: e.currentTarget.dataset.itemId }));
            });
            listEl.querySelectorAll('.delete-menu-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteMenuItem(businessId, e.currentTarget.dataset.itemId));
            });
        }

        function setupMenuItemForm(menuItemId = null, businessId) {
            const form = document.getElementById('menu-item-form');
            const titleEl = document.getElementById('menu-item-form-title');
            form.reset();
            document.getElementById('menu-item-form-id').value = '';
            document.getElementById('menu-item-form-business-id').value = businessId;

            if (menuItemId) {
                const menuItem = (mockMenus[businessId] || []).find(item => item.id === menuItemId);
                if (menuItem) {
                    titleEl.textContent = `Edit ${menuItem.name}`;
                    document.getElementById('menu-item-form-id').value = menuItem.id;
                    document.getElementById('menu-item-name').value = menuItem.name;
                    document.getElementById('menu-item-description').value = menuItem.description;
                    document.getElementById('menu-item-price').value = menuItem.price;
                    document.getElementById('menu-item-category').value = menuItem.category || '';
                    document.getElementById('menu-item-image-url').value = menuItem.imageUrl || '';
                }
            } else {
                titleEl.textContent = 'Add New Menu Item';
            }
        }

        document.getElementById('menu-item-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const itemId = document.getElementById('menu-item-form-id').value;
            const businessId = document.getElementById('menu-item-form-business-id').value;
            const menuItemData = {
                name: document.getElementById('menu-item-name').value,
                description: document.getElementById('menu-item-description').value,
                price: parseFloat(document.getElementById('menu-item-price').value),
                category: document.getElementById('menu-item-category').value,
                imageUrl: document.getElementById('menu-item-image-url').value,
                // Keep existing rating/reviews/badges or initialize for new
                rating: itemId ? (mockMenus[businessId].find(i=>i.id===itemId).rating || 0) : 0,
                reviewCount: itemId ? (mockMenus[businessId].find(i=>i.id===itemId).reviewCount || 0) : 0,
                badges: itemId ? (mockMenus[businessId].find(i=>i.id===itemId).badges || []) : [],
            };

            // TODO: API call to save/update menu item
            if (!mockMenus[businessId]) mockMenus[businessId] = [];

            if (itemId) { // Update
                const index = mockMenus[businessId].findIndex(item => item.id === itemId);
                if (index !== -1) {
                    mockMenus[businessId][index] = { ...mockMenus[businessId][index], ...menuItemData };
                    showModalMessage("Success", `${menuItemData.name} updated.`, "success");
                }
            } else { // Create
                menuItemData.id = 'm' + businessId + '-' + (mockMenus[businessId].length + 1) + Date.now(); // Simple unique ID
                mockMenus[businessId].push(menuItemData);
                showModalMessage("Success", `${menuItemData.name} added to menu.`, "success");
            }
            console.log('Saved Menu Item:', menuItemData);
            navigateTo('manageMenu', { businessId });
        });

        function deleteMenuItem(businessId, menuItemId) {
            // TODO: API call to delete menu item
            const itemName = mockMenus[businessId]?.find(item => item.id === menuItemId)?.name || 'this item';
            showConfirmationModal(
                `Delete ${itemName}?`,
                "Are you sure you want to delete this menu item? This action cannot be undone.",
                () => {
                    if (mockMenus[businessId]) {
                        mockMenus[businessId] = mockMenus[businessId].filter(item => item.id !== menuItemId);
                    }
                    console.log('Deleted Menu Item:', menuItemId, 'from business:', businessId);
                    renderMenuManagement(businessId); // Re-render the list
                    showModalMessage("Success", `${itemName} deleted.`, "success");
                }
            );
        }

        // Review Submission
        let selectedReviewRating = 0;
        function setupReviewForm(businessId) {
            const business = mockBusinesses.find(b => b.id === businessId);
            if (!business) { navigateTo('home'); return; }

            document.getElementById('review-business-name').textContent = business.name;
            document.getElementById('review-form-business-id').value = businessId;
            document.getElementById('review-form').reset();
            selectedReviewRating = 0;
            renderStarRating(0, document.getElementById('review-stars'), true); // Interactive stars
        }

        document.getElementById('review-stars').addEventListener('click', function(e) {
            if (e.target.classList.contains('fa-star')) {
                selectedReviewRating = parseInt(e.target.dataset.value);
                document.getElementById('review-rating-value').value = selectedReviewRating;
                renderStarRating(selectedReviewRating, this, true);
            }
        });

        document.getElementById('review-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const businessId = document.getElementById('review-form-business-id').value;
            if (selectedReviewRating === 0) {
                showModalMessage("Validation Error", "Please select a star rating.", "error");
                return;
            }
            const reviewData = {
                id: 'r' + businessId + '-' + Date.now(),
                userName: 'Current User', // Replace with actual user name from Telegram/Auth
                rating: selectedReviewRating,
                comment: document.getElementById('review-comment').value
            };

            // TODO: API call to submit review
            if (!mockReviews[businessId]) mockReviews[businessId] = [];
            mockReviews[businessId].unshift(reviewData); // Add to beginning

            // Update business average rating (simplified)
            const business = mockBusinesses.find(b => b.id === businessId);
            if (business) {
                const totalRating = mockReviews[businessId].reduce((sum, r) => sum + r.rating, 0);
                business.rating = parseFloat((totalRating / mockReviews[businessId].length).toFixed(1));
                business.reviewCount = mockReviews[businessId].length;
            }

            console.log('Submitted Review:', reviewData);
            showModalMessage("Review Submitted", "Thank you for your feedback!", "success");
            navigateTo('businessDetail', { businessId });
        });

        // --- Modal Functionality ---
        function openModal(modalElement) {
            modalElement.classList.remove('opacity-0', 'pointer-events-none');
            modalElement.classList.add('open');
            tg.BackButton.show();
            tg.onEvent('backButtonClicked', () => closeModal(modalElement));
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            modalElement.classList.remove('open');
            setTimeout(() => {
                modalElement.classList.add('pointer-events-none');
            }, 300); // Match transition duration
            tg.BackButton.hide();
            tg.offEvent('backButtonClicked', () => closeModal(modalElement)); // Clean up
        }

        document.getElementById('filter-btn').addEventListener('click', () => openModal(filterModal));
        document.getElementById('close-filter-modal-btn').addEventListener('click', () => closeModal(filterModal));
        document.getElementById('apply-filters-btn').addEventListener('click', () => {
            currentFilters.rating = parseInt(document.getElementById('filter-rating').value);
            currentFilters.price = document.getElementById('filter-price').value;
            currentFilters.badges = [];
            document.querySelectorAll('#filter-badges input[type="checkbox"]:checked').forEach(cb => {
                currentFilters.badges.push(cb.value);
            });
            filterAndRenderBusinesses();
            closeModal(filterModal);
        });
        document.getElementById('reset-filters-btn').addEventListener('click', () => {
            document.getElementById('filter-rating').value = "0";
            document.getElementById('filter-price').value = "any";
            document.querySelectorAll('#filter-badges input[type="checkbox"]').forEach(cb => cb.checked = false);
            currentFilters = { rating: 0, price: 'any', badges: [] }; // Reset internal state
            filterAndRenderBusinesses(); // Apply reset filters immediately
            // closeModal(filterModal); // Optionally close modal after reset
        });

        // Generic Message Modal
        const msgModalEl = document.getElementById('message-modal');
        const msgModalTitle = document.getElementById('message-modal-title');
        const msgModalText = document.getElementById('message-modal-text');
        const msgModalIcon = document.getElementById('message-modal-icon');
        const msgModalOkBtn = document.getElementById('message-modal-ok-btn');
        const closeMsgModalBtn = document.getElementById('close-message-modal-btn');

        function showModalMessage(title, text, type = "info") { // type: info, success, warning, error
            msgModalTitle.textContent = title;
            msgModalText.textContent = text;
            msgModalIcon.innerHTML = '';
            let iconClass = 'text-blue-500';
            if (type === "success") iconClass = 'fa-check-circle text-green-500';
            else if (type === "warning") iconClass = 'fa-exclamation-triangle text-yellow-500';
            else if (type === "error") iconClass = 'fa-times-circle text-red-500';
            else iconClass = 'fa-info-circle text-blue-500'; // Default info
            msgModalIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
            openModal(msgModalEl);
        }
        msgModalOkBtn.addEventListener('click', () => closeModal(msgModalEl));
        closeMsgModalBtn.addEventListener('click', () => closeModal(msgModalEl));

        // Confirmation Modal (repurposing message modal or create a new one)
        // For simplicity, using a global callback for confirmation
        let confirmCallback = null;
        function showConfirmationModal(title, text, onConfirm) {
            msgModalTitle.textContent = title;
            msgModalText.textContent = text;
            msgModalIcon.innerHTML = `<i class="fas fa-question-circle text-yellow-500"></i>`; // Question icon

            // Change OK button to "Confirm" and add a "Cancel" button
            msgModalOkBtn.textContent = "Confirm";
            const cancelButton = document.createElement('button');
            cancelButton.textContent = "Cancel";
            cancelButton.className = "px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition w-full mt-2";
            
            // Clear previous extra buttons if any
            const existingCancel = msgModalOkBtn.parentElement.querySelector('.cancel-confirm-btn');
            if(existingCancel) existingCancel.remove();

            msgModalOkBtn.parentElement.appendChild(cancelButton);
            cancelButton.classList.add('cancel-confirm-btn'); // Mark for removal

            confirmCallback = onConfirm;
            openModal(msgModalEl);

            msgModalOkBtn.onclick = () => {
                closeModal(msgModalEl);
                if (confirmCallback) confirmCallback();
                resetMessageModalButtons();
            };
            cancelButton.onclick = () => {
                closeModal(msgModalEl);
                resetMessageModalButtons();
            };
            closeMsgModalBtn.onclick = () => { // Ensure X button also cancels
                closeModal(msgModalEl);
                resetMessageModalButtons();
            }
        }

        function resetMessageModalButtons() {
            msgModalOkBtn.textContent = "OK";
            msgModalOkBtn.onclick = () => closeModal(msgModalEl); // Reset default OK behavior
            const cancelButton = msgModalOkBtn.parentElement.querySelector('.cancel-confirm-btn');
            if (cancelButton) cancelButton.remove();
            confirmCallback = null;
        }


        // --- Event Listeners for Navigation & Actions ---
        document.querySelectorAll('.back-to-home').forEach(btn => {
            btn.addEventListener('click', () => navigateTo('home'));
        });
        document.getElementById('user-profile-btn').addEventListener('click', () => {
            // Placeholder for user profile - could be a modal or another screen
            showModalMessage("Profile", "User profile management coming soon!", "info");
        });
        document.getElementById('manage-business-nav-btn').addEventListener('click', () => {
            navigateTo('manageMyBusiness');
        });

        // Business Detail Screen back button (if it's not a generic .back-to-home)
        // (Already handled by generic .back-to-home)

        // Add/Edit Business Screen back buttons
        document.querySelector('#add-edit-business-screen .back-to-manage-business').addEventListener('click', () => navigateTo('manageMyBusiness'));

        // Manage My Business Screen buttons
        document.getElementById('add-new-business-btn').addEventListener('click', () => navigateTo('addEditBusiness'));

        // Manage Menu Screen buttons
        document.querySelector('#manage-menu-screen .back-to-manage-business-overview').addEventListener('click', () => navigateTo('manageMyBusiness'));
        // Add new menu item button is handled in renderMenuManagement

        // Add/Edit Menu Item Screen back button
        document.querySelector('#add-edit-menu-item-screen .back-to-manage-menu').addEventListener('click', () => {
            if (currentManagingBusinessId) {
                navigateTo('manageMenu', { businessId: currentManagingBusinessId });
            } else {
                navigateTo('manageMyBusiness'); // Fallback
            }
        });

        // Submit Review Screen back button
        document.querySelector('#submit-review-screen .back-to-business-from-review').addEventListener('click', () => {
            if (currentBusinessId) {
                navigateTo('businessDetail', { businessId: currentBusinessId });
            } else {
                navigateTo('home'); // Fallback
            }
        });
        document.getElementById('add-review-btn').addEventListener('click', function() {
            const businessId = this.dataset.businessId;
            if (businessId) {
                navigateTo('submitReview', { businessId });
            }
        });

        // Search input listener
        document.getElementById('search-query').addEventListener('input', filterAndRenderBusinesses);


        // --- Telegram Specific Main Button ---
        // Example: tg.MainButton.setText("Show Results").show().onClick(() => { /* action */ });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCategories();
            getUserLocation(); // This will also trigger initial business list rendering and map update
            // Initial screen is loading, then navigates to home after location.
        });

    </script>
</body>
</html>
