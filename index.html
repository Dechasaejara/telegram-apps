<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>daily volueenter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Apply Telegram Theme Variables */
        :root {
            --tg-theme-bg-color: #ffffff; /* Default light theme bg */
            --tg-theme-text-color: #000000; /* Default light theme text */
            --tg-theme-hint-color: #999999; /* Default light theme hint */
            --tg-theme-link-color: #2481cc; /* Default light theme link */
            --tg-theme-button-color: #2481cc; /* Default light theme button */
            --tg-theme-button-text-color: #ffffff; /* Default light theme button text */
            --tg-theme-secondary-bg-color: #f0f0f0; /* Default light theme secondary bg */
            --tg-header-color: #ffffff; /* Default header color */
            --tg-section-header-color: #000000; /* Default section header text color */
            --tg-accent-text-color: #2481cc; /* Default accent text color */
            --tg-destructive-text-color: #ff3b30; /* Default destructive text color */
            --tg-border-color: #e0e0e0; /* Default border color */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh in mini app */
        }
        .screen {
            min-height: calc(100vh - 60px); /* Adjust if nav bar height changes */
            display: none; /* Hidden by default */
            box-sizing: border-box;
        }
        .screen.active {
            display: flex; /* Use flex for centering/layout */
            flex-direction: column;
        }
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: var(--tg-theme-secondary-bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-hint-color);
            border-radius: 5px;
        }
        .nav-bar {
            background-color: var(--tg-theme-secondary-bg-color);
            border-top: 1px solid var(--tg-border-color);
        }
        .nav-button {
            color: var(--tg-theme-hint-color);
        }
        .nav-button.active {
            color: var(--tg-theme-button-color);
        }
        .swipe-card {
            touch-action: none; /* Important for custom swipe gestures */
            user-select: none;
            transform-origin: bottom center;
        }
        .profile-pic-xl {
            width: 128px;
            height: 128px;
        }
        .profile-pic-lg {
            width: 80px;
            height: 80px;
        }
        .profile-pic-md {
            width: 56px;
            height: 56px;
        }
        .profile-pic-sm {
            width: 40px;
            height: 40px;
        }
        .tag {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        input, textarea, select {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-border-color);
        }
        input::placeholder, textarea::placeholder {
            color: var(--tg-theme-hint-color);
        }
        button.primary-btn {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        button.secondary-btn {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-button-color);
        }
        .tab-button {
            border-bottom: 2px solid transparent;
            color: var(--tg-theme-hint-color);
        }
        .tab-button.active {
            border-bottom-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-color);
        }
        .status-pending { color: orange; }
        .status-accepted { color: green; }

        /* Specific Telegram UI element mimicking */
        .tg-list-item {
            border-bottom: 1px solid var(--tg-border-color);
        }
        .tg-list-item:last-child {
            border-bottom: none;
        }
        .tg-section-title {
            color: var(--tg-section-header-color);
            font-weight: 600;
        }
    </style>
</head>
<body class="overscroll-none">

    <div id="app-container" class="h-screen flex flex-col">

        <main class="flex-grow overflow-y-auto">
            <div id="screen-profile" class="screen p-4 space-y-4">
                <div class="flex flex-col items-center space-y-3">
                    <img id="profile-main-pic" src="https://placehold.co/128x128/E0E0E0/B0B0B0?text=User" alt="Profile Picture" class="profile-pic-xl rounded-full object-cover">
                    <h2 id="profile-main-username" class="text-2xl font-semibold">@username</h2>
                </div>

                <div class="space-y-1">
                    <label for="profile-hobbies" class="block text-sm font-medium tg-section-title">Hobbies & Interests (comma separated):</label>
                    <textarea id="profile-hobbies" rows="3" class="w-full p-2 rounded-lg border" placeholder="e.g., hiking, coding, reading"></textarea>
                </div>
                <div class="space-y-1">
                    <label for="profile-passions" class="block text-sm font-medium tg-section-title">Passions (comma separated):</label>
                    <textarea id="profile-passions" rows="3" class="w-full p-2 rounded-lg border" placeholder="e.g., sustainable living, AI ethics"></textarea>
                </div>
                <div class="space-y-1">
                    <label for="profile-preferences" class="block text-sm font-medium tg-section-title">Relationship Preferences:</label>
                    <input type="text" id="profile-preferences" class="w-full p-2 rounded-lg border" placeholder="e.g., Looking for serious, casual">
                </div>
                <div class="space-y-1">
                    <label for="profile-personality" class="block text-sm font-medium tg-section-title">Key Personality Traits (comma separated):</label>
                    <input type="text" id="profile-personality" class="w-full p-2 rounded-lg border" placeholder="e.g., adventurous, empathetic, witty">
                </div>
                <button id="save-profile-btn" class="w-full primary-btn py-2.5 px-4 rounded-lg font-semibold">Save Profile</button>
            </div>

            <div id="screen-swipe" class="screen items-center justify-center p-4 relative overflow-hidden">
                <div id="swipe-card-container" class="relative w-full max-w-sm h-[70vh] aspect-[3/4]">
                    </div>
                <div id="swipe-empty-state" class="hidden text-center">
                    <p class="text-xl var(--tg-theme-hint-color)">No more profiles to show right now.</p>
                    <p class="var(--tg-theme-hint-color)">Check back later!</p>
                </div>
                <div class="absolute bottom-20 left-1/2 -translate-x-1/2 flex space-x-8">
                     <button id="reject-btn" class="bg-red-500 text-white rounded-full p-4 shadow-lg transform transition-transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <button id="accept-btn" class="bg-green-500 text-white rounded-full p-4 shadow-lg transform transition-transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="screen-adventure" class="screen p-4 space-y-6">
                <h2 class="text-2xl font-bold tg-section-title text-center">Your Adventure</h2>

                <div class="bg-var(--tg-theme-secondary-bg-color) p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold tg-section-title mb-2">Personality Assessments</h3>
                    <ul id="assessments-list" class="space-y-2">
                        </ul>
                </div>

                <div class="bg-var(--tg-theme-secondary-bg-color) p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold tg-section-title mb-2">Local Challenges</h3>
                    <ul id="challenges-list" class="space-y-2">
                        </ul>
                </div>
                 <div id="adventure-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-var(--tg-theme-bg-color) p-6 rounded-lg shadow-xl w-full max-w-md space-y-4">
                        <h3 id="adventure-modal-title" class="text-xl font-semibold tg-section-title">Modal Title</h3>
                        <div id="adventure-modal-content"></div>
                        <div class="flex justify-end space-x-2">
                            <button id="adventure-modal-close-btn" class="secondary-btn py-2 px-4 rounded-lg">Close</button>
                            <button id="adventure-modal-action-btn" class="primary-btn py-2 px-4 rounded-lg">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="screen-history" class="screen p-4 space-y-4">
                <h2 class="text-2xl font-bold tg-section-title text-center">Swipe History</h2>
                <div class="flex border-b border-var(--tg-border-color)">
                    <button data-tab="accepted" class="history-tab-btn tab-button flex-1 py-2 font-medium active">Accepted</button>
                    <button data-tab="rejected" class="history-tab-btn tab-button flex-1 py-2 font-medium">Rejected</button>
                </div>
                <div id="history-content" class="space-y-3">
                    </div>
            </div>

            <div id="screen-chat-list" class="screen p-4 space-y-3">
                <h2 class="text-2xl font-bold tg-section-title text-center">Your Matches & Chats</h2>
                <div id="chat-list-container" class="space-y-2">
                    </div>
                <p id="no-chats-message" class="text-center var(--tg-theme-hint-color) hidden">No active chats yet. Keep swiping!</p>
            </div>

            <div id="screen-chat-individual" class="screen flex flex-col h-full">
                <header class="bg-var(--tg-theme-secondary-bg-color) p-3 flex items-center space-x-3 border-b border-var(--tg-border-color) sticky top-0 z-10">
                    <button id="chat-back-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 var(--tg-theme-text-color)">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                        </svg>
                    </button>
                    <img id="chat-partner-pic" src="https://placehold.co/40x40/E0E0E0/B0B0B0?text=P" alt="Partner Pic" class="profile-pic-sm rounded-full object-cover">
                    <h3 id="chat-partner-name" class="font-semibold text-lg">Partner Name</h3>
                </header>
                <div id="chat-messages-container" class="flex-grow p-4 space-y-3 overflow-y-auto">
                    </div>
                <footer class="bg-var(--tg-theme-secondary-bg-color) p-3 border-t border-var(--tg-border-color) sticky bottom-0 z-10">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="chat-message-input" class="flex-grow p-2.5 rounded-lg border" placeholder="Type a message...">
                        <button id="chat-send-btn" class="primary-btn p-2.5 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                            </svg>
                        </button>
                    </div>
                </footer>
            </div>

        </main>

        <nav class="nav-bar grid grid-cols-5 gap-1 p-1 sticky bottom-0">
            <button data-screen="screen-profile" class="nav-button p-2 rounded-lg flex flex-col items-center space-y-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                <span class="text-xs">Profile</span>
            </button>
            <button data-screen="screen-swipe" class="nav-button p-2 rounded-lg flex flex-col items-center space-y-0.5 active">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 3.75H6A2.25 2.25 0 003.75 6v1.5M16.5 3.75H18A2.25 2.25 0 0120.25 6v1.5m0 9V18A2.25 2.25 0 0118 20.25h-1.5m-9 0H6A2.25 2.25 0 013.75 18v-1.5M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs">Discover</span>
            </button>
            <button data-screen="screen-adventure" class="nav-button p-2 rounded-lg flex flex-col items-center space-y-0.5">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503-6.998l4.875-2.172a.75.75 0 01.921.921l-2.173 4.875M14.25 12l-4.875 2.172a.75.75 0 01-.921-.921L10.5 8.25M12 15.75H9" /></svg>
                <span class="text-xs">Adventure</span>
            </button>
            <button data-screen="screen-history" class="nav-button p-2 rounded-lg flex flex-col items-center space-y-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
                <span class="text-xs">History</span>
            </button>
            <button data-screen="screen-chat-list" class="nav-button p-2 rounded-lg flex flex-col items-center space-y-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>
                <span class="text-xs">Chats</span>
            </button>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        // --- App State & Data ---
        let currentUser = {
            id: null,
            username: 'guest',
            photo_url: 'https://placehold.co/128x128/E0E0E0/B0B0B0?text=User',
            profile: { hobbies: '', passions: '', preferences: '', personality: '' }
        };
        let potentialPartners = []; // Will be populated with mock data
        let swipeHistory = { accepted: [], rejected: [] };
        let matches = []; // { partnerId, partnerName, partnerPic, chatLog: [{sender, text, time}] }
        let adventureProgress = { assessments: {}, challenges: {} }; // { 'assessmentId': {completed: true, answers: []} }

        const MOCK_USERS_COUNT = 20;
        const MOCK_ASSESSMENTS = [
            { id: 'assess1', title: 'Weekend Vibes', question: 'Your ideal weekend is:', options: ['Adventure outdoors', 'Cozy at home', 'Socializing with friends', 'Learning something new'], completed: false },
            { id: 'assess2', title: 'Communication Style', question: 'When resolving conflict, you prefer:', options: ['Direct conversation', 'Time to think first', 'Mediator help', 'Humor to lighten mood'], completed: false },
        ];
        const MOCK_CHALLENGES = [
            { id: 'challenge1', title: 'Cafe Connoisseur', description: "Visit 'The Daily Grind Cafe' and find the 'Secret Brew' name on their chalkboard.", task: "Enter the Secret Brew name:", completed: false, solution: "Moonbeam Mocha" },
            { id: 'challenge2', title: 'Bookworm Quest', description: "At 'Readers' Nook Bookstore', ask for the book recommended for 'dreamers'.", task: "What's the book title?", completed: false, solution: "The Starless Sea" },
        ];

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const navButtons = document.querySelectorAll('.nav-button');
        const profilePicEl = document.getElementById('profile-main-pic');
        const profileUsernameEl = document.getElementById('profile-main-username');
        const hobbiesInput = document.getElementById('profile-hobbies');
        const passionsInput = document.getElementById('profile-passions');
        const preferencesInput = document.getElementById('profile-preferences');
        const personalityInput = document.getElementById('profile-personality');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const swipeCardContainer = document.getElementById('swipe-card-container');
        const swipeEmptyState = document.getElementById('swipe-empty-state');
        const rejectBtn = document.getElementById('reject-btn');
        const acceptBtn = document.getElementById('accept-btn');
        const historyContentEl = document.getElementById('history-content');
        const historyTabButtons = document.querySelectorAll('.history-tab-btn');
        const chatListContainer = document.getElementById('chat-list-container');
        const noChatsMessage = document.getElementById('no-chats-message');
        const chatPartnerPic = document.getElementById('chat-partner-pic');
        const chatPartnerName = document.getElementById('chat-partner-name');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatMessageInput = document.getElementById('chat-message-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatBackBtn = document.getElementById('chat-back-btn');
        const assessmentsListEl = document.getElementById('assessments-list');
        const challengesListEl = document.getElementById('challenges-list');
        const adventureModal = document.getElementById('adventure-modal');
        const adventureModalTitle = document.getElementById('adventure-modal-title');
        const adventureModalContent = document.getElementById('adventure-modal-content');
        const adventureModalCloseBtn = document.getElementById('adventure-modal-close-btn');
        const adventureModalActionBtn = document.getElementById('adventure-modal-action-btn');

        let currentAdventureContext = null; // To store which assessment/challenge is active in modal
        let currentChatPartnerId = null;


        // --- Local Storage Utilities ---
        const getLocalStorage = (key, defaultValue) => {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultValue;
        };
        const setLocalStorage = (key, value) => {
            localStorage.setItem(key, JSON.stringify(value));
        };

        // --- Telegram Theme Application ---
        function applyTelegramTheme() {
            if (tg.themeParams) {
                const root = document.documentElement;
                root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                root.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                root.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2481cc');
                root.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
                root.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                root.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');
                
                // Additional derived colors or fallbacks
                root.style.setProperty('--tg-header-color', tg.themeParams.header_bg_color || tg.themeParams.bg_color || '#ffffff');
                root.style.setProperty('--tg-section-header-color', tg.themeParams.section_header_text_color || tg.themeParams.text_color || '#000000');
                root.style.setProperty('--tg-accent-text-color', tg.themeParams.accent_text_color || tg.themeParams.link_color || '#2481cc');
                root.style.setProperty('--tg-destructive-text-color', tg.themeParams.destructive_text_color || '#ff3b30');
                root.style.setProperty('--tg-border-color', tg.themeParams.section_bg_color || tg.themeParams.secondary_bg_color || '#e0e0e0');


                // Update body background explicitly as it might not be covered by CSS variables if set inline
                document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                document.body.style.color = tg.themeParams.text_color || '#000000';
            }
        }


        // --- Navigation ---
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.screen === screenId);
            });

            // Update Telegram MainButton based on screen
            tg.MainButton.hide();
            if (screenId === 'screen-profile') {
                // MainButton handled by specific save button
            } else if (screenId === 'screen-swipe' && swipeCardContainer.querySelector('.swipe-card')) {
                 // MainButton handled by on-screen accept/reject
            }
            // Add more MainButton logic for other screens if needed
        }

        // --- Profile Screen Logic ---
        function loadProfileData() {
            currentUser = getLocalStorage(`dailyVolueenter_currentUser_${currentUser.id}`, currentUser);
            profilePicEl.src = currentUser.photo_url || 'https://placehold.co/128x128/E0E0E0/B0B0B0?text=User';
            profileUsernameEl.textContent = currentUser.username ? `@${currentUser.username}` : '@guest';
            hobbiesInput.value = currentUser.profile.hobbies || '';
            passionsInput.value = currentUser.profile.passions || '';
            preferencesInput.value = currentUser.profile.preferences || '';
            personalityInput.value = currentUser.profile.personality || '';
        }

        function saveProfile() {
            currentUser.profile.hobbies = hobbiesInput.value;
            currentUser.profile.passions = passionsInput.value;
            currentUser.profile.preferences = preferencesInput.value;
            currentUser.profile.personality = personalityInput.value;
            setLocalStorage(`dailyVolueenter_currentUser_${currentUser.id}`, currentUser);
            tg.HapticFeedback.notificationOccurred('success');
            alertUser("Profile Saved!"); // Using custom alert
        }
        
        function alertUser(message, type = 'info') { // type can be 'info', 'success', 'error'
            // Simple alert for now, can be replaced with a styled modal
            const alertDiv = document.createElement('div');
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.bottom = '70px'; // Above nav bar
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.padding = '10px 20px';
            alertDiv.style.borderRadius = '8px';
            alertDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.transition = 'opacity 0.5s ease-in-out';
            
            if (type === 'success') {
                alertDiv.style.backgroundColor = 'var(--tg-theme-button-color)'; // Or a green color
                alertDiv.style.color = 'var(--tg-theme-button-text-color)';
            } else if (type === 'error') {
                alertDiv.style.backgroundColor = 'var(--tg-destructive-text-color)'; // Or a red color
                alertDiv.style.color = 'var(--tg-theme-button-text-color)';
            } else {
                alertDiv.style.backgroundColor = 'var(--tg-theme-secondary-bg-color)';
                alertDiv.style.color = 'var(--tg-theme-text-color)';
            }
            
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500);
            }, 2000);
        }


        // --- Swipe Screen Logic ---
        let currentCardIndex = 0;
        let swipeCards = [];

        function createSwipeCard(user, index) {
            const card = document.createElement('div');
            card.classList.add('swipe-card', 'absolute', 'w-full', 'h-full', 'bg-var(--tg-theme-secondary-bg-color)', 'rounded-xl', 'shadow-2xl', 'overflow-hidden', 'flex', 'flex-col', 'cursor-grab');
            card.style.zIndex = MOCK_USERS_COUNT - index; // Stack cards
            card.dataset.userId = user.id;

            card.innerHTML = `
                <img src="${user.photo_url}" alt="${user.username}" class="w-full h-3/4 object-cover">
                <div class="p-4 flex-grow flex flex-col justify-between">
                    <div>
                        <h3 class="text-2xl font-bold var(--tg-theme-text-color)">@${user.username}, ${user.age}</h3>
                        <p class="text-sm var(--tg-theme-hint-color) truncate">${user.bio.substring(0, 50)}...</p>
                    </div>
                    <div class="flex flex-wrap gap-1 mt-2">
                        ${user.tags.slice(0,3).map(tag => `<span class="tag text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}
                    </div>
                </div>
                <div id="swipe-overlay-${user.id}" class="absolute inset-0 flex items-center justify-center text-4xl font-bold uppercase opacity-0 transition-opacity duration-300"></div>
            `;
            makeCardDraggable(card);
            return card;
        }
        
        function loadPotentialPartners() {
            // Filter out users already swiped or the current user
            const swipedUserIds = [...swipeHistory.accepted, ...swipeHistory.rejected, currentUser.id];
            const availablePartners = potentialPartners.filter(p => !swipedUserIds.includes(p.id));
            
            swipeCardContainer.innerHTML = ''; // Clear existing cards
            swipeCards = []; // Reset the array of card elements

            if (availablePartners.length === 0) {
                swipeEmptyState.classList.remove('hidden');
                return;
            }
            swipeEmptyState.classList.add('hidden');

            // Create and append new cards
            // Show only a few cards at a time for performance, e.g., top 3
            availablePartners.slice(0, 3).reverse().forEach((user, index) => {
                const card = createSwipeCard(user, index);
                swipeCards.push(card);
                swipeCardContainer.appendChild(card);
            });
            currentCardIndex = swipeCards.length -1; // Start with the top card
        }


        function makeCardDraggable(card) {
            let startX, startY, isDragging = false, offsetX, offsetY;
            const overlay = card.querySelector(`#swipe-overlay-${card.dataset.userId}`);

            function onPointerDown(e) {
                if (e.target.closest('button')) return; // Don't drag if clicking a button on card
                isDragging = true;
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                card.style.transition = 'none'; // Remove transition for smooth dragging
                card.classList.add('grabbing');
            }

            function onPointerMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const currentX = e.clientX || e.touches[0].clientX;
                const currentY = e.clientY || e.touches[0].clientY;
                offsetX = currentX - startX;
                offsetY = currentY - startY;

                card.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${offsetX / 20}deg)`;
                
                // Show accept/reject overlay
                if (offsetX > 50) {
                    overlay.textContent = 'ACCEPT';
                    overlay.style.color = 'green';
                    overlay.style.opacity = Math.min(1, Math.abs(offsetX) / 100);
                } else if (offsetX < -50) {
                    overlay.textContent = 'REJECT';
                    overlay.style.color = 'red';
                    overlay.style.opacity = Math.min(1, Math.abs(offsetX) / 100);
                } else {
                    overlay.style.opacity = '0';
                }
            }

            function onPointerUp(e) {
                if (!isDragging) return;
                isDragging = false;
                card.classList.remove('grabbing');
                card.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                overlay.style.opacity = '0'; // Hide overlay quickly

                const threshold = card.offsetWidth / 3;
                if (offsetX > threshold) {
                    handleSwipe('accept', card.dataset.userId);
                } else if (offsetX < -threshold) {
                    handleSwipe('reject', card.dataset.userId);
                } else {
                    card.style.transform = 'translate(0,0) rotate(0deg)'; // Return to center
                }
            }
            
            card.addEventListener('mousedown', onPointerDown);
            card.addEventListener('touchstart', onPointerDown, { passive: false });

            document.addEventListener('mousemove', onPointerMove);
            document.addEventListener('touchmove', onPointerMove, { passive: false });
            
            document.addEventListener('mouseup', onPointerUp);
            document.addEventListener('touchend', onPointerUp);
        }

        function handleSwipe(direction, userId) {
            if (!userId && swipeCards.length > 0) { // From button click
                const topCard = swipeCards[swipeCards.length - 1];
                if (topCard) userId = topCard.dataset.userId;
            }
            if (!userId) return; // No card to swipe

            const cardEl = swipeCardContainer.querySelector(`.swipe-card[data-user-id="${userId}"]`);
            if (!cardEl) return;

            cardEl.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            const flyX = (direction === 'accept' ? 1 : -1) * (swipeCardContainer.offsetWidth + cardEl.offsetWidth);
            cardEl.style.transform = `translate(${flyX}px, ${cardEl.offsetTop * 0.3}px) rotate(${direction === 'accept' ? 30 : -30}deg)`;
            cardEl.style.opacity = '0';

            tg.HapticFeedback.impactOccurred('medium');

            setTimeout(() => {
                cardEl.remove();
                swipeCards = swipeCards.filter(c => c !== cardEl); // Remove from active cards array
                if (swipeCards.length === 0) {
                     loadPotentialPartners(); // Load more if needed
                }
            }, 500);


            if (direction === 'accept') {
                if (!swipeHistory.accepted.includes(userId)) swipeHistory.accepted.push(userId);
                // Check for mutual match (simplified)
                const partner = potentialPartners.find(p => p.id === userId);
                // In a real app, partner.preferences.acceptedMe would come from a server.
                // We simulate it: some users might "accept back" randomly or based on a flag.
                if (partner && (partner.acceptsCurrentUser || Math.random() < 0.3)) { // 30% chance of mutual like for demo
                    if (!matches.find(m => m.partnerId === userId)) {
                        matches.push({
                            partnerId: userId,
                            partnerName: partner.username,
                            partnerPic: partner.photo_url,
                            chatLog: [{ sender: 'system', text: 'You are now matched!', time: new Date().toISOString() }]
                        });
                        alertUser(`It's a Match with @${partner.username}!`, 'success');
                    }
                }
            } else {
                if (!swipeHistory.rejected.includes(userId)) swipeHistory.rejected.push(userId);
            }
            setLocalStorage(`dailyVolueenter_swipeHistory_${currentUser.id}`, swipeHistory);
            setLocalStorage(`dailyVolueenter_matches_${currentUser.id}`, matches);
        }
        
        // --- History Screen Logic ---
        let activeHistoryTab = 'accepted';
        function renderHistoryScreen() {
            historyContentEl.innerHTML = '';
            const listToShow = activeHistoryTab === 'accepted' ? swipeHistory.accepted : swipeHistory.rejected;

            if (listToShow.length === 0) {
                historyContentEl.innerHTML = `<p class="text-center var(--tg-theme-hint-color) mt-4">No users in this list yet.</p>`;
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-2';
            listToShow.forEach(userId => {
                const partner = potentialPartners.find(p => p.id === userId);
                if (!partner) return;

                const li = document.createElement('li');
                li.className = 'tg-list-item flex items-center justify-between p-3 bg-var(--tg-theme-secondary-bg-color) rounded-lg';
                
                let statusHtml = '';
                if (activeHistoryTab === 'accepted') {
                    const isMatch = matches.find(m => m.partnerId === userId);
                    if (isMatch) {
                        statusHtml = `<span class="status-accepted text-xs font-semibold">Accepted You Back</span>`;
                    } else {
                        statusHtml = `<span class="status-pending text-xs font-semibold">Pending Response</span>`;
                    }
                }

                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${partner.photo_url}" alt="${partner.username}" class="profile-pic-md rounded-full object-cover">
                        <div>
                            <p class="font-semibold var(--tg-theme-text-color)">@${partner.username}</p>
                            ${activeHistoryTab === 'accepted' ? statusHtml : ''}
                        </div>
                    </div>
                    ${activeHistoryTab === 'accepted' && matches.find(m => m.partnerId === userId) ? 
                        `<button data-chat-partner-id="${userId}" class="chat-now-btn primary-btn text-xs py-1 px-2 rounded">Chat</button>` : ''}
                `;
                ul.appendChild(li);
            });
            historyContentEl.appendChild(ul);
            
            document.querySelectorAll('.chat-now-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const partnerIdToChat = e.currentTarget.dataset.chatPartnerId;
                    openChatScreen(partnerIdToChat);
                });
            });
        }

        // --- Adventure Screen Logic ---
        function renderAdventureScreen() {
            assessmentsListEl.innerHTML = '';
            MOCK_ASSESSMENTS.forEach(assessment => {
                const isCompleted = adventureProgress.assessments[assessment.id]?.completed;
                const li = document.createElement('li');
                li.className = `tg-list-item flex justify-between items-center p-3 rounded-lg ${isCompleted ? 'opacity-60' : ''}`;
                li.innerHTML = `
                    <span>${assessment.title}</span>
                    <button data-type="assessment" data-id="${assessment.id}" class="start-adventure-item-btn ${isCompleted ? 'secondary-btn' : 'primary-btn'} text-sm py-1 px-3 rounded-md">
                        ${isCompleted ? 'View' : 'Start'}
                    </button>
                `;
                assessmentsListEl.appendChild(li);
            });

            challengesListEl.innerHTML = '';
            MOCK_CHALLENGES.forEach(challenge => {
                const isCompleted = adventureProgress.challenges[challenge.id]?.completed;
                const li = document.createElement('li');
                li.className = `tg-list-item flex justify-between items-center p-3 rounded-lg ${isCompleted ? 'opacity-60' : ''}`;
                li.innerHTML = `
                    <span>${challenge.title}</span>
                    <button data-type="challenge" data-id="${challenge.id}" class="start-adventure-item-btn ${isCompleted ? 'secondary-btn' : 'primary-btn'} text-sm py-1 px-3 rounded-md">
                        ${isCompleted ? 'View' : 'Start'}
                    </button>
                `;
                challengesListEl.appendChild(li);
            });

            document.querySelectorAll('.start-adventure-item-btn').forEach(btn => {
                btn.addEventListener('click', handleAdventureItemStart);
            });
        }
        
        function handleAdventureItemStart(event) {
            const type = event.target.dataset.type;
            const id = event.target.dataset.id;
            currentAdventureContext = { type, id };

            if (type === 'assessment') {
                const assessment = MOCK_ASSESSMENTS.find(a => a.id === id);
                adventureModalTitle.textContent = assessment.title;
                let contentHTML = `<p class="var(--tg-theme-hint-color) mb-3">${assessment.question}</p><div class="space-y-2">`;
                assessment.options.forEach((opt, index) => {
                    contentHTML += `<div><input type="radio" name="assessmentOption" id="opt${index}" value="${opt}" class="mr-2"><label for="opt${index}">${opt}</label></div>`;
                });
                contentHTML += `</div>`;
                adventureModalContent.innerHTML = contentHTML;
                adventureModalActionBtn.textContent = "Submit Answer";
                adventureModalActionBtn.onclick = submitAssessmentAnswer;
            } else if (type === 'challenge') {
                const challenge = MOCK_CHALLENGES.find(c => c.id === id);
                adventureModalTitle.textContent = challenge.title;
                adventureModalContent.innerHTML = `
                    <p class="var(--tg-theme-hint-color) mb-2">${challenge.description}</p>
                    <label for="challenge-input" class="block text-sm font-medium">${challenge.task}</label>
                    <input type="text" id="challenge-input" class="w-full p-2 rounded-lg border mt-1" placeholder="Your answer">
                `;
                adventureModalActionBtn.textContent = "Submit Proof";
                adventureModalActionBtn.onclick = submitChallengeProof;
            }
            adventureModal.classList.remove('hidden');
        }

        function submitAssessmentAnswer() {
            const selectedOption = document.querySelector('input[name="assessmentOption"]:checked');
            if (!selectedOption) {
                alertUser("Please select an answer.", "error");
                return;
            }
            if (!adventureProgress.assessments[currentAdventureContext.id]) {
                adventureProgress.assessments[currentAdventureContext.id] = { completed: false, answers: [] };
            }
            adventureProgress.assessments[currentAdventureContext.id].answers.push(selectedOption.value);
            adventureProgress.assessments[currentAdventureContext.id].completed = true; // Mark as completed after first answer
            setLocalStorage(`dailyVolueenter_adventureProgress_${currentUser.id}`, adventureProgress);
            alertUser("Assessment submitted!", "success");
            closeAdventureModal();
            renderAdventureScreen(); // Re-render to update button states
        }

        function submitChallengeProof() {
            const challengeInput = document.getElementById('challenge-input');
            const challenge = MOCK_CHALLENGES.find(c => c.id === currentAdventureContext.id);
            if (challengeInput.value.trim().toLowerCase() === challenge.solution.toLowerCase()) {
                 if (!adventureProgress.challenges[currentAdventureContext.id]) {
                    adventureProgress.challenges[currentAdventureContext.id] = { completed: false, attempts: [] };
                }
                adventureProgress.challenges[currentAdventureContext.id].completed = true;
                adventureProgress.challenges[currentAdventureContext.id].attempts.push({value: challengeInput.value, correct: true});
                setLocalStorage(`dailyVolueenter_adventureProgress_${currentUser.id}`, adventureProgress);
                alertUser("Challenge completed successfully!", "success");
            } else {
                adventureProgress.challenges[currentAdventureContext.id].attempts.push({value: challengeInput.value, correct: false});
                setLocalStorage(`dailyVolueenter_adventureProgress_${currentUser.id}`, adventureProgress);
                alertUser("Incorrect answer. Try again!", "error");
            }
            closeAdventureModal();
            renderAdventureScreen();
        }
        
        function closeAdventureModal() {
            adventureModal.classList.add('hidden');
            currentAdventureContext = null;
        }

        // --- Chat List & Individual Chat Logic ---
        function renderChatListScreen() {
            chatListContainer.innerHTML = '';
            if (matches.length === 0) {
                noChatsMessage.classList.remove('hidden');
                return;
            }
            noChatsMessage.classList.add('hidden');

            matches.forEach(match => {
                const partner = potentialPartners.find(p => p.id === match.partnerId) || { username: match.partnerName, photo_url: match.partnerPic };
                const lastMessage = match.chatLog && match.chatLog.length > 0 ? match.chatLog[match.chatLog.length - 1] : { text: 'No messages yet.' };
                
                const chatItem = document.createElement('div');
                chatItem.className = 'tg-list-item flex items-center space-x-3 p-3 bg-var(--tg-theme-secondary-bg-color) rounded-lg cursor-pointer hover:opacity-80';
                chatItem.dataset.partnerId = match.partnerId;
                chatItem.innerHTML = `
                    <img src="${partner.photo_url}" alt="${partner.username}" class="profile-pic-md rounded-full object-cover">
                    <div class="flex-grow overflow-hidden">
                        <p class="font-semibold var(--tg-theme-text-color)">@${partner.username}</p>
                        <p class="text-sm var(--tg-theme-hint-color) truncate">${lastMessage.text}</p>
                    </div>
                    ${lastMessage.time ? `<span class="text-xs var(--tg-theme-hint-color)">${new Date(lastMessage.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>` : ''}
                `;
                chatItem.addEventListener('click', () => openChatScreen(match.partnerId));
                chatListContainer.appendChild(chatItem);
            });
        }

        function openChatScreen(partnerId) {
            currentChatPartnerId = partnerId;
            const match = matches.find(m => m.partnerId === partnerId);
            if (!match) return;
            const partner = potentialPartners.find(p => p.id === partnerId) || { username: match.partnerName, photo_url: match.partnerPic };

            chatPartnerPic.src = partner.photo_url;
            chatPartnerName.textContent = `@${partner.username}`;
            renderChatMessages(match.chatLog || []);
            showScreen('screen-chat-individual');
             // Scroll to bottom
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function renderChatMessages(chatLog) {
            chatMessagesContainer.innerHTML = '';
            chatLog.forEach(msg => {
                const messageDiv = document.createElement('div');
                const isCurrentUser = msg.sender === currentUser.id || msg.sender === 'me'; // 'me' for older mock data
                messageDiv.className = `flex mb-2 ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
                messageDiv.innerHTML = `
                    <div class="max-w-[70%] p-2.5 rounded-xl ${isCurrentUser ? 'bg-var(--tg-theme-button-color) text-var(--tg-theme-button-text-color)' : 'bg-var(--tg-theme-secondary-bg-color) text-var(--tg-theme-text-color)'}">
                        <p class="text-sm">${msg.text}</p>
                        <p class="text-xs opacity-70 mt-1 text-right">${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                `;
                chatMessagesContainer.appendChild(messageDiv);
            });
             chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function sendChatMessage() {
            const text = chatMessageInput.value.trim();
            if (!text || !currentChatPartnerId) return;

            const match = matches.find(m => m.partnerId === currentChatPartnerId);
            if (!match) return;

            if (!match.chatLog) match.chatLog = [];
            match.chatLog.push({ sender: currentUser.id, text, time: new Date().toISOString() });
            setLocalStorage(`dailyVolueenter_matches_${currentUser.id}`, matches);
            renderChatMessages(match.chatLog);
            chatMessageInput.value = '';
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
            tg.HapticFeedback.impactOccurred('light');
        }

        // --- Mock Data Generation ---
        function generateMockUsers() {
            const firstNames = ["Alex", "Jamie", "Casey", "Riley", "Jessie", "Morgan", "Taylor", "Jordan", "Drew", "Skyler"];
            const lastNames = ["Smith", "Jones", "Williams", "Brown", "Davis", "Miller", "Wilson", "Moore", "Lee", "Garcia"];
            const bios = [
                "Lover of long walks and deep talks.", "Tech enthusiast and avid reader.", "Always up for an adventure!",
                "Seeking someone to share laughs and life with.", "Creative soul with a passion for art.", "Foodie and travel bug.",
                "Introvert with an extroverted cat.", "Musician looking for a duet partner.", "Fitness fanatic and nature lover."
            ];
            const allTags = ["Travel", "Foodie", "Music", "Art", "Tech", "Books", "Movies", "Sports", "Nature", "Gaming", "Fitness", "Animals", "Photography", "Cooking", "Dancing"];

            for (let i = 0; i < MOCK_USERS_COUNT; i++) {
                const id = `mockuser${i + 1}`;
                if (id === currentUser.id) continue; // Skip current user

                const userTags = [];
                const numTags = Math.floor(Math.random() * 3) + 2; // 2-4 tags
                const availableTags = [...allTags];
                for(let j=0; j<numTags; j++) {
                    if(availableTags.length === 0) break;
                    const tagIndex = Math.floor(Math.random() * availableTags.length);
                    userTags.push(availableTags.splice(tagIndex, 1)[0]);
                }

                potentialPartners.push({
                    id: id,
                    username: `${firstNames[Math.floor(Math.random() * firstNames.length)]}${lastNames[Math.floor(Math.random() * lastNames.length)]}${Math.floor(Math.random()*100)}`.toLowerCase(),
                    photo_url: `https://placehold.co/400x500/${Math.floor(Math.random()*16777215).toString(16)}/${Math.floor(Math.random()*16777215).toString(16)}?text=User${i+1}&font=roboto`,
                    age: Math.floor(Math.random() * 15) + 20, // Age 20-34
                    bio: bios[Math.floor(Math.random() * bios.length)],
                    tags: userTags,
                    profile: { // Mock dailyVolueenter profile data
                        hobbies: 'mock hobby ' + i,
                        passions: 'mock passion ' + i,
                        preferences: Math.random() < 0.5 ? 'Looking for serious' : 'Open to casual',
                        personality: Math.random() < 0.5 ? 'Adventurous' : 'Thoughtful'
                    },
                    acceptsCurrentUser: Math.random() < 0.4 // 40% chance they'd accept current user back (for demo)
                });
            }
        }

        // --- Initialization ---
        function initApp() {
            tg.ready(); // Inform Telegram app is ready
            tg.expand(); // Expand to full height
            applyTelegramTheme();

            // Handle theme changes from Telegram
            tg.onEvent('themeChanged', applyTelegramTheme);
            tg.onEvent('viewportChanged', () => tg.expand()); // Re-expand if viewport changes

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser.id = tg.initDataUnsafe.user.id?.toString() || 'guest_tg_user';
                currentUser.username = tg.initDataUnsafe.user.username || `user${currentUser.id.substring(0,5)}`;
                currentUser.photo_url = tg.initDataUnsafe.user.photo_url || currentUser.photo_url;
            } else {
                // Fallback for environments where SDK might not fully initialize (e.g. desktop browser)
                currentUser.id = 'guest' + Math.floor(Math.random()*10000);
                alertUser("Running in dev mode: Telegram user data not available.");
            }
            
            loadProfileData();
            swipeHistory = getLocalStorage(`dailyVolueenter_swipeHistory_${currentUser.id}`, { accepted: [], rejected: [] });
            matches = getLocalStorage(`dailyVolueenter_matches_${currentUser.id}`, []);
            adventureProgress = getLocalStorage(`dailyVolueenter_adventureProgress_${currentUser.id}`, { assessments: {}, challenges: {} });

            generateMockUsers();
            loadPotentialPartners(); // Initial load for swipe screen

            // Event Listeners
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const screenId = button.dataset.screen;
                    showScreen(screenId);
                    if (screenId === 'screen-swipe') loadPotentialPartners(); // Refresh swipe screen
                    if (screenId === 'screen-history') renderHistoryScreen();
                    if (screenId === 'screen-chat-list') renderChatListScreen();
                    if (screenId === 'screen-adventure') renderAdventureScreen();
                });
            });

            saveProfileBtn.addEventListener('click', saveProfile);
            rejectBtn.addEventListener('click', () => handleSwipe('reject'));
            acceptBtn.addEventListener('click', () => handleSwipe('accept'));

            historyTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    historyTabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeHistoryTab = btn.dataset.tab;
                    renderHistoryScreen();
                });
            });
            
            chatSendBtn.addEventListener('click', sendChatMessage);
            chatMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            chatBackBtn.addEventListener('click', () => showScreen('screen-chat-list'));

            adventureModalCloseBtn.addEventListener('click', closeAdventureModal);

            // Set initial screen
            showScreen('screen-swipe');
        }

        // Start the app
        initApp();

    </script>
</body>
</html>
