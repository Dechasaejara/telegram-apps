<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Food Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Custom Tailwind Configuration
        tailwind.config = {
            darkMode: 'class', // Enables dark mode based on class
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--tg-theme-button-color, #5D5CDE)', // Use Telegram button color as primary
                        'primary-dark': 'var(--tg-theme-button-color, #4A49B7)', // Darker shade or same
                        'telegram': 'var(--tg-theme-link-color, #0088cc)', // Use Telegram link color
                        'telegram-dark': 'var(--tg-theme-link-color, #0077b5)', // Darker shade or same
                        'yellow-rating': '#FFCA28',
                        'tg-bg': 'var(--tg-theme-bg-color, #F0F0F0)',
                        'tg-text': 'var(--tg-theme-text-color, #000000)',
                        'tg-hint': 'var(--tg-theme-hint-color, #999999)',
                        'tg-secondary-bg': 'var(--tg-theme-secondary-bg-color, #FFFFFF)',
                    },
                    spacing: {
                        '128': '32rem',
                    }
                }
            }
        }
    </script>
    <style>
        /* Apply Telegram theme variables as CSS custom properties for broader use */
        :root {
            --tg-theme-bg-color: #ffffff; /* Default light bg */
            --tg-theme-text-color: #000000; /* Default light text */
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #0088cc;
            --tg-theme-button-color: #0088cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
            --tg-header-color: #ffffff; /* For sticky header */
        }

        /* Basic body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh in Mini App */
        }

        /* Custom scrollbar to match Telegram's subtle style */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-hint-color, #888);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--tg-theme-text-color, #555);
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* For IE and Edge */
            scrollbar-width: none;  /* For Firefox */
        }

        /* Modal styles */
        .modal {
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal-content {
            transform: scale(0.95) translateY(20px);
            transition: transform 0.2s ease, opacity 0.2s ease;
            opacity: 0;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal.active .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Rating stars */
        .rating-stars { display: inline-flex; direction: rtl; }
        .rating-stars input { display: none; }
        .rating-stars label { cursor: pointer; color: var(--tg-theme-hint-color); transition: color 0.2s; font-size: 1.5rem; padding: 0 0.1rem;}
        .rating-stars label:hover,
        .rating-stars label:hover ~ label,
        .rating-stars input:checked ~ label { color: #FFCA28; } /* yellow-rating */

        /* Image effects */
        .restaurant-image img { transition: transform 0.3s ease; }
        .restaurant-image:hover img { transform: scale(1.05); }

        /* Animations */
        @keyframes slideInFromBottom {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .restaurant-card { animation: slideInFromBottom 0.3s ease forwards; opacity: 0; }
        .restaurant-card:nth-child(1) { animation-delay: 0.05s; }
        .restaurant-card:nth-child(2) { animation-delay: 0.1s; }
        .restaurant-card:nth-child(3) { animation-delay: 0.15s; }
        /* Add more if needed or handle dynamically */

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--tg-theme-secondary-bg-color) 25%, var(--tg-theme-hint-color) 50%, var(--tg-theme-secondary-bg-color) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            opacity: 0.5;
        }
        .dark .skeleton { /* This will be handled by Telegram's theme variables */
             background: linear-gradient(90deg, var(--tg-theme-secondary-bg-color) 25%, var(--tg-theme-hint-color) 50%, var(--tg-theme-secondary-bg-color) 75%);
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Ensure sticky header uses Telegram theme */
        header.sticky {
            background-color: var(--tg-header-color); /* Use a specific var for header if needed, or secondary-bg */
        }

        /* Style for filter buttons to use Telegram button colors */
        .filter-btn.active {
            background-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-button-text-color) !important;
        }
        .filter-btn {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
        }
        .filter-btn:hover {
            opacity: 0.8;
        }
        
        /* Input styling to match Telegram */
        input[type="text"], textarea {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 0 0 2px var(--tg-theme-button-color);
        }
        
        /* Button styling to use Telegram button colors */
        .tg-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            transition: opacity 0.2s;
        }
        .tg-button:hover {
            opacity: 0.85;
        }
        .tg-button-secondary {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-button-color); /* Or text_color */
            border: 1px solid var(--tg-theme-button-color);
        }
        .tg-button-secondary:hover {
            opacity: 0.85;
        }

    </style>
</head>
<body class="min-h-screen transition-colors duration-200">
    <div id="app">
        <div id="main-screen" class="block">
            <header class="shadow-md sticky top-0 z-20" style="background-color: var(--tg-header-color);">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold" style="color: var(--tg-theme-text-color);">Food Finder</h1>
                        <div class="flex items-center">
                            <div id="location-display" class="flex items-center text-sm mr-2" style="color: var(--tg-theme-hint-color);">
                                <i class="fas fa-location-dot mr-1" style="color: var(--tg-theme-button-color);"></i>
                                <span id="current-location">Loading location...</span>
                            </div>
                            <button id="refresh-location" class="p-2" style="color: var(--tg-theme-button-color);">
                                <i class="fas fa-arrow-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative mt-2">
                        <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2 rounded-full text-base focus:outline-none" placeholder="Search restaurants, cuisines...">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--tg-theme-hint-color);"></i>
                    </div>
                    
                    <div id="category-filters-container" class="flex space-x-2 mt-3 pb-1 overflow-x-auto hide-scrollbar">
                        </div>
                </div>
            </header>
            
            <div class="container mx-auto px-4 py-4">
                <div id="restaurant-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="skeleton-card rounded-lg shadow-md overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color);"> <div class="skeleton h-48 w-full"></div> <div class="p-4"> <div class="skeleton h-6 w-3/4 rounded mb-2"></div> <div class="skeleton h-4 w-1/2 rounded mb-3"></div> <div class="skeleton h-4 w-full rounded mb-2"></div> <div class="skeleton h-4 w-2/3 rounded"></div> </div> </div>
                    <div class="skeleton-card rounded-lg shadow-md overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color);"> <div class="skeleton h-48 w-full"></div> <div class="p-4"> <div class="skeleton h-6 w-3/4 rounded mb-2"></div> <div class="skeleton h-4 w-1/2 rounded mb-3"></div> <div class="skeleton h-4 w-full rounded mb-2"></div> <div class="skeleton h-4 w-2/3 rounded"></div> </div> </div>
                    <div class="skeleton-card rounded-lg shadow-md overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color);"> <div class="skeleton h-48 w-full"></div> <div class="p-4"> <div class="skeleton h-6 w-3/4 rounded mb-2"></div> <div class="skeleton h-4 w-1/2 rounded mb-3"></div> <div class="skeleton h-4 w-full rounded mb-2"></div> <div class="skeleton h-4 w-2/3 rounded"></div> </div> </div>
                </div>
                
                <div id="no-results" class="hidden text-center py-8">
                    <i class="fas fa-utensils text-4xl mb-3" style="color: var(--tg-theme-hint-color);"></i>
                    <p style="color: var(--tg-theme-hint-color);">No restaurants found.</p>
                    <button id="clear-filters-main" class="mt-2 tg-button px-3 py-1 rounded-md text-sm">Clear Filters</button>
                </div>
            </div>
        </div>
        
        <div id="detail-screen" class="hidden">
            <div class="relative">
                <div id="restaurant-cover" class="h-48 md:h-60 bg-gray-300 bg-center bg-cover" style="background-color: var(--tg-theme-secondary-bg-color);">
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 text-white">
                    <h1 id="detail-name" class="text-2xl font-bold mb-1">Restaurant Name</h1>
                    <div class="flex items-center text-sm">
                        <div id="detail-rating-stars" class="flex items-center mr-3">
                            </div>
                        <span id="detail-rating-text" class="mr-3"></span>
                        <div id="detail-cuisine" class="opacity-90">Cuisine</div>
                    </div>
                </div>
            </div>
            
            <div class="container mx-auto px-4 py-4">
                <div class="rounded-lg shadow-md p-4 mb-4" style="background-color: var(--tg-theme-secondary-bg-color);">
                    <div class="flex flex-wrap gap-x-6 gap-y-3 mb-3 text-sm">
                        <div class="flex items-center">
                            <i class="fas fa-location-dot mr-2" style="color: var(--tg-theme-button-color);"></i>
                            <span id="detail-distance">Loading...</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2" style="color: var(--tg-theme-button-color);"></i>
                            <span id="detail-hours">Loading...</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-phone mr-2" style="color: var(--tg-theme-button-color);"></i>
                            <a id="detail-phone" href="tel:" style="color: var(--tg-theme-link-color);">Loading...</a>
                        </div>
                    </div>
                    <p id="detail-description" class="mb-4" style="color: var(--tg-theme-text-color);"></p>
                    <div class="flex space-x-2">
                        <button id="share-restaurant" class="flex-1 tg-button py-2 px-4 rounded-md flex justify-center items-center text-sm">
                            <i class="fas fa-share-alt mr-2"></i>Share
                        </button>
                        <button id="view-location" class="flex-1 tg-button py-2 px-4 rounded-md flex justify-center items-center text-sm">
                            <i class="fas fa-map-marker-alt mr-2"></i>View Map
                        </button>
                    </div>
                </div>
                
                <div class="rounded-lg shadow-md p-4 mb-4" style="background-color: var(--tg-theme-secondary-bg-color);">
                    <h2 class="text-xl font-bold mb-3" style="color: var(--tg-theme-text-color);">Menu</h2>
                    <div id="menu-categories" class="flex space-x-2 mb-3 overflow-x-auto pb-1 hide-scrollbar">
                        </div>
                    <div id="menu-items" class="space-y-3">
                        </div>
                </div>
                
                <div class="rounded-lg shadow-md p-4 mb-4" style="background-color: var(--tg-theme-secondary-bg-color);">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold" style="color: var(--tg-theme-text-color);">Reviews (<span id="review-count">0</span>)</h2>
                        <button id="add-review" class="tg-button py-1 px-3 rounded-md text-sm">
                            Write a Review
                        </button>
                    </div>
                    <div id="review-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="review-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible">
            <div class="modal-content rounded-lg shadow-lg max-w-md w-11/12 mx-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" style="color: var(--tg-theme-text-color);">Write a Review</h3>
                        <button class="close-modal-btn text-2xl" style="color: var(--tg-theme-hint-color);">&times;</button>
                    </div>
                    <form id="review-form">
                        <input type="hidden" id="review-restaurant-id">
                        
                        <div class="mb-4 text-center">
                            <div class="text-sm mb-1" style="color: var(--tg-theme-text-color);">Rate your experience</div>
                            <div class="rating-stars">
                                <input type="radio" id="star5" name="rating" value="5" required/><label for="star5"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star4" name="rating" value="4" /><label for="star4"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star3" name="rating" value="3" /><label for="star3"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star2" name="rating" value="2" /><label for="star2"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star1" name="rating" value="1" /><label for="star1"><i class="fas fa-star"></i></label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="review-title" class="block text-sm font-medium mb-1" style="color: var(--tg-theme-text-color);">Title</label>
                            <input type="text" id="review-title" class="w-full px-3 py-2 border rounded-md text-base focus:outline-none" required placeholder="Summarize your experience">
                        </div>
                        
                        <div class="mb-6">
                            <label for="review-text" class="block text-sm font-medium mb-1" style="color: var(--tg-theme-text-color);">Your Review</label>
                            <textarea id="review-text" rows="3" class="w-full px-3 py-2 border rounded-md text-base focus:outline-none" required placeholder="Tell others about your experience"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="close-modal-btn tg-button-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
                            <button type="submit" class="tg-button px-4 py-2 rounded-lg text-sm">Submit Review</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Telegram WebApp SDK ---
    const tg = window.Telegram.WebApp;

    // --- App State ---
    const appState = {
        userLocation: null, // { latitude, longitude }
        currentRestaurantId: null,
        userProfile: { // Will be populated by Telegram data
            id: null,
            name: 'Guest',
            photo: 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=U'
        },
        restaurants: [], // Full list of restaurants
        reviews: [],     // Full list of reviews
        activeFilter: 'all',
        searchQuery: '',
        activeMenuCategory: 'all',
        isLoading: true,
    };

    // --- DOM Elements ---
    const mainScreen = document.getElementById('main-screen');
    const detailScreen = document.getElementById('detail-screen');
    const reviewModal = document.getElementById('review-modal');
    const restaurantListEl = document.getElementById('restaurant-list');
    const currentLocationEl = document.getElementById('current-location');
    const noResultsEl = document.getElementById('no-results');
    const categoryFiltersContainerEl = document.getElementById('category-filters-container');
    const searchInputEl = document.getElementById('search-input');
    // Detail Screen Elements
    const detailNameEl = document.getElementById('detail-name');
    const detailRatingStarsEl = document.getElementById('detail-rating-stars');
    const detailRatingTextEl = document.getElementById('detail-rating-text');
    const detailCuisineEl = document.getElementById('detail-cuisine');
    const detailDistanceEl = document.getElementById('detail-distance');
    const detailHoursEl = document.getElementById('detail-hours');
    const detailPhoneEl = document.getElementById('detail-phone');
    const detailDescriptionEl = document.getElementById('detail-description');
    const restaurantCoverEl = document.getElementById('restaurant-cover');
    const menuCategoriesEl = document.getElementById('menu-categories');
    const menuItemsEl = document.getElementById('menu-items');
    const reviewListEl = document.getElementById('review-list');
    const reviewCountEl = document.getElementById('review-count');
    // Review Modal Elements
    const reviewFormEl = document.getElementById('review-form');
    const reviewRestaurantIdInput = document.getElementById('review-restaurant-id');
    const reviewTitleInput = document.getElementById('review-title');
    const reviewTextInput = document.getElementById('review-text');


    // --- Telegram SDK Integration Functions ---
    function applyTelegramTheme(themeParams) {
        const root = document.documentElement;
        root.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#ffffff');
        root.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#000000');
        root.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#999999');
        root.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#0088cc');
        root.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#0088cc');
        root.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
        root.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#f0f0f0');
        
        // For sticky header, try to use secondary_bg_color or bg_color if it's distinct enough
        // This is a heuristic, might need adjustment based on typical Telegram themes
        let headerColor = themeParams.secondary_bg_color;
        if (headerColor === themeParams.bg_color || !headerColor) { // If secondary is same as main bg or not defined
             // A simple check to see if bg_color is very dark. If so, use a slightly lighter shade for header or a fixed light color.
            const isDarkBg = themeParams.bg_color && themeParams.bg_color.startsWith('#') && parseInt(themeParams.bg_color.substring(1, 3), 16) < 60; // very rough check
            headerColor = isDarkBg ? '#2c2c2c' : '#ffffff'; // Example fixed colors if heuristic is complex
        }
         root.style.setProperty('--tg-header-color', headerColor || themeParams.bg_color || '#ffffff');


        if (themeParams.bg_color) {
            const body = document.body;
            // Determine if the theme is dark
            // A common heuristic: if the background color is dark, assume dark theme.
            // This is simplified; Telegram might use a more complex logic or a direct property.
            const color = themeParams.bg_color.replace('#', '');
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            if (brightness < 128) { // Arbitrary threshold for darkness
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        // Force a re-render or update of components that depend on these CSS variables if necessary
        // For Tailwind, it should mostly pick up changes to CSS variables if used in `tailwind.config.js` correctly.
    }

    function setupTelegramFeatures() {
        tg.expand(); // Expand the Mini App
        tg.MainButton.hide(); // Hide by default, show when contextually relevant
        tg.BackButton.onClick(goBackToMainScreen); // Set back button action

        // Apply initial theme
        if (tg.themeParams) {
            applyTelegramTheme(tg.themeParams);
        }
        // Listen for theme changes
        tg.onEvent('themeChanged', () => applyTelegramTheme(tg.themeParams));
        tg.onEvent('viewportChanged', (event) => {
            if (!event.isStateStable) { // if false, the viewport is still changing
                // handle intermediate state if needed
            } else { // if true, the viewport is now stable
                // final handling, e.g. re-layout if necessary
            }
        });


        // Populate user profile from Telegram
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const tgUser = tg.initDataUnsafe.user;
            appState.userProfile.id = tgUser.id;
            appState.userProfile.name = `${tgUser.first_name}${tgUser.last_name ? ' ' + tgUser.last_name : ''}`;
            appState.userProfile.photo = tgUser.photo_url || appState.userProfile.photo;
        }
    }
    
    // --- Utility Functions ---
    function showLoadingSkeletons(count = 3) {
        restaurantListEl.innerHTML = ''; // Clear previous content
        noResultsEl.classList.add('hidden');
        for (let i = 0; i < count; i++) {
            const skeletonCard = `
                <div class="skeleton-card rounded-lg shadow-md overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color);">
                    <div class="skeleton h-48 w-full"></div>
                    <div class="p-4">
                        <div class="skeleton h-6 w-3/4 rounded mb-2"></div>
                        <div class="skeleton h-4 w-1/2 rounded mb-3"></div>
                        <div class="skeleton h-4 w-full rounded mb-2"></div>
                        <div class="skeleton h-4 w-2/3 rounded"></div>
                    </div>
                </div>`;
            restaurantListEl.innerHTML += skeletonCard;
        }
    }

    function hideLoadingSkeletons() {
        const skeletons = restaurantListEl.querySelectorAll('.skeleton-card');
        // If actual content will replace skeletons, just clearing innerHTML is fine.
        // If they need to be hidden before content is ready, then:
        // skeletons.forEach(sk => sk.classList.add('hidden'));
    }

    // --- Data Loading and Processing ---
    function loadSampleData() { // Simulates fetching data
        appState.isLoading = true;
        showLoadingSkeletons(6); // Show more skeletons for initial load

        return new Promise(resolve => {
            setTimeout(() => {
                // Sample data (similar to what user provided, but expanded)
                appState.restaurants = [
                    { id: 1, name: "The Burger Joint", cuisine: "Fast Food", cuisineType: "fastfood", description: "Classic American burgers, fries, and shakes.", distance: 0.5, rating: 4.5, reviewCount: 150, hours: "10:00 AM - 11:00 PM", phone: "+15550100", image: "https://placehold.co/600x400/FFDDC1/333333?text=Burger+Joint", location: { lat: 38.8951, lng: -77.0364 }, menu: [{ category: "Burgers", items: [{ name: "Classic Burger", price: 8.99, description: "Beef patty, lettuce, tomato, onion, pickles."},{ name: "Cheese Burger", price: 9.99, description: "Classic with cheese."}]},{ category: "Sides", items: [{ name: "Fries", price: 3.50, description: "Crispy golden fries."}]}]},
                    { id: 2, name: "Pasta Palace", cuisine: "Italian", cuisineType: "italian", description: "Authentic Italian pasta dishes and pizzas.", distance: 1.2, rating: 4.8, reviewCount: 210, hours: "11:00 AM - 10:00 PM", phone: "+15550101", image: "https://placehold.co/600x400/C1FFD7/333333?text=Pasta+Palace", location: { lat: 38.8977, lng: -77.0365 }, menu: [{ category: "Pasta", items: [{ name: "Spaghetti Carbonara", price: 15.00, description: "Creamy and delicious."},{ name: "Lasagna", price: 16.50, description: "Layered perfection."}]},{ category: "Pizza", items: [{ name: "Margherita", price: 12.00, description: "Classic tomato and mozzarella."}]}]},
                    { id: 3, name: "Sushi Central", cuisine: "Japanese", cuisineType: "asian", description: "Fresh sushi and sashimi, vibrant atmosphere.", distance: 2.1, rating: 4.6, reviewCount: 180, hours: "12:00 PM - 10:00 PM", phone: "+15550102", image: "https://placehold.co/600x400/C1D4FF/333333?text=Sushi+Central", location: { lat: 38.9000, lng: -77.0400 }, menu: [{ category: "Sushi Rolls", items: [{ name: "California Roll", price: 7.00},{ name: "Spicy Tuna Roll", price: 8.50}]},{ category: "Nigiri", items: [{ name: "Salmon Nigiri", price: 3.00},{ name: "Tuna Nigiri", price: 3.50}]}]},
                    { id: 4, name: "Morning Brew Cafe", cuisine: "Café", cuisineType: "cafe", description: "Cozy spot for coffee, pastries, and light meals.", distance: 0.8, rating: 4.3, reviewCount: 95, hours: "07:00 AM - 06:00 PM", phone: "+15550103", image: "https://placehold.co/600x400/FFF0C1/333333?text=Morning+Brew", location: { lat: 38.8920, lng: -77.0300 }, menu: [{ category: "Coffee", items: [{ name: "Espresso", price: 3.00},{ name: "Latte", price: 4.50}]},{ category: "Pastries", items: [{ name: "Croissant", price: 3.25},{ name: "Muffin", price: 3.00}]}]},
                    { id: 5, name: "Sweet Escape Desserts", cuisine: "Desserts", cuisineType: "desserts", description: "Indulgent cakes, ice creams, and sweet treats.", distance: 1.5, rating: 4.9, reviewCount: 120, hours: "11:00 AM - 09:00 PM", phone: "+15550104", image: "https://placehold.co/600x400/FFC1F5/333333?text=Sweet+Escape", location: { lat: 38.8985, lng: -77.0321 }, menu: [{ category: "Cakes", items: [{ name: "Chocolate Lava Cake", price: 7.50},{ name: "Cheesecake Slice", price: 6.50}]},{ category: "Ice Cream", items: [{ name: "Vanilla Bean Scoop", price: 4.00},{ name: "Strawberry Swirl", price: 4.50}]}]},
                    { id: 6, name: "Curry House", cuisine: "Indian", cuisineType: "asian", description: "Flavorful Indian curries and tandoori specialties.", distance: 3.0, rating: 4.7, reviewCount: 190, hours: "11:30 AM - 10:30 PM", phone: "+15550105", image: "https://placehold.co/600x400/FFDAB9/333333?text=Curry+House", location: { lat: 38.8940, lng: -77.0380 }, menu: [{ category: "Curries", items: [{ name: "Chicken Tikka Masala", price: 15.99},{ name: "Vegetable Korma", price: 13.99}]},{ category: "Breads", items: [{ name: "Naan", price: 3.00},{ name: "Garlic Naan", price: 3.50}]}]}
                ];
                appState.reviews = [
                    { id: 1, restaurantId: 1, userId: "user123", userName: "Alice Wonderland", userPhoto: "https://placehold.co/40x40/A0C4FF/333333?text=AW", rating: 5, title: "Best Burgers!", text: "The classic burger was juicy and delicious. Fries were perfect too!", date: new Date('2024-05-20T10:00:00Z') },
                    { id: 2, restaurantId: 1, userId: "user456", userName: "Bob The Builder", userPhoto: "https://placehold.co/40x40/FFB3BA/333333?text=BB", rating: 4, title: "Good stuff", text: "Quick service and tasty food. A bit crowded though.", date: new Date('2024-05-18T14:30:00Z') },
                    { id: 3, restaurantId: 2, userId: "user123", userName: "Alice Wonderland", userPhoto: "https://placehold.co/40x40/A0C4FF/333333?text=AW", rating: 5, title: "Authentic Italian", text: "Loved the Carbonara! Felt like I was in Italy.", date: new Date('2024-05-22T19:00:00Z') },
                ];
                appState.isLoading = false;
                resolve();
            }, 1000); // Simulate network delay
        });
    }

    // --- Rendering Functions ---
    function renderRatingStars(rating, container) {
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('i');
            star.classList.add('fas', 'fa-star', 'text-sm');
            star.style.color = i <= rating ? '#FFCA28' : 'var(--tg-theme-hint-color)';
            container.appendChild(star);
        }
    }

    function renderRestaurantCard(restaurant) {
        const card = document.createElement('div');
        card.className = 'restaurant-card rounded-lg shadow-lg overflow-hidden cursor-pointer transition-all duration-200 hover:shadow-xl';
        card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color)';
        card.addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('light');
            showDetailScreen(restaurant.id);
        });

        let avgRating = restaurant.rating;
        let numReviews = restaurant.reviewCount;
        // If reviews are in appState, calculate from there
        const restaurantReviews = appState.reviews.filter(r => r.restaurantId === restaurant.id);
        if (restaurantReviews.length > 0) {
            avgRating = restaurantReviews.reduce((sum, r) => sum + r.rating, 0) / restaurantReviews.length;
            numReviews = restaurantReviews.length;
        }


        card.innerHTML = `
            <div class="restaurant-image h-48 w-full overflow-hidden">
                <img src="${restaurant.image}" alt="${restaurant.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/969696?text=Image+Error';">
            </div>
            <div class="p-4">
                <h3 class="text-lg font-semibold mb-1 truncate" style="color: var(--tg-theme-text-color);">${restaurant.name}</h3>
                <div class="flex items-center text-xs mb-2" style="color: var(--tg-theme-hint-color);">
                    <div class="flex items-center mr-2">
                        ${[...Array(5)].map((_, i) => `<i class="fas fa-star ${i < Math.round(avgRating) ? 'text-yellow-rating' : 'text-gray-300 dark:text-gray-600'}"></i>`).join('')}
                    </div>
                    <span>${avgRating.toFixed(1)} (${numReviews} reviews)</span>
                </div>
                <p class="text-xs mb-1 truncate" style="color: var(--tg-theme-hint-color);">${restaurant.cuisine}</p>
                <p class="text-xs" style="color: var(--tg-theme-hint-color);"><i class="fas fa-location-dot text-xs mr-1" style="color: var(--tg-theme-button-color);"></i>${restaurant.distance} km away</p>
            </div>
        `;
        return card;
    }

    function renderRestaurantList() {
        restaurantListEl.innerHTML = ''; // Clear skeletons or previous items
        const query = appState.searchQuery.toLowerCase();
        const filteredRestaurants = appState.restaurants.filter(r => {
            const matchesCategory = appState.activeFilter === 'all' || r.cuisineType === appState.activeFilter;
            const matchesSearch = !query || r.name.toLowerCase().includes(query) || r.cuisine.toLowerCase().includes(query);
            return matchesCategory && matchesSearch;
        });

        if (filteredRestaurants.length === 0) {
            noResultsEl.classList.remove('hidden');
        } else {
            noResultsEl.classList.add('hidden');
            filteredRestaurants.forEach(r => {
                restaurantListEl.appendChild(renderRestaurantCard(r));
            });
        }
    }
    
    function renderCategoryFilters() {
        categoryFiltersContainerEl.innerHTML = '';
        const categories = ['all', ...new Set(appState.restaurants.map(r => r.cuisineType))];
        
        categories.forEach(cat => {
            const button = document.createElement('button');
            button.className = 'filter-btn whitespace-nowrap px-3 py-1.5 rounded-full text-sm font-medium transition-colors';
            button.dataset.filter = cat;
            button.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            if (cat === appState.activeFilter) {
                button.classList.add('active');
            }
            button.addEventListener('click', () => {
                tg.HapticFeedback.impactOccurred('light');
                appState.activeFilter = cat;
                document.querySelectorAll('#category-filters-container .filter-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderRestaurantList();
            });
            categoryFiltersContainerEl.appendChild(button);
        });
    }

    function renderRestaurantDetail(restaurant) {
        appState.currentRestaurantId = restaurant.id;
        detailNameEl.textContent = restaurant.name;
        restaurantCoverEl.style.backgroundImage = `url(${restaurant.image})`;
        
        const restaurantReviews = appState.reviews.filter(r => r.restaurantId === restaurant.id);
        const avgRating = restaurantReviews.length > 0 ? (restaurantReviews.reduce((sum, r) => sum + r.rating, 0) / restaurantReviews.length) : restaurant.rating;
        const numReviews = restaurantReviews.length > 0 ? restaurantReviews.length : restaurant.reviewCount;

        renderRatingStars(avgRating, detailRatingStarsEl);
        detailRatingTextEl.textContent = `${avgRating.toFixed(1)} (${numReviews} reviews)`;

        detailCuisineEl.textContent = restaurant.cuisine;
        detailDistanceEl.textContent = `${restaurant.distance} km away`; // Potentially calculate actual distance if userLocation is available
        detailHoursEl.textContent = restaurant.hours;
        detailPhoneEl.textContent = restaurant.phone;
        detailPhoneEl.href = `tel:${restaurant.phone}`;
        detailDescriptionEl.textContent = restaurant.description;

        // Render Menu
        menuCategoriesEl.innerHTML = '';
        menuItemsEl.innerHTML = '';
        const menuCats = ['all', ...new Set(restaurant.menu.map(mc => mc.category))];
        appState.activeMenuCategory = 'all';

        menuCats.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn whitespace-nowrap px-3 py-1 rounded-full text-xs';
            btn.textContent = cat;
            btn.dataset.category = cat;
            if (cat === 'all') btn.classList.add('active');
            btn.addEventListener('click', () => {
                tg.HapticFeedback.impactOccurred('light');
                appState.activeMenuCategory = cat;
                document.querySelectorAll('#menu-categories .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderMenuItemsForDetail(restaurant);
            });
            menuCategoriesEl.appendChild(btn);
        });
        renderMenuItemsForDetail(restaurant);
        renderReviewList(restaurant.id);
    }

    function renderMenuItemsForDetail(restaurant) {
        menuItemsEl.innerHTML = '';
        restaurant.menu.forEach(menuCategory => {
            if (appState.activeMenuCategory === 'all' || menuCategory.category === appState.activeMenuCategory) {
                if (appState.activeMenuCategory !== 'all') { // Show category title if not 'all'
                    const catTitle = document.createElement('h4');
                    catTitle.className = 'text-md font-semibold mt-3 mb-1';
                    catTitle.textContent = menuCategory.category;
                    catTitle.style.color = 'var(--tg-theme-text-color)';
                    menuItemsEl.appendChild(catTitle);
                }
                menuCategory.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'py-2 border-b';
                    itemDiv.style.borderColor = 'var(--tg-theme-hint-color)';
                    itemDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h5 class="font-medium" style="color: var(--tg-theme-text-color);">${item.name}</h5>
                            <span class="font-semibold" style="color: var(--tg-theme-text-color);">$${item.price.toFixed(2)}</span>
                        </div>
                        ${item.description ? `<p class="text-xs mt-1" style="color: var(--tg-theme-hint-color);">${item.description}</p>` : ''}
                    `;
                    menuItemsEl.appendChild(itemDiv);
                });
            }
        });
    }

    function renderReviewList(restaurantId) {
        reviewListEl.innerHTML = '';
        const reviews = appState.reviews.filter(r => r.restaurantId === restaurantId)
                                     .sort((a,b) => b.date - a.date); // Newest first
        reviewCountEl.textContent = reviews.length;

        if (reviews.length === 0) {
            reviewListEl.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--tg-theme-hint-color);">No reviews yet. Be the first!</p>`;
            return;
        }
        reviews.forEach(review => {
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'py-3 border-b';
            reviewDiv.style.borderColor = 'var(--tg-theme-hint-color)';
            reviewDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${review.userPhoto}" alt="${review.userName}" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <div class="flex items-center mb-0.5">
                            <h5 class="font-semibold text-sm mr-2" style="color: var(--tg-theme-text-color);">${review.userName}</h5>
                            <div class="flex items-center">
                                ${[...Array(5)].map((_, i) => `<i class="fas fa-star text-xs ${i < review.rating ? 'text-yellow-rating' : ''}" style="${i < review.rating ? '' : 'color: var(--tg-theme-hint-color);'}"></i>`).join('')}
                            </div>
                        </div>
                        <p class="text-xs mb-1" style="color: var(--tg-theme-hint-color);">${new Date(review.date).toLocaleDateString()}</p>
                        <h6 class="font-medium text-sm mb-1" style="color: var(--tg-theme-text-color);">${review.title}</h6>
                        <p class="text-sm" style="color: var(--tg-theme-text-color);">${review.text}</p>
                    </div>
                </div>
            `;
            reviewListEl.appendChild(reviewDiv);
        });
    }

    // --- Navigation and Modal Logic ---
    function showMainScreen() {
        mainScreen.classList.remove('hidden');
        detailScreen.classList.add('hidden');
        tg.BackButton.hide();
        tg.MainButton.hide(); // Or set MainButton for main screen context
        appState.currentRestaurantId = null;
        // Potentially refresh list if data could have changed
        // renderRestaurantList(); 
    }

    function showDetailScreen(restaurantId) {
        const restaurant = appState.restaurants.find(r => r.id === restaurantId);
        if (!restaurant) {
            tg.showAlert('Restaurant not found!');
            return;
        }
        mainScreen.classList.add('hidden');
        detailScreen.classList.remove('hidden');
        renderRestaurantDetail(restaurant);
        tg.BackButton.show();
        // Example: Use MainButton to "Book Table" or "Order"
        // tg.MainButton.setText('Book a Table (Not Impl.)');
        // tg.MainButton.show();
        // tg.MainButton.onClick(() => tg.showAlert(`Booking for ${restaurant.name} (Not Implemented)`));
        window.scrollTo(0, 0); // Scroll to top of detail view
    }
    
    function goBackToMainScreen() { // Called by Telegram BackButton
        tg.HapticFeedback.impactOccurred('light');
        showMainScreen();
    }

    function showReviewModal() {
        if (!appState.currentRestaurantId) return;
        tg.HapticFeedback.impactOccurred('medium');
        reviewRestaurantIdInput.value = appState.currentRestaurantId;
        reviewFormEl.reset(); // Clear previous input
        // Reset stars
        document.querySelectorAll('.rating-stars input').forEach(input => input.checked = false);

        reviewModal.classList.add('active');
    }

    function hideReviewModal() {
        reviewModal.classList.remove('active');
    }

    // --- Event Handlers ---
    function handleSearch(event) {
        appState.searchQuery = event.target.value;
        // Debounce rendering for better performance if needed
        renderRestaurantList();
    }

    function handleReviewSubmit(event) {
        event.preventDefault();
        tg.HapticFeedback.notificationOccurred('success');
        const newReview = {
            id: Date.now(), // Simple unique ID
            restaurantId: parseInt(reviewRestaurantIdInput.value),
            userId: appState.userProfile.id,
            userName: appState.userProfile.name,
            userPhoto: appState.userProfile.photo,
            rating: parseInt(event.target.rating.value),
            title: reviewTitleInput.value,
            text: reviewTextInput.value,
            date: new Date()
        };
        appState.reviews.push(newReview);
        // In a real app, send to backend here
        hideReviewModal();
        renderReviewList(newReview.restaurantId); // Re-render reviews for current restaurant
        // Update rating on main list if needed (more complex, requires re-rendering list or updating specific card)
        const restaurant = appState.restaurants.find(r => r.id === newReview.restaurantId);
        if(restaurant) { // Update the main restaurant object's review count and potentially rating for card display
            const restaurantReviews = appState.reviews.filter(r => r.restaurantId === restaurant.id);
            restaurant.rating = restaurantReviews.reduce((sum, r) => sum + r.rating, 0) / restaurantReviews.length;
            restaurant.reviewCount = restaurantReviews.length;
            renderRestaurantList(); // Re-render the whole list to reflect new average rating on cards
        }

        tg.showPopup({
            title: 'Review Submitted!',
            message: 'Thank you for your feedback.',
            buttons: [{ type: 'ok' }]
        });
    }
    
    function shareRestaurant() {
        if (!appState.currentRestaurantId) return;
        const restaurant = appState.restaurants.find(r => r.id === appState.currentRestaurantId);
        if (!restaurant) return;

        tg.HapticFeedback.impactOccurred('light');
        // For a real app, this URL should point to your Mini App with params to open this specific restaurant
        const shareUrl = `https://t.me/${tg.initDataUnsafe.bot_username || 'your_bot_username'}/${tg.WebApp.appName}?startapp=restaurant-${restaurant.id}`;
        const text = `Check out ${restaurant.name} on Food Finder! Great ${restaurant.cuisine}.`;

        try {
            // Try using the Web Share API if available and not in Telegram context (for local testing)
            if (navigator.share) {
                 navigator.share({
                    title: restaurant.name,
                    text: text,
                    url: shareUrl,
                });
            } else {
                // Fallback to Telegram's way of sharing
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`);
            }
        } catch (e) {
            tg.showAlert('Sharing failed. You can manually copy the link.');
            console.error("Share error: ", e);
        }
    }

    function viewRestaurantLocation() {
        if (!appState.currentRestaurantId) return;
        const restaurant = appState.restaurants.find(r => r.id === appState.currentRestaurantId);
        if (!restaurant || !restaurant.location) {
            tg.showAlert('Location data not available for this restaurant.');
            return;
        }
        tg.HapticFeedback.impactOccurred('light');
        // tg.openLink(`https://www.google.com/maps?q=${restaurant.location.lat},${restaurant.location.lng}`);
        // More native: request to show point on map
        try {
            tg.showMap(restaurant.location.lat, restaurant.location.lng);
        } catch (e) {
            // Fallback if showMap is not available or fails
            tg.openLink(`https://maps.google.com/?q=${restaurant.location.lat},${restaurant.location.lng}`, {try_instant_view: true});
            console.error("showMap error, falling back to openLink: ", e);
        }
    }
    
    function requestUserLocation() {
        currentLocationEl.textContent = 'Fetching location...';
        if (tg.CloudStorage && tg.CloudStorage.getItem) { // Check if CloudStorage is available
            tg.CloudStorage.getItem('user_city', (error, value) => {
                if (error) {
                    console.warn('Error getting city from cloud:', error);
                }
                if (value) {
                    currentLocationEl.textContent = `City: ${value}`;
                    // Potentially use this city to filter/sort restaurants if lat/lng not available
                } else {
                    // If no city in cloud or cloud not used, try geolocation
                    fetchGeoLocation();
                }
            });
        } else {
            fetchGeoLocation();
        }
    }

    function fetchGeoLocation() {
         if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    appState.userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    };
                    currentLocationEl.textContent = `Lat: ${appState.userLocation.latitude.toFixed(2)}, Lon: ${appState.userLocation.longitude.toFixed(2)}`;
                    tg.HapticFeedback.notificationOccurred('success');
                    // TODO: In a real app, re-fetch or sort restaurants by distance
                    // For now, we just display it. If restaurants have lat/lng, we could calculate distance.
                    // For example, update restaurant.distance here.
                    appState.restaurants.forEach(r => {
                        if (r.location && appState.userLocation) {
                            r.distance = calculateDistance(appState.userLocation.latitude, appState.userLocation.longitude, r.location.lat, r.location.lng);
                        }
                    });
                    appState.restaurants.sort((a,b) => a.distance - b.distance); // Sort by new distance
                    renderRestaurantList(); // Re-render with updated distances and order
                },
                (error) => {
                    console.warn("Error getting location:", error.message);
                    currentLocationEl.textContent = "Location access denied.";
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert(`Could not get location: ${error.message}. Some features might be limited.`);
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        } else {
            currentLocationEl.textContent = "Geolocation not supported.";
            tg.showAlert("Geolocation is not supported by your browser.");
        }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) { // Haversine formula
        const R = 6371; // Radius of the earth in km
        const dLat = deg2rad(lat2-lat1);
        const dLon = deg2rad(lon2-lon1);
        const a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const d = R * c; // Distance in km
        return parseFloat(d.toFixed(1));
    }
    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }


    function clearAllFilters() {
        tg.HapticFeedback.impactOccurred('light');
        appState.activeFilter = 'all';
        appState.searchQuery = '';
        searchInputEl.value = '';
        document.querySelectorAll('#category-filters-container .filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('#category-filters-container .filter-btn[data-filter="all"]').classList.add('active');
        renderRestaurantList();
    }


    // --- Initialization ---
    async function initApp() {
        setupTelegramFeatures(); // Initialize Telegram SDK features first
        
        // Attempt to get location
        requestUserLocation(); // This will also trigger initial render after location or on error

        await loadSampleData(); // Load mock data
        
        // Initial Render
        renderCategoryFilters();
        renderRestaurantList(); // This will be called again if location updates distances

        // Attach Event Listeners
        document.getElementById('refresh-location').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('medium');
            requestUserLocation();
        });
        searchInputEl.addEventListener('input', handleSearch);
        document.getElementById('clear-filters-main').addEventListener('click', clearAllFilters);

        // Detail screen buttons
        document.getElementById('add-review').addEventListener('click', showReviewModal);
        document.getElementById('share-restaurant').addEventListener('click', shareRestaurant);
        document.getElementById('view-location').addEventListener('click', viewRestaurantLocation);
        
        // Review Modal
        reviewFormEl.addEventListener('submit', handleReviewSubmit);
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                tg.HapticFeedback.impactOccurred('light');
                hideReviewModal();
            });
        });
        
        tg.ready(); // Inform Telegram that the app is ready
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
