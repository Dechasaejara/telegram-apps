<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoveQuest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: none; 
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .telegram-bg { background-color: var(--tg-theme-bg-color, #ffffff); }
        .telegram-text { color: var(--tg-theme-text-color, #000000); }
        .telegram-hint { color: var(--tg-theme-hint-color, #999999); }
        .telegram-link { color: var(--tg-theme-link-color, #2481cc); }
        .telegram-button-bg { background-color: var(--tg-theme-button-color, #2481cc); }
        .telegram-button-text { color: var(--tg-theme-button-text-color, #ffffff); }
        .telegram-secondary-bg { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }

        .quest-card, .profile-card, .match-card, .post-card, .journal-entry-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .quest-card:hover, .profile-card:hover, .match-card:hover, .post-card:hover, .journal-entry-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .nav-item.active {
            color: var(--tg-theme-button-color, #2481cc);
            border-bottom: 2px solid var(--tg-theme-button-color, #2481cc);
            font-weight: 600;
        }
        #main-content {
            padding-top: 4rem; 
            padding-bottom: 4rem; 
        }
        .modal-content-max-height {
             max-height: calc(80vh - 4rem); 
        }
    </style>
</head>
<body class="telegram-bg telegram-text">

    <div id="app-container" class="h-screen flex flex-col">
        <header id="app-header" class="telegram-bg shadow-md fixed top-0 left-0 right-0 z-50 border-b" style="border-color: var(--tg-theme-secondary-bg-color, #e0e0e0);">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between h-16">
                <h1 id="header-title" class="text-xl font-bold telegram-text">LoveQuest</h1>
            </div>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto">
            
            <div id="loading-view" class="p-6 text-center">
                <svg class="animate-spin h-10 w-10 telegram-text mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="telegram-hint">Initializing your adventure...</p>
            </div>

            <div id="profile-view" class="p-4 md:p-6 hidden space-y-6">
                <div class="telegram-secondary-bg p-6 rounded-xl shadow-lg">
                    <div class="flex items-center space-x-4 mb-6">
                        <img id="profile-avatar" src="https://placehold.co/80x80/E2E8F0/A0AEC0?text=Me" alt="User Avatar" class="w-20 h-20 rounded-full border-2 object-cover" style="border-color: var(--tg-theme-button-color, #2481cc);">
                        <div>
                            <h2 id="profile-name-display" class="text-2xl font-semibold telegram-text">Your Name</h2>
                            <p id="profile-age-gender-display" class="telegram-hint">Age, Gender</p>
                            <p id="profile-tg-username-display" class="telegram-hint text-sm"></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-lg font-medium telegram-text mb-1">Bio</h3>
                        <p id="profile-bio-display" class="telegram-hint text-sm leading-relaxed">Your captivating bio goes here...</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-lg font-medium telegram-text mb-2">Interests</h3>
                        <div id="profile-interests-display" class="flex flex-wrap gap-2"></div>
                    </div>
                     <div class="mb-4">
                        <h3 class="text-lg font-medium telegram-text mb-2">My Telegram User ID</h3>
                        <p id="profile-user-id-display" class="telegram-hint text-sm break-all"></p>
                    </div>
                </div>
                <form id="profile-edit-form" class="hidden space-y-4 telegram-secondary-bg p-6 rounded-xl shadow-lg">
                    <div>
                        <label for="profile-name" class="block text-sm font-medium telegram-text">Name (as you want it displayed)</label>
                        <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 telegram-bg telegram-text" placeholder="Your Display Name">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="profile-age" class="block text-sm font-medium telegram-text">Age</label>
                            <input type="number" id="profile-age" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 telegram-bg telegram-text" placeholder="25">
                        </div>
                        <div>
                            <label for="profile-gender" class="block text-sm font-medium telegram-text">Gender</label>
                            <select id="profile-gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 telegram-bg telegram-text">
                                <option>Prefer not to say</option><option>Male</option><option>Female</option><option>Non-binary</option><option>Other</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="profile-bio" class="block text-sm font-medium telegram-text">Bio</label>
                        <textarea id="profile-bio" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 telegram-bg telegram-text" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium telegram-text">Interests (select up to 5)</label>
                        <div id="profile-interests-edit" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                    </div>
                    <button type="submit" class="w-full telegram-button-bg telegram-button-text font-semibold py-2 px-4 rounded-lg shadow hover:opacity-90 transition duration-150">Save Profile</button>
                </form>
            </div>

            <div id="adventure-hub-view" class="p-4 md:p-6 hidden space-y-6">
                <h2 class="text-2xl font-semibold telegram-text">Available Adventures</h2>
                <div id="quests-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <p id="no-quests-message" class="telegram-hint col-span-full text-center hidden">No adventures available right now. Check back soon!</p>
                </div>
            </div>

            <div id="quest-detail-view" class="p-4 md:p-6 hidden space-y-6">
                <h2 id="quest-title" class="text-2xl font-bold telegram-text">Quest Title</h2>
                <p id="quest-description" class="telegram-hint">Quest description.</p>
                <div id="quest-steps-container" class="space-y-4"></div>
            </div>

            <div id="achievements-view" class="p-4 md:p-6 hidden space-y-6">
                <h2 class="text-2xl font-semibold telegram-text">My Quest Achievements</h2>
                <div id="achievements-list" class="space-y-4">
                    <p id="no-achievements-message" class="telegram-hint text-center">Complete quests to see your achievements here!</p>
                </div>
                 <button id="invite-friend-button" class="w-full telegram-button-bg telegram-button-text font-semibold py-2 px-4 rounded-lg shadow hover:opacity-90 mt-6">Invite a Friend to LoveQuest</button>
            </div>

            <div id="chat-view" class="p-4 md:p-6 hidden flex flex-col h-full">
                <div id="chat-with-name" class="text-xl font-semibold telegram-text mb-4">Chat Placeholder</div>
                <div id="chat-messages-container" class="flex-grow border telegram-secondary-bg rounded-lg p-4 overflow-y-auto mb-4">
                    <p class="telegram-hint">This is a placeholder for chat. Please use Telegram's native chat to connect with people you meet through LoveQuest adventures!</p>
                </div>
                <div class="flex">
                    <input type="text" id="chat-message-input" placeholder="Type your message (mock)..." class="flex-grow rounded-l-lg border-gray-300 shadow-sm p-2 telegram-bg telegram-text">
                    <button id="send-chat-message-button" class="telegram-button-bg telegram-button-text font-semibold px-4 rounded-r-lg shadow hover:opacity-90">Send (Mock)</button>
                </div>
            </div>

            <div id="journal-view" class="p-4 md:p-6 hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold telegram-text">My LoveQuest Journal</h2>
                    <button id="create-journal-entry-button" class="telegram-button-bg telegram-button-text font-semibold py-2 px-4 rounded-lg shadow hover:opacity-90">New Entry</button>
                </div>
                <div id="journal-entries-list" class="space-y-4">
                    <p id="no-journal-entries-message" class="telegram-hint text-center">No journal entries yet. Start reflecting on your journey!</p>
                </div>
                <form id="create-journal-entry-form" class="hidden space-y-4 telegram-secondary-bg p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold telegram-text">New Journal Entry</h3>
                    <div>
                        <label for="journal-entry-title-input" class="block text-sm font-medium telegram-text">Title</label>
                        <input type="text" id="journal-entry-title-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 telegram-bg telegram-text" placeholder="Entry Title">
                    </div>
                    <div>
                        <label for="journal-entry-content-input" class="block text-sm font-medium telegram-text">Reflection</label>
                        <textarea id="journal-entry-content-input" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 telegram-bg telegram-text" placeholder="Your thoughts and feelings..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                         <button type="button" id="cancel-journal-entry-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="telegram-button-bg telegram-button-text font-semibold py-2 px-4 rounded-lg shadow hover:opacity-90">Save Entry</button>
                    </div>
                </form>
            </div>
        </main>

        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] p-4">
            <div id="modal-content" class="telegram-bg p-6 rounded-xl shadow-xl w-full max-w-lg modal-content-max-height overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-semibold telegram-text">Modal Title</h3>
                    <button id="modal-close-button" class="telegram-hint hover:telegram-text text-2xl leading-none">&times;</button>
                </div>
                <div id="modal-body"></div>
            </div>
        </div>

        <nav id="bottom-nav" class="telegram-bg border-t fixed bottom-0 left-0 right-0 z-50 flex justify-around items-center h-16 shadow-top" style="border-color: var(--tg-theme-secondary-bg-color, #e0e0e0);">
            <button data-view="profile-view" class="nav-item flex-1 flex flex-col items-center justify-center p-2 telegram-hint hover:telegram-text transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 1 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z" /></svg>
                <span class="text-xs mt-1">Profile</span>
            </button>
            <button data-view="adventure-hub-view" class="nav-item flex-1 flex flex-col items-center justify-center p-2 telegram-hint hover:telegram-text transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 0 0 .723 0l.028-.015.071-.041a16.975 16.975 0 0 0 1.144-.742 19.58 19.58 0 0 0 2.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 0 0-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 0 0 2.682 2.282 16.975 16.975 0 0 0 1.145.742ZM12 13.5a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" /></svg>
                <span class="text-xs mt-1">Adventures</span>
            </button>
            <button data-view="achievements-view" class="nav-item flex-1 flex flex-col items-center justify-center p-2 telegram-hint hover:telegram-text transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10.788 3.212a.75.75 0 0 0-1.06 0l-7.5 7.5a.75.75 0 0 0 1.06 1.06L4.5 11.06l2.72 2.72a.75.75 0 0 0 1.06-1.06L5.56 10l5.228-5.228a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M13.212 3.212a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 0 1-1.06 1.06L18.5 11.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L17.44 10l-5.228-5.228a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /> <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25c0 2.008.994 4.042 2.758 5.875a.75.75 0 0 0 1.144-.028L12 11.036l1.348 1.563a.75.75 0 0 0 1.144.028c1.764-1.833 2.758-3.867 2.758-5.875A5.25 5.25 0 0 0 12 1.5Zm-3.75 5.25a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0Z" clip-rule="evenodd" /> </svg>
                <span class="text-xs mt-1">Achievements</span>
            </button>
            <button data-view="journal-view" class="nav-item flex-1 flex flex-col items-center justify-center p-2 telegram-hint hover:telegram-text transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.522c0 .314.21.598.5.707A9.733 9.733 0 0 0 6 21a9.707 9.707 0 0 0 5.25-1.533.75.75 0 0 0 .5-.707V5.24a.75.75 0 0 0-.5-.707Z" /><path d="M12.75 4.533A9.707 9.707 0 0 1 18 3a9.735 9.735 0 0 1 3.25.555.75.75 0 0 1 .5.707v14.522c0 .314-.21.598-.5.707A9.733 9.733 0 0 1 18 21a9.707 9.707 0 0 1-5.25-1.533.75.75 0 0 1-.5-.707V5.24a.75.75 0 0 1 .5-.707Z" /></svg>
                <span class="text-xs mt-1">Journal</span>
            </button>
        </nav>
    </div>

    <script type="module">
        // --- App State and Configuration ---
        const app = {
            userId: null, 
            tgUser: null, 
            currentView: 'loading-view',
            tgWebApp: window.Telegram.WebApp,
            currentUserProfile: null, // Will be loaded from CloudStorage
            userQuestProgress: {}, // { questId: { completedSteps: [0, 1], answers: {...} } } - CloudStorage
            userJournalEntries: [], // [{id: 'uuid', title: '', content: '', date: ''}] - CloudStorage
            
            availableInterests: ["Reading", "Hiking", "Cooking", "Gaming", "Movies", "Music", "Travel", "Art", "Sports", "Photography", "Coding", "Yoga"],
            activeQuest: null, // Details of the currently viewed quest (from hardcoded QUEST_DEFINITIONS)
            
            // Hardcoded Quest Definitions
            QUEST_DEFINITIONS: [
                { 
                    id: "quest1",
                    title: "The Spark of Connection",
                    description: "Embark on a journey to discover your communication style. This quest involves self-reflection and expressing yourself.",
                    steps: [
                        { type: "assessment", title: "Communication Quiz", details: "Answer a few questions about how you connect with others.", questions: [{ q: "When meeting someone new, you usually:", options: ["Listen more than talk", "Talk more than listen", "Balance both"] }, {q: "Your preferred way to resolve conflict is:", options:["Direct discussion", "Avoiding it", "Mediated talk"]}] },
                        { type: "challenge_virtual", title: "Icebreaker Intro", details: "Craft a fun 3-sentence introduction about yourself. Imagine you're sharing it." },
                        { type: "clue_reveal", title: "First Insight", clueText: "Authentic communication is key to building strong connections." }
                    ],
                    achievement: "Completed 'The Spark of Connection' and reflected on communication style."
                },
                { 
                    id: "quest2",
                    title: "The Local Explorer",
                    description: "Explore your surroundings (even virtually) and find hidden gems. This quest is about observation and a sense of adventure.",
                    steps: [
                        { type: "challenge_local", title: "Cafe 'The Daily Grind' Code", businessName: "The Daily Grind", details: "Imagine you visited 'The Daily Grind' cafe. The special code word for LoveQuest users is displayed near the counter. What is it? (Or scan QR)", expectedCode: "COFFEELOVE", qrEnabled: true },
                        { type: "assessment", title: "Adventure Preferences", details: "What kind of adventures excite you most?", questions: [{q: "Ideal weekend activity:", options:["Relaxing at home", "Exploring nature", "Trying a new restaurant/cafe", "Attending a social event"]}] },
                        { type: "clue_reveal", title: "Partner Insight", clueText: "Shared experiences can bring people closer." }
                    ],
                    achievement: "Completed 'The Local Explorer' and embraced a spirit of adventure."
                }
            ],
            
            dom: { // DOM elements (same as before, but with new views)
                headerTitle: document.getElementById('header-title'),
                loadingView: document.getElementById('loading-view'),
                profileView: document.getElementById('profile-view'),
                profileForm: document.getElementById('profile-edit-form'),
                profileAvatar: document.getElementById('profile-avatar'),
                profileNameDisplay: document.getElementById('profile-name-display'),
                profileTgUsernameDisplay: document.getElementById('profile-tg-username-display'),
                profileAgeGenderDisplay: document.getElementById('profile-age-gender-display'),
                profileBioDisplay: document.getElementById('profile-bio-display'),
                profileInterestsDisplay: document.getElementById('profile-interests-display'),
                profileUserIdDisplay: document.getElementById('profile-user-id-display'),
                profileNameInput: document.getElementById('profile-name'),
                profileAgeInput: document.getElementById('profile-age'),
                profileGenderInput: document.getElementById('profile-gender'),
                profileBioInput: document.getElementById('profile-bio'),
                profileInterestsEdit: document.getElementById('profile-interests-edit'),
                
                adventureHubView: document.getElementById('adventure-hub-view'),
                questsList: document.getElementById('quests-list'),
                noQuestsMessage: document.getElementById('no-quests-message'),

                questDetailView: document.getElementById('quest-detail-view'),
                questTitle: document.getElementById('quest-title'),
                questDescription: document.getElementById('quest-description'),
                questStepsContainer: document.getElementById('quest-steps-container'),

                achievementsView: document.getElementById('achievements-view'), // New
                achievementsList: document.getElementById('achievements-list'), // New
                noAchievementsMessage: document.getElementById('no-achievements-message'), // New
                inviteFriendButton: document.getElementById('invite-friend-button'), // New

                chatView: document.getElementById('chat-view'), // Placeholder
                chatWithName: document.getElementById('chat-with-name'),
                chatMessagesContainer: document.getElementById('chat-messages-container'),
                chatMessageInput: document.getElementById('chat-message-input'),
                sendChatMessageButton: document.getElementById('send-chat-message-button'),

                journalView: document.getElementById('journal-view'), // New
                journalEntriesList: document.getElementById('journal-entries-list'), // New
                noJournalEntriesMessage: document.getElementById('no-journal-entries-message'), // New
                createJournalEntryButton: document.getElementById('create-journal-entry-button'), // New
                createJournalEntryForm: document.getElementById('create-journal-entry-form'), // New
                journalEntryTitleInput: document.getElementById('journal-entry-title-input'), // New
                journalEntryContentInput: document.getElementById('journal-entry-content-input'), // New
                cancelJournalEntryButton: document.getElementById('cancel-journal-entry-button'), // New

                bottomNav: document.getElementById('bottom-nav'),
                modalContainer: document.getElementById('modal-container'),
                modalContent: document.getElementById('modal-content'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalCloseButton: document.getElementById('modal-close-button'),
            },

            async init() {
                this.tgWebApp.ready();
                this.tgWebApp.expand();
                this.applyTelegramTheme();

                if (this.tgWebApp.initDataUnsafe && this.tgWebApp.initDataUnsafe.user) {
                    this.tgUser = this.tgWebApp.initDataUnsafe.user;
                    this.userId = this.tgUser.id.toString();
                    console.log("Telegram User:", this.tgUser);
                    this.dom.profileUserIdDisplay.textContent = this.userId;
                    if (this.tgUser.photo_url) this.dom.profileAvatar.src = this.tgUser.photo_url;
                    if (this.tgUser.username) this.dom.profileTgUsernameDisplay.textContent = `@${this.tgUser.username}`;
                } else {
                    console.error("Telegram user data not available!");
                    this.showError("Could not retrieve your Telegram profile. Please try launching from Telegram.");
                    this.navigateTo('loading-view'); // Stay on loading or show specific error view
                    this.dom.loadingView.innerHTML = `<p class="text-red-500 text-center p-6">Critical: Telegram user data missing. Please launch from Telegram.</p>`;
                    return;
                }
                
                this.setupEventListeners();
                this.populateInterestCheckboxes();
                await this.loadDataFromCloudStorage(); // Load profile, progress, journal

                if (!this.currentUserProfile || !this.currentUserProfile.name) {
                    this.navigateTo('profile-view');
                    this.showProfileEditForm();
                    this.tgWebApp.MainButton.setText("Save Profile").show().onClick(this.handleProfileSave);
                } else {
                   this.navigateTo('adventure-hub-view');
                }
            },
            
            // --- CloudStorage Helpers ---
            saveToCloudStorage(key, value, callback) {
                this.tgWebApp.CloudStorage.setItem(key, JSON.stringify(value), (error, success) => {
                    if (error) {
                        this.showError(`Cloud Save Error (${key}): ${error}`);
                        if (callback) callback(error, null);
                        return;
                    }
                    if (callback) callback(null, success);
                });
            },

            getFromCloudStorage(keys, callback) {
                this.tgWebApp.CloudStorage.getItems(keys, (error, data) => {
                    if (error) {
                        this.showError(`Cloud Load Error: ${error}`);
                        if (callback) callback(error, null);
                        return;
                    }
                    const parsedData = {};
                    for (const key in data) {
                        try {
                            parsedData[key] = JSON.parse(data[key]);
                        } catch (e) {
                            console.warn(`Could not parse JSON for key ${key} from CloudStorage:`, data[key]);
                            parsedData[key] = null; // Or some default
                        }
                    }
                    if (callback) callback(null, parsedData);
                });
            },
            
            async loadDataFromCloudStorage() {
                return new Promise((resolve) => {
                    this.getFromCloudStorage(['userProfile', 'userQuestProgress', 'userJournalEntries'], (error, data) => {
                        if (error) {
                            this.showError("Failed to load your data from the cloud.");
                            // Initialize with defaults if load fails
                            this.currentUserProfile = this.currentUserProfile || this.getInitialProfile();
                            this.userQuestProgress = {};
                            this.userJournalEntries = [];
                        } else {
                            this.currentUserProfile = data.userProfile || this.getInitialProfile();
                            this.userQuestProgress = data.userQuestProgress || {};
                            this.userJournalEntries = data.userJournalEntries || [];
                        }
                        this.displayUserProfile();
                        resolve();
                    });
                });
            },

            getInitialProfile() {
                 return { 
                    name: `${this.tgUser.first_name || ''} ${this.tgUser.last_name || ''}`.trim() || '',
                    tgUsername: this.tgUser.username || '',
                    tgPhotoUrl: this.tgUser.photo_url || '',
                    age: '', gender: '', bio: '', interests: [] 
                };
            },

            applyTelegramTheme() { /* ... same as before ... */ 
                const themeParams = this.tgWebApp.themeParams;
                document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#f0f0f0');
                document.body.style.backgroundColor = themeParams.bg_color || '#ffffff';
                document.body.style.color = themeParams.text_color || '#000000';
            },

            navigateTo(viewId, params = {}) {
                console.log(`Navigating to ${viewId}`);
                ['loading-view', 'profile-view', 'adventure-hub-view', 'quest-detail-view', 'achievements-view', 'chat-view', 'journal-view'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    this.currentView = viewId;
                    this.updateHeaderAndMainButton(viewId, params);
                    this.updateActiveNavItem(viewId);
                    if(document.getElementById('main-content')) document.getElementById('main-content').scrollTop = 0;

                    if (viewId === 'adventure-hub-view') this.loadQuestsDisplay();
                    if (viewId === 'quest-detail-view' && params.questId) this.loadQuestDetail(params.questId);
                    if (viewId === 'achievements-view') this.loadAchievements();
                    if (viewId === 'journal-view') this.loadJournalEntries();
                    if (viewId === 'chat-view') this.loadChatPlaceholder(); // Chat is just a placeholder
                } else {
                    console.error(`View ${viewId} not found!`);
                }
            },
            
            updateActiveNavItem(viewId) { /* ... same as before ... */ 
                 this.dom.bottomNav.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.view === viewId) {
                        item.classList.add('active');
                    }
                });
            },

            updateHeaderAndMainButton(viewId, params = {}) { /* ... adapted for new views ... */ 
                this.tgWebApp.BackButton.hide();
                this.tgWebApp.MainButton.hide();
                this.dom.headerTitle.textContent = "LoveQuest"; 

                switch (viewId) {
                    case 'profile-view':
                        this.dom.headerTitle.textContent = "My Profile";
                        if (this.dom.profileForm.classList.contains('hidden')) {
                            this.tgWebApp.MainButton.setText("Edit Profile").show().onClick(this.showProfileEditForm);
                        } else {
                            this.tgWebApp.MainButton.setText("Save Profile").show().onClick(this.handleProfileSave);
                            this.tgWebApp.BackButton.show().onClick(() => this.showProfileDisplay());
                        }
                        break;
                    case 'adventure-hub-view':
                        this.dom.headerTitle.textContent = "Adventures";
                        break;
                    case 'quest-detail-view':
                        this.dom.headerTitle.textContent = params.questTitle || "Quest Details"; 
                        this.tgWebApp.BackButton.show().onClick(() => this.navigateTo('adventure-hub-view'));
                        // MainButton for quest steps handled in renderQuestSteps
                        break;
                    case 'achievements-view':
                        this.dom.headerTitle.textContent = "My Achievements";
                        break;
                    case 'journal-view':
                        this.dom.headerTitle.textContent = "My Journal";
                         if (this.dom.createJournalEntryForm.classList.contains('hidden')) {
                            this.tgWebApp.MainButton.setText("New Entry").show().onClick(() => {
                                this.dom.createJournalEntryForm.classList.remove('hidden');
                                this.tgWebApp.MainButton.setText("Save Entry").onClick(this.handleCreateJournalEntry);
                                this.tgWebApp.BackButton.show().onClick(() => {
                                    this.dom.createJournalEntryForm.classList.add('hidden');
                                    this.updateHeaderAndMainButton('journal-view'); 
                                });
                            });
                        } else { // Form is visible
                             this.tgWebApp.MainButton.setText("Save Entry").show().onClick(this.handleCreateJournalEntry);
                             this.tgWebApp.BackButton.show().onClick(() => {
                                this.dom.createJournalEntryForm.classList.add('hidden');
                                this.updateHeaderAndMainButton('journal-view'); 
                            });
                        }
                        break;
                    case 'chat-view': // Placeholder
                        this.dom.headerTitle.textContent = "Chat";
                        this.tgWebApp.BackButton.show().onClick(() => this.navigateTo('achievements-view')); // Or previous view
                        break;
                }
            },

            displayUserProfile() { /* ... same as before, loads from this.currentUserProfile ... */ 
                if (!this.currentUserProfile) this.currentUserProfile = this.getInitialProfile();
                const profile = this.currentUserProfile;
                
                this.dom.profileNameDisplay.textContent = profile.name || "Your Name";
                this.dom.profileAgeGenderDisplay.textContent = `${profile.age || 'Age'}, ${profile.gender || 'Gender'}`;
                this.dom.profileBioDisplay.textContent = profile.bio || "No bio yet. Tell us about yourself!";
                this.dom.profileTgUsernameDisplay.textContent = profile.tgUsername ? `@${profile.tgUsername}` : (this.tgUser.username ? `@${this.tgUser.username}` : '');
                
                const avatarUrl = profile.tgPhotoUrl || (this.tgUser ? this.tgUser.photo_url : null);
                this.dom.profileAvatar.src = avatarUrl || `https://placehold.co/80x80/E2E8F0/A0AEC0?text=${(profile.name || 'Me').charAt(0)}`;

                this.dom.profileInterestsDisplay.innerHTML = '';
                if (profile.interests && profile.interests.length > 0) {
                    profile.interests.forEach(interest => {
                        const interestEl = document.createElement('span');
                        interestEl.className = 'telegram-button-bg telegram-button-text px-3 py-1 rounded-full text-sm';
                        interestEl.textContent = interest;
                        this.dom.profileInterestsDisplay.appendChild(interestEl);
                    });
                } else {
                    this.dom.profileInterestsDisplay.innerHTML = `<span class="telegram-hint text-sm">Add some interests!</span>`;
                }
                
                this.dom.profileNameInput.value = profile.name || '';
                this.dom.profileAgeInput.value = profile.age || '';
                this.dom.profileGenderInput.value = profile.gender || 'Prefer not to say';
                this.dom.profileBioInput.value = profile.bio || '';
                
                this.dom.profileInterestsEdit.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = profile.interests && profile.interests.includes(checkbox.value);
                });
            },

            showProfileEditForm() { /* ... same as before ... */ 
                this.dom.profileView.querySelectorAll('.telegram-secondary-bg:not(#profile-edit-form)').forEach(el => el.classList.add('hidden'));
                this.dom.profileForm.classList.remove('hidden');
                if (!this.currentUserProfile.name && this.tgUser) { 
                    this.dom.profileNameInput.value = `${this.tgUser.first_name || ''} ${this.tgUser.last_name || ''}`.trim();
                } else {
                    this.dom.profileNameInput.value = this.currentUserProfile.name || '';
                }
                this.dom.profileAgeInput.value = this.currentUserProfile.age || '';
                this.dom.profileGenderInput.value = this.currentUserProfile.gender || 'Prefer not to say';
                this.dom.profileBioInput.value = this.currentUserProfile.bio || '';
                this.dom.profileInterestsEdit.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = this.currentUserProfile.interests && this.currentUserProfile.interests.includes(checkbox.value);
                });
                this.updateHeaderAndMainButton('profile-view');
                this.tgWebApp.HapticFeedback.impactOccurred('light');
            },
            showProfileDisplay() { /* ... same as before ... */ 
                this.dom.profileForm.classList.add('hidden');
                this.dom.profileView.querySelectorAll('.telegram-secondary-bg:not(#profile-edit-form)').forEach(el => el.classList.remove('hidden'));
                this.updateHeaderAndMainButton('profile-view');
            },

            handleProfileSave: async () => { /* ... saves to CloudStorage ... */ 
                app.tgWebApp.MainButton.showProgress();
                const name = app.dom.profileNameInput.value.trim();
                const age = app.dom.profileAgeInput.value;
                const gender = app.dom.profileGenderInput.value;
                const bio = app.dom.profileBioInput.value.trim();
                const selectedInterests = Array.from(app.dom.profileInterestsEdit.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

                if (!name) { app.showError("Display Name is required."); app.tgWebApp.MainButton.hideProgress(); return; }
                if (selectedInterests.length > 5) { app.showError("Please select up to 5 interests."); app.tgWebApp.MainButton.hideProgress(); return; }

                const profileData = {
                    name,
                    age: parseInt(age) || null,
                    gender,
                    bio,
                    interests: selectedInterests,
                    tgUsername: app.tgUser.username || '', 
                    tgPhotoUrl: app.tgUser.photo_url || '', 
                    updatedAt: new Date().toISOString() // Simple timestamp
                };
                
                app.saveToCloudStorage('userProfile', profileData, (error, success) => {
                    app.tgWebApp.MainButton.hideProgress();
                    if (error) return; // showError already called in helper
                    app.currentUserProfile = profileData; 
                    app.displayUserProfile();
                    app.showProfileDisplay();
                    app.tgWebApp.HapticFeedback.notificationOccurred('success');
                    app.showSuccess("Profile saved!");
                });
            },

            populateInterestCheckboxes() { /* ... same as before ... */ 
                this.dom.profileInterestsEdit.innerHTML = '';
                this.availableInterests.forEach(interest => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `interest-${interest.toLowerCase().replace(' ', '-')}`;
                    checkbox.value = interest;
                    checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2';
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = interest;
                    label.className = 'text-sm telegram-text';
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    this.dom.profileInterestsEdit.appendChild(div);
                });
            },

            loadQuestsDisplay() { // Renamed from loadQuests
                this.dom.questsList.innerHTML = ''; 
                this.dom.noQuestsMessage.classList.add('hidden');
                if (this.QUEST_DEFINITIONS.length === 0) {
                    this.dom.noQuestsMessage.classList.remove('hidden');
                    return;
                }
                this.QUEST_DEFINITIONS.forEach(quest => this.renderQuestCard(quest));
            },

            renderQuestCard(quest) { /* ... same as before ... */ 
                const card = document.createElement('div');
                card.className = 'quest-card telegram-secondary-bg p-4 rounded-lg shadow cursor-pointer';
                card.innerHTML = `
                    <h3 class="text-lg font-semibold telegram-text mb-1">${quest.title}</h3>
                    <p class="telegram-hint text-sm mb-3">${quest.description.substring(0, 100)}${quest.description.length > 100 ? '...' : ''}</p>
                    <button class="start-quest-button telegram-button-bg telegram-button-text text-sm font-medium py-2 px-3 rounded-md hover:opacity-90 w-full">Start Adventure</button>
                `;
                card.querySelector('.start-quest-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.tgWebApp.showConfirm(`Start the adventure "${quest.title}"?`, (confirmed) => {
                        if (confirmed) {
                            this.navigateTo('quest-detail-view', { questId: quest.id, questTitle: quest.title });
                        }
                    });
                });
                card.addEventListener('click', () => { 
                     this.tgWebApp.showConfirm(`Start the adventure "${quest.title}"?`, (confirmed) => {
                        if (confirmed) {
                            this.navigateTo('quest-detail-view', { questId: quest.id, questTitle: quest.title });
                        }
                    });
                });
                this.dom.questsList.appendChild(card);
            },

            loadQuestDetail(questId) {
                this.activeQuest = this.QUEST_DEFINITIONS.find(q => q.id === questId);
                if (this.activeQuest) {
                    this.dom.questTitle.textContent = this.activeQuest.title;
                    this.dom.questDescription.textContent = this.activeQuest.description;
                    this.updateHeaderAndMainButton('quest-detail-view', { questTitle: this.activeQuest.title });
                    this.renderQuestSteps();
                } else {
                    this.showError("Quest not found.");
                    this.navigateTo('adventure-hub-view');
                }
            },

            renderQuestSteps() { /* ... adapted for userQuestProgress ... */
                this.dom.questStepsContainer.innerHTML = '';
                if (!this.activeQuest || !this.activeQuest.steps || this.activeQuest.steps.length === 0) {
                    this.dom.questStepsContainer.innerHTML = `<p class="telegram-hint">No steps defined for this quest.</p>`;
                    return;
                }

                const questProgress = this.userQuestProgress[this.activeQuest.id] || { completedSteps: [], answers: {} };

                this.activeQuest.steps.forEach((step, index) => {
                    const isCompleted = questProgress.completedSteps.includes(index);
                    const stepEl = document.createElement('div');
                    stepEl.className = `telegram-secondary-bg p-4 rounded-lg shadow ${isCompleted ? 'opacity-70' : ''}`;
                    let stepContent = `<h4 class="font-semibold telegram-text mb-1">${index + 1}. ${step.title} ${isCompleted ? '<span class="text-green-500 text-xs ml-2">(Completed)</span>' : ''}</h4>
                                       <p class="telegram-hint text-sm mb-2">${step.details}</p>`;
                    
                    if (!isCompleted) {
                        switch(step.type) {
                            case 'assessment':
                                stepContent += `<button data-step-index="${index}" class="assessment-button telegram-link font-medium text-sm">Take Assessment</button>`;
                                break;
                            case 'challenge_virtual':
                                stepContent += `<textarea data-step-index="${index}" class="virtual-challenge-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 telegram-bg telegram-text" rows="3" placeholder="Your response..."></textarea>
                                                <button data-step-index="${index}" class="submit-challenge-button telegram-button-bg telegram-button-text text-sm font-medium py-1 px-3 rounded-md hover:opacity-90 mt-2">Submit</button>`;
                                break;
                            case 'challenge_local':
                                 stepContent += `<p class="text-sm telegram-hint my-1">Visit: <strong>${step.businessName || 'the designated location'}</strong></p>`;
                                 if (step.qrEnabled) {
                                     stepContent += `<button data-step-index="${index}" class="scan-qr-button telegram-button-bg telegram-button-text text-sm font-medium py-1 px-3 rounded-md hover:opacity-90 mt-2">Scan QR Code</button>`;
                                 }
                                 stepContent += `<input type="text" data-step-index="${index}" class="local-challenge-code mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 telegram-bg telegram-text" placeholder="Enter code found (if no QR)">
                                                 <button data-step-index="${index}" class="submit-code-button telegram-button-bg telegram-button-text text-sm font-medium py-1 px-3 rounded-md hover:opacity-90 mt-2">Verify Code</button>`;
                                break;
                            case 'clue_reveal': // Clues are revealed upon completing a prior step or immediately if no condition
                                stepContent += `<p class="italic telegram-text p-2 bg-yellow-100 text-yellow-700 rounded">Clue: ${step.clueText || "A new clue awaits!"}</p>
                                                <button data-step-index="${index}" class="mark-clue-read-button telegram-link font-medium text-sm mt-1">Mark as Read</button>`;
                                break;
                        }
                    } else if (step.type === 'clue_reveal') { // Show clue if completed
                         stepContent += `<p class="italic telegram-text p-2 bg-yellow-100 text-yellow-700 rounded">Clue: ${step.clueText || "A new clue awaits!"}</p>`;
                    }
                    stepEl.innerHTML = stepContent;
                    this.dom.questStepsContainer.appendChild(stepEl);
                });
                this.attachQuestStepListeners();

                const allStepsCompleted = questProgress.completedSteps.length === this.activeQuest.steps.length;
                if (allStepsCompleted) {
                    this.tgWebApp.MainButton.setText("Quest Completed!").setParams({is_active: false}).show();
                } else {
                     this.tgWebApp.MainButton.setText("Complete Next Step").show().onClick(() => {
                        // This is a generic button, specific step actions are better
                        this.showError("Please interact with the specific step buttons.");
                    });
                }
            },

            markStepAsComplete(questId, stepIndex, answerData = null) {
                if (!this.userQuestProgress[questId]) {
                    this.userQuestProgress[questId] = { completedSteps: [], answers: {} };
                }
                if (!this.userQuestProgress[questId].completedSteps.includes(stepIndex)) {
                    this.userQuestProgress[questId].completedSteps.push(stepIndex);
                }
                if (answerData) {
                    this.userQuestProgress[questId].answers[stepIndex] = answerData;
                }
                this.saveToCloudStorage('userQuestProgress', this.userQuestProgress, (err) => {
                    if (!err) {
                        this.showSuccess("Step completed!");
                        this.renderQuestSteps(); // Re-render to show completion
                    }
                });
            },
            
            attachQuestStepListeners() { /* ... adapted for markStepAsComplete ... */
                this.dom.questStepsContainer.querySelectorAll('.assessment-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stepIndex = parseInt(e.target.dataset.stepIndex);
                        const step = this.activeQuest.steps[stepIndex];
                        this.showAssessmentModal(step, stepIndex);
                    });
                });
                 this.dom.questStepsContainer.querySelectorAll('.submit-challenge-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stepIndex = parseInt(e.target.dataset.stepIndex);
                        const input = this.dom.questStepsContainer.querySelector(`.virtual-challenge-input[data-step-index="${stepIndex}"]`);
                        if (input.value.trim()) {
                            this.markStepAsComplete(this.activeQuest.id, stepIndex, { response: input.value.trim() });
                            input.disabled = true; button.disabled = true; button.textContent = "Submitted";
                        } else {
                            this.showError("Please provide a response.");
                        }
                    });
                });
                this.dom.questStepsContainer.querySelectorAll('.scan-qr-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stepIndex = parseInt(e.target.dataset.stepIndex);
                        const step = this.activeQuest.steps[stepIndex];
                        this.tgWebApp.showScanQrPopup({text: `Scan QR at ${step.businessName || 'location'}`}, (scannedText) => {
                            if (scannedText && scannedText.trim().toUpperCase() === step.expectedCode.toUpperCase()) {
                                this.markStepAsComplete(this.activeQuest.id, stepIndex, { qrScanned: scannedText });
                            } else if (scannedText) {
                                this.showError("Incorrect QR Code.");
                            }
                            return true; 
                        });
                    });
                });
                this.dom.questStepsContainer.querySelectorAll('.submit-code-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stepIndex = parseInt(e.target.dataset.stepIndex);
                        const input = this.dom.questStepsContainer.querySelector(`.local-challenge-code[data-step-index="${stepIndex}"]`);
                        const step = this.activeQuest.steps[stepIndex];
                        if (input.value.trim().toUpperCase() === step.expectedCode.toUpperCase()) {
                             this.markStepAsComplete(this.activeQuest.id, stepIndex, { codeEntered: input.value.trim() });
                        } else {
                            this.showError("Incorrect code.");
                        }
                    });
                });
                this.dom.questStepsContainer.querySelectorAll('.mark-clue-read-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stepIndex = parseInt(e.target.dataset.stepIndex);
                        this.markStepAsComplete(this.activeQuest.id, stepIndex);
                    });
                });
            },

            showAssessmentModal(step, stepIndex) { /* ... adapted for markStepAsComplete ... */
                let modalHtml = `<p class="telegram-hint mb-4">${step.details}</p>`;
                step.questions.forEach((q, qi) => {
                    modalHtml += `<div class="mb-3">
                                    <p class="font-medium telegram-text">${qi + 1}. ${q.q}</p>
                                    <div class="mt-1 space-y-1">`;
                    q.options.forEach((opt, opti) => {
                        modalHtml += `<div>
                                        <input type="radio" name="q${qi}" id="q${qi}o${opti}" value="${opt}" class="mr-2">
                                        <label for="q${qi}o${opti}" class="telegram-text">${opt}</label>
                                      </div>`;
                    });
                    modalHtml += `</div></div>`;
                });
                modalHtml += `<button id="submit-assessment-button" class="w-full telegram-button-bg telegram-button-text font-semibold py-2 px-4 rounded-lg shadow mt-4">Submit Answers</button>`;
                
                this.dom.modalTitle.textContent = step.title;
                this.dom.modalBody.innerHTML = modalHtml;
                this.dom.modalContainer.classList.remove('hidden');
                this.dom.modalContainer.classList.add('flex');

                document.getElementById('submit-assessment-button').onclick = () => {
                    const answers = {};
                    let allAnswered = true;
                    step.questions.forEach((q, qi) => {
                        const selectedOption = this.dom.modalBody.querySelector(`input[name="q${qi}"]:checked`);
                        if (selectedOption) {
                            answers[`q${qi}`] = selectedOption.value;
                        } else {
                            allAnswered = false;
                        }
                    });

                    if (!allAnswered) {
                        this.showError("Please answer all questions.");
                        return;
                    }
                    this.markStepAsComplete(this.activeQuest.id, stepIndex, answers);
                    this.closeModal();
                };
            },

            // --- Achievements View (Replaces Matches) ---
            loadAchievements() {
                this.dom.achievementsList.innerHTML = '';
                this.dom.noAchievementsMessage.classList.add('hidden');
                let achievementsCount = 0;

                this.QUEST_DEFINITIONS.forEach(quest => {
                    const progress = this.userQuestProgress[quest.id];
                    if (progress && progress.completedSteps.length === quest.steps.length) {
                        const achievementEl = document.createElement('div');
                        achievementEl.className = 'telegram-secondary-bg p-4 rounded-lg shadow';
                        achievementEl.innerHTML = `
                            <h3 class="font-semibold telegram-text">${quest.title} Completed!</h3>
                            <p class="text-sm telegram-hint">${quest.achievement || 'Great job on completing this adventure!'}</p>
                        `;
                        this.dom.achievementsList.appendChild(achievementEl);
                        achievementsCount++;
                    }
                });

                if (achievementsCount === 0) {
                    this.dom.noAchievementsMessage.classList.remove('hidden');
                }
            },

            // --- Chat (Placeholder) ---
            loadChatPlaceholder() {
                this.dom.chatWithName.textContent = "Chat (Suggestion)";
                this.dom.sendChatMessageButton.onclick = () => {
                    this.showError("Please use Telegram's native chat to message users.");
                };
            },

            // --- Journal View ---
            loadJournalEntries() {
                this.dom.journalEntriesList.innerHTML = '';
                this.dom.noJournalEntriesMessage.classList.add('hidden');
                if (this.userJournalEntries.length === 0) {
                    this.dom.noJournalEntriesMessage.classList.remove('hidden');
                    return;
                }
                // Sort by date, newest first (optional)
                const sortedEntries = [...this.userJournalEntries].sort((a,b) => new Date(b.date) - new Date(a.date));

                sortedEntries.forEach(entry => this.renderJournalEntry(entry));
                this.updateHeaderAndMainButton('journal-view'); // Reset buttons
            },
            renderJournalEntry(entry) {
                const entryEl = document.createElement('div');
                entryEl.className = 'journal-entry-card telegram-secondary-bg p-4 rounded-lg shadow';
                entryEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold telegram-text">${entry.title}</h3>
                            <p class="text-xs telegram-hint mb-1">${new Date(entry.date).toLocaleDateString()}</p>
                        </div>
                        <button data-entry-id="${entry.id}" class="delete-journal-entry-button telegram-hint hover:text-red-500 text-xl">&times;</button>
                    </div>
                    <p class="text-sm telegram-text mt-1 whitespace-pre-wrap">${entry.content.substring(0,150)}${entry.content.length > 150 ? '...' : ''}</p>
                `;
                // Add click to view full entry modal if desired
                entryEl.querySelector('.delete-journal-entry-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const entryId = e.currentTarget.dataset.entryId;
                    this.tgWebApp.showConfirm("Delete this journal entry?", (confirmed) => {
                        if (confirmed) this.deleteJournalEntry(entryId);
                    });
                });
                this.dom.journalEntriesList.appendChild(entryEl);
            },
            handleCreateJournalEntry: async () => {
                app.tgWebApp.MainButton.showProgress();
                const title = app.dom.journalEntryTitleInput.value.trim();
                const content = app.dom.journalEntryContentInput.value.trim();

                if (!title || !content) {
                    app.showError("Title and content are required for a journal entry.");
                    app.tgWebApp.MainButton.hideProgress();
                    return;
                }
                const newEntry = {
                    id: crypto.randomUUID(), // Simple unique ID
                    title,
                    content,
                    date: new Date().toISOString()
                };
                app.userJournalEntries.push(newEntry);
                app.saveToCloudStorage('userJournalEntries', app.userJournalEntries, (error) => {
                    app.tgWebApp.MainButton.hideProgress();
                    if (error) return;
                    app.showSuccess("Journal entry saved!");
                    app.dom.createJournalEntryForm.classList.add('hidden');
                    app.dom.journalEntryTitleInput.value = '';
                    app.dom.journalEntryContentInput.value = '';
                    app.loadJournalEntries(); // Refresh list
                });
            },
            deleteJournalEntry(entryId) {
                this.userJournalEntries = this.userJournalEntries.filter(entry => entry.id !== entryId);
                this.saveToCloudStorage('userJournalEntries', this.userJournalEntries, (error) => {
                    if(error) return;
                    this.showSuccess("Entry deleted.");
                    this.loadJournalEntries();
                });
            },

            setupEventListeners() {
                this.dom.bottomNav.addEventListener('click', (e) => {
                    const navButton = e.target.closest('.nav-item');
                    if (navButton && navButton.dataset.view) {
                        this.navigateTo(navButton.dataset.view);
                        this.tgWebApp.HapticFeedback.impactOccurred('light');
                    }
                });
                this.dom.profileForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleProfileSave(); });
                this.dom.modalCloseButton.addEventListener('click', () => this.closeModal());
                this.dom.modalContainer.addEventListener('click', (e) => { if (e.target === this.dom.modalContainer) this.closeModal(); });

                // Journal listeners
                this.dom.createJournalEntryButton.addEventListener('click', () => {
                    this.dom.createJournalEntryForm.classList.remove('hidden');
                    this.updateHeaderAndMainButton('journal-view');
                });
                this.dom.cancelJournalEntryButton.addEventListener('click', () => {
                    this.dom.createJournalEntryForm.classList.add('hidden');
                    this.dom.journalEntryTitleInput.value = '';
                    this.dom.journalEntryContentInput.value = '';
                    this.updateHeaderAndMainButton('journal-view');
                });
                this.dom.createJournalEntryForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleCreateJournalEntry(); });
                
                // Invite friend button
                this.dom.inviteFriendButton.addEventListener('click', () => {
                    const inviteText = `Check out LoveQuest, a fun app to explore connections! You can open it in Telegram.`; // Customize as needed
                    // Option 1: Open a link to your Mini App (if you have a direct link)
                    // this.tgWebApp.openTelegramLink(`https://t.me/your_bot_username/your_app_name`);
                    // Option 2: Switch to inline query to share the app (more complex, requires bot setup)
                    // this.tgWebApp.switchInlineQuery(`LoveQuest`);
                    // Option 3: Simple share text (user copies and pastes)
                    this.tgWebApp.showPopup({
                        title: "Invite a Friend",
                        message: "Share this link with your friends to invite them to LoveQuest:\n(Link to your Mini App)", // Replace with actual link
                        buttons: [{ type: "ok" }]
                    });
                     // For a real share, you'd use a proper link or inline query.
                     // For now, just show a generic message.
                     // this.showError("Share functionality to be implemented with a Mini App link or bot inline query.");
                });
            },
            
            closeModal() { /* ... same as before ... */ 
                this.dom.modalContainer.classList.add('hidden');
                this.dom.modalContainer.classList.remove('flex');
                this.dom.modalBody.innerHTML = ''; 
            },
            showError(message) { /* ... same as before ... */ 
                console.error("App Error:", message);
                this.tgWebApp.showAlert(message); 
                this.tgWebApp.HapticFeedback.notificationOccurred('error');
            },
            showSuccess(message) { /* ... same as before ... */ 
                console.log("App Success:", message);
                this.tgWebApp.HapticFeedback.notificationOccurred('success');
                const successToast = document.createElement('div');
                successToast.textContent = message;
                successToast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 telegram-button-bg telegram-button-text px-4 py-2 rounded-lg shadow-lg z-[200] text-sm';
                document.body.appendChild(successToast);
                setTimeout(() => { successToast.remove(); }, 2500);
            }
        };

        window.addEventListener('load', () => {
            if (app.tgWebApp.initDataUnsafe && app.tgWebApp.initDataUnsafe.user) {
                 app.init();
            } else {
                console.error("Critical: Telegram user data missing at load time.");
                const loadingView = document.getElementById('loading-view');
                if (loadingView) {
                    loadingView.innerHTML = `<p class="text-red-500 text-center p-6">App cannot start: Telegram user data is missing. Please launch from Telegram.</p>`;
                }
            }
        });
    </script>
</body>
</html>
