<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Direct Democracy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Tailwind configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tg: {
                            bg: 'var(--tg-theme-bg-color, #ffffff)',
                            text: 'var(--tg-theme-text-color, #000000)',
                            hint: 'var(--tg-theme-hint-color, #999999)',
                            link: 'var(--tg-theme-link-color, #5D5CDE)',
                            button: 'var(--tg-theme-button-color, #5D5CDE)',
                            buttonText: 'var(--tg-theme-button-text-color, #ffffff)',
                            secondary: 'var(--tg-theme-secondary-bg-color, #f0f0f0)',
                        }
                    },
                    fontFamily: {
                        sans: ['"Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'],
                    }
                }
            }
        };
    </script>
    <style type="text/css">
        :root {
            --default-bg-color: #ffffff;
            --default-text-color: #000000;
            --default-hint-color: #999999;
            --default-link-color: #5D5CDE;
            --default-button-color: #5D5CDE;
            --default-button-text-color: #ffffff;
            --default-secondary-bg-color: #f0f0f0;
        }
        
        /* Dark mode defaults if Telegram theme not available */
        .dark {
            --default-bg-color: #212121;
            --default-text-color: #ffffff;
            --default-hint-color: #aaaaaa;
            --default-link-color: #8E8DFF;
            --default-button-color: #8E8DFF;
            --default-button-text-color: #ffffff;
            --default-secondary-bg-color: #303030;
        }
        
        body {
            background-color: var(--tg-theme-bg-color, var(--default-bg-color));
            color: var(--tg-theme-text-color, var(--default-text-color));
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Telegram-style bubbles */
        .message-bubble {
            position: relative;
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 85%;
            margin-bottom: 8px;
        }
        
        .message-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 12px;
            height: 12px;
        }
        
        .message-bubble.outgoing {
            background-color: var(--tg-theme-button-color, var(--default-button-color));
            color: var(--tg-theme-button-text-color, var(--default-button-text-color));
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        
        .message-bubble.incoming {
            background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        /* Telegram-style scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-hint-color, var(--default-hint-color));
            border-radius: 5px;
        }

        /* Telegram-style vote animation */
        @keyframes vote-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .vote-animate {
            animation: vote-pulse 0.3s ease;
        }

        /* Ripple effect for buttons */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active::after {
            transform: scale(0, 0);
            opacity: .3;
            transition: 0s;
        }
    </style>
</head>
<body class="font-sans">
    <div id="app" class="flex flex-col h-screen max-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-10 shadow-sm" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color))">
            <div class="flex items-center justify-between p-3 border-b" style="border-color: var(--tg-theme-hint-color, var(--default-hint-color)); border-opacity: 0.2;">
                <div class="flex items-center">
                    <button id="back-button" class="mr-3 text-lg font-bold" style="color: var(--tg-theme-link-color, var(--default-link-color));">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                    <h1 class="text-lg font-bold" id="header-title">Digital Democracy</h1>
                </div>
                <div>
                    <button id="menu-button" class="text-lg" style="color: var(--tg-theme-link-color, var(--default-link-color));">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Tab navigation -->
            <div class="flex border-b overflow-x-auto" style="border-color: var(--tg-theme-hint-color, var(--default-hint-color)); border-opacity: 0.2;">
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap active" data-view="proposals">
                    Proposals
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="active-votes">
                    Active Votes
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="passed">
                    Passed
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="my-activities">
                    My Activities
                </button>
            </div>
        </header>

        <!-- Main content area -->
        <main class="flex-grow overflow-y-auto" id="main-content">
            <!-- Proposals View (default) -->
            <div id="proposals-view" class="view-content">
                <div class="p-4">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-bold">Active Proposals</h2>
                            <button id="new-proposal-btn" class="ripple px-3 py-1 rounded-full text-sm" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                + New Proposal
                            </button>
                        </div>
                        <p class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            Proposals require 100 supporters to advance to voting
                        </p>
                    </div>

                    <div class="proposal-list space-y-3">
                        <!-- Proposal cards will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Active Votes View -->
            <div id="active-votes-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Active Votes</h2>
                    <div class="active-votes-list space-y-3">
                        <!-- Active votes will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Passed Legislation View -->
            <div id="passed-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Passed Legislation</h2>
                    <div class="passed-list space-y-3">
                        <!-- Passed legislation will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- My Activities View -->
            <div id="my-activities-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">My Activities</h2>
                    <div class="activities-list space-y-3">
                        <!-- User activities will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Proposal Detail View -->
            <div id="proposal-detail-view" class="view-content hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h2 id="proposal-title" class="text-lg font-bold mb-1"></h2>
                        <p id="proposal-author" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                    </div>
                    
                    <div id="proposal-content" class="mb-4 text-sm"></div>
                    
                    <div class="support-section mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span id="support-count" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></span>
                            <button id="support-button" class="ripple px-4 py-2 rounded-full text-sm" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                Support
                            </button>
                        </div>
                        <div class="w-full h-2 rounded-full overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                            <div id="support-bar" class="h-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); width: 0%;"></div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold mb-2">Discussion</h3>
                    <div id="discussion-list" class="mb-4 space-y-3">
                        <!-- Discussion messages will be dynamically generated here -->
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="text" id="discussion-input" placeholder="Add to the discussion..." class="flex-grow p-2 rounded-full text-base" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">
                        <button id="send-discussion" class="ripple p-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vote Detail View -->
            <div id="vote-detail-view" class="view-content hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h2 id="vote-title" class="text-lg font-bold mb-1"></h2>
                        <p id="vote-status" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                    </div>
                    
                    <div id="vote-content" class="mb-4 text-sm"></div>
                    
                    <div class="voting-section mb-4">
                        <h3 class="font-bold mb-2">Cast Your Vote</h3>
                        <div class="flex gap-3 mb-4">
                            <button id="vote-yes" class="ripple flex-1 py-2 rounded-full text-sm" style="background-color: #4CAF50; color: white;">Yes</button>
                            <button id="vote-no" class="ripple flex-1 py-2 rounded-full text-sm" style="background-color: #F44336; color: white;">No</button>
                            <button id="vote-abstain" class="ripple flex-1 py-2 rounded-full text-sm" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">Abstain</button>
                        </div>
                        
                        <div class="results-section">
                            <div class="flex justify-between mb-1">
                                <span>Yes</span>
                                <span id="yes-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="yes-bar" class="h-full" style="background-color: #4CAF50; width: 0%;"></div>
                            </div>
                            
                            <div class="flex justify-between mb-1">
                                <span>No</span>
                                <span id="no-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="no-bar" class="h-full" style="background-color: #F44336; width: 0%;"></div>
                            </div>
                            
                            <div class="flex justify-between mb-1">
                                <span>Abstain</span>
                                <span id="abstain-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="abstain-bar" class="h-full" style="background-color: #9E9E9E; width: 0%;"></div>
                            </div>
                            
                            <p id="vote-time-remaining" class="text-sm mt-2" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                        </div>
                    </div>
                    
                    <div class="discussion-section">
                        <h3 class="font-bold mb-2">Discussion</h3>
                        <div id="vote-discussion-list" class="mb-4 space-y-3">
                            <!-- Vote discussion messages will be dynamically generated here -->
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="text" id="vote-discussion-input" placeholder="Add to the discussion..." class="flex-grow p-2 rounded-full text-base" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">
                            <button id="send-vote-discussion" class="ripple p-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Proposal Form -->
            <div id="new-proposal-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Create New Proposal</h2>
                    
                    <form id="proposal-form" class="space-y-4">
                        <div>
                            <label for="proposal-title-input" class="block mb-1 font-medium">Title</label>
                            <input type="text" id="proposal-title-input" class="w-full p-2 rounded text-base" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));" placeholder="Enter a clear, concise title">
                        </div>
                        
                        <div>
                            <label for="proposal-content-input" class="block mb-1 font-medium">Content</label>
                            <textarea id="proposal-content-input" rows="8" class="w-full p-2 rounded text-base" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));" placeholder="Describe your proposal in detail..."></textarea>
                        </div>
                        
                        <div>
                            <label for="proposal-category" class="block mb-1 font-medium">Category</label>
                            <select id="proposal-category" class="w-full p-2 rounded text-base" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">
                                <option value="environment">Environment</option>
                                <option value="economy">Economy</option>
                                <option value="education">Education</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 pt-3">
                            <button type="button" id="cancel-proposal" class="ripple flex-1 py-2 rounded-full" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">Cancel</button>
                            <button type="submit" id="submit-proposal" class="ripple flex-1 py-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram?.WebApp;
        let user = {};
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            if (tg) {
                tg.expand();
                tg.ready();
                user = {
                    id: tg.initDataUnsafe?.user?.id || 'anonymous',
                    first_name: tg.initDataUnsafe?.user?.first_name || 'Anonymous',
                    last_name: tg.initDataUnsafe?.user?.last_name || 'User',
                    username: tg.initDataUnsafe?.user?.username || 'anonymous'
                };
            } else {
                console.log("Telegram WebApp is not available. Using demo mode.");
                // Set default theme colors for testing
                document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', '#5D5CDE');
                document.documentElement.style.setProperty('--tg-theme-button-color', '#5D5CDE');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', '#f0f0f0');
                
                // Check for dark mode
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.style.setProperty('--tg-theme-bg-color', '#212121');
                    document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
                    document.documentElement.style.setProperty('--tg-theme-hint-color', '#aaaaaa');
                    document.documentElement.style.setProperty('--tg-theme-link-color', '#8E8DFF');
                    document.documentElement.style.setProperty('--tg-theme-button-color', '#8E8DFF');
                    document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                    document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', '#303030');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        document.documentElement.style.setProperty('--tg-theme-bg-color', '#212121');
                        document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
                        document.documentElement.style.setProperty('--tg-theme-hint-color', '#aaaaaa');
                        document.documentElement.style.setProperty('--tg-theme-link-color', '#8E8DFF');
                        document.documentElement.style.setProperty('--tg-theme-button-color', '#8E8DFF');
                        document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', '#303030');
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
                        document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
                        document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');
                        document.documentElement.style.setProperty('--tg-theme-link-color', '#5D5CDE');
                        document.documentElement.style.setProperty('--tg-theme-button-color', '#5D5CDE');
                        document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', '#f0f0f0');
                    }
                });
                
                // Mock user for testing
                user = {
                    id: 'demo123',
                    first_name: 'Demo',
                    last_name: 'User',
                    username: 'demouser'
                };
            }
            
            // Set active tab style
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.classList.contains('active')) {
                    button.style.borderBottom = `2px solid var(--tg-theme-button-color, var(--default-button-color))`;
                    button.style.color = `var(--tg-theme-button-color, var(--default-button-color))`;
                } else {
                    button.style.borderBottom = 'none';
                    button.style.color = `var(--tg-theme-text-color, var(--default-text-color))`;
                }
            });
            
            initData();
            setupEventListeners();
        });

        // Sample data
        const mockData = {
            proposals: [
                {
                    id: 1,
                    title: "Urban Green Space Expansion",
                    author: "EcoAdvocate",
                    authorId: "eco123",
                    content: "Proposal to mandate that 15% of all new urban development must be dedicated to public green spaces, including parks, community gardens, and natural conservation areas.",
                    supporters: 78,
                    requiredSupporters: 100,
                    category: "environment",
                    timestamp: new Date(Date.now() - 86400000 * 3).toISOString(),
                    discussion: [
                        {
                            id: 1,
                            author: "UrbanPlanner",
                            authorId: "urban456",
                            content: "This proposal would significantly improve quality of life in urban areas while promoting biodiversity.",
                            timestamp: new Date(Date.now() - 86400000 * 2).toISOString()
                        },
                        {
                            id: 2,
                            author: "DevelopmentPro",
                            authorId: "dev789",
                            content: "While I support the goal, 15% may be excessive in dense urban areas. Perhaps we could consider a sliding scale based on population density?",
                            timestamp: new Date(Date.now() - 86400000 * 1).toISOString()
                        }
                    ]
                },
                {
                    id: 2,
                    title: "Digital Education Fund",
                    author: "TechEdu",
                    authorId: "tech456",
                    content: "Establish a dedicated fund to provide digital devices and high-speed internet access to all students in public education systems, ensuring equal access to digital learning resources.",
                    supporters: 92,
                    requiredSupporters: 100,
                    category: "education",
                    timestamp: new Date(Date.now() - 86400000 * 2).toISOString(),
                    discussion: [
                        {
                            id: 1,
                            author: "TeacherVoice",
                            authorId: "teach123",
                            content: "As a teacher, I've seen firsthand how the digital divide affects learning outcomes. This is desperately needed.",
                            timestamp: new Date(Date.now() - 86400000 * 1).toISOString()
                        }
                    ]
                },
                {
                    id: 3,
                    title: "Community Healthcare Centers",
                    author: "HealthAdvocate",
                    authorId: "health789",
                    content: "Fund the establishment of community healthcare centers in underserved neighborhoods to provide basic preventative care, vaccinations, and health education.",
                    supporters: 65,
                    requiredSupporters: 100,
                    category: "healthcare",
                    timestamp: new Date(Date.now() - 86400000 * 1).toISOString(),
                    discussion: []
                }
            ],
            activeVotes: [
                {
                    id: 101,
                    title: "Renewable Energy Transition",
                    content: "Mandate that 50% of all energy production must come from renewable sources by 2030, with incentives for solar, wind, and hydroelectric power development.",
                    yesVotes: 1245,
                    noVotes: 532,
                    abstainVotes: 89,
                    totalVotes: 1866,
                    category: "environment",
                    endTime: new Date(Date.now() + 86400000 * 3).toISOString(),
                    discussion: [
                        {
                            id: 1,
                            author: "EnergyExpert",
                            authorId: "energy123",
                            content: "The timeline is ambitious but achievable with proper investment. I support this transition.",
                            timestamp: new Date(Date.now() - 86400000 * 2).toISOString()
                        },
                        {
                            id: 2,
                            author: "EconomistView",
                            authorId: "econ456",
                            content: "We need to ensure that energy prices remain affordable during this transition. Has an economic impact study been conducted?",
                            timestamp: new Date(Date.now() - 86400000 * 1).toISOString()
                        }
                    ]
                },
                {
                    id: 102,
                    title: "Universal Basic Income Pilot",
                    content: "Establish a 2-year pilot program providing a universal basic income of $1,000 per month to 5,000 randomly selected adult citizens to study the economic and social impacts.",
                    yesVotes: 983,
                    noVotes: 1024,
                    abstainVotes: 121,
                    totalVotes: 2128,
                    category: "economy",
                    endTime: new Date(Date.now() + 86400000 * 5).toISOString(),
                    discussion: [
                        {
                            id: 1,
                            author: "EconomicJustice",
                            authorId: "justice123",
                            content: "This pilot would provide valuable data on UBI effects while supporting vulnerable citizens.",
                            timestamp: new Date(Date.now() - 86400000 * 3).toISOString()
                        }
                    ]
                }
            ],
            passedLegislation: [
                {
                    id: 201,
                    title: "Public Transportation Expansion",
                    content: "Allocate funding to expand public transportation networks, including bus routes and light rail, to reduce traffic congestion and decrease carbon emissions from private vehicles.",
                    yesVotes: 1876,
                    noVotes: 423,
                    abstainVotes: 102,
                    totalVotes: 2401,
                    category: "infrastructure",
                    implementationDate: new Date(Date.now() + 86400000 * 30).toISOString(),
                    passedDate: new Date(Date.now() - 86400000 * 5).toISOString()
                },
                {
                    id: 202,
                    title: "Mental Health Services Funding",
                    content: "Increase funding for mental health services by 15%, with a focus on community-based treatment options, prevention programs, and reducing stigma around mental health issues.",
                    yesVotes: 2103,
                    noVotes: 298,
                    abstainVotes: 76,
                    totalVotes: 2477,
                    category: "healthcare",
                    implementationDate: new Date(Date.now() + 86400000 * 45).toISOString(),
                    passedDate: new Date(Date.now() - 86400000 * 10).toISOString()
                }
            ],
            userActivities: [
                {
                    id: 301,
                    type: "support",
                    title: "Digital Education Fund",
                    timestamp: new Date(Date.now() - 86400000 * 1).toISOString(),
                    relatedId: 2
                },
                {
                    id: 302,
                    type: "vote",
                    title: "Renewable Energy Transition",
                    vote: "yes",
                    timestamp: new Date(Date.now() - 86400000 * 2).toISOString(),
                    relatedId: 101
                },
                {
                    id: 303,
                    type: "comment",
                    title: "Urban Green Space Expansion",
                    comment: "I think this is crucial for improving urban livability and addressing climate change.",
                    timestamp: new Date(Date.now() - 86400000 * 3).toISOString(),
                    relatedId: 1
                }
            ]
        };

        function initData() {
            renderProposals();
            renderActiveVotes();
            renderPassedLegislation();
            renderUserActivities();
        }

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.dataset.view;
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.borderBottom = 'none';
                        btn.style.color = `var(--tg-theme-text-color, var(--default-text-color))`;
                    });
                    this.classList.add('active');
                    this.style.borderBottom = `2px solid var(--tg-theme-button-color, var(--default-button-color))`;
                    this.style.color = `var(--tg-theme-button-color, var(--default-button-color))`;
                    
                    document.querySelectorAll('.view-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(`${view}-view`).classList.remove('hidden');
                    document.getElementById('header-title').textContent = view.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                });
            });
            
            // Back button
            document.getElementById('back-button').addEventListener('click', function() {
                const detailViews = ['proposal-detail-view', 'vote-detail-view', 'new-proposal-view'];
                let isDetailView = false;
                
                detailViews.forEach(viewId => {
                    if (!document.getElementById(viewId).classList.contains('hidden')) {
                        document.getElementById(viewId).classList.add('hidden');
                        isDetailView = true;
                    }
                });
                
                if (isDetailView) {
                    // Return to the main view
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        if (btn.classList.contains('active')) {
                            document.getElementById(`${btn.dataset.view}-view`).classList.remove('hidden');
                        }
                    });
                    return;
                }
                
                // If we're not in a detail view, just close the WebApp
                if (tg) {
                    tg.close();
                }
            });
            
            // New proposal button
            document.getElementById('new-proposal-btn').addEventListener('click', function() {
                document.querySelectorAll('.view-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById('new-proposal-view').classList.remove('hidden');
                document.getElementById('header-title').textContent = 'New Proposal';
            });
            
            // Cancel proposal button
            document.getElementById('cancel-proposal').addEventListener('click', function() {
                document.getElementById('new-proposal-view').classList.add('hidden');
                document.getElementById('proposals-view').classList.remove('hidden');
                document.getElementById('header-title').textContent = 'Proposals';
                document.getElementById('proposal-form').reset();
            });
            
            // Submit proposal form
            document.getElementById('proposal-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('proposal-title-input').value;
                const content = document.getElementById('proposal-content-input').value;
                const category = document.getElementById('proposal-category').value;
                
                if (!title || !content) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Create new proposal
                const newProposal = {
                    id: mockData.proposals.length + 1 + 100,
                    title: title,
                    author: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                    authorId: user.id,
                    content: content,
                    supporters: 1, // Author supports by default
                    requiredSupporters: 100,
                    category: category,
                    timestamp: new Date().toISOString(),
                    discussion: []
                };
                
                mockData.proposals.push(newProposal);
                
                // Add to user activities
                mockData.userActivities.push({
                    id: mockData.userActivities.length + 1 + 1000,
                    type: "proposal",
                    title: title,
                    timestamp: new Date().toISOString(),
                    relatedId: newProposal.id
                });
                
                // Update views
                renderProposals();
                renderUserActivities();
                
                // Show success notification
                const notification = document.createElement('div');
                notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'px-4', 'py-2', 'rounded', 'shadow-lg');
                notification.style.backgroundColor = 'var(--tg-theme-button-color, var(--default-button-color))';
                notification.style.color = 'var(--tg-theme-button-text-color, var(--default-button-text-color))';
                notification.textContent = 'Proposal submitted successfully!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
                
                // Reset form and go back to proposals
                document.getElementById('proposal-form').reset();
                document.getElementById('new-proposal-view').classList.add('hidden');
                document.getElementById('proposals-view').classList.remove('hidden');
                document.getElementById('header-title').textContent = 'Proposals';
            });
            
            // Support button
            document.getElementById('support-button').addEventListener('click', function() {
                const proposalId = parseInt(this.dataset.proposalId);
                const proposal = mockData.proposals.find(p => p.id === proposalId);
                
                if (!proposal) return;
                
                // Check if user already supported
                const alreadySupported = mockData.userActivities.some(activity => 
                    activity.type === 'support' && activity.relatedId === proposalId
                );
                
                if (alreadySupported) {
                    // Show notification that user already supported
                    const notification = document.createElement('div');
                    notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'px-4', 'py-2', 'rounded', 'shadow-lg');
                    notification.style.backgroundColor = 'var(--tg-theme-button-color, var(--default-button-color))';
                    notification.style.color = 'var(--tg-theme-button-text-color, var(--default-button-text-color))';
                    notification.textContent = 'You have already supported this proposal';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                    
                    return;
                }
                
                // Add support
                proposal.supporters += 1;
                
                // Add to user activities
                mockData.userActivities.push({
                    id: mockData.userActivities.length + 1 + 1000,
                    type: "support",
                    title: proposal.title,
                    timestamp: new Date().toISOString(),
                    relatedId: proposalId
                });
                
                // Check if proposal has enough support to move to voting
                if (proposal.supporters >= proposal.requiredSupporters) {
                    // Move to active votes
                    const newVote = {
                        id: mockData.activeVotes.length + 1 + 1000,
                        title: proposal.title,
                        content: proposal.content,
                        yesVotes: 0,
                        noVotes: 0,
                        abstainVotes: 0,
                        totalVotes: 0,
                        category: proposal.category,
                        endTime: new Date(Date.now() + 86400000 * 7).toISOString(), // 7 days from now
                        discussion: proposal.discussion
                    };
                    
                    mockData.activeVotes.push(newVote);
                    
                    // Remove from proposals
                    mockData.proposals = mockData.proposals.filter(p => p.id !== proposalId);
                    
                    // Update views
                    renderProposals();
                    renderActiveVotes();
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'px-4', 'py-2', 'rounded', 'shadow-lg');
                    notification.style.backgroundColor = 'var(--tg-theme-button-color, var(--default-button-color))';
                    notification.style.color = 'var(--tg-theme-button-text-color, var(--default-button-text-color))';
                    notification.textContent = 'Proposal has advanced to voting stage!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                    
                    // Go back to proposals
                    document.getElementById('proposal-detail-view').classList.add('hidden');
                    document.getElementById('proposals-view').classList.remove('hidden');
                    document.getElementById('header-title').textContent = 'Proposals';
                } else {
                    // Update proposal details
                    updateProposalDetails(proposalId);
                    
                    // Add animation to the support button
                    this.classList.add('vote-animate');
                    setTimeout(() => {
                        this.classList.remove('vote-animate');
                    }, 300);
                }
                
                // Update user activities
                renderUserActivities();
            });
            
            // Voting buttons
            ['vote-yes', 'vote-no', 'vote-abstain'].forEach(buttonId => {
                document.getElementById(buttonId).addEventListener('click', function() {
                    const voteId = parseInt(this.dataset.voteId);
                    const vote = mockData.activeVotes.find(v => v.id === voteId);
                    
                    if (!vote) return;
                    
                    // Check if user already voted
                    const alreadyVoted = mockData.userActivities.some(activity => 
                        activity.type === 'vote' && activity.relatedId === voteId
                    );
                    
                    if (alreadyVoted) {
                        // Show notification that user already voted
                        const notification = document.createElement('div');
                        notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'px-4', 'py-2', 'rounded', 'shadow-lg');
                        notification.style.backgroundColor = 'var(--tg-theme-button-color, var(--default-button-color))';
                        notification.style.color = 'var(--tg-theme-button-text-color, var(--default-button-text-color))';
                        notification.textContent = 'You have already voted on this proposal';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 3000);
                        
                        return;
                    }
                    
                    // Add vote
                    const voteType = buttonId.split('-')[1];
                    if (voteType === 'yes') {
                        vote.yesVotes += 1;
                    } else if (voteType === 'no') {
                        vote.noVotes += 1;
                    } else {
                        vote.abstainVotes += 1;
                    }
                    
                    vote.totalVotes += 1;
                    
                    // Add to user activities
                    mockData.userActivities.push({
                        id: mockData.userActivities.length + 1 + 1000,
                        type: "vote",
                        title: vote.title,
                        vote: voteType,
                        timestamp: new Date().toISOString(),
                        relatedId: voteId
                    });
                    
                    // Update vote details
                    updateVoteDetails(voteId);
                    
                    // Add animation to the vote button
                    this.classList.add('vote-animate');
                    setTimeout(() => {
                        this.classList.remove('vote-animate');
                    }, 300);
                    
                    // Update user activities
                    renderUserActivities();
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'px-4', 'py-2', 'rounded', 'shadow-lg');
                    notification.style.backgroundColor = 'var(--tg-theme-button-color, var(--default-button-color))';
                    notification.style.color = 'var(--tg-theme-button-text-color, var(--default-button-text-color))';
                    notification.textContent = 'Vote cast successfully!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                });
            });
            
            // Discussion send buttons
            document.getElementById('send-discussion').addEventListener('click', function() {
                sendDiscussion('proposal');
            });
            
            document.getElementById('send-vote-discussion').addEventListener('click', function() {
                sendDiscussion('vote');
            });
            
            // Setup discussion input enter key press
            document.getElementById('discussion-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendDiscussion('proposal');
                }
            });
            
            document.getElementById('vote-discussion-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendDiscussion('vote');
                }
            });
        }

        function renderProposals() {
            const proposalList = document.querySelector('.proposal-list');
            proposalList.innerHTML = '';
            
            if (mockData.proposals.length === 0) {
                proposalList.innerHTML = `
                    <div class="p-4 rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <p class="text-center">No proposals available. Be the first to create one!</p>
                    </div>
                `;
                return;
            }
            
            mockData.proposals.forEach(proposal => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded shadow-sm';
                card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color))';
                
                // Calculate progress percentage
                const progressPercent = Math.min(100, Math.round((proposal.supporters / proposal.requiredSupporters) * 100));
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium">${proposal.title}</h3>
                        <span class="text-xs px-2 py-1 rounded-full" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color)); color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            ${proposal.category}
                        </span>
                    </div>
                    <p class="text-sm mb-3" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                        By ${proposal.author}  ${timeAgo(new Date(proposal.timestamp))}
                    </p>
                    <p class="text-sm mb-3 line-clamp-2">${proposal.content}</p>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            ${proposal.supporters} of ${proposal.requiredSupporters} supporters
                        </span>
                        <span class="text-xs font-bold" style="color: var(--tg-theme-button-color, var(--default-button-color));">
                            ${progressPercent}%
                        </span>
                    </div>
                    <div class="w-full h-1.5 rounded-full overflow-hidden" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                        <div class="h-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); width: ${progressPercent}%;"></div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    showProposalDetails(proposal.id);
                });
                
                proposalList.appendChild(card);
            });
        }

        function renderActiveVotes() {
            const votesList = document.querySelector('.active-votes-list');
            votesList.innerHTML = '';
            
            if (mockData.activeVotes.length === 0) {
                votesList.innerHTML = `
                    <div class="p-4 rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <p class="text-center">No active votes at the moment.</p>
                    </div>
                `;
                return;
            }
            
            mockData.activeVotes.forEach(vote => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded shadow-sm';
                card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color))';
                
                // Calculate percentages
                const yesPercent = vote.totalVotes > 0 ? Math.round((vote.yesVotes / vote.totalVotes) * 100) : 0;
                const noPercent = vote.totalVotes > 0 ? Math.round((vote.noVotes / vote.totalVotes) * 100) : 0;
                const abstainPercent = vote.totalVotes > 0 ? Math.round((vote.abstainVotes / vote.totalVotes) * 100) : 0;
                
                // Calculate time remaining
                const endDate = new Date(vote.endTime);
                const now = new Date();
                const timeRemaining = timeRemaining_(endDate, now);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium">${vote.title}</h3>
                        <span class="text-xs px-2 py-1 rounded-full" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color)); color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            ${vote.category}
                        </span>
                    </div>
                    <p class="text-sm mb-3 line-clamp-2">${vote.content}</p>
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs">Yes</span>
                            <span class="text-xs">${yesPercent}% (${vote.yesVotes})</span>
                        </div>
                        <div class="w-full h-1.5 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                            <div class="h-full" style="background-color: #4CAF50; width: ${yesPercent}%;"></div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs">No</span>
                            <span class="text-xs">${noPercent}% (${vote.noVotes})</span>
                        </div>
                        <div class="w-full h-1.5 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                            <div class="h-full" style="background-color: #F44336; width: ${noPercent}%;"></div>
                        </div>
                    </div>
                    <p class="text-xs" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                        ${vote.totalVotes} votes  ${timeRemaining} remaining
                    </p>
                `;
                
                card.addEventListener('click', () => {
                    showVoteDetails(vote.id);
                });
                
                votesList.appendChild(card);
            });
        }

        function renderPassedLegislation() {
            const passedList = document.querySelector('.passed-list');
            passedList.innerHTML = '';
            
            if (mockData.passedLegislation.length === 0) {
                passedList.innerHTML = `
                    <div class="p-4 rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <p class="text-center">No passed legislation yet.</p>
                    </div>
                `;
                return;
            }
            
            mockData.passedLegislation.forEach(legislation => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded shadow-sm';
                card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color))';
                
                // Calculate percentages
                const yesPercent = legislation.totalVotes > 0 ? Math.round((legislation.yesVotes / legislation.totalVotes) * 100) : 0;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium">${legislation.title}</h3>
                        <span class="text-xs px-2 py-1 rounded-full" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color)); color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            ${legislation.category}
                        </span>
                    </div>
                    <p class="text-sm mb-3 line-clamp-2">${legislation.content}</p>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="px-2 py-1 rounded text-xs" style="background-color: #4CAF50; color: white;">
                            Passed with ${yesPercent}%
                        </div>
                        <span class="text-xs" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            ${legislation.totalVotes} votes
                        </span>
                    </div>
                    <p class="text-xs" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                        Passed ${timeAgo(new Date(legislation.passedDate))}  Implementation: ${formatDate(new Date(legislation.implementationDate))}
                    </p>
                `;
                
                passedList.appendChild(card);
            });
        }

        function renderUserActivities() {
            const activitiesList = document.querySelector('.activities-list');
            activitiesList.innerHTML = '';
            
            if (mockData.userActivities.length === 0) {
                activitiesList.innerHTML = `
                    <div class="p-4 rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <p class="text-center">No activities yet. Start participating!</p>
                    </div>
                `;
                return;
            }
            
            // Sort activities by timestamp (newest first)
            const sortedActivities = [...mockData.userActivities].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedActivities.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded shadow-sm';
                card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color))';
                
                let icon, activityText;
                
                switch(activity.type) {
                    case 'proposal':
                        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
                        activityText = `You created a proposal: "${activity.title}"`;
                        break;
                    case 'support':
                        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>';
                        activityText = `You supported: "${activity.title}"`;
                        break;
                    case 'vote':
                        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>';
                        activityText = `You voted ${activity.vote} on: "${activity.title}"`;
                        break;
                    case 'comment':
                        icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>';
                        activityText = `You commented on: "${activity.title}"`;
                        break;
                }
                
                card.innerHTML = `
                    <div class="flex gap-3">
                        <div class="mt-1" style="color: var(--tg-theme-button-color, var(--default-button-color));">
                            ${icon}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm mb-1">${activityText}</p>
                            ${activity.comment ? `<p class="text-sm mb-2 italic">"${activity.comment}"</p>` : ''}
                            <p class="text-xs" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                                ${timeAgo(new Date(activity.timestamp))}
                            </p>
                        </div>
                    </div>
                `;
                
                // Add click handler to navigate to the related item
                if (activity.relatedId) {
                    card.addEventListener('click', () => {
                        // Find what type of item this is
                        const proposal = mockData.proposals.find(p => p.id === activity.relatedId);
                        if (proposal) {
                            showProposalDetails(proposal.id);
                            return;
                        }
                        
                        const vote = mockData.activeVotes.find(v => v.id === activity.relatedId);
                        if (vote) {
                            showVoteDetails(vote.id);
                            return;
                        }
                    });
                }
                
                activitiesList.appendChild(card);
            });
        }

        function showProposalDetails(proposalId) {
            const proposal = mockData.proposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            document.getElementById('proposal-title').textContent = proposal.title;
            document.getElementById('proposal-author').textContent = `Proposed by ${proposal.author}  ${timeAgo(new Date(proposal.timestamp))}`;
            document.getElementById('proposal-content').textContent = proposal.content;
            document.getElementById('support-count').textContent = `${proposal.supporters} of ${proposal.requiredSupporters} supporters`;
            
            // Calculate progress percentage
            const progressPercent = Math.min(100, Math.round((proposal.supporters / proposal.requiredSupporters) * 100));
            document.getElementById('support-bar').style.width = `${progressPercent}%`;
            
            // Set support button data
            const supportButton = document.getElementById('support-button');
            supportButton.dataset.proposalId = proposalId;
            
            // Check if user already supported
            const alreadySupported = mockData.userActivities.some(activity => 
                activity.type === 'support' && activity.relatedId === proposalId
            );
            
            if (alreadySupported) {
                supportButton.textContent = 'Supported';
                supportButton.disabled = true;
                supportButton.style.opacity = '0.7';
            } else {
                supportButton.textContent = 'Support';
                supportButton.disabled = false;
                supportButton.style.opacity = '1';
            }
            
            // Render discussion
            renderDiscussion(proposal.discussion, 'discussion-list');
            
            // Show proposal detail view
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('proposal-detail-view').classList.remove('hidden');
            document.getElementById('header-title').textContent = 'Proposal Details';
        }

        function updateProposalDetails(proposalId) {
            const proposal = mockData.proposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            document.getElementById('support-count').textContent = `${proposal.supporters} of ${proposal.requiredSupporters} supporters`;
            
            // Calculate progress percentage
            const progressPercent = Math.min(100, Math.round((proposal.supporters / proposal.requiredSupporters) * 100));
            document.getElementById('support-bar').style.width = `${progressPercent}%`;
            
            // Check if user already supported
            const alreadySupported = mockData.userActivities.some(activity => 
                activity.type === 'support' && activity.relatedId === proposalId
            );
            
            const supportButton = document.getElementById('support-button');
            if (alreadySupported) {
                supportButton.textContent = 'Supported';
                supportButton.disabled = true;
                supportButton.style.opacity = '0.7';
            }
        }

        function showVoteDetails(voteId) {
            const vote = mockData.activeVotes.find(v => v.id === voteId);
            if (!vote) return;
            
            document.getElementById('vote-title').textContent = vote.title;
            
            // Calculate time remaining
            const endDate = new Date(vote.endTime);
            const now = new Date();
            const timeRemaining = timeRemaining_(endDate, now);
            
            document.getElementById('vote-status').textContent = `Voting ends in ${timeRemaining}  ${vote.totalVotes} votes cast`;
            document.getElementById('vote-content').textContent = vote.content;
            document.getElementById('vote-time-remaining').textContent = `Voting ends ${formatDate(endDate)}`;
            
            // Calculate percentages
            const yesPercent = vote.totalVotes > 0 ? Math.round((vote.yesVotes / vote.totalVotes) * 100) : 0;
            const noPercent = vote.totalVotes > 0 ? Math.round((vote.noVotes / vote.totalVotes) * 100) : 0;
            const abstainPercent = vote.totalVotes > 0 ? Math.round((vote.abstainVotes / vote.totalVotes) * 100) : 0;
            
            document.getElementById('yes-percentage').textContent = `${yesPercent}% (${vote.yesVotes})`;
            document.getElementById('no-percentage').textContent = `${noPercent}% (${vote.noVotes})`;
            document.getElementById('abstain-percentage').textContent = `${abstainPercent}% (${vote.abstainVotes})`;
            
            document.getElementById('yes-bar').style.width = `${yesPercent}%`;
            document.getElementById('no-bar').style.width = `${noPercent}%`;
            document.getElementById('abstain-bar').style.width = `${abstainPercent}%`;
            
            // Set vote buttons data
            document.getElementById('vote-yes').dataset.voteId = voteId;
            document.getElementById('vote-no').dataset.voteId = voteId;
            document.getElementById('vote-abstain').dataset.voteId = voteId;
            
            // Check if user already voted
            const alreadyVoted = mockData.userActivities.some(activity => 
                activity.type === 'vote' && activity.relatedId === voteId
            );
            
            if (alreadyVoted) {
                const userVote = mockData.userActivities.find(activity => 
                    activity.type === 'vote' && activity.relatedId === voteId
                );
                
                // Disable all vote buttons
                document.getElementById('vote-yes').disabled = true;
                document.getElementById('vote-no').disabled = true;
                document.getElementById('vote-abstain').disabled = true;
                
                document.getElementById('vote-yes').style.opacity = '0.7';
                document.getElementById('vote-no').style.opacity = '0.7';
                document.getElementById('vote-abstain').style.opacity = '0.7';
                
                // Highlight the user's vote
                if (userVote) {
                    document.getElementById(`vote-${userVote.vote}`).style.opacity = '1';
                }
            } else {
                document.getElementById('vote-yes').disabled = false;
                document.getElementById('vote-no').disabled = false;
                document.getElementById('vote-abstain').disabled = false;
                
                document.getElementById('vote-yes').style.opacity = '1';
                document.getElementById('vote-no').style.opacity = '1';
                document.getElementById('vote-abstain').style.opacity = '1';
            }
            
            // Render discussion
            renderDiscussion(vote.discussion, 'vote-discussion-list');
            
            // Show vote detail view
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('vote-detail-view').classList.remove('hidden');
            document.getElementById('header-title').textContent = 'Vote Details';
        }

        function updateVoteDetails(voteId) {
            const vote = mockData.activeVotes.find(v => v.id === voteId);
            if (!vote) return;
            
            // Calculate time remaining
            const endDate = new Date(vote.endTime);
            const now = new Date();
            const timeRemaining = timeRemaining_(endDate, now);
            
            document.getElementById('vote-status').textContent = `Voting ends in ${timeRemaining}  ${vote.totalVotes} votes cast`;
            
            // Calculate percentages
            const yesPercent = vote.totalVotes > 0 ? Math.round((vote.yesVotes / vote.totalVotes) * 100) : 0;
            const noPercent = vote.totalVotes > 0 ? Math.round((vote.noVotes / vote.totalVotes) * 100) : 0;
            const abstainPercent = vote.totalVotes > 0 ? Math.round((vote.abstainVotes / vote.totalVotes) * 100) : 0;
            
            document.getElementById('yes-percentage').textContent = `${yesPercent}% (${vote.yesVotes})`;
            document.getElementById('no-percentage').textContent = `${noPercent}% (${vote.noVotes})`;
            document.getElementById('abstain-percentage').textContent = `${abstainPercent}% (${vote.abstainVotes})`;
            
            document.getElementById('yes-bar').style.width = `${yesPercent}%`;
            document.getElementById('no-bar').style.width = `${noPercent}%`;
            document.getElementById('abstain-bar').style.width = `${abstainPercent}%`;
            
            // Check if user already voted
            const alreadyVoted = mockData.userActivities.some(activity => 
                activity.type === 'vote' && activity.relatedId === voteId
            );
            
            if (alreadyVoted) {
                const userVote = mockData.userActivities.find(activity => 
                    activity.type === 'vote' && activity.relatedId === voteId
                );
                
                // Disable all vote buttons
                document.getElementById('vote-yes').disabled = true;
                document.getElementById('vote-no').disabled = true;
                document.getElementById('vote-abstain').disabled = true;
                
                document.getElementById('vote-yes').style.opacity = '0.7';
                document.getElementById('vote-no').style.opacity = '0.7';
                document.getElementById('vote-abstain').style.opacity = '0.7';
                
                // Highlight the user's vote
                if (userVote) {
                    document.getElementById(`vote-${userVote.vote}`).style.opacity = '1';
                }
            }
        }

        function renderDiscussion(discussion, containerId) {
            const discussionList = document.getElementById(containerId);
            discussionList.innerHTML = '';
            
            if (discussion.length === 0) {
                discussionList.innerHTML = `
                    <p class="text-center text-sm italic" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                        No comments yet. Be the first to start the discussion!
                    </p>
                `;
                return;
            }
            
            // Sort discussion by timestamp (oldest first)
            const sortedDiscussion = [...discussion].sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );
            
            sortedDiscussion.forEach(message => {
                const isCurrentUser = message.authorId === user.id;
                const messageEl = document.createElement('div');
                
                messageEl.innerHTML = `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="message-bubble ${isCurrentUser ? 'outgoing' : 'incoming'} max-w-[80%]">
                            ${!isCurrentUser ? `<p class="text-xs font-bold mb-1">${message.author}</p>` : ''}
                            <p class="text-sm">${message.content}</p>
                            <p class="text-xs text-right mt-1" style="opacity: 0.7;">
                                ${timeAgo(new Date(message.timestamp))}
                            </p>
                        </div>
                    </div>
                `;
                
                discussionList.appendChild(messageEl);
            });
            
            // Scroll to bottom
            discussionList.scrollTop = discussionList.scrollHeight;
        }

        function sendDiscussion(type) {
            let input, discussionList, targetArray, targetId;
            
            if (type === 'proposal') {
                input = document.getElementById('discussion-input');
                discussionList = document.getElementById('discussion-list');
                targetId = parseInt(document.getElementById('support-button').dataset.proposalId);
                targetArray = mockData.proposals.find(p => p.id === targetId)?.discussion;
            } else {
                input = document.getElementById('vote-discussion-input');
                discussionList = document.getElementById('vote-discussion-list');
                targetId = parseInt(document.getElementById('vote-yes').dataset.voteId);
                targetArray = mockData.activeVotes.find(v => v.id === targetId)?.discussion;
            }
            
            if (!input || !targetArray) return;
            
            const content = input.value.trim();
            if (!content) return;
            
            // Create new message
            const newMessage = {
                id: targetArray.length + 1,
                author: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                authorId: user.id,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            // Add to array
            targetArray.push(newMessage);
            
            // Add to user activities
            mockData.userActivities.push({
                id: mockData.userActivities.length + 1 + 1000,
                type: "comment",
                title: type === 'proposal' 
                    ? mockData.proposals.find(p => p.id === targetId)?.title
                    : mockData.activeVotes.find(v => v.id === targetId)?.title,
                comment: content,
                timestamp: new Date().toISOString(),
                relatedId: targetId
            });
            
            // Re-render discussion
            renderDiscussion(targetArray, discussionList.id);
            
            // Clear input
            input.value = '';
            
            // Update user activities
            renderUserActivities();
        }

        // Helper functions
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return '1 day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return '1 minute ago';
            
            if (seconds < 10) return 'just now';
            
            return Math.floor(seconds) + ' seconds ago';
        }

        function timeRemaining_(endDate, now) {
            const diffTime = endDate - now;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays > 1) return diffDays + ' days';
            if (diffDays === 1) return '1 day and ' + diffHours + ' hours';
            if (diffHours > 1) return diffHours + ' hours';
            if (diffHours === 1) return '1 hour';
            
            const diffMinutes = Math.floor((diffTime % (1000 * 60 * 60)) / (1000 * 60));
            return diffMinutes + ' minutes';
        }

        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>
