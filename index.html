<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>City Cycle Tours</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: 'var(--tg-theme-button-color, #5D5CDE)',
            'primary-text': 'var(--tg-theme-button-text-color, #ffffff)',
            bg: 'var(--tg-theme-bg-color, #ffffff)',
            text: 'var(--tg-theme-text-color, #222222)',
            hint: 'var(--tg-theme-hint-color, #999999)',
            link: 'var(--tg-theme-link-color, #2678b6)',
            'section-bg': 'var(--tg-theme-secondary-bg-color, #f0f0f0)',
            'section-header-bg': 'var(--tg-theme-header-bg-color, #ffffff)',
            'section-header-text': 'var(--tg-theme-header-text-color, #222222)',
          },
          fontFamily: {
            sans: ['system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-light': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
        },
      },
    };
  </script>
  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }

    body {
      padding-top: var(--safe-area-inset-top);
      padding-right: var(--safe-area-inset-right);
      padding-bottom: calc(var(--safe-area-inset-bottom) + 64px); /* Add space for bottom navigation */
      padding-left: var(--safe-area-inset-left);
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #222222);
      font-family: system-ui, sans-serif;
      touch-action: manipulation;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      max-width: 100vw;
      overflow-x: hidden;
    }

    .hidden {
      display: none !important;
    }

    .page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateX(100%);
      opacity: 0;
      z-index: 10;
      padding-top: var(--safe-area-inset-top);
      padding-bottom: 64px;
      overflow-y: auto;
      background-color: var(--tg-theme-bg-color, #ffffff);
    }

    .page.active {
      transform: translateX(0);
      opacity: 1;
      z-index: 20;
    }

    .page-content {
      padding-bottom: 80px;
    }

    #map {
      width: 100%;
      height: 100%;
      z-index: 5;
    }

    .active-route-info {
      z-index: 6;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 64px;
      background-color: var(--tg-theme-bg-color, #ffffff);
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 50;
      padding-bottom: var(--safe-area-inset-bottom);
    }

    .skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      background-color: var(--tg-theme-hint-color, #999999);
      opacity: 0.2;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.2;
      }
      50% {
        opacity: 0.5;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      width: 90%;
      max-width: 400px;
      background-color: var(--tg-theme-bg-color, #ffffff);
      border-radius: 12px;
      padding: 20px;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .leaflet-container {
      background-color: var(--tg-theme-bg-color, #ffffff);
    }

    /* Make sure popup and controls are properly themed */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #222222);
    }

    .leaflet-control {
      color: var(--tg-theme-text-color, #222222);
    }
  </style>
</head>
<body>
  <!-- Header Component -->
  <header class="fixed top-0 left-0 w-full bg-section-header-bg text-section-header-text z-40 border-b border-section-bg" style="padding-top: var(--safe-area-inset-top);">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="text-lg font-semibold" id="header-title">City Cycle Tours</div>
      <button id="header-action" class="hidden p-2 rounded-full hover:bg-section-bg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Loading Indicator -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-bg z-50">
    <div class="flex flex-col items-center">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-text">Loading app...</p>
    </div>
  </div>

  <!-- Discover Page -->
  <div id="discover-page" class="page active pt-16">
    <div class="page-content px-4">
      <div class="mb-4">
        <div id="user-greeting" class="flex items-center my-4">
          <div id="user-avatar" class="w-12 h-12 rounded-full bg-section-bg overflow-hidden flex-shrink-0 skeleton"></div>
          <div class="ml-3">
            <div id="user-name" class="font-medium text-lg skeleton h-6 w-32 rounded"></div>
            <div id="user-stats" class="text-hint text-sm skeleton h-4 w-48 mt-1 rounded"></div>
          </div>
        </div>

        <!-- Weather Widget -->
        <div class="bg-section-bg rounded-lg p-4 mb-4">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="font-medium">Today's Weather</h3>
              <div id="weather-info" class="flex items-center mt-1">
                <span id="weather-temp" class="text-lg">--Â°C</span>
                <span id="weather-desc" class="ml-2 text-hint">Loading...</span>
              </div>
            </div>
            <div id="weather-icon" class="w-10 h-10 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Tour Categories -->
        <div class="mb-4">
          <h2 class="font-semibold text-lg mb-3">Explore Tours</h2>
          <div class="flex overflow-x-auto pb-2 -mx-4 px-4 space-x-3">
            <button class="category-btn flex-shrink-0 bg-primary text-primary-text py-2 px-4 rounded-full text-sm font-medium">All Routes</button>
            <button class="category-btn flex-shrink-0 bg-section-bg text-text py-2 px-4 rounded-full text-sm font-medium">Scenic</button>
            <button class="category-btn flex-shrink-0 bg-section-bg text-text py-2 px-4 rounded-full text-sm font-medium">Historical</button>
            <button class="category-btn flex-shrink-0 bg-section-bg text-text py-2 px-4 rounded-full text-sm font-medium">Challenging</button>
            <button class="category-btn flex-shrink-0 bg-section-bg text-text py-2 px-4 rounded-full text-sm font-medium">Family</button>
          </div>
        </div>

        <!-- Featured Tour -->
        <div class="mb-6">
          <h2 class="font-semibold text-lg mb-3">Featured Tour</h2>
          <div id="featured-tour" class="bg-section-bg rounded-lg overflow-hidden skeleton h-48"></div>
        </div>

        <!-- Tour List -->
        <div class="mb-4">
          <div class="flex justify-between items-center mb-3">
            <h2 class="font-semibold text-lg">Popular Tours</h2>
            <button class="text-primary text-sm">See All</button>
          </div>
          <div id="tour-list" class="space-y-4">
            <!-- Tours will be populated here -->
            <!-- Skeleton loaders -->
            <div class="tour-item skeleton h-24 rounded-lg"></div>
            <div class="tour-item skeleton h-24 rounded-lg"></div>
            <div class="tour-item skeleton h-24 rounded-lg"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Page -->
  <div id="map-page" class="page pt-16">
    <div id="map" class="w-full h-full"></div>
    <div id="active-route-card" class="hidden fixed bottom-20 left-0 right-0 mx-4 bg-bg rounded-lg shadow-lg p-4 active-route-info">
      <div class="flex justify-between items-center mb-2">
        <h3 id="active-route-name" class="font-medium text-lg">Route Name</h3>
        <button id="close-active-route" class="p-1 rounded-full hover:bg-section-bg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex justify-between text-sm text-hint mb-3">
        <span id="active-route-distance">0.0 km</span>
        <span id="active-route-duration">0 min</span>
      </div>
      <div class="flex justify-between">
        <button id="start-navigation-btn" class="bg-primary text-primary-text py-2 px-6 rounded-lg text-sm font-medium">Start Tour</button>
        <button id="show-details-btn" class="bg-section-bg text-text py-2 px-6 rounded-lg text-sm font-medium">Details</button>
      </div>
    </div>
    <div id="route-navigation" class="hidden fixed bottom-20 left-0 right-0 mx-4 bg-bg rounded-lg shadow-lg p-4 active-route-info">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-medium text-lg">Navigation</h3>
        <button id="close-navigation" class="p-1 rounded-full hover:bg-section-bg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex justify-between text-sm mb-2">
        <div>
          <div class="text-hint">Current Speed</div>
          <div id="current-speed" class="font-medium">0.0 km/h</div>
        </div>
        <div>
          <div class="text-hint">Distance Left</div>
          <div id="distance-left" class="font-medium">0.0 km</div>
        </div>
        <div>
          <div class="text-hint">Time</div>
          <div id="elapsed-time" class="font-medium">00:00</div>
        </div>
      </div>
      <button id="end-tour-btn" class="w-full bg-primary text-primary-text py-2 rounded-lg text-sm font-medium">End Tour</button>
    </div>
  </div>

  <!-- Profile Page -->
  <div id="profile-page" class="page pt-16">
    <div class="page-content px-4">
      <div class="flex flex-col items-center mb-6 pt-4">
        <div id="profile-avatar" class="w-20 h-20 rounded-full bg-section-bg overflow-hidden mb-3 skeleton"></div>
        <h2 id="profile-name" class="text-xl font-semibold skeleton h-7 w-40 rounded mb-1"></h2>
        <p id="profile-username" class="text-hint skeleton h-5 w-32 rounded"></p>
      </div>

      <div class="bg-section-bg rounded-lg p-4 mb-6">
        <h3 class="font-medium mb-3">Your Stats</h3>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div class="p-2">
            <div id="stats-tours" class="text-xl font-semibold">0</div>
            <div class="text-hint text-sm">Tours</div>
          </div>
          <div class="p-2">
            <div id="stats-distance" class="text-xl font-semibold">0</div>
            <div class="text-hint text-sm">km</div>
          </div>
          <div class="p-2">
            <div id="stats-achievements" class="text-xl font-semibold">0</div>
            <div class="text-hint text-sm">Badges</div>
          </div>
        </div>
      </div>

      <div class="bg-section-bg rounded-lg p-4 mb-6">
        <h3 class="font-medium mb-3">Recent Activities</h3>
        <div id="recent-activities" class="space-y-3">
          <div class="skeleton h-12 rounded-lg"></div>
          <div class="skeleton h-12 rounded-lg"></div>
          <div class="skeleton h-12 rounded-lg"></div>
        </div>
      </div>

      <div class="bg-section-bg rounded-lg p-4 mb-6">
        <h3 class="font-medium mb-3">Achievements</h3>
        <div id="achievements" class="grid grid-cols-3 gap-3">
          <div class="skeleton h-20 rounded-lg"></div>
          <div class="skeleton h-20 rounded-lg"></div>
          <div class="skeleton h-20 rounded-lg"></div>
          <div class="skeleton h-20 rounded-lg"></div>
          <div class="skeleton h-20 rounded-lg"></div>
          <div class="skeleton h-20 rounded-lg"></div>
        </div>
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="font-medium mb-2">Settings</h3>
        <div class="bg-section-bg rounded-lg overflow-hidden">
          <div class="p-4 border-b border-bg">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">Distance Units</div>
                <div class="text-hint text-sm">Choose between km or miles</div>
              </div>
              <select id="distance-unit" class="bg-bg border border-hint text-text rounded px-2 py-1 text-base">
                <option value="km">Kilometers</option>
                <option value="mi">Miles</option>
              </select>
            </div>
          </div>
          <div class="p-4 border-b border-bg">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">Notifications</div>
                <div class="text-hint text-sm">Receive tour suggestions</div>
              </div>
              <div class="relative inline-block w-12 align-middle select-none">
                <input type="checkbox" id="notifications-toggle" class="sr-only">
                <div class="block bg-hint w-12 h-6 rounded-full"></div>
                <div id="toggle-dot" class="dot absolute left-1 top-1 bg-bg w-4 h-4 rounded-full transition-transform"></div>
              </div>
            </div>
          </div>
          <div class="p-4">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">Map Style</div>
                <div class="text-hint text-sm">Choose map appearance</div>
              </div>
              <select id="map-style" class="bg-bg border border-hint text-text rounded px-2 py-1 text-base">
                <option value="standard">Standard</option>
                <option value="satellite">Satellite</option>
                <option value="terrain">Terrain</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Page -->
  <div id="activity-page" class="page pt-16">
    <div class="page-content px-4">
      <div class="flex justify-between items-center mb-4 pt-2">
        <h2 class="font-semibold text-lg">Your Activities</h2>
        <select id="activity-filter" class="bg-section-bg border-none text-text rounded px-2 py-1 text-sm">
          <option value="all">All Activities</option>
          <option value="completed">Completed Tours</option>
          <option value="saved">Saved Tours</option>
        </select>
      </div>

      <div id="activity-list" class="space-y-4 mb-6">
        <!-- Activities will be populated here -->
        <!-- Skeleton loaders -->
        <div class="skeleton h-32 rounded-lg"></div>
        <div class="skeleton h-32 rounded-lg"></div>
        <div class="skeleton h-32 rounded-lg"></div>
      </div>

      <div id="no-activities" class="hidden text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-hint mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
        <h3 class="font-medium text-lg mb-2">No Activities Yet</h3>
        <p class="text-hint">Start exploring tours to see your activity history</p>
        <button id="explore-btn" class="mt-4 bg-primary text-primary-text py-2 px-6 rounded-lg text-sm font-medium">Explore Tours</button>
      </div>
    </div>
  </div>

  <!-- Route Details Modal -->
  <div id="route-details-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-start mb-3">
        <h3 id="modal-route-name" class="font-semibold text-lg">Route Name</h3>
        <button id="close-modal" class="p-1 rounded-full hover:bg-section-bg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="modal-route-image" class="w-full h-40 bg-section-bg rounded-lg overflow-hidden mb-3 skeleton"></div>
      <div class="flex justify-between text-sm text-hint mb-3">
        <span id="modal-route-distance">0.0 km</span>
        <span id="modal-route-duration">0 min</span>
        <span id="modal-route-difficulty">Easy</span>
      </div>
      <div id="modal-route-description" class="text-sm mb-4 skeleton h-24 rounded-lg"></div>
      <h4 class="font-medium mb-2">Points of Interest</h4>
      <div id="modal-route-poi" class="space-y-2 mb-4">
        <div class="skeleton h-8 rounded-lg"></div>
        <div class="skeleton h-8 rounded-lg"></div>
        <div class="skeleton h-8 rounded-lg"></div>
      </div>
      <div class="flex justify-between">
        <button id="modal-start-tour" class="bg-primary text-primary-text py-2 px-4 rounded-lg text-sm font-medium">Start Tour</button>
        <button id="modal-save-tour" class="bg-section-bg text-text py-2 px-4 rounded-lg text-sm font-medium">Save Tour</button>
        <button id="modal-share-tour" class="bg-section-bg text-text py-2 px-4 rounded-lg text-sm font-medium">Share</button>
      </div>
    </div>
  </div>

  <!-- Completed Tour Modal -->
  <div id="completed-tour-modal" class="modal">
    <div class="modal-content">
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 rounded-full bg-primary flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-primary-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>
      <h3 class="text-xl font-semibold text-center mb-2">Tour Completed!</h3>
      <p class="text-center text-hint mb-4">Congratulations on completing your tour</p>
      <div class="grid grid-cols-3 gap-4 text-center mb-4">
        <div>
          <div id="completed-distance" class="font-semibold">0.0 km</div>
          <div class="text-hint text-sm">Distance</div>
        </div>
        <div>
          <div id="completed-duration" class="font-semibold">00:00</div>
          <div class="text-hint text-sm">Duration</div>
        </div>
        <div>
          <div id="completed-avg-speed" class="font-semibold">0.0 km/h</div>
          <div class="text-hint text-sm">Avg Speed</div>
        </div>
      </div>
      <div class="flex justify-between">
        <button id="view-summary-btn" class="bg-primary text-primary-text py-2 px-4 rounded-lg text-sm font-medium">View Summary</button>
        <button id="share-result-btn" class="bg-section-bg text-text py-2 px-4 rounded-lg text-sm font-medium">Share Results</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button id="nav-discover" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-primary">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      <span class="text-xs mt-1">Discover</span>
    </button>
    <button id="nav-map" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
      </svg>
      <span class="text-xs mt-1">Map</span>
    </button>
    <button id="nav-activity" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span class="text-xs mt-1">Activity</span>
    </button>
    <button id="nav-profile" class="nav-btn flex flex-col items-center justify-center w-1/4 h-full text-hint">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <span class="text-xs mt-1">Profile</span>
    </button>
  </nav>

  <script>
    // Initialize Telegram Web App
    const tgApp = window.Telegram?.WebApp;
    let map, userMarker, routeLayer, activeTourInterval;
    let routes = [];
    let activities = [];
    let userStats = {
      tours: 0,
      distance: 0,
      achievements: 0
    };
    let settings = {
      distanceUnit: 'km',
      notifications: true,
      mapStyle: 'standard'
    };
    let activeRoute = null;
    let isNavigating = false;
    let navigationStartTime = null;
    let userPosition = null;
    let activeTourData = {
      distance: 0,
      duration: 0,
      avgSpeed: 0
    };

    // Sample data for routes
    const routesData = [
      {
        id: 1,
        name: "City Center Historical Tour",
        description: "Explore the historic landmarks and architecture of the city center. This route takes you through centuries of history, showcasing the evolution of urban design and cultural heritage.",
        distance: 8.5,
        duration: 45,
        difficulty: "Easy",
        category: "Historical",
        popularity: 4.8,
        image: generateCityImage("historical"),
        coords: generateRandomRoute(10),
        pois: [
          { name: "Old Town Square", description: "Historic central square" },
          { name: "Cathedral of St. Peter", description: "Gothic cathedral from 14th century" },
          { name: "Liberty Bridge", description: "Iconic city landmark" },
          { name: "Museum of History", description: "Exhibitions spanning 500 years" }
        ]
      },
      {
        id: 2,
        name: "Riverside Scenic Route",
        description: "Follow the river through beautiful parks and natural areas. Enjoy the serene atmosphere and stunning views of the water, with plenty of spots to stop and take photos.",
        distance: 12.3,
        duration: 60,
        difficulty: "Medium",
        category: "Scenic",
        popularity: 4.9,
        image: generateCityImage("riverside"),
        coords: generateRandomRoute(15),
        pois: [
          { name: "Waterfront Park", description: "Green space with river views" },
          { name: "Botanical Gardens", description: "Diverse collection of plants" },
          { name: "Sunset Point", description: "Perfect spot for evening views" },
          { name: "River Cafe", description: "Refreshments with a view" }
        ]
      },
      {
        id: 3,
        name: "Urban Arts District Tour",
        description: "Discover the vibrant street art and cultural spots in the arts district. This route showcases murals, galleries, and creative spaces that define the city's contemporary art scene.",
        distance: 6.8,
        duration: 35,
        difficulty: "Easy",
        category: "Cultural",
        popularity: 4.6,
        image: generateCityImage("arts"),
        coords: generateRandomRoute(8),
        pois: [
          { name: "Modern Art Gallery", description: "Contemporary exhibitions" },
          { name: "Street Art Alley", description: "Famous murals and graffiti" },
          { name: "Artisan Market", description: "Local crafts and designs" },
          { name: "Creative Hub", description: "Artist studios and workshops" }
        ]
      },
      {
        id: 4,
        name: "Hill Climb Challenge",
        description: "Test your endurance with this challenging route up the city's highest points. Rewarding views await at the top, making the climb worth every pedal stroke.",
        distance: 18.5,
        duration: 90,
        difficulty: "Hard",
        category: "Challenging",
        popularity: 4.5,
        image: generateCityImage("hills"),
        coords: generateRandomRoute(20),
        pois: [
          { name: "North Hill Viewpoint", description: "Panoramic city views" },
          { name: "Mountain Pass", description: "Challenging uphill section" },
          { name: "Forest Reserve", description: "Protected natural area" },
          { name: "Summit Cafe", description: "Refreshments at the top" }
        ]
      },
      {
        id: 5,
        name: "Family Park Loop",
        description: "A gentle ride perfect for families with children. This safe, traffic-free route circles through the city's largest park with playgrounds and picnic spots along the way.",
        distance: 5.2,
        duration: 30,
        difficulty: "Easy",
        category: "Family",
        popularity: 4.7,
        image: generateCityImage("park"),
        coords: generateRandomRoute(6),
        pois: [
          { name: "Central Playground", description: "Family-friendly play area" },
          { name: "Duck Pond", description: "Wildlife viewing spot" },
          { name: "Picnic Meadow", description: "Open space for breaks" },
          { name: "Ice Cream Stand", description: "Treats for all ages" }
        ]
      }
    ];

    // Sample data for achievements
    const achievementsData = [
      { id: 1, name: "First Ride", description: "Complete your first tour", icon: "ðŸš²", unlocked: false },
      { id: 2, name: "Explorer", description: "Complete 5 different tours", icon: "ðŸ§­", unlocked: false },
      { id: 3, name: "Distance Crusher", description: "Ride more than 50km total", icon: "ðŸ“", unlocked: false },
      { id: 4, name: "Early Bird", description: "Start a tour before 8 AM", icon: "ðŸŒ…", unlocked: false },
      { id: 5, name: "History Buff", description: "Complete all historical tours", icon: "ðŸ›ï¸", unlocked: false },
      { id: 6, name: "Scenic Lover", description: "Complete all scenic tours", icon: "ðŸŒ„", unlocked: false }
    ];

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Check if Telegram WebApp is available
      if (tgApp) {
        console.log("Telegram WebApp is available");
        tgApp.ready();
        initTelegramApp();
      } else {
        console.log("Telegram WebApp not available, running in standalone mode");
        setTimeout(() => {
          document.getElementById('loading').classList.add('hidden');
          initStandaloneApp();
        }, 1000);
      }

      // Set up the map
      setupMap();

      // Initialize event listeners
      setupEventListeners();

      // Load data
      loadData();
    });

    // Initialize app with Telegram WebApp integration
    function initTelegramApp() {
      // Configure app theme based on Telegram theme
      document.body.style.backgroundColor = tgApp.themeParams.bg_color || '#ffffff';
      document.body.style.color = tgApp.themeParams.text_color || '#222222';

      // Get user data from Telegram
      if (tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
        const user = tgApp.initDataUnsafe.user;
        updateUserProfile(user);
      }

      // Initialize BackButton
      tgApp.BackButton.onClick(() => {
        handleBackNavigation();
      });

      // Initialize MainButton
      tgApp.MainButton.setParams({
        text: 'Start Exploring',
        color: tgApp.themeParams.button_color || '#5D5CDE',
        text_color: tgApp.themeParams.button_text_color || '#ffffff'
      });

      tgApp.MainButton.onClick(() => {
        if (isNavigating) {
          endTour();
        } else if (activeRoute) {
          startNavigation();
        } else {
          openPage('discover-page');
          tgApp.MainButton.hide();
        }
      });

      // Hide loading screen
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
      }, 1000);

      // Enable haptic feedback
      if (tgApp.HapticFeedback) {
        setupHapticFeedback();
      }
    }

    // Initialize standalone app (without Telegram WebApp)
    function initStandaloneApp() {
      // Simulate user data
      const mockUser = {
        first_name: 'Demo',
        last_name: 'User',
        username: 'demo_user',
        photo_url: generateAvatar('Demo User')
      };
      updateUserProfile(mockUser);
    }

    // Update user profile with data
    function updateUserProfile(user) {
      // Update user greeting
      const userAvatar = document.getElementById('user-avatar');
      const userName = document.getElementById('user-name');
      const userStats = document.getElementById('user-stats');

      userAvatar.style.backgroundImage = user.photo_url ? `url(${user.photo_url})` : `url(${generateAvatar(user.first_name)})`;
      userAvatar.classList.remove('skeleton');
      userName.textContent = `Hi, ${user.first_name}!`;
      userName.classList.remove('skeleton');
      userStats.textContent = `Ready to explore new routes?`;
      userStats.classList.remove('skeleton');

      // Update profile page
      const profileAvatar = document.getElementById('profile-avatar');
      const profileName = document.getElementById('profile-name');
      const profileUsername = document.getElementById('profile-username');

      profileAvatar.style.backgroundImage = user.photo_url ? `url(${user.photo_url})` : `url(${generateAvatar(user.first_name)})`;
      profileAvatar.classList.remove('skeleton');
      profileName.textContent = `${user.first_name} ${user.last_name || ''}`;
      profileName.classList.remove('skeleton');
      profileUsername.textContent = user.username ? `@${user.username}` : '';
      profileUsername.classList.remove('skeleton');
    }

    // Set up the map
    function setupMap() {
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      });

      // Use OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);

      // Add zoom control to top right
      L.control.zoom({
        position: 'topright'
      }).addTo(map);

      // Initialize with a default location
      map.setView([51.505, -0.09], 13);

      // Create a layer for routes
      routeLayer = L.layerGroup().addTo(map);

      // Try to get user location
      getUserLocation();
    }

    // Get user location
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            userPosition = { lat: latitude, lng: longitude };
            map.setView([latitude, longitude], 14);

            // Add user marker
            if (!userMarker) {
              const userIcon = L.divIcon({
                className: 'user-marker',
                html: `<div class="w-4 h-4 bg-primary rounded-full border-2 border-white shadow-lg"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
              });
              userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(map);
            } else {
              userMarker.setLatLng([latitude, longitude]);
            }

            // Start watching position for navigation
            startPositionWatching();
          },
          (error) => {
            console.log("Error getting location:", error);
            showLocationError();
          }
        );
      } else {
        console.log("Geolocation is not supported by this browser.");
        showLocationError();
      }
    }

    // Start watching user position for navigation
    function startPositionWatching() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            userPosition = { lat: latitude, lng: longitude };
            
            if (userMarker) {
              userMarker.setLatLng([latitude, longitude]);
            }

            if (isNavigating && activeRoute) {
              updateNavigationInfo();
            }
          },
          (error) => {
            console.log("Error watching position:", error);
          },
          { enableHighAccuracy: true }
        );
      }
    }

    // Show location error
    function showLocationError() {
      // Create a notification at the top of the map
      const notification = document.createElement('div');
      notification.className = 'fixed top-20 left-0 right-0 mx-4 bg-bg rounded-lg shadow-lg p-4 z-30';
      notification.innerHTML = `
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span>Location access is required for navigation. Please enable location services.</span>
        </div>
        <button id="retry-location" class="mt-2 bg-primary text-primary-text py-1 px-4 rounded text-sm">Retry</button>
      `;
      document.body.appendChild(notification);

      // Add event listener to retry button
      document.getElementById('retry-location').addEventListener('click', () => {
        notification.remove();
        getUserLocation();
      });

      // Auto-remove after 10 seconds
      setTimeout(() => {
        notification.remove();
      }, 10000);
    }

    // Set up event listeners
    function setupEventListeners() {
      // Navigation buttons
      document.getElementById('nav-discover').addEventListener('click', () => navigateTo('discover-page'));
      document.getElementById('nav-map').addEventListener('click', () => navigateTo('map-page'));
      document.getElementById('nav-activity').addEventListener('click', () => navigateTo('activity-page'));
      document.getElementById('nav-profile').addEventListener('click', () => navigateTo('profile-page'));

      // Route interaction
      document.getElementById('close-active-route').addEventListener('click', closeActiveRoute);
      document.getElementById('start-navigation-btn').addEventListener('click', startNavigation);
      document.getElementById('show-details-btn').addEventListener('click', showRouteDetails);
      
      // Navigation controls
      document.getElementById('close-navigation').addEventListener('click', endTour);
      document.getElementById('end-tour-btn').addEventListener('click', endTour);

      // Modal controls
      document.getElementById('close-modal').addEventListener('click', closeModal);
      document.getElementById('modal-start-tour').addEventListener('click', () => {
        closeModal();
        if (activeRoute) {
          showRoute(activeRoute);
          startNavigation();
        }
      });
      document.getElementById('modal-save-tour').addEventListener('click', saveRoute);
      document.getElementById('modal-share-tour').addEventListener('click', shareRoute);

      // Completed tour modal
      document.getElementById('view-summary-btn').addEventListener('click', viewTourSummary);
      document.getElementById('share-result-btn').addEventListener('click', shareTourResults);

      // Settings
      document.getElementById('distance-unit').addEventListener('change', (e) => {
        settings.distanceUnit = e.target.value;
        saveSettings();
        triggerHapticFeedback('medium');
      });

      document.getElementById('notifications-toggle').addEventListener('change', (e) => {
        settings.notifications = e.target.checked;
        document.getElementById('toggle-dot').style.transform = e.target.checked ? 'translateX(1.5rem)' : 'translateX(0)';
        document.getElementById('toggle-dot').parentElement.querySelector('.block').style.backgroundColor = e.target.checked ? 'var(--tg-theme-button-color, #5D5CDE)' : 'var(--tg-theme-hint-color, #999999)';
        saveSettings();
        triggerHapticFeedback('medium');
      });

      document.getElementById('map-style').addEventListener('change', (e) => {
        settings.mapStyle = e.target.value;
        saveSettings();
        triggerHapticFeedback('medium');
      });

      // Activity filters
      document.getElementById('activity-filter').addEventListener('change', (e) => {
        filterActivities(e.target.value);
        triggerHapticFeedback('light');
      });

      // No activities explore button
      document.getElementById('explore-btn').addEventListener('click', () => navigateTo('discover-page'));

      // Category buttons
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // Deselect all category buttons
          document.querySelectorAll('.category-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-primary-text');
            b.classList.add('bg-section-bg', 'text-text');
          });
          
          // Select clicked button
          e.target.classList.remove('bg-section-bg', 'text-text');
          e.target.classList.add('bg-primary', 'text-primary-text');
          
          // Filter routes by category
          const category = e.target.textContent;
          filterRoutesByCategory(category);
          
          triggerHapticFeedback('light');
        });
      });
    }

    // Navigate to a page
    function navigateTo(pageId) {
      const currentPage = document.querySelector('.page.active');
      const targetPage = document.getElementById(pageId);
      
      if (currentPage) {
        currentPage.classList.remove('active');
      }
      
      targetPage.classList.add('active');
      
      // Update header title
      const headerTitle = document.getElementById('header-title');
      switch(pageId) {
        case 'discover-page':
          headerTitle.textContent = 'City Cycle Tours';
          break;
        case 'map-page':
          headerTitle.textContent = 'Explore Map';
          break;
        case 'activity-page':
          headerTitle.textContent = 'Your Activity';
          break;
        case 'profile-page':
          headerTitle.textContent = 'Profile';
          break;
      }
      
      // Update navigation buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-primary');
        btn.classList.add('text-hint');
      });
      
      // Highlight active nav button
      const buttonId = 'nav-' + pageId.split('-')[0];
      document.getElementById(buttonId).classList.remove('text-hint');
      document.getElementById(buttonId).classList.add('text-primary');
      
      // Update Telegram back button
      updateBackButton(pageId);
      
      // Special handling for map page
      if (pageId === 'map-page') {
        setTimeout(() => {
          map.invalidateSize();
          if (userPosition) {
            map.setView([userPosition.lat, userPosition.lng], 14);
          }
        }, 300);
      }
      
      triggerHapticFeedback('medium');
    }

    // Update Telegram back button
    function updateBackButton(pageId) {
      if (!tgApp) return;
      
      if (pageId === 'discover-page') {
        tgApp.BackButton.hide();
      } else {
        tgApp.BackButton.show();
      }
    }

    // Handle back navigation
    function handleBackNavigation() {
      navigateTo('discover-page');
    }

    // Load app data
    function loadData() {
      // Load routes from sample data
      routes = routesData;
      
      // Load user data from local storage
      const storedSettings = localStorage.getItem('cycleAppSettings');
      if (storedSettings) {
        settings = JSON.parse(storedSettings);
        
        // Apply settings to UI
        document.getElementById('distance-unit').value = settings.distanceUnit;
        document.getElementById('notifications-toggle').checked = settings.notifications;
        document.getElementById('toggle-dot').style.transform = settings.notifications ? 'translateX(1.5rem)' : 'translateX(0)';
        document.getElementById('toggle-dot').parentElement.querySelector('.block').style.backgroundColor = settings.notifications ? 'var(--tg-theme-button-color, #5D5CDE)' : 'var(--tg-theme-hint-color, #999999)';
        document.getElementById('map-style').value = settings.mapStyle;
      }
      
      // Load activities
      const storedActivities = localStorage.getItem('cycleAppActivities');
      if (storedActivities) {
        activities = JSON.parse(storedActivities);
      }
      
      // Load user stats
      const storedStats = localStorage.getItem('cycleAppStats');
      if (storedStats) {
        userStats = JSON.parse(storedStats);
      }
      
      // Update UI with data
      updateRoutesList();
      updateFeaturedTour();
      updateActivitiesList();
      updateUserStats();
      updateWeatherInfo();
      updateAchievements();
    }

    // Update routes list
    function updateRoutesList() {
      const tourList = document.getElementById('tour-list');
      tourList.innerHTML = '';
      
      routes.sort((a, b) => b.popularity - a.popularity).slice(0, 5).forEach(route => {
        const routeItem = document.createElement('div');
        routeItem.className = 'tour-item bg-section-bg rounded-lg overflow-hidden';
        routeItem.innerHTML = `
          <div class="flex h-24">
            <div class="w-1/3 bg-cover bg-center" style="background-image: url('${route.image}')"></div>
            <div class="w-2/3 p-3 flex flex-col justify-between">
              <div>
                <h3 class="font-medium text-sm">${route.name}</h3>
                <div class="flex text-xs text-hint mt-1">
                  <span>${route.distance} km</span>
                  <span class="mx-2">â€¢</span>
                  <span>${route.duration} min</span>
                  <span class="mx-2">â€¢</span>
                  <span>${route.difficulty}</span>
                </div>
              </div>
              <div class="flex items-center">
                <div class="flex items-center text-xs mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-primary mr-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                  </svg>
                  <span>${route.popularity.toFixed(1)}</span>
                </div>
                <div class="text-xs text-primary font-medium">${route.category}</div>
              </div>
            </div>
          </div>
        `;
        
        routeItem.addEventListener('click', () => {
          activeRoute = route;
          showRouteDetails();
        });
        
        tourList.appendChild(routeItem);
      });
    }

    // Update featured tour
    function updateFeaturedTour() {
      const featuredTour = routes.sort((a, b) => b.popularity - a.popularity)[0];
      const featuredElement = document.getElementById('featured-tour');
      
      featuredElement.classList.remove('skeleton');
      featuredElement.style.backgroundImage = `url('${featuredTour.image}')`;
      featuredElement.style.backgroundSize = 'cover';
      featuredElement.style.backgroundPosition = 'center';
      featuredElement.innerHTML = `
        <div class="h-full flex flex-col justify-end p-4 bg-gradient-to-t from-black/70 to-transparent">
          <h3 class="text-white font-semibold text-lg">${featuredTour.name}</h3>
          <div class="flex text-white/80 text-sm mt-1">
            <span>${featuredTour.distance} km</span>
            <span class="mx-2">â€¢</span>
            <span>${featuredTour.duration} min</span>
            <span class="mx-2">â€¢</span>
            <span>${featuredTour.difficulty}</span>
          </div>
        </div>
      `;
      
      featuredElement.addEventListener('click', () => {
        activeRoute = featuredTour;
        showRouteDetails();
      });
    }

    // Filter routes by category
    function filterRoutesByCategory(category) {
      const tourList = document.getElementById('tour-list');
      tourList.innerHTML = '';
      
      let filteredRoutes = routes;
      if (category !== 'All Routes') {
        filteredRoutes = routes.filter(route => route.category === category);
      }
      
      if (filteredRoutes.length === 0) {
        tourList.innerHTML = `
          <div class="text-center py-4 text-hint">
            No tours found in this category
          </div>
        `;
        return;
      }
      
      filteredRoutes.forEach(route => {
        const routeItem = document.createElement('div');
        routeItem.className = 'tour-item bg-section-bg rounded-lg overflow-hidden';
        routeItem.innerHTML = `
          <div class="flex h-24">
            <div class="w-1/3 bg-cover bg-center" style="background-image: url('${route.image}')"></div>
            <div class="w-2/3 p-3 flex flex-col justify-between">
              <div>
                <h3 class="font-medium text-sm">${route.name}</h3>
                <div class="flex text-xs text-hint mt-1">
                  <span>${route.distance} km</span>
                  <span class="mx-2">â€¢</span>
                  <span>${route.duration} min</span>
                  <span class="mx-2">â€¢</span>
                  <span>${route.difficulty}</span>
                </div>
              </div>
              <div class="flex items-center">
                <div class="flex items-center text-xs mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-primary mr-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                  </svg>
                  <span>${route.popularity.toFixed(1)}</span>
                </div>
                <div class="text-xs text-primary font-medium">${route.category}</div>
              </div>
            </div>
          </div>
        `;
        
        routeItem.addEventListener('click', () => {
          activeRoute = route;
          showRouteDetails();
        });
        
        tourList.appendChild(routeItem);
      });
    }

    // Update activities list
    function updateActivitiesList() {
      const activityList = document.getElementById('activity-list');
      const noActivities = document.getElementById('no-activities');
      
      if (activities.length === 0) {
        activityList.classList.add('hidden');
        noActivities.classList.remove('hidden');
        return;
      }
      
      activityList.classList.remove('hidden');
      noActivities.classList.add('hidden');
      
      activityList.innerHTML = '';
      
      activities.sort((a, b) => b.date - a.date).forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'bg-section-bg rounded-lg overflow-hidden';
        
        const date = new Date(activity.date);
        const formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        
        activityItem.innerHTML = `
          <div class="flex h-32">
            <div class="w-1/3 bg-cover bg-center" style="background-image: url('${activity.image}')"></div>
            <div class="w-2/3 p-3 flex flex-col justify-between">
              <div>
                <div class="flex justify-between items-start">
                  <h3 class="font-medium">${activity.name}</h3>
                  <span class="text-xs text-hint">${formattedDate}</span>
                </div>
                <div class="flex text-xs text-hint mt-1">
                  <span>${activity.distance} km</span>
                  <span class="mx-2">â€¢</span>
                  <span>${activity.duration} min</span>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex justify-between items-center">
                  <div class="flex items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Avg: ${activity.avgSpeed} km/h</span>
                  </div>
                  <button class="text-xs bg-primary text-primary-text py-1 px-3 rounded-full">View</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        activityItem.querySelector('button').addEventListener('click', () => {
          showActivityDetails(activity);
        });
        
        activityList.appendChild(activityItem);
      });
      
      // Update recent activities in profile
      updateRecentActivities();
    }

    // Filter activities
    function filterActivities(filter) {
      const activityList = document.getElementById('activity-list');
      const noActivities = document.getElementById('no-activities');
      
      if (activities.length === 0) {
        activityList.classList.add('hidden');
        noActivities.classList.remove('hidden');
        return;
      }
      
      activityList.classList.remove('hidden');
      noActivities.classList.add('hidden');
      
      activityList.innerHTML = '';
      
      let filteredActivities = activities;
      if (filter === 'completed') {
        filteredActivities = activities.filter(activity => activity.completed);
      } else if (filter === 'saved') {
        filteredActivities = activities.filter(activity => activity.saved);
      }
      
      if (filteredActivities.length === 0) {
        activityList.classList.add('hidden');
        noActivities.classList.remove('hidden');
        return;
      }
      
      filteredActivities.sort((a, b) => b.date - a.date).forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'bg-section-bg rounded-lg overflow-hidden';
        
        const date = new Date(activity.date);
        const formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        
        activityItem.innerHTML = `
          <div class="flex h-32">
            <div class="w-1/3 bg-cover bg-center" style="background-image: url('${activity.image}')"></div>
            <div class="w-2/3 p-3 flex flex-col justify-between">
              <div>
                <div class="flex justify-between items-start">
                  <h3 class="font-medium">${activity.name}</h3>
                  <span class="text-xs text-hint">${formattedDate}</span>
                </div>
                <div class="flex text-xs text-hint mt-1">
                  <span>${activity.distance} km</span>
                  <span class="mx-2">â€¢</span>
                  <span>${activity.duration} min</span>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex justify-between items-center">
                  <div class="flex items-center text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Avg: ${activity.avgSpeed} km/h</span>
                  </div>
                  <button class="text-xs bg-primary text-primary-text py-1 px-3 rounded-full">View</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        activityItem.querySelector('button').addEventListener('click', () => {
          showActivityDetails(activity);
        });
        
        activityList.appendChild(activityItem);
      });
    }

    // Update recent activities in profile
    function updateRecentActivities() {
      const recentActivities = document.getElementById('recent-activities');
      
      if (activities.length === 0) {
        recentActivities.innerHTML = `
          <div class="text-center py-2 text-hint text-sm">
            No activities yet
          </div>
        `;
        return;
      }
      
      recentActivities.innerHTML = '';
      
      activities.sort((a, b) => b.date - a.date).slice(0, 3).forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'flex justify-between items-center p-2 bg-bg rounded-lg';
        
        const date = new Date(activity.date);
        const formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        
        activityItem.innerHTML = `
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z" />
              </svg>
            </div>
            <div>
              <div class="text-sm font-medium">${activity.name}</div>
              <div class="text-xs text-hint">${activity.distance} km â€¢ ${activity.duration} min</div>
            </div>
          </div>
          <div class="text-xs text-hint">${formattedDate}</div>
        `;
        
        recentActivities.appendChild(activityItem);
      });
    }

    // Update user stats
    function updateUserStats() {
      document.getElementById('stats-tours').textContent = userStats.tours;
      document.getElementById('stats-distance').textContent = userStats.distance;
      document.getElementById('stats-achievements').textContent = userStats.achievements;
    }

    // Update weather info
    function updateWeatherInfo() {
      // In a real app, this would fetch from a weather API
      // Simulated weather data
      const weatherTemp = document.getElementById('weather-temp');
      const weatherDesc = document.getElementById('weather-desc');
      const weatherIcon = document.getElementById('weather-icon');
      
      setTimeout(() => {
        const temp = Math.floor(Math.random() * 15) + 15; // Random temp between 15-30Â°C
        const descriptions = ['Sunny', 'Partly Cloudy', 'Clear Sky', 'Light Breeze'];
        const description = descriptions[Math.floor(Math.random() * descriptions.length)];
        
        weatherTemp.textContent = `${temp}Â°C`;
        weatherDesc.textContent = description;
        
        // Update icon based on description
        if (description.includes('Sunny')) {
          weatherIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          `;
        } else if (description.includes('Cloudy')) {
          weatherIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
            </svg>
          `;
        } else {
          weatherIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          `;
        }
      }, 1500);
    }

    // Update achievements
    function updateAchievements() {
      const achievementsContainer = document.getElementById('achievements');
      achievementsContainer.innerHTML = '';
      
      achievementsData.forEach(achievement => {
        const achievementItem = document.createElement('div');
        achievementItem.className = `flex flex-col items-center justify-center p-3 rounded-lg ${achievement.unlocked ? 'bg-primary/10' : 'bg-bg'}`;
        
        achievementItem.innerHTML = `
          <div class="text-2xl mb-1">${achievement.icon}</div>
          <div class="text-xs font-medium text-center">${achievement.name}</div>
        `;
        
        // Add tooltip with achievement description on hover
        achievementItem.title = achievement.description;
        
        achievementsContainer.appendChild(achievementItem);
      });
    }

    // Show a route on the map
    function showRoute(route) {
      // Clear previous routes
      routeLayer.clearLayers();
      
      // Center map on route
      const firstPoint = route.coords[0];
      map.setView([firstPoint.lat, firstPoint.lng], 14);
      
      // Draw route on map
      const routePath = L.polyline(route.coords, {
        color: 'var(--tg-theme-button-color, #5D5CDE)',
        weight: 5,
        opacity: 0.8,
        lineJoin: 'round'
      }).addTo(routeLayer);
      
      // Add start marker
      const startIcon = L.divIcon({
        className: 'start-marker',
        html: `<div class="flex items-center justify-center w-6 h-6 bg-primary rounded-full text-primary-text font-bold shadow-lg">S</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      
      L.marker([route.coords[0].lat, route.coords[0].lng], { icon: startIcon }).addTo(routeLayer);
      
      // Add end marker
      const endIcon = L.divIcon({
        className: 'end-marker',
        html: `<div class="flex items-center justify-center w-6 h-6 bg-primary rounded-full text-primary-text font-bold shadow-lg">F</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      
      const lastPoint = route.coords[route.coords.length - 1];
      L.marker([lastPoint.lat, lastPoint.lng], { icon: endIcon }).addTo(routeLayer);
      
      // Add POI markers
      route.pois.forEach((poi, index) => {
        // Create a position for POI based on route (evenly distributed)
        const position = Math.floor((index + 1) * route.coords.length / (route.pois.length + 1));
        const poiPoint = route.coords[position];
        
        const poiIcon = L.divIcon({
          className: 'poi-marker',
          html: `<div class="flex items-center justify-center w-6 h-6 bg-white rounded-full text-primary font-bold border-2 border-primary shadow-lg">${index + 1}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        
        const marker = L.marker([poiPoint.lat, poiPoint.lng], { icon: poiIcon }).addTo(routeLayer);
        
        marker.bindPopup(`<b>${poi.name}</b><br>${poi.description}`);
      });
      
      // Fit map to route bounds
      const bounds = routePath.getBounds();
      map.fitBounds(bounds, { padding: [50, 50] });
      
      // Show route card
      document.getElementById('active-route-card').classList.remove('hidden');
      document.getElementById('active-route-name').textContent = route.name;
      document.getElementById('active-route-distance').textContent = `${route.distance} km`;
      document.getElementById('active-route-duration').textContent = `${route.duration} min`;
      
      // Hide navigation card if visible
      document.getElementById('route-navigation').classList.add('hidden');
      
      // Update Telegram MainButton
      if (tgApp) {
        tgApp.MainButton.setText('Start Tour');
        tgApp.MainButton.show();
      }
      
      triggerHapticFeedback('medium');
    }

    // Close active route
    function closeActiveRoute() {
      document.getElementById('active-route-card').classList.add('hidden');
      routeLayer.clearLayers();
      activeRoute = null;
      
      // Hide Telegram MainButton
      if (tgApp && !isNavigating) {
        tgApp.MainButton.hide();
      }
      
      triggerHapticFeedback('light');
    }

    // Show route details
    function showRouteDetails() {
      if (!activeRoute) return;
      
      const modal = document.getElementById('route-details-modal');
      const modalRouteName = document.getElementById('modal-route-name');
      const modalRouteImage = document.getElementById('modal-route-image');
      const modalRouteDistance = document.getElementById('modal-route-distance');
      const modalRouteDuration = document.getElementById('modal-route-duration');
      const modalRouteDifficulty = document.getElementById('modal-route-difficulty');
      const modalRouteDescription = document.getElementById('modal-route-description');
      const modalRoutePoi = document.getElementById('modal-route-poi');
      
      modalRouteName.textContent = activeRoute.name;
      modalRouteImage.style.backgroundImage = `url('${activeRoute.image}')`;
      modalRouteImage.classList.remove('skeleton');
      modalRouteDistance.textContent = `${activeRoute.distance} km`;
      modalRouteDuration.textContent = `${activeRoute.duration} min`;
      modalRouteDifficulty.textContent = activeRoute.difficulty;
      modalRouteDescription.textContent = activeRoute.description;
      modalRouteDescription.classList.remove('skeleton');
      
      // Add POIs
      modalRoutePoi.innerHTML = '';
      activeRoute.pois.forEach((poi, index) => {
        const poiItem = document.createElement('div');
        poiItem.className = 'flex items-center p-2 bg-bg rounded';
        poiItem.innerHTML = `
          <div class="flex items-center justify-center w-5 h-5 bg-primary rounded-full text-primary-text text-xs font-medium mr-2">${index + 1}</div>
          <div>
            <div class="text-sm font-medium">${poi.name}</div>
            <div class="text-xs text-hint">${poi.description}</div>
          </div>
        `;
        modalRoutePoi.appendChild(poiItem);
      });
      
      // Update Save Tour button text
      const modalSaveBtn = document.getElementById('modal-save-tour');
      const isSaved = activities.some(a => a.id === activeRoute.id && a.saved);
      modalSaveBtn.textContent = isSaved ? 'Unsave Tour' : 'Save Tour';
      
      // Show modal
      modal.classList.add('active');
      
      triggerHapticFeedback('medium');
    }

    // Close modal
    function closeModal() {
      document.getElementById('route-details-modal').classList.remove('active');
      document.getElementById('completed-tour-modal').classList.remove('active');
      triggerHapticFeedback('light');
    }

    // Save a route
    function saveRoute() {
      if (!activeRoute) return;
      
      const isSaved = activities.some(a => a.id === activeRoute.id && a.saved);
      
      if (isSaved) {
        // Unsave route
        activities = activities.filter(a => !(a.id === activeRoute.id && a.saved && !a.completed));
      } else {
        // Save route
        activities.push({
          id: activeRoute.id,
          name: activeRoute.name,
          distance: activeRoute.distance,
          duration: activeRoute.duration,
          image: activeRoute.image,
          date: new Date().getTime(),
          saved: true,
          completed: false,
          avgSpeed: 0
        });
      }
      
      // Update UI
      saveActivities();
      updateActivitiesList();
      
      // Update button text
      const modalSaveBtn = document.getElementById('modal-save-tour');
      modalSaveBtn.textContent = isSaved ? 'Save Tour' : 'Unsave Tour';
      
      // Show toast notification
      showToast(isSaved ? 'Tour removed from saved' : 'Tour saved successfully');
      
      triggerHapticFeedback('medium');
    }

    // Share a route
    function shareRoute() {
      if (!activeRoute) return;
      
      if (tgApp && tgApp.switchInlineQuery) {
        // Share to Telegram chat
        tgApp.switchInlineQuery(`Check out this cycling tour: ${activeRoute.name} (${activeRoute.distance} km)`, ['users', 'groups', 'channels']);
      } else {
        // Show toast if sharing not available
        showToast('Sharing not available in this context');
      }
      
      triggerHapticFeedback('medium');
    }

    // Start navigation for a route
    function startNavigation() {
      if (!activeRoute) return;
      
      // Check if location is available
      if (!userPosition) {
        showToast('Location access is required for navigation');
        getUserLocation();
        return;
      }
      
      // Hide route card
      document.getElementById('active-route-card').classList.add('hidden');
      
      // Show navigation card
      document.getElementById('route-navigation').classList.remove('hidden');
      
      // Set navigation state
      isNavigating = true;
      navigationStartTime = new Date();
      
      // Center map on user
      map.setView([userPosition.lat, userPosition.lng], 15);
      
      // Start tracking progress
      startTrackingProgress();
      
      // Update Telegram MainButton
      if (tgApp) {
        tgApp.MainButton.setText('End Tour');
        tgApp.MainButton.show();
      }
      
      triggerHapticFeedback('heavy');
    }

    // Start tracking progress
    function startTrackingProgress() {
      // Clear any existing interval
      if (activeTourInterval) {
        clearInterval(activeTourInterval);
      }
      
      // Update navigation info immediately
      updateNavigationInfo();
      
      // Set interval to update navigation info
      activeTourInterval = setInterval(() => {
        updateNavigationInfo();
      }, 1000);
    }

    // Update navigation info
    function updateNavigationInfo() {
      if (!isNavigating || !activeRoute || !userPosition) return;
      
      // Calculate current speed (random for demo)
      const speed = Math.random() * 15 + 5;
      document.getElementById('current-speed').textContent = `${speed.toFixed(1)} km/h`;
      
      // Calculate distance left (random decreasing for demo)
      const elapsedSeconds = (new Date() - navigationStartTime) / 1000;
      const progressPercent = Math.min(elapsedSeconds / (activeRoute.duration * 60), 1);
      const distanceLeft = Math.max(activeRoute.distance * (1 - progressPercent), 0);
      document.getElementById('distance-left').textContent = `${distanceLeft.toFixed(1)} km`;
      
      // Update elapsed time
      const minutes = Math.floor(elapsedSeconds / 60);
      const seconds = Math.floor(elapsedSeconds % 60);
      document.getElementById('elapsed-time').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Check if tour should be automatically completed (for demo)
      if (progressPercent >= 1) {
        endTour();
      }
    }

    // End the current tour
    function endTour() {
      if (!isNavigating || !activeRoute) return;
      
      // Stop tracking progress
      if (activeTourInterval) {
        clearInterval(activeTourInterval);
        activeTourInterval = null;
      }
      
      // Calculate tour data
      const elapsedSeconds = (new Date() - navigationStartTime) / 1000;
      const elapsedMinutes = Math.max(Math.round(elapsedSeconds / 60), 1);
      const distanceCovered = Math.min(activeRoute.distance, activeRoute.distance * (elapsedSeconds / (activeRoute.duration * 60)));
      const avgSpeed = distanceCovered / (elapsedSeconds / 3600);
      
      // Save tour data
      activeTourData = {
        distance: distanceCovered.toFixed(1),
        duration: elapsedMinutes,
        avgSpeed: avgSpeed.toFixed(1)
      };
      
      // Update UI
      document.getElementById('completed-distance').textContent = `${activeTourData.distance} km`;
      document.getElementById('completed-duration').textContent = `${Math.floor(elapsedMinutes / 60)}:${(elapsedMinutes % 60).toString().padStart(2, '0')}`;
      document.getElementById('completed-avg-speed').textContent = `${activeTourData.avgSpeed} km/h`;
      
      // Hide navigation card
      document.getElementById('route-navigation').classList.add('hidden');
      
      // Show completed modal
      document.getElementById('completed-tour-modal').classList.add('active');
      
      // Add to activities
      activities.push({
        id: activeRoute.id,
        name: activeRoute.name,
        distance: parseFloat(activeTourData.distance),
        duration: activeTourData.duration,
        avgSpeed: parseFloat(activeTourData.avgSpeed),
        image: activeRoute.image,
        date: new Date().getTime(),
        saved: false,
        completed: true
      });
      
      // Update user stats
      userStats.tours += 1;
      userStats.distance += parseFloat(activeTourData.distance);
      
      // Check for achievements
      checkAchievements();
      
      // Save data
      saveActivities();
      saveUserStats();
      
      // Reset navigation state
      isNavigating = false;
      activeRoute = null;
      
      // Update Telegram MainButton
      if (tgApp) {
        tgApp.MainButton.hide();
      }
      
      triggerHapticFeedback('heavy');
    }

    // Check for achievements
    function checkAchievements() {
      let newAchievements = 0;
      
      // First Ride
      if (!achievementsData[0].unlocked && userStats.tours >= 1) {
        achievementsData[0].unlocked = true;
        newAchievements++;
      }
      
      // Explorer
      if (!achievementsData[1].unlocked && userStats.tours >= 5) {
        achievementsData[1].unlocked = true;
        newAchievements++;
      }
      
      // Distance Crusher
      if (!achievementsData[2].unlocked && userStats.distance >= 50) {
        achievementsData[2].unlocked = true;
        newAchievements++;
      }
      
      // Early Bird (simulate)
      if (!achievementsData[3].unlocked && Math.random() > 0.7) {
        achievementsData[3].unlocked = true;
        newAchievements++;
      }
      
      // Update achievements count
      userStats.achievements += newAchievements;
      
      // Update UI
      if (newAchievements > 0) {
        updateAchievements();
        showToast(`Unlocked ${newAchievements} new achievement${newAchievements > 1 ? 's' : ''}!`);
      }
    }

    // View tour summary
    function viewTourSummary() {
      closeModal();
      navigateTo('activity-page');
    }

    // Share tour results
    function shareTourResults() {
      if (tgApp && tgApp.switchInlineQuery) {
        // Share to Telegram chat
        tgApp.switchInlineQuery(`I just completed a ${activeTourData.distance} km cycling tour with an average speed of ${activeTourData.avgSpeed} km/h!`, ['users', 'groups', 'channels']);
      } else {
        // Show toast if sharing not available
        showToast('Sharing not available in this context');
      }
      
      closeModal();
      triggerHapticFeedback('medium');
    }

    // Show activity details
    function showActivityDetails(activity) {
      // In a real app, this would show a detailed view of the activity
      showToast('Activity details coming soon');
    }

    // Save activities to local storage
    function saveActivities() {
      localStorage.setItem('cycleAppActivities', JSON.stringify(activities));
    }

    // Save user stats to local storage
    function saveUserStats() {
      localStorage.setItem('cycleAppStats', JSON.stringify(userStats));
    }

    // Save settings to local storage
    function saveSettings() {
      localStorage.setItem('cycleAppSettings', JSON.stringify(settings));
    }

    // Show toast notification
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-20 left-0 right-0 mx-auto w-4/5 max-w-sm bg-bg text-text p-3 rounded-lg shadow-lg z-50 flex items-center opacity-0 transition-opacity';
      toast.style.textAlign = 'center';
      toast.innerHTML = message;
      
      document.body.appendChild(toast);
      
      // Fade in
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);
      
      // Fade out and remove
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }

    // Set up haptic feedback
    function setupHapticFeedback() {
      if (!tgApp || !tgApp.HapticFeedback) return;
      
      // Add haptic feedback to all buttons
      document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          triggerHapticFeedback('light');
        });
      });
    }

    // Trigger haptic feedback
    function triggerHapticFeedback(type) {
      if (!tgApp || !tgApp.HapticFeedback) return;
      
      switch (type) {
        case 'light':
          tgApp.HapticFeedback.impactOccurred('light');
          break;
        case 'medium':
          tgApp.HapticFeedback.impactOccurred('medium');
          break;
        case 'heavy':
          tgApp.HapticFeedback.impactOccurred('heavy');
          break;
        case 'rigid':
          tgApp.HapticFeedback.impactOccurred('rigid');
          break;
        case 'soft':
          tgApp.HapticFeedback.impactOccurred('soft');
          break;
      }
    }

    // Generate a random route for demonstration
    function generateRandomRoute(points) {
      const coords = [];
      const baseLat = 51.505;
      const baseLng = -0.09;
      
      for (let i = 0; i < points; i++) {
        const lat = baseLat + (Math.random() - 0.5) * 0.05;
        const lng = baseLng + (Math.random() - 0.5) * 0.05;
        coords.push({ lat, lng });
      }
      
      return coords;
    }

    // Generate a city image programmatically
    function generateCityImage(type) {
      const canvas = document.createElement('canvas');
      canvas.width = 300;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      
      // Background
      ctx.fillStyle = '#e0e0e0';
      ctx.fillRect(0, 0, 300, 200);
      
      // Generate different image based on type
      if (type === 'historical') {
        // Old buildings
        ctx.fillStyle = '#8b7355';
        ctx.fillRect(50, 60, 70, 140);
        ctx.fillRect(130, 80, 60, 120);
        ctx.fillRect(200, 70, 80, 130);
        
        // Windows
        ctx.fillStyle = '#ffd700';
        for (let i = 0; i < 3; i++) {
          for (let j = 0; j < 4; j++) {
            ctx.fillRect(60 + i * 15, 80 + j * 30, 10, 15);
            ctx.fillRect(140 + i * 15, 90 + j * 25, 10, 15);
            ctx.fillRect(210 + i * 20, 90 + j * 25, 15, 15);
          }
        }
        
        // Roofs
        ctx.fillStyle = '#703030';
        ctx.beginPath();
        ctx.moveTo(40, 60);
        ctx.lineTo(85, 30);
        ctx.lineTo(130, 60);
        ctx.fill();
        
        ctx.beginPath();
        ctx.moveTo(120, 80);
        ctx.lineTo(160, 50);
        ctx.lineTo(200, 80);
        ctx.fill();
        
        ctx.beginPath();
        ctx.moveTo(190, 70);
        ctx.lineTo(240, 40);
        ctx.lineTo(290, 70);
        ctx.fill();
      } else if (type === 'riverside') {
        // Sky
        ctx.fillStyle = '#87ceeb';
        ctx.fillRect(0, 0, 300, 100);
        
        // River
        ctx.fillStyle = '#4682b4';
        ctx.fillRect(0, 100, 300, 100);
        
        // Sun
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.arc(250, 40, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // Reflection
        ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
        ctx.beginPath();
        ctx.moveTo(230, 100);
        ctx.lineTo(270, 100);
        ctx.lineTo(280, 180);
        ctx.lineTo(220, 180);
        ctx.fill();
        
        // Trees
        ctx.fillStyle = '#556b2f';
        ctx.beginPath();
        ctx.arc(60, 90, 30, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(120, 95, 25, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(30, 100, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // Tree trunks
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(55, 90, 10, 30);
        ctx.fillRect(115, 95, 10, 25);
        ctx.fillRect(25, 100, 10, 20);
        
        // Boat
        ctx.fillStyle = '#a0522d';
        ctx.beginPath();
        ctx.moveTo(180, 140);
        ctx.lineTo(220, 140);
        ctx.lineTo(210, 160);
        ctx.lineTo(190, 160);
        ctx.fill();
        
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(200, 140);
        ctx.lineTo(200, 110);
        ctx.lineTo(220, 140);
        ctx.fill();
      } else if (type === 'arts') {
        // Wall background
        ctx.fillStyle = '#d3d3d3';
        ctx.fillRect(0, 0, 300, 200);
        
        // Colorful murals
        ctx.fillStyle = '#ff6347';
        ctx.fillRect(20, 40, 80, 120);
        
        ctx.fillStyle = '#4169e1';
        ctx.fillRect(110, 60, 70, 100);
        
        ctx.fillStyle = '#32cd32';
        ctx.fillRect(190, 50, 90, 110);
        
        // Abstract patterns
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(60, 100, 25, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.moveTo(110, 60);
        ctx.lineTo(145, 100);
        ctx.lineTo(110, 140);
        ctx.lineTo(180, 140);
        ctx.lineTo(180, 60);
        ctx.fill();
        
        ctx.fillStyle = '#ff69b4';
        ctx.beginPath();
        ctx.moveTo(190, 100);
        ctx.lineTo(220, 50);
        ctx.lineTo(280, 100);
        ctx.lineTo(220, 150);
        ctx.fill();
      } else if (type === 'hills') {
        // Sky
        ctx.fillStyle = '#b0e0e6';
        ctx.fillRect(0, 0, 300, 200);
        
        // Mountains
        ctx.fillStyle = '#6b8e23';
        ctx.beginPath();
        ctx.moveTo(0, 200);
        ctx.lineTo(0, 120);
        ctx.lineTo(80, 60);
        ctx.lineTo(140, 120);
        ctx.lineTo(220, 80);
        ctx.lineTo(300, 150);
        ctx.lineTo(300, 200);
        ctx.fill();
        
        // Mountain tops
        ctx.fillStyle = '#808080';
        ctx.beginPath();
        ctx.moveTo(60, 70);
        ctx.lineTo(80, 60);
        ctx.lineTo(100, 70);
        ctx.fill();
        
        ctx.beginPath();
        ctx.moveTo(200, 90);
        ctx.lineTo(220, 80);
        ctx.lineTo(240, 90);
        ctx.fill();
        
        // Path
        ctx.fillStyle = '#d2b48c';
        ctx.beginPath();
        ctx.moveTo(0, 200);
        ctx.lineTo(20, 170);
        ctx.lineTo(60, 160);
        ctx.lineTo(100, 170);
        ctx.lineTo(150, 150);
        ctx.lineTo(200, 160);
        ctx.lineTo(250, 150);
        ctx.lineTo(300, 170);
        ctx.lineTo(300, 200);
        ctx.fill();
        
        // Trees
        ctx.fillStyle = '#556b2f';
        ctx.beginPath();
        ctx.arc(40, 150, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(120, 160, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(220, 145, 10, 0, Math.PI * 2);
        ctx.fill();
      } else if (type === 'park') {
        // Grass background
        ctx.fillStyle = '#90ee90';
        ctx.fillRect(0, 0, 300, 200);
        
        // Sky
        ctx.fillStyle = '#87ceeb';
        ctx.fillRect(0, 0, 300, 60);
        
        // Sun
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.arc(50, 30, 15, 0, Math.PI * 2);
        ctx.fill();
        
        // Path
        ctx.fillStyle = '#d2b48c';
        ctx.beginPath();
        ctx.moveTo(0, 120);
        ctx.lineTo(50, 130);
        ctx.lineTo(100, 120);
        ctx.lineTo(150, 130);
        ctx.lineTo(200, 120);
        ctx.lineTo(250, 130);
        ctx.lineTo(300, 120);
        ctx.lineTo(300, 150);
        ctx.lineTo(250, 160);
        ctx.lineTo(200, 150);
        ctx.lineTo(150, 160);
        ctx.lineTo(100, 150);
        ctx.lineTo(50, 160);
        ctx.lineTo(0, 150);
        ctx.fill();
        
        // Trees
        ctx.fillStyle = '#228b22';
        ctx.beginPath();
        ctx.arc(50, 90, 30, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(150, 80, 25, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(250, 90, 30, 0, Math.PI * 2);
        ctx.fill();
        
        // Tree trunks
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(45, 90, 10, 30);
        ctx.fillRect(145, 80, 10, 40);
        ctx.fillRect(245, 90, 10, 30);
        
        // Playground
        ctx.fillStyle = '#cd5c5c';
        ctx.fillRect(180, 180, 100, 20);
        ctx.fillStyle = '#4682b4';
        ctx.fillRect(200, 170, 20, 30);
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.arc(240, 180, 10, 0, Math.PI, true);
        ctx.fill();
      } else {
        // Default city
        // Sky
        ctx.fillStyle = '#87ceeb';
        ctx.fillRect(0, 0, 300, 100);
        
        // Ground
        ctx.fillStyle = '#8b4513';
        ctx.fillRect(0, 100, 300, 100);
        
        // Buildings
        ctx.fillStyle = '#708090';
        ctx.fillRect(20, 30, 40, 70);
        ctx.fillRect(70, 10, 30, 90);
        ctx.fillRect(110, 40, 50, 60);
        ctx.fillRect(170, 20, 35, 80);
        ctx.fillRect(215, 5, 25, 95);
        ctx.fillRect(250, 30, 40, 70);
        
        // Windows
        ctx.fillStyle = '#ffff00';
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 5; j++) {
            if (Math.random() > 0.3) { // Some windows are dark
              ctx.fillRect(25 + i * 10, 35 + j * 12, 5, 7);
              ctx.fillRect(75 + i * 5, 15 + j * 15, 4, 10);
              ctx.fillRect(115 + i * 10, 45 + j * 10, 6, 5);
              ctx.fillRect(175 + i * 7, 25 + j * 12, 5, 7);
              ctx.fillRect(218 + i * 5, 10 + j * 15, 4, 5);
              ctx.fillRect(255 + i * 10, 35 + j * 12, 5, 7);
            }
          }
        }
        
        // Road
        ctx.fillStyle = '#696969';
        ctx.fillRect(0, 130, 300, 40);
        
        // Road markings
        ctx.fillStyle = '#ffffff';
        for (let i = 0; i < 6; i++) {
          ctx.fillRect(10 + i * 50, 148, 30, 4);
        }
      }
      
      return canvas.toDataURL();
    }

    // Generate avatar for user
    function generateAvatar(name) {
      const canvas = document.createElement('canvas');
      canvas.width = 100;
      canvas.height = 100;
      const ctx = canvas.getContext('2d');
      
      // Generate background color based on name
      const hue = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360;
      ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
      ctx.fillRect(0, 0, 100, 100);
      
      // Add initials
      const initials = name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 40px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(initials, 50, 50);
      
      return canvas.toDataURL();
    }
  </script>
</body>
</html>
