<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>NatureEats - Local Menu Ordering</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "tg-bg": "var(--tg-theme-bg-color, #ffffff)",
              "tg-secondary-bg": "var(--tg-theme-secondary-bg-color, #f1f1f1)",
              "tg-text": "var(--tg-theme-text-color, #000000)",
              "tg-hint": "var(--tg-theme-hint-color, #999999)",
              "tg-link": "var(--tg-theme-link-color, #2481cc)",
              "tg-button": "var(--tg-theme-button-color, #2481cc)",
              "tg-button-text": "var(--tg-theme-button-text-color, #ffffff)",
              "nature-primary": "#22c55e",
              "nature-secondary": "#16a34a",
              "nature-accent": "#84cc16",
              "nature-earth": "#a3a3a3",
              "nature-water": "#06b6d4",
              "nature-fire": "#f97316",
            },
            animation: {
              "leaf-float": "leafFloat 3s ease-in-out infinite",
              "pulse-gentle": "pulseGentle 2s ease-in-out infinite",
              "slide-up": "slideUp 0.3s ease-out",
              "fade-in": "fadeIn 0.3s ease-out",
              "heart-beat": "heartBeat 0.5s ease-in-out",
            },
            keyframes: {
              leafFloat: {
                "0%, 100%": { transform: "translateY(0px) rotate(0deg)" },
                "50%": { transform: "translateY(-10px) rotate(5deg)" },
              },
              pulseGentle: {
                "0%, 100%": { transform: "scale(1)" },
                "50%": { transform: "scale(1.05)" },
              },
              slideUp: {
                "0%": { transform: "translateY(100%)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
              heartBeat: {
                "0%": { transform: "scale(1)" },
                "50%": { transform: "scale(1.2)" },
                "100%": { transform: "scale(1)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Telegram CSS Variables Integration */
      :root {
        --tg-viewport-height: 100vh;
        --tg-viewport-stable-height: 100vh;
      }

      .tg-safe-area {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Custom scrollbar for webkit browsers */
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: var(--tg-theme-hint-color, #ccc);
        border-radius: 2px;
      }

      /* Nature-inspired elements */
      .leaf-pattern::before {
        content: "üçÉ";
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 12px;
        opacity: 0.7;
      }

      .gradient-nature {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      }

      .glass-effect {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #2a2a2a 25%,
          #3a3a3a 50%,
          #2a2a2a 75%
        );
        background-size: 200% 100%;
      }

      .favorite-btn {
        transition: all 0.3s ease;
      }

      .favorite-btn.active {
        color: #f97316;
        animation: heartBeat 0.5s ease-in-out;
      }

      .error-state {
        border: 1px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
    </style>
  </head>
  <body class="bg-tg-bg text-tg-text overflow-hidden">
    <!-- App Container -->
    <div id="app" class="h-screen flex flex-col tg-safe-area">
      <!-- Header -->
      <header
        id="app-header"
        class="bg-tg-secondary-bg border-b border-tg-hint/20 px-4 py-3 flex items-center justify-between shadow-sm"
      >
        <div class="flex items-center">
          <button
            id="back-btn"
            class="hidden mr-3 p-1 rounded-full hover:bg-tg-hint/10 transition-colors"
          >
            <svg
              class="w-6 h-6 text-tg-text"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>
          <div class="flex items-center">
            <div class="relative">
              <span class="text-2xl">üåø</span>
              <div
                class="absolute -top-1 -right-1 w-3 h-3 bg-nature-primary rounded-full animate-pulse-gentle"
              ></div>
            </div>
            <h1
              id="header-title"
              class="ml-2 text-lg font-semibold text-tg-text"
            >
              NatureEats
            </h1>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button
            id="search-btn"
            class="p-2 rounded-full hover:bg-tg-hint/10 transition-colors"
          >
            <svg
              class="w-5 h-5 text-tg-text"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </button>
          <button
            id="profile-btn"
            class="w-8 h-8 rounded-full bg-nature-primary text-white flex items-center justify-center text-sm font-medium"
          >
            <span id="user-avatar">üå±</span>
          </button>
        </div>
      </header>

      <!-- Error Banner -->
      <div
        id="error-banner"
        class="hidden bg-red-500 text-white px-4 py-2 text-sm"
      >
        <div class="flex items-center justify-between">
          <span id="error-message">An error occurred</span>
          <button
            id="dismiss-error"
            class="ml-2 text-white/80 hover:text-white"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <main id="main-content" class="flex-1 overflow-hidden relative">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active h-full flex flex-col">
          <!-- Location Banner -->
          <div
            id="location-banner"
            class="bg-gradient-to-r from-nature-primary to-nature-secondary text-white p-4"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <div>
                  <p class="text-sm opacity-90">Current Location</p>
                  <p id="current-location" class="font-medium">
                    Getting location...
                  </p>
                </div>
              </div>
              <button
                id="refresh-location"
                class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Quick Filters -->
          <div class="px-4 py-3 border-b border-tg-hint/10">
            <div class="flex space-x-2 overflow-x-auto pb-1 custom-scrollbar">
              <button
                class="filter-btn active flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-nature-primary text-white"
                data-filter="all"
              >
                üåø All
              </button>
              <button
                class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-tg-secondary-bg text-tg-text border border-tg-hint/20"
                data-filter="favorites"
              >
                ‚ù§Ô∏è Favorites
              </button>
              <button
                class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-tg-secondary-bg text-tg-text border border-tg-hint/20"
                data-filter="organic"
              >
                üå± Organic
              </button>
              <button
                class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-tg-secondary-bg text-tg-text border border-tg-hint/20"
                data-filter="vegan"
              >
                ü•¨ Vegan
              </button>
              <button
                class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-tg-secondary-bg text-tg-text border border-tg-hint/20"
                data-filter="fast"
              >
                ‚ö° Fast
              </button>
              <button
                class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-tg-secondary-bg text-tg-text border border-tg-hint/20"
                data-filter="popular"
              >
                ‚≠ê Popular
              </button>
            </div>
          </div>

          <!-- Restaurant List -->
          <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="restaurants-container" class="p-4 space-y-4">
              <!-- Restaurant cards will be injected here -->
            </div>
          </div>
        </div>

        <!-- Restaurant Detail Screen -->
        <div
          id="restaurant-screen"
          class="screen h-full overflow-y-auto custom-scrollbar hidden"
        >
          <div id="restaurant-detail-content">
            <!-- Restaurant detail content will be injected here -->
          </div>
        </div>

        <!-- Orders Screen -->
        <div
          id="orders-screen"
          class="screen h-full overflow-y-auto custom-scrollbar hidden"
        >
          <div class="p-4">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-tg-text">Your Orders</h2>
              <span
                id="order-count"
                class="bg-nature-primary text-white px-3 py-1 rounded-full text-sm"
                >0</span
              >
            </div>

            <!-- Current Orders -->
            <div id="current-orders" class="mb-6">
              <h3
                class="text-lg font-semibold text-tg-text mb-3 flex items-center"
              >
                <span class="mr-2">üî•</span>Active Orders
              </h3>
              <div id="current-orders-list" class="space-y-3">
                <!-- Current orders will be injected here -->
              </div>
            </div>

            <!-- Order History -->
            <div id="order-history">
              <h3
                class="text-lg font-semibold text-tg-text mb-3 flex items-center"
              >
                <span class="mr-2">üìú</span>Order History
              </h3>
              <div id="order-history-list" class="space-y-3">
                <!-- Order history will be injected here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Screen -->
        <div
          id="profile-screen"
          class="screen h-full overflow-y-auto custom-scrollbar hidden"
        >
          <div class="p-4">
            <!-- User Info -->
            <div class="bg-tg-secondary-bg rounded-2xl p-6 mb-6 text-center">
              <div
                class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-nature flex items-center justify-center text-2xl text-white"
              >
                <span id="profile-avatar">üå±</span>
              </div>
              <h2 id="user-name" class="text-xl font-bold text-tg-text mb-1">
                Loading...
              </h2>
              <p id="user-username" class="text-tg-hint text-sm mb-4">
                @username
              </p>
              <button
                id="edit-profile-btn"
                class="bg-nature-primary text-white px-6 py-2 rounded-full text-sm font-medium hover:bg-nature-secondary transition-colors"
              >
                Edit Profile
              </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 mb-6">
              <div class="bg-tg-secondary-bg rounded-xl p-4 text-center">
                <div class="text-2xl mb-1">üåø</div>
                <div id="total-orders" class="text-lg font-bold text-tg-text">
                  0
                </div>
                <div class="text-xs text-tg-hint">Orders</div>
              </div>
              <div class="bg-tg-secondary-bg rounded-xl p-4 text-center">
                <div class="text-2xl mb-1">‚≠ê</div>
                <div
                  id="eco-score"
                  class="text-lg font-bold text-nature-primary"
                >
                  0
                </div>
                <div class="text-xs text-tg-hint">Eco Score</div>
              </div>
              <div class="bg-tg-secondary-bg rounded-xl p-4 text-center">
                <div class="text-2xl mb-1">üíö</div>
                <div
                  id="saved-co2"
                  class="text-lg font-bold text-nature-accent"
                >
                  0kg
                </div>
                <div class="text-xs text-tg-hint">CO‚ÇÇ Saved</div>
              </div>
            </div>

            <!-- Favorites Section -->
            <div class="bg-tg-secondary-bg rounded-xl p-4 mb-6">
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-lg font-semibold text-tg-text flex items-center"
                >
                  <span class="mr-2">‚ù§Ô∏è</span>Favorite Restaurants
                </h3>
                <span
                  id="favorites-count"
                  class="bg-nature-primary text-white px-2 py-1 rounded-full text-xs"
                  >0</span
                >
              </div>
              <div id="favorites-list" class="space-y-2">
                <!-- Favorites will be populated here -->
              </div>
            </div>

            <!-- Settings -->
            <div class="space-y-4">
              <div class="bg-tg-secondary-bg rounded-xl overflow-hidden">
                <button
                  class="settings-item w-full p-4 flex items-center justify-between hover:bg-tg-hint/5 transition-colors"
                  data-action="notifications"
                >
                  <div class="flex items-center">
                    <span class="mr-3 text-xl">üîî</span>
                    <span class="text-tg-text font-medium">Notifications</span>
                  </div>
                  <svg
                    class="w-5 h-5 text-tg-hint"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
                <div class="border-t border-tg-hint/10"></div>
                <button
                  class="settings-item w-full p-4 flex items-center justify-between hover:bg-tg-hint/5 transition-colors"
                  data-action="location"
                >
                  <div class="flex items-center">
                    <span class="mr-3 text-xl">üìç</span>
                    <span class="text-tg-text font-medium"
                      >Location Settings</span
                    >
                  </div>
                  <svg
                    class="w-5 h-5 text-tg-hint"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
                <div class="border-t border-tg-hint/10"></div>
                <button
                  class="settings-item w-full p-4 flex items-center justify-between hover:bg-tg-hint/5 transition-colors"
                  data-action="preferences"
                >
                  <div class="flex items-center">
                    <span class="mr-3 text-xl">üå±</span>
                    <span class="text-tg-text font-medium"
                      >Dietary Preferences</span
                    >
                  </div>
                  <svg
                    class="w-5 h-5 text-tg-hint"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
              </div>

              <div class="bg-tg-secondary-bg rounded-xl overflow-hidden">
                <button
                  class="settings-item w-full p-4 flex items-center justify-between hover:bg-tg-hint/5 transition-colors"
                  data-action="help"
                >
                  <div class="flex items-center">
                    <span class="mr-3 text-xl">‚ùì</span>
                    <span class="text-tg-text font-medium">Help & Support</span>
                  </div>
                  <svg
                    class="w-5 h-5 text-tg-hint"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
                <div class="border-t border-tg-hint/10"></div>
                <button
                  class="settings-item w-full p-4 flex items-center justify-between hover:bg-tg-hint/5 transition-colors"
                  data-action="about"
                >
                  <div class="flex items-center">
                    <span class="mr-3 text-xl">‚ÑπÔ∏è</span>
                    <span class="text-tg-text font-medium"
                      >About NatureEats</span
                    >
                  </div>
                  <svg
                    class="w-5 h-5 text-tg-hint"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Bottom Navigation -->
      <nav
        class="bg-tg-secondary-bg border-t border-tg-hint/20 px-4 py-2 safe-area-bottom"
      >
        <div class="flex justify-around">
          <button
            class="nav-btn active flex flex-col items-center py-2 px-3 rounded-lg transition-colors"
            data-screen="home"
          >
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
              ></path>
            </svg>
            <span class="text-xs font-medium">Home</span>
          </button>
          <button
            class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg transition-colors"
            data-screen="orders"
          >
            <svg
              class="w-6 h-6 mb-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
              ></path>
            </svg>
            <span class="text-xs font-medium">Orders</span>
            <div
              id="orders-badge"
              class="hidden absolute -top-1 -right-1 bg-nature-primary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
            >
              0
            </div>
          </button>
          <button
            class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg transition-colors"
            data-screen="profile"
          >
            <svg
              class="w-6 h-6 mb-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            <span class="text-xs font-medium">Profile</span>
          </button>
        </div>
      </nav>
    </div>

    <!-- Modals and Overlays -->
    <!-- Search Modal -->
    <div
      id="search-modal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div class="bg-tg-bg rounded-t-2xl mt-12 h-full overflow-hidden">
        <div class="p-4 border-b border-tg-hint/20">
          <div class="flex items-center">
            <button id="close-search" class="mr-3 p-1">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
            <input
              id="search-input"
              type="text"
              placeholder="Search restaurants, dishes..."
              class="flex-1 text-base bg-tg-secondary-bg text-tg-text border border-tg-hint/20 rounded-lg px-4 py-2"
            />
          </div>
        </div>
        <div
          id="search-results"
          class="p-4 overflow-y-auto custom-scrollbar h-full"
        >
          <!-- Search results will be populated here -->
        </div>
      </div>
    </div>

    <!-- Cart Modal -->
    <div
      id="cart-modal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div
        class="bg-tg-bg rounded-t-2xl mt-20 h-full overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-tg-hint/20">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Your Order</h3>
            <button
              id="close-cart"
              class="p-2 rounded-full hover:bg-tg-hint/10"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <div id="cart-items" class="p-4">
            <!-- Cart items will be populated here -->
          </div>
        </div>
        <div class="p-4 border-t border-tg-hint/20 bg-tg-secondary-bg">
          <div class="flex items-center justify-between mb-3">
            <span class="text-lg font-semibold">Total</span>
            <span id="cart-total" class="text-lg font-bold text-nature-primary"
              >$0.00</span
            >
          </div>
          <button
            id="checkout-btn"
            class="w-full bg-nature-primary text-white py-3 rounded-xl font-medium hover:bg-nature-secondary transition-colors"
          >
            Place Order üåø
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center hidden"
    >
      <div class="bg-tg-bg rounded-2xl p-6 flex flex-col items-center">
        <div
          class="w-12 h-12 border-4 border-nature-primary border-t-transparent rounded-full animate-spin mb-4"
        ></div>
        <p class="text-tg-text font-medium">Loading...</p>
      </div>
    </div>

    <script>
      // Telegram Web App initialization with error handling
      let tg;
      try {
        tg = window.Telegram?.WebApp;
        if (tg) {
          tg.ready();
          tg.expand();
        } else {
          console.warn("Telegram WebApp not available");
          // Fallback for development or non-Telegram environments
          tg = {
            initDataUnsafe: { user: null },
            colorScheme: "light",
            BackButton: { show: () => {}, hide: () => {}, onClick: () => {} },
            HapticFeedback: {
              impactOccurred: () => {},
              selectionChanged: () => {},
              notificationOccurred: () => {},
            },
            showPopup: (params) => {
              alert(params.message);
            },
            showAlert: (message) => {
              alert(message);
            },
            openLink: (url) => {
              window.open(url, "_blank");
            },
            enableClosingConfirmation: () => {},
            onEvent: () => {},
          };
        }
      } catch (error) {
        console.error("Failed to initialize Telegram WebApp:", error);
        // Provide minimal fallback
        tg = {
          initDataUnsafe: { user: null },
          colorScheme: "light",
          BackButton: { show: () => {}, hide: () => {}, onClick: () => {} },
          HapticFeedback: {
            impactOccurred: () => {},
            selectionChanged: () => {},
            notificationOccurred: () => {},
          },
          showPopup: (params) => {
            alert(params.message);
          },
          showAlert: (message) => {
            alert(message);
          },
          openLink: (url) => {
            window.open(url, "_blank");
          },
          enableClosingConfirmation: () => {},
          onEvent: () => {},
        };
      }

      // Global App State
      const AppState = {
        currentScreen: "home",
        user: null,
        location: null,
        restaurants: [],
        cart: [],
        orders: [],
        favorites: [],
        filters: { active: "all" },
        searchQuery: "",
        isLoading: false,
        errors: {
          location: null,
          network: null,
          general: null,
        },
      };

      // Storage utilities (since localStorage is not available)
      const Storage = {
        save: (key, data) => {
          try {
            // Use a simple memory storage as fallback
            if (!window.appStorage) window.appStorage = {};
            window.appStorage[key] = JSON.stringify(data);
          } catch (error) {
            console.warn("Failed to save data:", error);
          }
        },
        load: (key, defaultValue = null) => {
          try {
            if (!window.appStorage) window.appStorage = {};
            const data = window.appStorage[key];
            return data ? JSON.parse(data) : defaultValue;
          } catch (error) {
            console.warn("Failed to load data:", error);
            return defaultValue;
          }
        },
      };

      // Sample Data
      const SAMPLE_RESTAURANTS = [
        {
          id: 1,
          name: "Green Garden Bistro",
          cuisine: "Organic Mediterranean",
          rating: { leaves: 5, reviews: 234 },
          distance: 0.3,
          deliveryTime: "20-30 min",
          image: "ü•ó",
          tags: ["organic", "vegan", "popular"],
          description: "Farm-to-table dining with locally sourced ingredients",
          menu: [
            {
              id: 1,
              name: "Mediterranean Bowl",
              price: 12.99,
              description: "Quinoa, roasted vegetables, feta, olive oil",
              category: "bowls",
              image: "ü•ô",
            },
            {
              id: 2,
              name: "Organic Salad",
              price: 10.99,
              description: "Mixed greens, seasonal vegetables, house dressing",
              category: "salads",
              image: "ü•ó",
            },
            {
              id: 3,
              name: "Herbal Tea",
              price: 3.99,
              description: "Organic chamomile and lavender blend",
              category: "drinks",
              image: "üçµ",
            },
          ],
          coordinates: { lat: 40.7128, lng: -74.006 },
        },
        {
          id: 2,
          name: "Forest Fresh Kitchen",
          cuisine: "Plant-Based American",
          rating: { leaves: 4, reviews: 189 },
          distance: 0.7,
          deliveryTime: "25-35 min",
          image: "üå≤",
          tags: ["vegan", "fast"],
          description: "100% plant-based comfort food made with love",
          menu: [
            {
              id: 4,
              name: "Beyond Burger",
              price: 14.99,
              description: "Plant-based patty, lettuce, tomato, avocado",
              category: "mains",
              image: "üçî",
            },
            {
              id: 5,
              name: "Sweet Potato Fries",
              price: 6.99,
              description: "Crispy sweet potato fries with herbs",
              category: "sides",
              image: "üçü",
            },
            {
              id: 6,
              name: "Green Smoothie",
              price: 7.99,
              description: "Spinach, banana, mango, coconut milk",
              category: "drinks",
              image: "ü•§",
            },
          ],
          coordinates: { lat: 40.7589, lng: -73.9851 },
        },
        {
          id: 3,
          name: "Sunrise Caf√©",
          cuisine: "Healthy Breakfast & Brunch",
          rating: { leaves: 4, reviews: 156 },
          distance: 1.2,
          deliveryTime: "15-25 min",
          image: "üåÖ",
          tags: ["organic", "fast", "popular"],
          description:
            "Start your day right with our nutritious breakfast options",
          menu: [
            {
              id: 7,
              name: "Acai Bowl",
              price: 11.99,
              description: "Acai base, granola, fresh berries, coconut",
              category: "bowls",
              image: "üçì",
            },
            {
              id: 8,
              name: "Avocado Toast",
              price: 9.99,
              description: "Sourdough, avocado, cherry tomatoes, hemp seeds",
              category: "mains",
              image: "ü•ë",
            },
            {
              id: 9,
              name: "Cold Press Juice",
              price: 5.99,
              description: "Apple, celery, cucumber, lemon, ginger",
              category: "drinks",
              image: "üßÉ",
            },
          ],
          coordinates: { lat: 40.7488, lng: -73.9857 },
        },
      ];

      const SAMPLE_ORDERS = [
        {
          id: 1,
          restaurantId: 1,
          restaurantName: "Green Garden Bistro",
          items: [
            { id: 1, name: "Mediterranean Bowl", price: 12.99, quantity: 1 },
            { id: 3, name: "Herbal Tea", price: 3.99, quantity: 1 },
          ],
          total: 16.98,
          status: "delivered",
          orderTime: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
          deliveryTime: new Date(Date.now() - 1.5 * 60 * 60 * 1000), // 1.5 hours ago
        },
        {
          id: 2,
          restaurantId: 2,
          restaurantName: "Forest Fresh Kitchen",
          items: [
            { id: 4, name: "Beyond Burger", price: 14.99, quantity: 1 },
            { id: 5, name: "Sweet Potato Fries", price: 6.99, quantity: 1 },
          ],
          total: 21.98,
          status: "preparing",
          orderTime: new Date(Date.now() - 0.5 * 60 * 60 * 1000), // 30 min ago
          estimatedDelivery: new Date(Date.now() + 0.5 * 60 * 60 * 1000), // 30 min from now
        },
      ];

      // Utility Functions
      function showLoading(show = true) {
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          if (show) {
            overlay.classList.remove("hidden");
          } else {
            overlay.classList.add("hidden");
          }
        }
        AppState.isLoading = show;
      }

      function showError(message, type = "general") {
        AppState.errors[type] = message;
        const banner = document.getElementById("error-banner");
        const messageEl = document.getElementById("error-message");

        if (banner && messageEl) {
          messageEl.textContent = message;
          banner.classList.remove("hidden");

          // Auto-hide after 5 seconds
          setTimeout(() => {
            hideError();
          }, 5000);
        }
      }

      function hideError() {
        const banner = document.getElementById("error-banner");
        if (banner) {
          banner.classList.add("hidden");
        }
        AppState.errors = { location: null, network: null, general: null };
      }

      function formatTime(date) {
        try {
          return new Intl.DateTimeFormat("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          }).format(date);
        } catch (error) {
          return date.toLocaleTimeString();
        }
      }

      function formatRelativeTime(date) {
        try {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMins / 60);

          if (diffMins < 60) {
            return `${diffMins} min ago`;
          } else if (diffHours < 24) {
            return `${diffHours}h ago`;
          } else {
            return formatTime(date);
          }
        } catch (error) {
          return "Recently";
        }
      }

      function generateNatureRating(leaves) {
        const leafEmojis = ["üçÉ", "üåø", "üå±", "‚òòÔ∏è", "üçÄ"];
        return leafEmojis.slice(0, Math.min(leaves, 5)).join("");
      }

      function hapticFeedback(type = "impact") {
        try {
          if (tg?.HapticFeedback) {
            switch (type) {
              case "impact":
                tg.HapticFeedback.impactOccurred("medium");
                break;
              case "selection":
                tg.HapticFeedback.selectionChanged();
                break;
              case "notification":
                tg.HapticFeedback.notificationOccurred("success");
                break;
            }
          }
        } catch (error) {
          console.warn("Haptic feedback failed:", error);
        }
      }

      // Theme Management
      function applyTelegramTheme() {
        try {
          if (tg?.colorScheme === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        } catch (error) {
          console.warn("Theme application failed:", error);
        }
      }

      // Favorites Management
      function toggleFavorite(restaurantId) {
        try {
          const index = AppState.favorites.indexOf(restaurantId);
          if (index > -1) {
            AppState.favorites.splice(index, 1);
          } else {
            AppState.favorites.push(restaurantId);
          }

          Storage.save("favorites", AppState.favorites);
          updateFavoriteButtons();
          renderProfile();
          hapticFeedback("selection");

          const restaurant = SAMPLE_RESTAURANTS.find(
            (r) => r.id === restaurantId
          );
          const action = index > -1 ? "removed from" : "added to";

          if (restaurant && tg?.showPopup) {
            tg.showPopup({
              title: `${action === "added to" ? "‚ù§Ô∏è" : "üíî"} Favorites Updated`,
              message: `${restaurant.name} has been ${action} your favorites!`,
              buttons: [{ type: "ok" }],
            });
          }
        } catch (error) {
          console.error("Failed to toggle favorite:", error);
          showError("Failed to update favorites");
        }
      }

      function updateFavoriteButtons() {
        document.querySelectorAll(".favorite-btn").forEach((btn) => {
          const restaurantId = parseInt(btn.dataset.restaurantId);
          const isFavorite = AppState.favorites.includes(restaurantId);

          if (isFavorite) {
            btn.classList.add("active");
            btn.innerHTML = "‚ù§Ô∏è";
          } else {
            btn.classList.remove("active");
            btn.innerHTML = "ü§ç";
          }
        });
      }

      function renderFavoritesList() {
        const favoritesList = document.getElementById("favorites-list");
        const favoritesCount = document.getElementById("favorites-count");

        if (!favoritesList || !favoritesCount) return;

        favoritesCount.textContent = AppState.favorites.length;

        if (AppState.favorites.length === 0) {
          favoritesList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-3xl mb-2">üíî</div>
                        <p class="text-tg-hint text-sm">No favorite restaurants yet</p>
                    </div>
                `;
          return;
        }

        const favoriteRestaurants = SAMPLE_RESTAURANTS.filter((r) =>
          AppState.favorites.includes(r.id)
        );

        favoritesList.innerHTML = favoriteRestaurants
          .map(
            (restaurant) => `
                <div class="flex items-center justify-between p-2 bg-tg-bg rounded-lg">
                    <div class="flex items-center">
                        <span class="text-xl mr-3">${restaurant.image}</span>
                        <div>
                            <p class="text-sm font-medium text-tg-text">${restaurant.name}</p>
                            <p class="text-xs text-tg-hint">${restaurant.cuisine}</p>
                        </div>
                    </div>
                    <button class="favorite-btn text-lg" data-restaurant-id="${restaurant.id}">‚ù§Ô∏è</button>
                </div>
            `
          )
          .join("");
      }

      // Location Services
      async function getCurrentLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation not supported"));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
              };
              AppState.location = location;
              AppState.errors.location = null;
              resolve(location);
            },
            (error) => {
              let message = "Location access denied";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  message = "Location access denied";
                  break;
                case error.POSITION_UNAVAILABLE:
                  message = "Location unavailable";
                  break;
                case error.TIMEOUT:
                  message = "Location request timeout";
                  break;
              }
              AppState.errors.location = message;
              reject(new Error(message));
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
          );
        });
      }

      async function reverseGeocode(lat, lng) {
        // Simulate reverse geocoding - in production, use a real service
        try {
          const locations = [
            "Downtown, New York",
            "Midtown Manhattan, NY",
            "Brooklyn Heights, NY",
            "Central Park Area, NY",
          ];
          // Simulate network delay
          await new Promise((resolve) => setTimeout(resolve, 500));
          return locations[Math.floor(Math.random() * locations.length)];
        } catch (error) {
          throw new Error("Failed to get location name");
        }
      }

      // Restaurant Functions
      function filterRestaurants() {
        try {
          const { active } = AppState.filters;
          const { searchQuery } = AppState;

          let filtered = [...SAMPLE_RESTAURANTS];

          if (active === "favorites") {
            filtered = filtered.filter((restaurant) =>
              AppState.favorites.includes(restaurant.id)
            );
          } else if (active !== "all") {
            filtered = filtered.filter((restaurant) =>
              restaurant.tags.includes(active)
            );
          }

          if (searchQuery) {
            filtered = filtered.filter(
              (restaurant) =>
                restaurant.name
                  .toLowerCase()
                  .includes(searchQuery.toLowerCase()) ||
                restaurant.cuisine
                  .toLowerCase()
                  .includes(searchQuery.toLowerCase())
            );
          }

          AppState.restaurants = filtered;
          return filtered;
        } catch (error) {
          console.error("Failed to filter restaurants:", error);
          showError("Failed to filter restaurants");
          return [];
        }
      }

      function renderRestaurants() {
        try {
          const container = document.getElementById("restaurants-container");
          if (!container) return;

          const restaurants = filterRestaurants();

          if (restaurants.length === 0) {
            const emptyMessage =
              AppState.filters.active === "favorites"
                ? "No favorite restaurants yet"
                : "No restaurants found";
            const emptyIcon =
              AppState.filters.active === "favorites" ? "üíî" : "üå±";

            container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">${emptyIcon}</div>
                            <h3 class="text-lg font-semibold text-tg-text mb-2">${emptyMessage}</h3>
                            <p class="text-tg-hint">
                                ${
                                  AppState.filters.active === "favorites"
                                    ? "Add some restaurants to your favorites!"
                                    : "Try adjusting your filters or search criteria"
                                }
                            </p>
                        </div>
                    `;
            return;
          }

          container.innerHTML = restaurants
            .map(
              (restaurant) => `
                    <div class="restaurant-card bg-tg-secondary-bg rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer" data-id="${
                      restaurant.id
                    }">
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center flex-1">
                                    <div class="text-3xl mr-3">${
                                      restaurant.image
                                    }</div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-tg-text">${
                                          restaurant.name
                                        }</h3>
                                        <p class="text-sm text-tg-hint">${
                                          restaurant.cuisine
                                        }</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="favorite-btn text-xl" data-restaurant-id="${
                                      restaurant.id
                                    }">
                                        ${
                                          AppState.favorites.includes(
                                            restaurant.id
                                          )
                                            ? "‚ù§Ô∏è"
                                            : "ü§ç"
                                        }
                                    </button>
                                    <div class="text-right">
                                        <div class="flex items-center mb-1">
                                            <span class="text-sm mr-1">${generateNatureRating(
                                              restaurant.rating.leaves
                                            )}</span>
                                            <span class="text-xs text-tg-hint">(${
                                              restaurant.rating.reviews
                                            })</span>
                                        </div>
                                        <div class="text-xs text-tg-hint">${
                                          restaurant.distance
                                        } km</div>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-sm text-tg-hint mb-3">${
                              restaurant.description
                            }</p>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex space-x-1">
                                    ${restaurant.tags
                                      .map(
                                        (tag) => `
                                        <span class="px-2 py-1 bg-nature-primary/10 text-nature-secondary text-xs rounded-full">${tag}</span>
                                    `
                                      )
                                      .join("")}
                                </div>
                                <div class="text-sm text-tg-text font-medium">‚è± ${
                                  restaurant.deliveryTime
                                }</div>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          updateFavoriteButtons();
        } catch (error) {
          console.error("Failed to render restaurants:", error);
          showError("Failed to load restaurants");
        }
      }

      function renderRestaurantDetail(restaurantId) {
        try {
          const restaurant = SAMPLE_RESTAURANTS.find(
            (r) => r.id === restaurantId
          );
          if (!restaurant) {
            showError("Restaurant not found");
            return;
          }

          const content = document.getElementById("restaurant-detail-content");
          if (!content) return;

          content.innerHTML = `
                    <div class="restaurant-header bg-gradient-nature text-white p-6 relative overflow-hidden" data-restaurant-id="${
                      restaurant.id
                    }">
                        <div class="absolute top-0 right-0 text-8xl opacity-20 transform rotate-12">${
                          restaurant.image
                        }</div>
                        <div class="relative z-10">
                            <div class="flex items-start justify-between mb-2">
                                <h1 class="text-2xl font-bold flex-1">${
                                  restaurant.name
                                }</h1>
                                <button class="favorite-btn text-2xl ml-3" data-restaurant-id="${
                                  restaurant.id
                                }">
                                    ${
                                      AppState.favorites.includes(restaurant.id)
                                        ? "‚ù§Ô∏è"
                                        : "ü§ç"
                                    }
                                </button>
                            </div>
                            <p class="text-lg opacity-90 mb-3">${
                              restaurant.cuisine
                            }</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="mr-2">${generateNatureRating(
                                      restaurant.rating.leaves
                                    )}</span>
                                    <span class="text-sm opacity-90">(${
                                      restaurant.rating.reviews
                                    } reviews)</span>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-sm">üìç ${
                                      restaurant.distance
                                    } km</div>
                                    <div class="text-sm">‚è± ${
                                      restaurant.deliveryTime
                                    }</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <p class="text-tg-hint mb-6">${
                          restaurant.description
                        }</p>
                        
                        <!-- Menu Categories -->
                        <div class="menu-categories flex space-x-2 mb-6 overflow-x-auto pb-2">
                            <button class="menu-category-btn active flex-shrink-0 px-4 py-2 bg-nature-primary text-white rounded-full text-sm font-medium" data-category="all">All</button>
                            <button class="menu-category-btn flex-shrink-0 px-4 py-2 bg-tg-secondary-bg text-tg-text rounded-full text-sm font-medium border border-tg-hint/20" data-category="bowls">Bowls</button>
                            <button class="menu-category-btn flex-shrink-0 px-4 py-2 bg-tg-secondary-bg text-tg-text rounded-full text-sm font-medium border border-tg-hint/20" data-category="mains">Mains</button>
                            <button class="menu-category-btn flex-shrink-0 px-4 py-2 bg-tg-secondary-bg text-tg-text rounded-full text-sm font-medium border border-tg-hint/20" data-category="drinks">Drinks</button>
                        </div>
                        
                        <!-- Menu Items -->
                        <div class="menu-items space-y-4">
                            ${restaurant.menu
                              .map(
                                (item) => `
                                <div class="menu-item bg-tg-secondary-bg rounded-xl p-4 flex items-center justify-between" data-category="${item.category}">
                                    <div class="flex items-center flex-1">
                                        <div class="text-3xl mr-4">${item.image}</div>
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-tg-text mb-1">${item.name}</h4>
                                            <p class="text-sm text-tg-hint mb-2">${item.description}</p>
                                            <p class="text-lg font-bold text-nature-primary">$${item.price}</p>
                                        </div>
                                    </div>
                                    <button class="add-to-cart-btn bg-nature-primary text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-nature-secondary transition-colors" data-item-id="${item.id}">
                                        Add
                                    </button>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                    
                    <!-- Floating Cart Button -->
                    <div id="floating-cart" class="hidden fixed bottom-20 right-4 z-40">
                        <button id="view-cart-btn" class="bg-nature-primary text-white px-6 py-3 rounded-full shadow-lg flex items-center space-x-2 hover:bg-nature-secondary transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            <span id="cart-count">0</span>
                            <span id="cart-total-floating">$0.00</span>
                        </button>
                    </div>
                `;

          updateFavoriteButtons();
        } catch (error) {
          console.error("Failed to render restaurant detail:", error);
          showError("Failed to load restaurant details");
        }
      }

      // Cart Functions
      function addToCart(itemId, restaurantId) {
        try {
          const restaurant = SAMPLE_RESTAURANTS.find(
            (r) => r.id === restaurantId
          );
          const item = restaurant?.menu.find((i) => i.id === itemId);

          if (!item) {
            showError("Item not found");
            return;
          }

          const existingItem = AppState.cart.find(
            (cartItem) => cartItem.id === itemId
          );

          if (existingItem) {
            existingItem.quantity += 1;
          } else {
            AppState.cart.push({
              ...item,
              restaurantId,
              restaurantName: restaurant.name,
              quantity: 1,
            });
          }

          updateCartUI();
          hapticFeedback("impact");

          // Show brief feedback
          if (tg?.showPopup) {
            tg.showPopup({
              title: "Added to Cart! üåø",
              message: `${item.name} has been added to your cart`,
              buttons: [{ type: "ok" }],
            });
          }
        } catch (error) {
          console.error("Failed to add to cart:", error);
          showError("Failed to add item to cart");
        }
      }

      function updateCartUI() {
        try {
          const cartCount = AppState.cart.reduce(
            (sum, item) => sum + item.quantity,
            0
          );
          const cartTotal = AppState.cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );

          // Update floating cart
          const floatingCart = document.getElementById("floating-cart");
          const cartCountEl = document.getElementById("cart-count");
          const cartTotalEl = document.getElementById("cart-total-floating");

          if (floatingCart && cartCountEl && cartTotalEl) {
            if (cartCount > 0) {
              floatingCart.classList.remove("hidden");
              cartCountEl.textContent = cartCount;
              cartTotalEl.textContent = `$${cartTotal.toFixed(2)}`;
            } else {
              floatingCart.classList.add("hidden");
            }
          }

          // Update orders badge
          const ordersBadge = document.getElementById("orders-badge");
          if (ordersBadge) {
            if (cartCount > 0) {
              ordersBadge.classList.remove("hidden");
              ordersBadge.textContent = cartCount;
            } else {
              ordersBadge.classList.add("hidden");
            }
          }
        } catch (error) {
          console.error("Failed to update cart UI:", error);
        }
      }

      function renderCart() {
        try {
          const cartItems = document.getElementById("cart-items");
          const cartTotal = document.getElementById("cart-total");

          if (!cartItems || !cartTotal) return;

          if (AppState.cart.length === 0) {
            cartItems.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üõí</div>
                            <h3 class="text-lg font-semibold text-tg-text mb-2">Your cart is empty</h3>
                            <p class="text-tg-hint">Add some delicious items from our restaurants!</p>
                        </div>
                    `;
            cartTotal.textContent = "$0.00";
            return;
          }

          const total = AppState.cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );

          cartItems.innerHTML = AppState.cart
            .map(
              (item) => `
                    <div class="cart-item bg-tg-secondary-bg rounded-xl p-4 flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="text-2xl mr-3">${item.image}</div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-tg-text">${item.name}</h4>
                                <p class="text-sm text-tg-hint">${item.restaurantName}</p>
                                <p class="text-lg font-bold text-nature-primary">$${item.price}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="quantity-btn w-8 h-8 rounded-full bg-tg-hint/20 flex items-center justify-center" data-action="decrease" data-item-id="${item.id}">-</button>
                            <span class="font-semibold">${item.quantity}</span>
                            <button class="quantity-btn w-8 h-8 rounded-full bg-nature-primary text-white flex items-center justify-center" data-action="increase" data-item-id="${item.id}">+</button>
                        </div>
                    </div>
                `
            )
            .join("");

          cartTotal.textContent = `$${total.toFixed(2)}`;
        } catch (error) {
          console.error("Failed to render cart:", error);
          showError("Failed to load cart");
        }
      }

      function updateCartQuantity(itemId, action) {
        try {
          const item = AppState.cart.find((cartItem) => cartItem.id === itemId);
          if (!item) return;

          if (action === "increase") {
            item.quantity += 1;
          } else if (action === "decrease") {
            item.quantity -= 1;
            if (item.quantity <= 0) {
              AppState.cart = AppState.cart.filter(
                (cartItem) => cartItem.id !== itemId
              );
            }
          }

          renderCart();
          updateCartUI();
          hapticFeedback("selection");
        } catch (error) {
          console.error("Failed to update cart quantity:", error);
          showError("Failed to update cart");
        }
      }

      // Orders Functions
      function placeOrder() {
        try {
          if (AppState.cart.length === 0) return;

          const newOrder = {
            id: Date.now(),
            restaurantId: AppState.cart[0].restaurantId,
            restaurantName: AppState.cart[0].restaurantName,
            items: [...AppState.cart],
            total: AppState.cart.reduce(
              (sum, item) => sum + item.price * item.quantity,
              0
            ),
            status: "preparing",
            orderTime: new Date(),
            estimatedDelivery: new Date(Date.now() + 30 * 60 * 1000), // 30 minutes from now
          };

          AppState.orders.unshift(newOrder);
          AppState.cart = [];

          updateCartUI();
          renderCart();
          closeModal("cart-modal");

          hapticFeedback("notification");

          if (tg?.showPopup) {
            tg.showPopup({
              title: "Order Placed! üéâ",
              message: `Your order from ${
                newOrder.restaurantName
              } has been placed successfully. Estimated delivery: ${formatTime(
                newOrder.estimatedDelivery
              )}`,
              buttons: [{ type: "ok" }],
            });
          }

          // Switch to orders screen
          switchScreen("orders");
        } catch (error) {
          console.error("Failed to place order:", error);
          showError("Failed to place order");
        }
      }

      function renderOrders() {
        const currentOrdersList = document.getElementById(
          "current-orders-list"
        );
        const orderHistoryList = document.getElementById("order-history-list");
        const orderCount = document.getElementById("order-count");

        if (!currentOrdersList || !orderHistoryList || !orderCount) return;

        const currentOrders = AppState.orders.filter((order) =>
          ["preparing", "on_way"].includes(order.status)
        );
        const historyOrders = AppState.orders.filter((order) =>
          ["delivered", "cancelled"].includes(order.status)
        );

        orderCount.textContent = AppState.orders.length;

        // Render current orders
        if (currentOrders.length === 0) {
          currentOrdersList.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-2">üìã</div>
                            <p class="text-tg-hint text-sm">No active orders</p>
                        </div>
                    `;
        } else {
          currentOrdersList.innerHTML = currentOrders
            .map(
              (order) => `
                        <div class="order-card bg-tg-secondary-bg rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-semibold text-tg-text">${
                                      order.restaurantName
                                    }</h4>
                                    <p class="text-sm text-tg-hint">Order #${
                                      order.id
                                    }</p>
                                </div>
                                <div class="text-right">
                                    <div class="bg-nature-primary text-white px-3 py-1 rounded-full text-xs font-medium mb-1">
                                        ${
                                          order.status === "preparing"
                                            ? "üë®‚Äçüç≥ Preparing"
                                            : "üöö On the way"
                                        }
                                    </div>
                                    <p class="text-sm text-tg-hint">ETA: ${formatTime(
                                      order.estimatedDelivery
                                    )}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-3">
                                ${order.items
                                  .map(
                                    (item) => `
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-tg-text">${
                                          item.quantity
                                        }x ${item.name}</span>
                                        <span class="text-tg-hint">$${(
                                          item.price * item.quantity
                                        ).toFixed(2)}</span>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-tg-hint/20">
                                <span class="font-semibold text-tg-text">Total: $${order.total.toFixed(
                                  2
                                )}</span>
                                <button class="track-order-btn text-nature-primary text-sm font-medium" data-order-id="${
                                  order.id
                                }">
                                    Track Order
                                </button>
                            </div>
                        </div>
                    `
            )
            .join("");
        }

        // Render order history
        if (historyOrders.length === 0) {
          orderHistoryList.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-2">üìú</div>
                            <p class="text-tg-hint text-sm">No order history yet</p>
                        </div>
                    `;
        } else {
          orderHistoryList.innerHTML = historyOrders
            .map(
              (order) => `
                        <div class="order-card bg-tg-secondary-bg rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-semibold text-tg-text">${
                                      order.restaurantName
                                    }</h4>
                                    <p class="text-sm text-tg-hint">Order #${
                                      order.id
                                    } ‚Ä¢ ${formatRelativeTime(
                order.orderTime
              )}</p>
                                </div>
                                <div class="text-right">
                                    <div class="px-3 py-1 rounded-full text-xs font-medium mb-1 ${
                                      order.status === "delivered"
                                        ? "bg-green-100 text-green-700"
                                        : "bg-red-100 text-red-700"
                                    }">
                                        ${
                                          order.status === "delivered"
                                            ? "‚úÖ Delivered"
                                            : "‚ùå Cancelled"
                                        }
                                    </div>
                                    ${
                                      order.deliveryTime
                                        ? `<p class="text-sm text-tg-hint">${formatTime(
                                            order.deliveryTime
                                          )}</p>`
                                        : ""
                                    }
                                </div>
                            </div>
                            
                            <div class="space-y-1 mb-3">
                                ${order.items
                                  .slice(0, 2)
                                  .map(
                                    (item) => `
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-tg-hint">${
                                          item.quantity
                                        }x ${item.name}</span>
                                        <span class="text-tg-hint">$${(
                                          item.price * item.quantity
                                        ).toFixed(2)}</span>
                                    </div>
                                `
                                  )
                                  .join("")}
                                ${
                                  order.items.length > 2
                                    ? `<p class="text-xs text-tg-hint">+${
                                        order.items.length - 2
                                      } more items</p>`
                                    : ""
                                }
                            </div>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-tg-hint/20">
                                <span class="font-semibold text-tg-text">Total: $${order.total.toFixed(
                                  2
                                )}</span>
                                <button class="reorder-btn text-nature-primary text-sm font-medium" data-order-id="${
                                  order.id
                                }">
                                    Reorder
                                </button>
                            </div>
                        </div>
                    `
            )
            .join("");
        }
      }

      // Profile Functions
      function renderProfile() {
        try {
          const user = AppState.user || tg?.initDataUnsafe?.user;

          if (user) {
            const profileAvatar = document.getElementById("profile-avatar");
            const userName = document.getElementById("user-name");
            const userUsername = document.getElementById("user-username");
            const userAvatar = document.getElementById("user-avatar");

            if (profileAvatar)
              profileAvatar.textContent = user.first_name?.charAt(0) || "üå±";
            if (userName)
              userName.textContent =
                `${user.first_name || ""} ${user.last_name || ""}`.trim() ||
                "Nature Lover";
            if (userUsername)
              userUsername.textContent = user.username
                ? `@${user.username}`
                : "@natureeats";
            if (userAvatar)
              userAvatar.textContent = user.first_name?.charAt(0) || "üå±";
          }

          // Update stats
          const totalOrdersEl = document.getElementById("total-orders");
          const ecoScoreEl = document.getElementById("eco-score");
          const savedCo2El = document.getElementById("saved-co2");

          if (totalOrdersEl) totalOrdersEl.textContent = AppState.orders.length;
          if (ecoScoreEl)
            ecoScoreEl.textContent = Math.min(100, AppState.orders.length * 10);
          if (savedCo2El)
            savedCo2El.textContent = (AppState.orders.length * 0.5).toFixed(1);

          // Render favorites list
          renderFavoritesList();
        } catch (error) {
          console.error("Failed to render profile:", error);
          showError("Failed to load profile");
        }
      }

      // Navigation Functions
      function switchScreen(screenName) {
        try {
          // Hide all screens
          document.querySelectorAll(".screen").forEach((screen) => {
            screen.classList.add("hidden");
            screen.classList.remove("active");
          });

          // Show target screen
          const targetScreen = document.getElementById(`${screenName}-screen`);
          if (targetScreen) {
            targetScreen.classList.remove("hidden");
            targetScreen.classList.add("active");
            targetScreen.style.animation = "fadeIn 0.3s ease-out";
          }

          // Update navigation
          document.querySelectorAll(".nav-btn").forEach((btn) => {
            btn.classList.remove("active", "text-nature-primary");
            btn.classList.add("text-tg-hint");
          });

          const activeNavBtn = document.querySelector(
            `[data-screen="${screenName}"]`
          );
          if (activeNavBtn) {
            activeNavBtn.classList.add("active", "text-nature-primary");
            activeNavBtn.classList.remove("text-tg-hint");
          }

          // Update header
          const headerTitle = document.getElementById("header-title");
          const backBtn = document.getElementById("back-btn");

          if (headerTitle && backBtn) {
            switch (screenName) {
              case "home":
                headerTitle.textContent = "NatureEats";
                backBtn.classList.add("hidden");
                break;
              case "restaurant":
                headerTitle.textContent = "Menu";
                backBtn.classList.remove("hidden");
                break;
              case "orders":
                headerTitle.textContent = "Your Orders";
                backBtn.classList.add("hidden");
                break;
              case "profile":
                headerTitle.textContent = "Profile";
                backBtn.classList.add("hidden");
                break;
            }
          }

          AppState.currentScreen = screenName;

          // Update Telegram BackButton
          if (screenName === "restaurant") {
            tg?.BackButton?.show();
          } else {
            tg?.BackButton?.hide();
          }

          hapticFeedback("selection");
        } catch (error) {
          console.error("Failed to switch screen:", error);
          showError("Navigation error");
        }
      }

      function showModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.remove("hidden");
            modal.style.animation = "fadeIn 0.3s ease-out";
          }
        } catch (error) {
          console.error("Failed to show modal:", error);
        }
      }

      function closeModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.add("hidden");
          }
        } catch (error) {
          console.error("Failed to close modal:", error);
        }
      }

      // Search Functions
      function performSearch(query) {
        try {
          AppState.searchQuery = query.toLowerCase();
          renderRestaurants();
        } catch (error) {
          console.error("Failed to perform search:", error);
          showError("Search failed");
        }
      }

      // Initialization
      async function initializeApp() {
        showLoading(true);

        try {
          // Apply Telegram theme
          applyTelegramTheme();

          // Initialize user data
          AppState.user = tg?.initDataUnsafe?.user;
          AppState.orders = [...SAMPLE_ORDERS];

          // Load favorites from storage
          AppState.favorites = Storage.load("favorites", []);

          // Get location
          try {
            const location = await getCurrentLocation();
            const locationName = await reverseGeocode(
              location.lat,
              location.lng
            );
            const currentLocationEl =
              document.getElementById("current-location");
            if (currentLocationEl) {
              currentLocationEl.textContent = locationName;
            }
          } catch (error) {
            console.warn("Location error:", error.message);
            const currentLocationEl =
              document.getElementById("current-location");
            if (currentLocationEl) {
              currentLocationEl.textContent = "Location unavailable";
            }
            showError(
              "Location access required for nearby restaurants",
              "location"
            );
          }

          // Render initial content
          renderRestaurants();
          renderOrders();
          renderProfile();
          updateCartUI();

          // Set up Telegram-specific features
          if (tg?.BackButton) {
            tg.BackButton.onClick(() => {
              if (AppState.currentScreen === "restaurant") {
                switchScreen("home");
              }
            });
          }

          // Enable haptic feedback
          tg?.enableClosingConfirmation?.();
        } catch (error) {
          console.error("Initialization error:", error);
          showError("Failed to initialize app. Please refresh and try again.");
          if (tg?.showAlert) {
            tg.showAlert("Failed to initialize app. Please try again.");
          }
        } finally {
          showLoading(false);
        }
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", () => {
        initializeApp();

        // Error banner dismiss
        document
          .getElementById("dismiss-error")
          ?.addEventListener("click", hideError);

        // Navigation
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const screen = e.currentTarget.dataset.screen;
            switchScreen(screen);
          });
        });

        // Back button
        document.getElementById("back-btn")?.addEventListener("click", () => {
          switchScreen("home");
        });

        // Profile button
        document
          .getElementById("profile-btn")
          ?.addEventListener("click", () => {
            switchScreen("profile");
          });

        // Search
        document.getElementById("search-btn")?.addEventListener("click", () => {
          showModal("search-modal");
          document.getElementById("search-input")?.focus();
        });

        document
          .getElementById("close-search")
          ?.addEventListener("click", () => {
            closeModal("search-modal");
            AppState.searchQuery = "";
            renderRestaurants();
          });

        document
          .getElementById("search-input")
          ?.addEventListener("input", (e) => {
            performSearch(e.target.value);
          });

        // Filters
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("filter-btn")) {
            document.querySelectorAll(".filter-btn").forEach((btn) => {
              btn.classList.remove("active", "bg-nature-primary", "text-white");
              btn.classList.add("bg-tg-secondary-bg", "text-tg-text");
            });

            e.target.classList.add("active", "bg-nature-primary", "text-white");
            e.target.classList.remove("bg-tg-secondary-bg", "text-tg-text");

            AppState.filters.active = e.target.dataset.filter;
            renderRestaurants();
            hapticFeedback("selection");
          }
        });

        // Favorites
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("favorite-btn")) {
            e.stopPropagation();
            const restaurantId = parseInt(e.target.dataset.restaurantId);
            toggleFavorite(restaurantId);
          }
        });

        // Restaurant cards
        document.addEventListener("click", (e) => {
          const card = e.target.closest(".restaurant-card");
          if (card && !e.target.classList.contains("favorite-btn")) {
            const restaurantId = parseInt(card.dataset.id);
            renderRestaurantDetail(restaurantId);
            switchScreen("restaurant");
          }
        });

        // Menu categories
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("menu-category-btn")) {
            document.querySelectorAll(".menu-category-btn").forEach((btn) => {
              btn.classList.remove("active", "bg-nature-primary", "text-white");
              btn.classList.add("bg-tg-secondary-bg", "text-tg-text");
            });

            e.target.classList.add("active", "bg-nature-primary", "text-white");
            e.target.classList.remove("bg-tg-secondary-bg", "text-tg-text");

            const category = e.target.dataset.category;
            document.querySelectorAll(".menu-item").forEach((item) => {
              if (category === "all" || item.dataset.category === category) {
                item.style.display = "flex";
              } else {
                item.style.display = "none";
              }
            });

            hapticFeedback("selection");
          }
        });

        // Add to cart
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("add-to-cart-btn")) {
            const itemId = parseInt(e.target.dataset.itemId);
            const restaurantHeader =
              document.querySelector(".restaurant-header");
            const restaurantId = parseInt(
              restaurantHeader?.dataset?.restaurantId || 1
            );
            addToCart(itemId, restaurantId);
          }
        });

        // Cart
        document.addEventListener("click", (e) => {
          if (
            e.target.id === "view-cart-btn" ||
            e.target.closest("#view-cart-btn")
          ) {
            renderCart();
            showModal("cart-modal");
          }
        });

        document.getElementById("close-cart")?.addEventListener("click", () => {
          closeModal("cart-modal");
        });

        // Cart quantity
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("quantity-btn")) {
            const action = e.target.dataset.action;
            const itemId = parseInt(e.target.dataset.itemId);
            updateCartQuantity(itemId, action);
          }
        });

        // Checkout
        document
          .getElementById("checkout-btn")
          ?.addEventListener("click", () => {
            placeOrder();
          });

        // Location refresh
        document
          .getElementById("refresh-location")
          ?.addEventListener("click", async () => {
            try {
              hapticFeedback("impact");
              const location = await getCurrentLocation();
              const locationName = await reverseGeocode(
                location.lat,
                location.lng
              );
              const currentLocationEl =
                document.getElementById("current-location");
              if (currentLocationEl) {
                currentLocationEl.textContent = locationName;
              }

              if (tg?.showPopup) {
                tg.showPopup({
                  title: "Location Updated! üìç",
                  message: `Your location has been updated to ${locationName}`,
                  buttons: [{ type: "ok" }],
                });
              }
              hideError();
            } catch (error) {
              if (tg?.showAlert) {
                tg.showAlert(`Failed to update location: ${error.message}`);
              }
              showError(
                `Failed to update location: ${error.message}`,
                "location"
              );
            }
          });

        // Settings
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("settings-item")) {
            const action = e.target.dataset.action;
            hapticFeedback("selection");

            switch (action) {
              case "notifications":
                if (tg?.showPopup) {
                  tg.showPopup({
                    title: "Notifications üîî",
                    message:
                      "Notification settings will be available in the next update!",
                    buttons: [{ type: "ok" }],
                  });
                }
                break;
              case "location":
                if (tg?.showPopup) {
                  tg.showPopup({
                    title: "Location Settings üìç",
                    message:
                      "Location settings will be available in the next update!",
                    buttons: [{ type: "ok" }],
                  });
                }
                break;
              case "preferences":
                if (tg?.showPopup) {
                  tg.showPopup({
                    title: "Dietary Preferences üå±",
                    message:
                      "Dietary preference settings will be available in the next update!",
                    buttons: [{ type: "ok" }],
                  });
                }
                break;
              case "help":
                if (tg?.openLink) {
                  tg.openLink("https://t.me/natureeats_support");
                }
                break;
              case "about":
                if (tg?.showPopup) {
                  tg.showPopup({
                    title: "About NatureEats üåø",
                    message:
                      "NatureEats v1.0\n\nSustainable food delivery with a nature-inspired approach to healthy eating.",
                    buttons: [{ type: "ok" }],
                  });
                }
                break;
            }
          }
        });

        // Theme changes
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", applyTelegramTheme);

        // Handle visibility changes
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            // App became visible, refresh data if needed
            renderOrders();
          }
        });
      });

      // Handle Telegram Web App events
      try {
        tg?.onEvent?.("themeChanged", applyTelegramTheme);
        tg?.onEvent?.("viewportChanged", () => {
          console.log(
            "Viewport changed:",
            tg.viewportHeight,
            tg.viewportStableHeight
          );
        });
      } catch (error) {
        console.warn("Failed to register Telegram events:", error);
      }

      // Expose necessary functions to global scope for debugging
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        window.AppState = AppState;
        window.switchScreen = switchScreen;
        window.renderRestaurants = renderRestaurants;
        window.toggleFavorite = toggleFavorite;
      }
    </script>
  </body>
</html>
