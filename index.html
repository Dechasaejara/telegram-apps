<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MemeGen Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Apply Telegram theme variables for better integration */
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh issues */
        }
        .nav-button.active {
            color: var(--tg-theme-button-color, #007aff);
            border-bottom: 2px solid var(--tg-theme-button-color, #007aff);
        }
        input, select, textarea, button {
            border-radius: 8px;
        }
        input[type="text"], input[type="number"], select, textarea {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #c7c7cc);
            color: var(--tg-theme-text-color, #000000);
            padding: 10px 12px;
        }
        input[type="color"] {
             min-height: 44px; /* Ensure color input is tappable */
        }
        button.primary-action {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        button.secondary-action {
            background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-button-color, #007aff); /* Or text color if more appropriate */
        }
        .tab-content {
            padding-bottom: 70px; /* Space for bottom nav */
        }
        .meme-card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        .leaderboard-item {
             background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--tg-theme-hint-color, #c7c7cc); border-radius: 10px; }
        .sub-tab-button.active {
            background-color: var(--tg-theme-button-color, #007aff) !important;
            color: var(--tg-theme-button-text-color, #ffffff) !important;
        }
        .sub-tab-button {
            background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-text-color, #000000);
        }
        #memeCanvas {
            max-width: 100%;
            height: auto;
            display: block; 
            background-color: var(--tg-theme-secondary-bg-color, #e0e0e0); /* BG for canvas area */
        }
        .text-band {
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            color: white;
            -webkit-text-stroke: 1px black; /* Safari/Chrome */
            text-stroke: 1px black; /* Standard */
            paint-order: stroke fill; /* Ensures stroke is behind fill */
        }
    </style>
</head>
<body class="text-sm md:text-base">
    <div id="app" class="h-screen flex flex-col max-w-3xl mx-auto">
        <main class="flex-grow overflow-y-auto">
            <section id="home-tab" class="tab-content p-4">
                <div class="text-center space-y-4">
                    <img src="https://placehold.co/120x120/007AFF/FFFFFF?text=MemeGen" alt="App Logo" class="mx-auto rounded-full shadow-lg">
                    <h1 class="text-2xl font-bold" style="color: var(--tg-theme-text-color);">Welcome to MemeGen!</h1>
                    <p style="color: var(--tg-theme-hint-color);">Create classic memes, choose templates, and share. Navigate using the tabs below.</p>
                    <button id="goToGeneratorBtn" class="primary-action px-6 py-3 text-lg font-semibold rounded-lg shadow hover:opacity-90 transition-opacity">
                        Create a Meme!
                    </button>
                </div>
            </section>

            <section id="generator-tab" class="tab-content p-2 md:p-4 hidden space-y-3">
                <div>
                    <label for="imageUpload" class="block text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">1. Upload Image:</label>
                    <input type="file" id="imageUpload" accept="image/*" class="mt-1 block w-full text-xs p-2 border shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="templateSelector" class="block text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">2. Choose Template:</label>
                    <select id="templateSelector" class="mt-1 block w-full text-xs p-2 border shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="classic">Classic Meme (Auto-adjusts)</option>
                        <option value="facebook">Facebook Post (1.91:1)</option>
                        <option value="tiktok">TikTok Story (9:16)</option>
                    </select>
                </div>
                
                <canvas id="memeCanvas" class="w-full border-2 rounded-lg shadow-lg" style="border-color: var(--tg-theme-hint-color);"></canvas>

                <div>
                    <label for="topTextInput" class="block text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">3. Top Text:</label>
                    <textarea id="topTextInput" rows="2" class="mt-1 block w-full text-xs" placeholder="Enter top text"></textarea>
                </div>
                <div>
                    <label for="bottomTextInput" class="block text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">4. Bottom Text:</label>
                    <textarea id="bottomTextInput" rows="2" class="mt-1 block w-full text-xs" placeholder="Enter bottom text"></textarea>
                </div>
                 <div> <label for="fontSizeMultiplier" class="block text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">Font Size Adjust:</label>
                    <input type="range" id="fontSizeMultiplier" min="0.5" max="1.5" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>


                <hr class="my-3" style="border-color: var(--tg-theme-hint-color);">
                <h3 class="text-sm font-semibold" style="color: var(--tg-theme-text-color);">5. Actions:</h3>

                <div class="grid grid-cols-2 gap-2 mt-1">
                    <button id="saveMemeButton" class="secondary-action py-2 text-sm font-medium">Save to Device</button>
                    <button id="saveToCollectionButton" class="primary-action py-2 text-sm font-medium">Save to My Collection</button>
                </div>
                
                <div class="mt-3 p-3 rounded-lg" style="background-color: var(--tg-theme-secondary-bg-color);">
                    <h4 class="text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">Share to Telegram Channel:</h4>
                    <input type="text" id="channelUsernameInput" class="mt-1 block w-full text-xs mb-2" placeholder="channel_username (no @)">
                    <button id="prepareForChannelButton" class="w-full primary-action py-2 text-sm font-medium">Prepare & Get Channel Link</button>
                    <div id="channelShareHelper" class="text-xs mt-2 hidden" style="color: var(--tg-theme-hint-color);">
                        <p>1. Meme image is ready for download (if not already saved).</p>
                        <p>2. Click below to open the channel, then paste/upload your saved meme.</p>
                        <button id="openChannelLinkButton" class="w-full secondary-action py-1.5 text-xs mt-1">Open Channel</button>
                    </div>
                </div>
            </section>

            <section id="collection-tab" class="tab-content p-2 md:p-4 hidden space-y-3">
                <div class="flex items-center gap-2">
                    <label for="categoryFilter" class="block text-xs font-medium whitespace-nowrap" style="color: var(--tg-theme-hint-color);">Filter:</label>
                    <select id="categoryFilter" class="block w-full text-xs p-2 border shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </select>
                </div>
                <div id="memeCollectionContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    </div>
            </section>

            <section id="leaderboard-tab" class="tab-content p-2 md:p-4 hidden space-y-3">
                <div>
                    <p class="text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">Category:</p>
                    <div id="leaderboardCategoryTabs" class="flex flex-wrap gap-1">
                        </div>
                </div>
                <div>
                    <p class="text-xs font-medium mb-1" style="color: var(--tg-theme-hint-color);">Timeframe:</p>
                    <div id="leaderboardTimeframeTabs" class="flex flex-wrap gap-1" data-current-category="all" data-current-timeframe="all_time">
                        <button data-timeframe="all_time" class="sub-tab-button text-xs px-3 py-1.5 rounded-md active">All Time</button>
                        <button data-timeframe="weekly" class="sub-tab-button text-xs px-3 py-1.5 rounded-md">Weekly</button>
                        <button data-timeframe="daily" class="sub-tab-button text-xs px-3 py-1.5 rounded-md">Daily</button>
                    </div>
                </div>
                <div id="leaderboardContainer" class="space-y-2">
                    </div>
            </section>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-3xl mx-auto border-t p-1 flex justify-around text-xs" style="background-color: var(--tg-theme-secondary-bg-color, #f9f9f9); border-color: var(--tg-theme-hint-color, #d1d1d6);">
            <button data-tab="home-tab" class="nav-button active flex-1 p-2 flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>Home</span>
            </button>
            <button data-tab="generator-tab" class="nav-button flex-1 p-2 flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                <span>Generator</span>
            </button>
            <button data-tab="collection-tab" class="nav-button flex-1 p-2 flex flex-col items-center justify-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
                <span>Collection</span>
            </button>
            <button data-tab="leaderboard-tab" class="nav-button flex-1 p-2 flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                <span>Leaderboard</span>
            </button>
        </nav>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); 

        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        document.body.style.color = tg.themeParams.text_color || '#000000';

        const navButtons = document.querySelectorAll('.nav-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const goToGeneratorBtn = document.getElementById('goToGeneratorBtn');

        const switchTab = (targetTabId) => {
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = tg.themeParams.hint_color || '#999999';
                btn.querySelector('svg')?.setAttribute('stroke', tg.themeParams.hint_color || '#999999');
            });
            tabContents.forEach(tab => tab.classList.add('hidden'));

            const activeButton = document.querySelector(`.nav-button[data-tab="${targetTabId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.style.color = tg.themeParams.button_color || '#007aff';
                activeButton.querySelector('svg')?.setAttribute('stroke', tg.themeParams.button_color || '#007aff');
            }
            const activeTab = document.getElementById(targetTabId);
            if (activeTab) activeTab.classList.remove('hidden');

            if (targetTabId === 'collection-tab') UI.renderMemeCollection();
            if (targetTabId === 'leaderboard-tab') Leaderboard.renderLeaderboard();
            if (targetTabId === 'generator-tab') MemeGenerator.handleTemplateChange(); // Resize canvas on tab switch
        };

        navButtons.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });

        if (goToGeneratorBtn) {
            goToGeneratorBtn.addEventListener('click', () => switchTab('generator-tab'));
        }
        
        // --- MemeStorage (largely unchanged) ---
        const MemeStorage = (() => {
            const MEMES_KEY = 'userMemes_v3'; 
            const getTelegramUser = () => {
                return tg.initDataUnsafe?.user || { id: 'guest', username: 'Guest', first_name: 'Guest', photo_url: null };
            };
            const getMemes = () => JSON.parse(localStorage.getItem(MEMES_KEY)) || [];
            const saveMemes = (memes) => localStorage.setItem(MEMES_KEY, JSON.stringify(memes));

            const saveMeme = (memeData) => {
                const memes = getMemes();
                const user = getTelegramUser();
                const newMeme = {
                    id: `meme_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    title: memeData.title || 'Untitled Meme', // Title is now optional for collection
                    category: memeData.category || 'General', // Category optional for collection
                    memeImage: memeData.memeImage, 
                    reactions: {},
                    createdAt: new Date().toISOString(),
                    userId: user.id,
                    username: user.username || `${user.first_name || 'User'}`,
                    userPhotoUrl: user.photo_url || `https://placehold.co/40x40/${(tg.themeParams.button_color || '007AFF').substring(1)}/FFFFFF?text=${(user.username || user.first_name || 'U').charAt(0).toUpperCase()}`
                };
                memes.unshift(newMeme);
                saveMemes(memes);
                UI.populateFilters(); 
                return newMeme;
            };
            const updateMemeReaction = (memeId, reactionType) => {
                const memes = getMemes();
                const memeIndex = memes.findIndex(m => m.id === memeId);
                if (memeIndex !== -1) {
                    if (!memes[memeIndex].reactions[reactionType]) memes[memeIndex].reactions[reactionType] = 0;
                    memes[memeIndex].reactions[reactionType]++;
                    saveMemes(memes);
                    return memes[memeIndex];
                }
                return null;
            };
            const getMemesByCategory = (category) => {
                const memes = getMemes();
                if (!category || category.toLowerCase() === 'all') return memes;
                return memes.filter(m => m.category.toLowerCase() === category.toLowerCase());
            };
            return { getMemes, saveMeme, updateMemeReaction, getMemesByCategory };
        })();

        // --- MemeGenerator (Heavily Refactored) ---
        const MemeGenerator = (() => {
            const canvas = document.getElementById('memeCanvas');
            const ctx = canvas.getContext('2d');
            let image = null;
            let topText = '';
            let bottomText = '';
            let currentTemplate = 'classic';
            let fontSizeMultiplier = 1;

            const TEMPLATE_CONFIG = {
                classic: { type: 'auto', textBandRatio: 0.15, baseFontSizeRatio: 0.07 }, // 15% of image height for each band
                facebook: { type: 'fixed', aspectRatio: 1200 / 630, contentAreaRatio: 0.9, textBandRatio: 0.12, baseFontSizeRatio: 0.045 }, // 90% for image, 12% of content height for text
                tiktok: { type: 'fixed', aspectRatio: 9 / 16, contentAreaRatio: 0.7, textBandRatio: 0.15, baseFontSizeRatio: 0.04 } // 70% for image (center), 15% of content height for text
            };
            const MAX_CANVAS_WIDTH = Math.min(window.innerWidth, 600) - 20; // Max width for canvas on screen

            const init = () => {
                document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
                document.getElementById('templateSelector').addEventListener('change', handleTemplateChange);
                document.getElementById('topTextInput').addEventListener('input', (e) => { topText = e.target.value; renderPreview(); });
                document.getElementById('bottomTextInput').addEventListener('input', (e) => { bottomText = e.target.value; renderPreview(); });
                document.getElementById('fontSizeMultiplier').addEventListener('input', (e) => { fontSizeMultiplier = parseFloat(e.target.value); renderPreview(); });
                
                document.getElementById('saveMemeButton').addEventListener('click', downloadMeme);
                document.getElementById('saveToCollectionButton').addEventListener('click', saveToCollection);
                document.getElementById('prepareForChannelButton').addEventListener('click', prepareForChannel);

                handleTemplateChange(); // Initial setup
            };

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        image = new Image();
                        image.onload = () => {
                            renderPreview();
                        };
                        image.onerror = () => {
                            tg.showAlert("Could not load image."); image = null; renderPreview();
                        }
                        image.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleTemplateChange = () => {
                currentTemplate = document.getElementById('templateSelector').value;
                document.getElementById('channelShareHelper').classList.add('hidden'); // Hide helper on template change
                renderPreview();
            };
            
            const drawTextWithStroke = (text, x, y, fontSize, maxWidth) => {
                ctx.font = `${fontSize}px Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif`;
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = Math.max(1, fontSize / 15); // Stroke width based on font size
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Simple auto-fit font size (basic version)
                let currentFontSize = fontSize;
                while (ctx.measureText(text).width > maxWidth && currentFontSize > 10) {
                    currentFontSize -= 2;
                    ctx.font = `${currentFontSize}px Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif`;
                }
                
                // Paint order for clean stroke
                ctx.strokeText(text, x, y);
                ctx.fillText(text, x, y);
            };

            const renderPreview = () => {
                const config = TEMPLATE_CONFIG[currentTemplate];
                let canvasWidth, canvasHeight;
                let imgDrawX = 0, imgDrawY = 0, imgDrawWidth = 0, imgDrawHeight = 0;
                let topBandHeight = 0, bottomBandHeight = 0;

                // Determine canvas dimensions and image placement
                if (config.type === 'auto' && image) { // Classic meme: adapts to image
                    canvasWidth = Math.min(MAX_CANVAS_WIDTH, image.naturalWidth);
                    imgDrawWidth = canvasWidth;
                    imgDrawHeight = (image.naturalHeight / image.naturalWidth) * imgDrawWidth;
                    topBandHeight = bottomBandHeight = imgDrawHeight * config.textBandRatio;
                    canvasHeight = imgDrawHeight + topBandHeight + bottomBandHeight;
                    imgDrawX = 0;
                    imgDrawY = topBandHeight;
                } else if (config.type === 'fixed') { // Facebook, TikTok
                    canvasWidth = MAX_CANVAS_WIDTH;
                    canvasHeight = canvasWidth / config.aspectRatio;
                    if (currentTemplate === 'tiktok' && canvasHeight > window.innerHeight * 0.6) { // Cap height for TikTok
                        canvasHeight = window.innerHeight * 0.6;
                        canvasWidth = canvasHeight * config.aspectRatio;
                    }

                    const contentTotalHeight = canvasHeight * config.contentAreaRatio; // e.g. 90% of canvas for image + text
                    topBandHeight = bottomBandHeight = contentTotalHeight * config.textBandRatio;
                    imgDrawHeight = contentTotalHeight - topBandHeight - bottomBandHeight;
                    imgDrawWidth = imgDrawHeight * (image ? image.naturalWidth / image.naturalHeight : 16/9); // Use image aspect or default

                    if (imgDrawWidth > canvasWidth * 0.95) { // If image is wider than canvas
                        imgDrawWidth = canvasWidth * 0.95;
                        imgDrawHeight = (image ? image.naturalHeight / image.naturalWidth : 9/16) * imgDrawWidth;
                    }
                    
                    imgDrawX = (canvasWidth - imgDrawWidth) / 2;
                    imgDrawY = topBandHeight + (canvasHeight - contentTotalHeight) / 2; // Center content area vertically

                } else { // No image, default placeholder
                    canvasWidth = MAX_CANVAS_WIDTH;
                    canvasHeight = MAX_CANVAS_WIDTH * (currentTemplate === 'tiktok' ? 16/9 : (currentTemplate === 'facebook' ? 630/1200 : 3/4));
                    if (currentTemplate === 'tiktok' && canvasHeight > window.innerHeight * 0.6) {
                         canvasHeight = window.innerHeight * 0.6;
                         canvasWidth = canvasHeight * (9/16);
                    }
                }
                
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                canvas.style.width = `${canvasWidth}px`; // For display scaling
                canvas.style.height = `${canvasHeight}px`;

                // Clear canvas with a BG color
                ctx.fillStyle = tg.themeParams.secondary_bg_color || '#DDDDDD';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (image) {
                    ctx.drawImage(image, imgDrawX, imgDrawY, imgDrawWidth, imgDrawHeight);
                } else {
                    ctx.fillStyle = tg.themeParams.hint_color || '#888888';
                    ctx.textAlign = 'center';
                    ctx.font = `${Math.min(20, canvas.width / 15)}px Arial`;
                    ctx.fillText("Upload an image", canvas.width / 2, canvas.height / 2 - 10);
                }

                // Draw Text
                const baseFontSize = (image ? imgDrawHeight : canvas.height) * config.baseFontSizeRatio * fontSizeMultiplier;
                const textPadding = 5; // Padding from edge of band or image

                if (topText) {
                    const yPos = (config.type === 'auto') ? topBandHeight / 2 : imgDrawY - topBandHeight / 2;
                    drawTextWithStroke(topText, canvas.width / 2, yPos, baseFontSize, canvas.width - 2 * textPadding);
                }
                if (bottomText) {
                    const yPos = (config.type === 'auto') ? imgDrawY + imgDrawHeight + bottomBandHeight / 2 : imgDrawY + imgDrawHeight + topBandHeight / 2; // topBandHeight used as it's same as bottom
                    drawTextWithStroke(bottomText, canvas.width / 2, yPos, baseFontSize, canvas.width - 2 * textPadding);
                }
            };
            window.addEventListener('resize', renderPreview);


            const generateMemeDataURL = () => {
                if (!image && !topText && !bottomText) {
                    tg.showAlert("Please create something first!");
                    return null;
                }
                return canvas.toDataURL('image/png');
            };

            const downloadMeme = () => {
                const dataURL = generateMemeDataURL();
                if (!dataURL) return;

                const link = document.createElement('a');
                link.download = `meme_${Date.now()}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                tg.HapticFeedback.notificationOccurred('success');
            };

            const saveToCollection = () => {
                const dataURL = generateMemeDataURL();
                if (!dataURL) return;
                
                // For collection, we might not need title/category from user explicitly for this flow
                MemeStorage.saveMeme({ 
                    title: `${topText.substring(0,20)}...` || 'Meme', // Auto-title
                    category: currentTemplate, // Use template as category
                    memeImage: dataURL 
                });
                tg.showAlert(`Meme saved to your collection!`);
                tg.HapticFeedback.notificationOccurred('success');
            };

            const prepareForChannel = () => {
                const channelUsername = document.getElementById('channelUsernameInput').value.trim();
                if (!channelUsername) {
                    tg.showAlert("Please enter a channel username.");
                    return;
                }
                const dataURL = generateMemeDataURL(); // Ensure meme is drawn
                if (!dataURL) return;

                tg.showConfirm("Your meme is ready. Please save it to your device first, then you can open the channel to post it. Save now?", (confirmed) => {
                    if (confirmed) {
                        downloadMeme(); // Trigger download
                        const helper = document.getElementById('channelShareHelper');
                        const openChannelBtn = document.getElementById('openChannelLinkButton');
                        openChannelBtn.onclick = () => tg.openTelegramLink(`https://t.me/${channelUsername}`);
                        helper.classList.remove('hidden');
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                });
            };
            
            return { init, handleTemplateChange, renderPreview }; // Expose renderPreview if needed by resize
        })();

        // --- UI (largely unchanged, ensure populateFilters is called) ---
        const UI = (() => {
            const init = () => {
                document.getElementById('categoryFilter').addEventListener('change', (e) => renderMemeCollection(e.target.value));
                populateFilters();
            };
            const populateFilters = () => {
                const categoryFilter = document.getElementById('categoryFilter');
                const memes = MemeStorage.getMemes();
                const categories = ['All', ...new Set(memes.map(m => m.category).filter(Boolean).sort())];
                
                const currentFilterValue = categoryFilter.value;
                categoryFilter.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.toLowerCase();
                    option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1); // Capitalize
                    categoryFilter.appendChild(option);
                });

                if (categories.map(c=>c.toLowerCase()).includes(currentFilterValue)) {
                    categoryFilter.value = currentFilterValue;
                } else if (categories.length > 0) {
                    categoryFilter.value = categories[0].toLowerCase();
                }
            };
            const renderMemeCollection = (category = document.getElementById('categoryFilter')?.value || 'all') => {
                const container = document.getElementById('memeCollectionContainer');
                container.innerHTML = '';
                const memes = MemeStorage.getMemesByCategory(category);

                if (memes.length === 0) {
                    container.innerHTML = `<p class="text-center py-10" style="color: var(--tg-theme-hint-color);">No memes found in this category.</p>`;
                    return;
                }
                memes.forEach(meme => {
                    const card = document.createElement('div');
                    card.className = 'meme-card p-3 rounded-lg shadow-md space-y-2';
                    let reactionsHTML = '<div class="flex flex-wrap gap-1 text-xs items-center">';
                    if (Object.keys(meme.reactions).length > 0) {
                        for (const [reaction, count] of Object.entries(meme.reactions)) {
                            reactionsHTML += `<span class="px-2 py-0.5 rounded-full" style="background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: 1px solid var(--tg-theme-hint-color);">${reaction} ${count}</span>`;
                        }
                    } else { reactionsHTML += `<span style="color: var(--tg-theme-hint-color);">No reactions yet.</span>`; }
                    reactionsHTML += '</div>';
                    const reactionButtons = `<div class="mt-1 pt-1 border-t flex gap-1" style="border-color: var(--tg-theme-hint-color);">${['👍', '❤️', '😂', '🔥', '🤔'].map(r => `<button class="text-sm p-1.5 rounded-md hover:opacity-75 reaction-btn flex-1" style="background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);" data-meme-id="${meme.id}" data-reaction="${r}">${r}</button>`).join('')}</div>`;
                    
                    card.innerHTML = `
                        <h3 class="text-base font-semibold truncate" style="color: var(--tg-theme-text-color);">${meme.title || 'Meme'}</h3>
                        <p class="text-xs" style="color: var(--tg-theme-hint-color);">Category: ${meme.category} by @${meme.username || 'Unknown'}</p>
                        <img src="${meme.memeImage}" alt="${meme.title || 'Meme'}" class="w-full h-auto rounded-md object-contain max-h-72" loading="lazy">
                        ${reactionsHTML}
                        ${reactionButtons}
                    `;
                    container.appendChild(card);
                });
                document.querySelectorAll('.reaction-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const memeId = e.currentTarget.dataset.memeId;
                        const reaction = e.currentTarget.dataset.reaction;
                        MemeStorage.updateMemeReaction(memeId, reaction);
                        renderMemeCollection(document.getElementById('categoryFilter').value); 
                        tg.HapticFeedback.impactOccurred('light');
                    });
                });
            };
            return { init, renderMemeCollection, populateFilters };
        })();

        // --- Leaderboard (largely unchanged) ---
        const Leaderboard = (() => {
            let currentCategory = 'all';
            let currentTimeframe = 'all_time';
            const init = () => {
                document.getElementById('leaderboardCategoryTabs').addEventListener('click', handleCategoryTabClick);
                document.getElementById('leaderboardTimeframeTabs').addEventListener('click', handleTimeframeTabClick);
                populateLeaderboardCategoryTabs();
                renderLeaderboard();
            };
            const handleCategoryTabClick = (event) => {
                const button = event.target.closest('button');
                if (button && button.dataset.category) {
                    currentCategory = button.dataset.category;
                    updateActiveButtonStyles(document.getElementById('leaderboardCategoryTabs'), button);
                    renderLeaderboard();
                }
            };
            const handleTimeframeTabClick = (event) => {
                const button = event.target.closest('button');
                if (button && button.dataset.timeframe) {
                    currentTimeframe = button.dataset.timeframe;
                     updateActiveButtonStyles(document.getElementById('leaderboardTimeframeTabs'), button);
                    renderLeaderboard();
                }
            };
            const updateActiveButtonStyles = (container, activeButton) => {
                container.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = tg.themeParams.secondary_bg_color || '#e5e5ea';
                    btn.style.color = tg.themeParams.text_color || '#000000';
                });
                activeButton.classList.add('active');
                activeButton.style.backgroundColor = tg.themeParams.button_color || '#007aff';
                activeButton.style.color = tg.themeParams.button_text_color || '#ffffff';
            };
            const calculatePoints = (meme) => {
                let points = 5; 
                for (const count of Object.values(meme.reactions)) { points += count; }
                return points;
            };
            const getLeaderboardData = () => {
                let memes = MemeStorage.getMemes();
                if (currentCategory !== 'all') {
                    memes = memes.filter(m => m.category.toLowerCase() === currentCategory.toLowerCase());
                }
                const now = new Date();
                if (currentTimeframe === 'daily') {
                    memes = memes.filter(m => new Date(m.createdAt).toDateString() === now.toDateString());
                } else if (currentTimeframe === 'weekly') {
                    const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                    memes = memes.filter(m => new Date(m.createdAt) >= oneWeekAgo);
                }
                const userScores = {};
                memes.forEach(meme => {
                    const userId = meme.userId || 'guest';
                    if (!userScores[userId]) {
                        userScores[userId] = { username: meme.username || 'Guest', profileImage: meme.userPhotoUrl || `https://placehold.co/40x40/777/FFF?text=${(meme.username || 'G').charAt(0)}`, points: 0, memesCreated: 0 };
                    }
                    userScores[userId].points += calculatePoints(meme);
                    userScores[userId].memesCreated++;
                });
                return Object.values(userScores).sort((a, b) => b.points - a.points || b.memesCreated - a.memesCreated);
            };
            const renderLeaderboard = () => {
                const container = document.getElementById('leaderboardContainer');
                container.innerHTML = '';
                const topUsers = getLeaderboardData().slice(0, 50); 
                if (topUsers.length === 0) {
                    container.innerHTML = `<p class="text-center py-10" style="color: var(--tg-theme-hint-color);">No data for this leaderboard yet.</p>`;
                    return;
                }
                topUsers.forEach((user, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item flex items-center justify-between p-2.5 rounded-lg shadow';
                    item.innerHTML = `
                        <div class="flex items-center space-x-2.5">
                            <span class="font-semibold w-6 text-center" style="color: var(--tg-theme-hint-color);">${index + 1}.</span>
                            <img src="${user.profileImage}" alt="${user.username}" class="w-8 h-8 rounded-full object-cover">
                            <span class="font-medium truncate" style="color: var(--tg-theme-text-color); max-width: 150px;">${user.username}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-semibold block" style="color: var(--tg-theme-link-color);">${user.points} pts</span>
                            <span class="text-xs block" style="color: var(--tg-theme-hint-color);">${user.memesCreated} meme${user.memesCreated === 1 ? '' : 's'}</span>
                        </div>`;
                    container.appendChild(item);
                });
            };
            const populateLeaderboardCategoryTabs = () => {
                const tabsContainer = document.getElementById('leaderboardCategoryTabs');
                const memes = MemeStorage.getMemes();
                const categories = ['All', ...new Set(memes.map(m => m.category).filter(Boolean).sort())];
                
                tabsContainer.innerHTML = '';
                categories.forEach(cat => {
                    const button = document.createElement('button');
                    button.className = 'sub-tab-button text-xs px-3 py-1.5 rounded-md';
                    button.dataset.category = cat.toLowerCase();
                    button.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                    if (cat.toLowerCase() === currentCategory) {
                         button.classList.add('active');
                         button.style.backgroundColor = tg.themeParams.button_color || '#007aff';
                         button.style.color = tg.themeParams.button_text_color || '#ffffff';
                    }
                    tabsContainer.appendChild(button);
                });
            };
            return { init, renderLeaderboard, populateLeaderboardCategoryTabs };
        })();

        MemeGenerator.init();
        UI.init();
        Leaderboard.init();
        switchTab('home-tab'); 
    });
    </script>
</body>
</html>
