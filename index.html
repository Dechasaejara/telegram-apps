<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Addis Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      /* Inter Font */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Basic Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: var(--tg-theme-secondary-bg-color, #f1f1f1);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--tg-theme-button-color, #888);
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--tg-theme-button-hover-color, #555);
      }

      /* Skeleton Loader */
      .skeleton {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        background-color: var(--tg-theme-secondary-bg-color, #e0e0e0);
        border-radius: 0.375rem; /* rounded-md */
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Page transition placeholder */
      .page {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        min-height: 100vh; /* Ensure page takes full viewport height */
        padding-bottom: 80px; /* Space for bottom nav */
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        background-color: var(--tg-theme-bg-color, #ffffff);
        overflow-y: auto; /* Allow scrolling within page */
      }
      .page-enter {
        transform: translateX(100%);
        opacity: 0;
      }
      .page-enter-active {
        transform: translateX(0);
        opacity: 1;
      }
      .page-exit {
        transform: translateX(0);
        opacity: 1;
      }
      .page-exit-active {
        transform: translateX(-100%);
        opacity: 0;
      }

      /* Header */
      .app-header {
        background-color: var(
          --tg-theme-header-bg-color,
          var(--tg-theme-bg-color, #ffffff)
        );
        color: var(--tg-theme-text-color, #000000);
        border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        height: 56px; /* Standard header height */
      }

      /* Content area with padding for fixed header and footer */
      .content-area {
        padding-top: 56px; /* Header height */
        padding-bottom: 70px; /* Bottom nav height */
        min-height: calc(100vh - 56px); /* Full height minus header */
      }

      /* Bottom Navigation */
      .bottom-nav {
        background-color: var(--tg-theme-secondary-bg-color, #f8f8f8);
        border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
        height: 64px; /* Standard bottom nav height */
      }
      .bottom-nav-item.active svg {
        color: var(--tg-theme-button-color, #007aff);
      }
      .bottom-nav-item.active span {
        color: var(--tg-theme-button-color, #007aff);
      }

      /* Modal styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: var(--tg-theme-bg-color, white);
        color: var(--tg-theme-text-color, black);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 400px;
      }

      /* Input field styling to match Telegram */
      .tg-input {
        background-color: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        border: 1px solid var(--tg-theme-hint-color, #cccccc);
        padding: 10px 12px;
        border-radius: 8px;
        width: 100%;
        font-size: 16px;
      }
      .tg-input:focus {
        border-color: var(--tg-theme-link-color, #007aff);
        outline: none;
      }
      .tg-select {
        background-color: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        border: 1px solid var(--tg-theme-hint-color, #cccccc);
        padding: 10px 12px;
        border-radius: 8px;
        width: 100%;
        font-size: 16px;
        appearance: none; /* Remove default arrow */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%236b7280' class='w-4 h-4'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
      }

      /* Button styling to match Telegram */
      .tg-button {
        background-color: var(--tg-theme-button-color, #007aff);
        color: var(--tg-theme-button-text-color, #ffffff);
        padding: 12px 18px;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
      }
      .tg-button:hover {
        background-color: var(
          --tg-theme-button-hover-color,
          #005bb5
        ); /* Custom hover or darker shade */
      }
      .tg-button-secondary {
        background-color: var(--tg-theme-secondary-bg-color, #e5e5e5);
        color: var(--tg-theme-text-color, #000000);
      }
      .tg-button-secondary:hover {
        background-color: var(--tg-theme-hint-color, #d5d5d5);
      }

      /* Ensure content is not hidden by fixed header/footer */
      #app-container
        > div:not(.app-header):not(.bottom-nav):not(.modal-backdrop) {
        padding-top: 56px;
        padding-bottom: 64px;
      }

      /* Card styling */
      .event-card {
        background-color: var(--tg-theme-secondary-bg-color, #f9f9f9);
        color: var(--tg-theme-text-color, #000000);
        border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      }
      .event-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      /* Fix for potential double padding on page containers */
      .page {
        padding-top: 0 !important; /* Override previous padding-top */
        padding-bottom: 0 !important; /* Override previous padding-bottom */
      }
      .page-content-wrapper {
        padding-top: 56px; /* Header height */
        padding-bottom: 70px; /* Bottom nav height + small buffer */
        min-height: calc(100vh); /* Full height minus header and footer */
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="app-container" class="relative min-h-screen">
      <header
        id="app-header"
        class="app-header flex items-center justify-between px-4 shadow-sm"
      >
        <button
          id="back-button"
          class="hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 19.5L8.25 12l7.5-7.5"
            />
          </svg>
        </button>
        <h1 id="header-title" class="text-lg font-semibold">Discover Events</h1>
        <div class="w-10"></div>
      </header>

      <main id="page-content" class="content-area"></main>

      <nav
        id="bottom-nav"
        class="bottom-nav flex justify-around items-center shadow-t-lg"
      ></nav>

      <div id="modal-container"></div>

      <div
        id="loading-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000]"
        style="display: none"
      >
        <div
          class="w-16 h-16 border-4 border-t-transparent border-[var(--tg-theme-button-color,blue)] rounded-full animate-spin"
        ></div>
      </div>
    </div>

    <script>
      // --- TELEGRAM WEB APP SDK ---
      const tg = window.Telegram.WebApp;

      // --- GLOBAL STATE & CONFIG ---
      const AppState = {
        currentUser: null,
        currentPage: "discover",
        historyStack: ["discover"], // For back button navigation
        events: [],
        organizers: [],
        tickets: [], // User's purchased tickets
        userPreferences: {
          interests: [],
          locationEnabled: false,
          notifications: true,
          language: "en", // 'am' for Amharic
        },
        currentEventDetail: null, // To store event being viewed
        isLoading: false,
        filters: {
          category: "all",
          date: "",
          searchTerm: "",
          priceRange: [0, 10000], // Example price range in ETB
        },
        mapServiceAvailable: false, // Placeholder for map integration check
      };

      // --- SAMPLE DATA ---
      // This would typically come from an API
      const SampleData = {
        organizers: [
          {
            id: "org1",
            name: "Shega Events",
            contact: "info@shega.com",
            logoUrl: "https://placehold.co/100x100/blue/white?text=Shega",
            events: ["evt1", "evt3"],
          },
          {
            id: "org2",
            name: "AddisVibes Productions",
            contact: "contact@addisvibes.et",
            logoUrl: "https://placehold.co/100x100/green/white?text=AVP",
            events: ["evt2"],
          },
        ],
        events: [
          {
            id: "evt1",
            organizerId: "org1",
            title: "Tech Innovators Summit Addis",
            description:
              "Join us for the annual Tech Innovators Summit, bringing together the brightest minds in Ethiopian tech. Workshops, networking, and keynote speeches.",
            dateTime: new Date(
              Date.now() + 7 * 24 * 60 * 60 * 1000
            ).toISOString(), // One week from now
            venue: {
              name: "Skylight Hotel",
              address: "Bole Medhanealem, Addis Ababa",
              lat: 8.9994,
              lon: 38.7892,
              mapLink: "https://maps.google.com/?q=Skylight+Hotel+Addis+Ababa",
            },
            category: "Workshop", // Music, Sports, Cultural, Workshop, Conference, Festival
            priceTiers: [
              {
                type: "Early Bird",
                price: 500,
                currency: "ETB",
                available: 50,
                sold: 10,
              },
              {
                type: "General Admission",
                price: 800,
                currency: "ETB",
                available: 150,
                sold: 5,
              },
              {
                type: "VIP Pass",
                price: 1500,
                currency: "ETB",
                available: 20,
                sold: 2,
              },
            ],
            capacity: 220,
            posterImageUrl:
              "https://placehold.co/600x400/007bff/ffffff?text=Tech+Summit",
            images: [
              "https://placehold.co/600x400/007bff/ffffff?text=Summit+Pic+1",
              "https://placehold.co/600x400/007bff/ffffff?text=Summit+Pic+2",
            ],
            status: "published",
            recurring: null, // { type: 'weekly', day: 'Saturday' }
            instructions:
              "Please bring your ID for registration. Doors open at 8:00 AM.",
            tags: ["tech", "innovation", "startup", "addis ababa"],
          },
          {
            id: "evt2",
            organizerId: "org2",
            title: "Cultural Music Night",
            description:
              "Experience the vibrant sounds of Ethiopia with traditional and contemporary live music performances. A night of cultural immersion and celebration.",
            dateTime: new Date(
              Date.now() + 14 * 24 * 60 * 60 * 1000
            ).toISOString(), // Two weeks from now
            venue: {
              name: "Ethiopian National Theatre",
              address: "Churchill Ave, Addis Ababa",
              lat: 9.0212,
              lon: 38.7525,
              mapLink: "https://maps.google.com/?q=Ethiopian+National+Theatre",
            },
            category: "Music",
            priceTiers: [
              {
                type: "Standard Ticket",
                price: 300,
                currency: "ETB",
                available: 300,
                sold: 120,
              },
              {
                type: "At The Door",
                price: 400,
                currency: "ETB",
                available: 50,
                sold: 0,
              },
            ],
            capacity: 350,
            posterImageUrl:
              "https://placehold.co/600x400/28a745/ffffff?text=Music+Night",
            images: [],
            status: "published",
            instructions: "Seating is first-come, first-served.",
            tags: ["music", "cultural", "live performance", "ethiopian music"],
          },
          {
            id: "evt3",
            organizerId: "org1",
            title: "Startup Pitch Competition",
            description:
              "Watch the next generation of Ethiopian entrepreneurs pitch their innovative ideas to a panel of investors. Networking opportunities available.",
            dateTime: new Date(
              Date.now() + 21 * 24 * 60 * 60 * 1000
            ).toISOString(), // Three weeks from now
            venue: {
              name: "Ice Addis",
              address: "Roosevelt St, Addis Ababa",
              lat: 9.0054,
              lon: 38.7636,
              mapLink: "https://maps.google.com/?q=Ice+Addis",
            },
            category: "Conference",
            priceTiers: [
              {
                type: "Attendee Pass",
                price: 200,
                currency: "ETB",
                available: 100,
                sold: 30,
              },
              {
                type: "Student Pass",
                price: 100,
                currency: "ETB",
                available: 50,
                sold: 15,
                requiresStudentId: true,
              },
            ],
            capacity: 150,
            posterImageUrl:
              "https://placehold.co/600x400/ffc107/000000?text=Pitch+Comp",
            images: [],
            status: "published",
            instructions:
              "Student ID required for student pass holders at entry.",
            tags: ["startup", "pitch", "entrepreneurship", "investment"],
          },
          {
            id: "evt4",
            organizerId: "org2",
            title: "Addis Ababa Food Festival",
            description:
              "A culinary journey through Ethiopia and beyond! Taste delicious foods from various vendors, enjoy live cooking shows and music.",
            dateTime: new Date(
              Date.now() + 5 * 24 * 60 * 60 * 1000
            ).toISOString(), // Five days from now
            venue: {
              name: "Ghion Hotel Gardens",
              address: "Ras Desta Damtew St, Addis Ababa",
              lat: 9.0167,
              lon: 38.7619,
              mapLink: "https://maps.google.com/?q=Ghion+Hotel+Addis+Ababa",
            },
            category: "Festival",
            priceTiers: [
              {
                type: "Entry Ticket",
                price: 150,
                currency: "ETB",
                available: 1000,
                sold: 250,
              },
              {
                type: "Family Package (2 Adults, 2 Kids)",
                price: 500,
                currency: "ETB",
                available: 100,
                sold: 20,
              },
            ],
            capacity: 1100, // Sum of available in tiers
            posterImageUrl:
              "https://placehold.co/600x400/dc3545/ffffff?text=Food+Fest",
            images: [],
            status: "published",
            instructions: "Come hungry! Pets are not allowed.",
            tags: ["food", "festival", "cuisine", "family", "addis ababa"],
          },
        ],
        userTickets: [
          // Example of tickets a user might have
          // { ticketId: 'tkt123', eventId: 'evt1', userId: 'user123', tierType: 'General Admission', purchaseDate: new Date().toISOString(), qrCodeData: 'EVENT:evt1;USER:user123;TIER:General;TID:tkt123', status: 'valid' }
        ],
        promotions: [
          {
            id: "promo1",
            eventId: "evt1",
            code: "TECHSAVE20",
            discountPercentage: 20,
            isActive: true,
          },
          {
            id: "promo2",
            eventId: "evt2",
            code: "MUSIC10",
            discountPercentage: 10,
            isActive: true,
          },
        ],
      };

      // --- DOM ELEMENTS ---
      const appContainer = document.getElementById("app-container");
      const headerEl = document.getElementById("app-header");
      const headerTitleEl = document.getElementById("header-title");
      const backButtonEl = document.getElementById("back-button");
      const pageContentEl = document.getElementById("page-content");
      const bottomNavEl = document.getElementById("bottom-nav");
      const modalContainerEl = document.getElementById("modal-container");
      const loadingOverlayEl = document.getElementById("loading-overlay");

      // --- UTILITY FUNCTIONS ---
      const Utils = {
        formatDate: (isoString, locale = "en-US") => {
          // Consider 'am-ET' for Amharic
          if (!isoString) return "Date TBD";
          const date = new Date(isoString);
          const options = {
            weekday: "short",
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          };
          return date.toLocaleDateString(locale, options);
        },
        truncateText: (text, maxLength = 100) => {
          if (text.length <= maxLength) return text;
          return text.substring(0, maxLength) + "...";
        },
        generateGUID: () => {
          // Simple GUID for mock data
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0,
                v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        },
        showLoading: (show) => {
          AppState.isLoading = show;
          loadingOverlayEl.style.display = show ? "flex" : "none";
          if (show) {
            tg.MainButton.showProgress();
          } else {
            tg.MainButton.hideProgress();
          }
        },
        showModal: (
          title,
          content,
          buttons = [
            { text: "OK", type: "primary", action: () => Utils.closeModal() },
          ]
        ) => {
          tg.HapticFeedback.notificationOccurred("warning");
          const modalHTML = `
                    <div class="modal-backdrop" id="active-modal-backdrop">
                        <div class="modal-content animate__animated animate__fadeInUp animate__faster">
                            <h3 class="text-xl font-semibold mb-3">${title}</h3>
                            <div class="text-sm mb-6">${content}</div>
                            <div class="flex justify-end space-x-3">
                                ${buttons
                                  .map(
                                    (btn) =>
                                      `<button class="tg-button ${
                                        btn.type === "secondary"
                                          ? "tg-button-secondary"
                                          : ""
                                      }" data-action="${btn.text}">${
                                        btn.text
                                      }</button>`
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                `;
          modalContainerEl.innerHTML = modalHTML;
          modalContainerEl
            .querySelector(".modal-backdrop")
            .addEventListener("click", (e) => {
              if (e.target.id === "active-modal-backdrop") Utils.closeModal(); // Close on backdrop click
            });
          buttons.forEach((btn) => {
            const btnEl = modalContainerEl.querySelector(
              `button[data-action="${btn.text}"]`
            );
            if (btnEl)
              btnEl.addEventListener("click", () => {
                btn.action();
                if (btn.closesModal !== false) Utils.closeModal();
              });
          });
        },
        closeModal: () => {
          const modalBackdrop =
            modalContainerEl.querySelector(".modal-backdrop");
          if (modalBackdrop) {
            modalBackdrop.classList.remove("animate__fadeInUp");
            modalBackdrop.classList.add("animate__fadeOutDown");
            setTimeout(() => {
              modalContainerEl.innerHTML = "";
            }, 300); // Animation duration
          }
        },
        getOrganizerById: (id) =>
          AppState.organizers.find((org) => org.id === id),
        getEventById: (id) => AppState.events.find((event) => event.id === id),
        getTicketById: (id) =>
          AppState.tickets.find((ticket) => ticket.id === id),
      };

      // --- TELEGRAM SDK INTEGRATION ---
      const TelegramService = {
        init: () => {
          tg.ready();
          tg.expand(); // Expand the Mini App to full height

          // User data
          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            AppState.currentUser = {
              id: tg.initDataUnsafe.user.id,
              firstName: tg.initDataUnsafe.user.first_name,
              lastName: tg.initDataUnsafe.user.last_name || "",
              username: tg.initDataUnsafe.user.username,
              photoUrl: tg.initDataUnsafe.user.photo_url,
              languageCode: tg.initDataUnsafe.user.language_code || "en",
            };
            // Potentially set app language based on user's TG language
            // AppState.userPreferences.language = AppState.currentUser.languageCode.startsWith('am') ? 'am' : 'en';
          } else {
            // Fallback for testing outside Telegram
            AppState.currentUser = {
              id: "testuser123",
              firstName: "Test",
              lastName: "User",
              username: "testuser",
              photoUrl: "https://placehold.co/100x100/777/fff?text=TU",
              languageCode: "en",
            };
          }

          // Theme
          TelegramService.applyTheme();
          tg.onEvent("themeChanged", TelegramService.applyTheme);

          // Back button
          tg.BackButton.onClick(Navigation.handleBack);

          // Main button (initially hidden or configured per page)
          tg.MainButton.setParams({
            text: "CONTINUE",
            color: tg.themeParams.button_color || "#007AFF",
            text_color: tg.themeParams.button_text_color || "#FFFFFF",
          });
          // tg.MainButton.onClick(() => { /* Define contextually */ });
          // tg.MainButton.hide();

          // Version check
          console.log("Telegram WebApp version:", tg.version);
          if (tg.isVersionAtLeast("6.1")) {
            // Use newer features
          }

          // Viewport changed (for safe areas)
          tg.onEvent("viewportChanged", TelegramService.handleViewportChange);
          TelegramService.handleViewportChange({ isStateStable: true }); // Initial call
        },
        applyTheme: () => {
          document.body.style.backgroundColor =
            tg.themeParams.bg_color || "#ffffff";
          document.body.style.color = tg.themeParams.text_color || "#000000";
          // Update other elements if needed, Tailwind dark mode might handle a lot via CSS vars
          if (tg.colorScheme === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
          // Re-render UI elements that depend on theme if necessary
          // For example, if icons need to change color based on theme not covered by text_color
          UI.renderBottomNav(); // Re-render nav to pick up active colors
        },
        handleViewportChange: (event) => {
          // Handle safe areas if needed, e.g., adjusting padding for header/footer
          // For now, fixed header/footer and content padding should manage this.
          // console.log("Viewport changed:", tg.viewportHeight, tg.viewportStableHeight, event.isStateStable);
          if (event.isStateStable) {
            // Adjust layout if needed, e.g. when keyboard appears/disappears
          }
        },
        requestLocation: (callback) => {
          if (tg.CloudStorage) {
            // Example of checking for a feature, not directly for location
            // Telegram doesn't directly provide a location API in the WebApp SDK.
            // You'd use browser's navigator.geolocation
            console.warn(
              "Telegram Mini App SDK does not provide a location API. Using browser geolocation."
            );
          }
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                tg.HapticFeedback.notificationOccurred("success");
                callback({
                  success: true,
                  coords: {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                  },
                });
              },
              (error) => {
                tg.HapticFeedback.notificationOccurred("error");
                console.error("Geolocation error:", error);
                Utils.showModal(
                  "Location Error",
                  `Could not retrieve location: ${error.message}. Please ensure location services are enabled.`,
                  [{ text: "OK" }]
                );
                callback({ success: false, error: error.message });
              }
            );
          } else {
            Utils.showModal(
              "Location Not Supported",
              "Geolocation is not supported by your browser or device.",
              [{ text: "OK" }]
            );
            callback({ success: false, error: "Geolocation not supported" });
          }
        },
        shareEvent: (event) => {
          const text = `Check out this event: ${
            event.title
          }! Happening on ${Utils.formatDate(
            event.dateTime
          )}. More info in the Addis Events app!`;
          // The actual URL should be the link to your Mini App, possibly with params to open this specific event.
          // tg.switchInlineQuery or a share URL for tg://resolve?domain=YourBotName&startapp=event-${event.id}
          // For simplicity, we'll use a generic share text.
          tg.openTelegramLink(
            `https://t.me/share/url?url=${encodeURIComponent(
              "https://yourminiapp.link/event/" + event.id
            )}&text=${encodeURIComponent(text)}`
          );
          tg.HapticFeedback.impactOccurred("medium");
        },
      };

      // --- UI RENDERING ---
      const UI = {
        renderPage: (pageId, params = {}) => {
          Utils.showLoading(true);
          // Simple fade transition (can be improved with CSS animations)
          pageContentEl.style.opacity = 0;

          setTimeout(() => {
            // Simulate async loading and allow transition
            pageContentEl.innerHTML = ""; // Clear previous content
            let content = "";
            let pageTitle = "";

            switch (pageId) {
              case "discover":
                content = UI.Pages.discover();
                pageTitle = "Discover Events";
                tg.MainButton.hide();
                break;
              case "eventDetail":
                AppState.currentEventDetail = AppState.events.find(
                  (e) => e.id === params.eventId
                );
                if (AppState.currentEventDetail) {
                  content = UI.Pages.eventDetail(AppState.currentEventDetail);
                  pageTitle = AppState.currentEventDetail.title;
                  tg.MainButton.setText("Get Tickets");
                  tg.MainButton.onClick(() =>
                    UI.handleGetTickets(AppState.currentEventDetail)
                  );
                  tg.MainButton.show();
                } else {
                  content = `<p class="p-4 text-red-500">Event not found.</p>`;
                  pageTitle = "Error";
                  tg.MainButton.hide();
                }
                break;
              case "myTickets":
                content = UI.Pages.myTickets();
                pageTitle = "My Tickets";
                tg.MainButton.hide();
                break;
              case "profile":
                content = UI.Pages.profile();
                pageTitle = "My Profile";
                tg.MainButton.setText("Save Preferences");
                tg.MainButton.onClick(UI.handleSavePreferences);
                tg.MainButton.show();
                break;
              case "organizerDashboard": // Simplified
                content = UI.Pages.organizerDashboard();
                pageTitle = "Organizer Dashboard";
                tg.MainButton.hide();
                break;
              case "ticketPurchase":
                const eventForPurchase = AppState.events.find(
                  (e) => e.id === params.eventId
                );
                if (eventForPurchase) {
                  content = UI.Pages.ticketPurchase(eventForPurchase);
                  pageTitle = `Buy: ${eventForPurchase.title}`;
                  // MainButton handled by ticketPurchase page logic
                } else {
                  content = `<p class="p-4 text-red-500">Event not found for purchase.</p>`;
                  pageTitle = "Error";
                  tg.MainButton.hide();
                }
                break;
              default:
                content = `<p class="p-4">Page not found.</p>`;
                pageTitle = "Not Found";
                tg.MainButton.hide();
            }
            pageContentEl.innerHTML = `<div class="page-content-wrapper">${content}</div>`;
            headerTitleEl.textContent = pageTitle;

            // Attach event listeners for dynamically added content
            UI.attachPageEventListeners(pageId, params);

            pageContentEl.style.opacity = 1;
            Utils.showLoading(false);
            window.scrollTo(0, 0); // Scroll to top on new page
          }, 150); // Small delay for perceived responsiveness & transition
        },

        Pages: {
          discover: () => {
            const { category, date, searchTerm } = AppState.filters;
            const filteredEvents = AppState.events.filter((event) => {
              const matchCategory =
                category === "all" ||
                event.category.toLowerCase() === category.toLowerCase();
              const matchSearch =
                !searchTerm ||
                event.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                event.description
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase()) ||
                (event.tags &&
                  event.tags.some((tag) =>
                    tag.toLowerCase().includes(searchTerm.toLowerCase())
                  ));
              const matchDate =
                !date ||
                new Date(event.dateTime).toDateString() ===
                  new Date(date).toDateString();
              // Add price filter if implemented
              return (
                matchCategory &&
                matchSearch &&
                matchDate &&
                event.status === "published"
              );
            });

            const categories = [
              "All",
              ...new Set(AppState.events.map((e) => e.category)),
            ];

            // Skeleton loading state
            if (AppState.isLoading && !filteredEvents.length) {
              return Array(3)
                .fill(0)
                .map(
                  () => `
                            <div class="event-card m-4 p-4 rounded-lg shadow-md transition-all duration-300">
                                <div class="skeleton h-40 w-full mb-3"></div>
                                <div class="skeleton h-6 w-3/4 mb-2"></div>
                                <div class="skeleton h-4 w-1/2 mb-1"></div>
                                <div class="skeleton h-4 w-1/3"></div>
                            </div>
                        `
                )
                .join("");
            }

            return `
                        <div class="p-4">
                            <input type="text" id="search-input" placeholder="Search events (e.g., music, tech summit)" class="tg-input mb-3" value="${searchTerm}">
                            <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                                <select id="filter-category" class="tg-select flex-grow">
                                    ${categories
                                      .map(
                                        (cat) =>
                                          `<option value="${cat.toLowerCase()}" ${
                                            category === cat.toLowerCase()
                                              ? "selected"
                                              : ""
                                          }>${cat}</option>`
                                      )
                                      .join("")}
                                </select>
                                <input type="date" id="filter-date" class="tg-input flex-grow" value="${date}">
                            </div>
                             <div id="geolocation-info" class="text-sm text-[var(--tg-theme-hint-color)] mb-3 hidden"></div>
                             <button id="locate-me-btn" class="tg-button tg-button-secondary w-full mb-4 text-sm py-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline mr-1">
                                  <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.145l.005-.002.007-.004.011-.007a48.458 48.458 0 001.14-.642l.003-.002.003-.002a48.152 48.152 0 001.072-.703l.002-.001.002-.002.003-.002.003-.003.002-.002.005-.003a13.078 13.078 0 002.99-2.717 10.002 10.002 0 002.15-4.082A9.973 9.973 0 0019 10a9 9 0 10-18 0c0 .414.029.822.085 1.226l.002.008.002.008.004.012a10.036 10.036 0 002.15 4.082 13.078 13.078 0 002.99 2.718l.005.003.002.002.003.003.003.002.002.001.002.002a48.153 48.153 0 001.072.703l.003.002.003.002a48.459 48.459 0 001.14.642l.011.007.007.004.005.002a5.743 5.743 0 00.28.145l.019.008.006.003zM10 11.25a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" clip-rule="evenodd" />
                                </svg>
                                Find Events Near Me
                             </button>

                            ${
                              filteredEvents.length > 0
                                ? filteredEvents
                                    .map((event) =>
                                      UI.Components.eventCard(event)
                                    )
                                    .join("")
                                : '<p class="text-center text-[var(--tg-theme-hint-color)] py-8">No events match your criteria. Try adjusting your filters!</p>'
                            }
                        </div>
                    `;
          },
          eventDetail: (event) => {
            if (!event)
              return '<p class="p-4 text-red-500">Error: Event details could not be loaded.</p>';
            const organizer = Utils.getOrganizerById(event.organizerId);
            return `
                        <div class="pb-16">
                            <img src="${event.posterImageUrl}" alt="${
              event.title
            }" class="w-full h-64 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=Image+Not+Found';">
                            <div class="p-4">
                                <h2 class="text-3xl font-bold mb-2">${
                                  event.title
                                }</h2>
                                <div class="flex items-center text-sm text-[var(--tg-theme-hint-color)] mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5A.75.75 0 014 6.75v8.5a1.25 1.25 0 001.25 1.25h10.5a1.25 1.25 0 001.25-1.25v-8.5a1.25 1.25 0 00-1.25-1.25H4a.75.75 0 01.75.75z" clip-rule="evenodd" /></svg>
                                    <span>${Utils.formatDate(
                                      event.dateTime
                                    )}</span>
                                </div>
                                <div class="flex items-center text-sm text-[var(--tg-theme-hint-color)] mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.145l.005-.002.007-.004.011-.007a48.458 48.458 0 001.14-.642l.003-.002.003-.002a48.152 48.152 0 001.072-.703l.002-.001.002-.002.003-.002.003-.003.002-.002.005-.003a13.078 13.078 0 002.99-2.717A10.002 10.002 0 0017.85 10a7.85 7.85 0 10-15.7 0c0 .414.029.822.085 1.226l.002.008.002.008.004.012a10.036 10.036 0 002.15 4.082 13.078 13.078 0 002.99 2.718l.005.003.002.002.003.003.003.002.002.001.002.002a48.153 48.153 0 001.072.703l.003.002.003.002a48.459 48.459 0 001.14.642l.011.007.007.004.005.002a5.743 5.743 0 00.28.145l.019.008.006.003zM10 11.25a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" clip-rule="evenodd" /></svg>
                                    <span>${event.venue.name} - ${
              event.venue.address
            }</span>
                                    ${
                                      event.venue.mapLink
                                        ? `<a href="${event.venue.mapLink}" target="_blank" class="text-[var(--tg-theme-link-color)] ml-2 text-xs">(View Map)</a>`
                                        : ""
                                    }
                                </div>
                                
                                <div class="mb-4">
                                    <span class="inline-block bg-[var(--tg-theme-button-color)] bg-opacity-20 text-[var(--tg-theme-button-color)] text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${
                                      event.category
                                    }</span>
                                    ${
                                      event.tags &&
                                      event.tags
                                        .map(
                                          (tag) =>
                                            `<span class="inline-block bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`
                                        )
                                        .join("")
                                    }
                                </div>

                                <p class="text-base leading-relaxed mb-6">${
                                  event.description
                                }</p>
                                
                                ${
                                  event.images && event.images.length > 0
                                    ? `
                                    <h4 class="text-lg font-semibold mb-2">Gallery</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
                                        ${event.images
                                          .map(
                                            (img) =>
                                              `<img src="${img}" class="rounded-md object-cover h-32 w-full" onerror="this.style.display='none'">`
                                          )
                                          .join("")}
                                    </div>
                                `
                                    : ""
                                }

                                <h4 class="text-lg font-semibold mb-2">Tickets</h4>
                                <div class="space-y-2 mb-6">
                                    ${event.priceTiers
                                      .map(
                                        (tier) => `
                                        <div class="p-3 rounded-md border border-[var(--tg-theme-hint-color)] flex justify-between items-center">
                                            <div>
                                                <span class="font-medium">${
                                                  tier.type
                                                }</span>
                                                <span class="text-xs block text-[var(--tg-theme-hint-color)]">${
                                                  tier.available - tier.sold
                                                } available</span>
                                            </div>
                                            <span class="font-semibold text-lg">${
                                              tier.price
                                            } ${tier.currency}</span>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                                
                                ${
                                  event.instructions
                                    ? `
                                    <h4 class="text-lg font-semibold mb-2">Important Information</h4>
                                    <p class="text-sm text-[var(--tg-theme-hint-color)] mb-6">${event.instructions}</p>
                                `
                                    : ""
                                }

                                ${
                                  organizer
                                    ? `
                                <div class="mt-6 pt-4 border-t border-[var(--tg-theme-hint-color)]">
                                    <h4 class="text-lg font-semibold mb-2">Organized by</h4>
                                    <div class="flex items-center">
                                        <img src="${organizer.logoUrl}" alt="${organizer.name}" class="w-12 h-12 rounded-full mr-3 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/48x48/cccccc/333333?text=Logo';">
                                        <div>
                                            <p class="font-medium">${organizer.name}</p>
                                            <p class="text-xs text-[var(--tg-theme-hint-color)]">${organizer.contact}</p>
                                        </div>
                                    </div>
                                </div>
                                `
                                    : ""
                                }
                                
                                <button id="share-event-btn" class="mt-6 tg-button tg-button-secondary w-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline mr-1">
                                      <path d="M13 4.5a2.5 2.5 0 11.702 4.289l-4.014 2.409a2.502 2.502 0 010 1.604l4.014 2.408a2.5 2.5 0 11-.702.788l-4.014-2.408a2.5 2.5 0 110-3.18l4.014-2.409A2.5 2.5 0 0113 4.5z" />
                                    </svg>
                                    Share Event
                                </button>
                            </div>
                        </div>
                    `;
          },
          myTickets: () => {
            if (AppState.tickets.length === 0) {
              return `
                            <div class="p-4 text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-[var(--tg-theme-hint-color)] mb-4">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" />
                                </svg>
                                <p class="text-lg font-medium mb-2">No Tickets Yet!</p>
                                <p class="text-[var(--tg-theme-hint-color)] mb-4">Looks like you haven't purchased any tickets. Explore events and get yours today!</p>
                                <button class="tg-button" onclick="Navigation.navigateTo('discover')">Discover Events</button>
                            </div>
                        `;
            }
            return `
                        <div class="p-4 space-y-4">
                            ${AppState.tickets
                              .map((ticket) => {
                                const event = Utils.getEventById(
                                  ticket.eventId
                                );
                                return UI.Components.ticketCard(ticket, event);
                              })
                              .join("")}
                        </div>
                    `;
          },
          profile: () => {
            const user = AppState.currentUser;
            const prefs = AppState.userPreferences;
            const interestsOptions = [
              "Music",
              "Sports",
              "Cultural",
              "Workshop",
              "Conference",
              "Festival",
              "Tech",
              "Food",
            ]; // Sample interests
            return `
                        <div class="p-4">
                            <div class="flex items-center mb-6">
                                <img src="${
                                  user.photoUrl ||
                                  "https://placehold.co/80x80/cccccc/333333?text=P"
                                }" alt="Profile" class="w-20 h-20 rounded-full mr-4 object-cover">
                                <div>
                                    <h2 class="text-2xl font-semibold">${
                                      user.firstName
                                    } ${user.lastName}</h2>
                                    <p class="text-[var(--tg-theme-hint-color)]">@${
                                      user.username || "N/A"
                                    }</p>
                                </div>
                            </div>

                            <h3 class="text-lg font-semibold mb-2 mt-6">My Interests</h3>
                            <p class="text-sm text-[var(--tg-theme-hint-color)] mb-3">Select interests for personalized recommendations.</p>
                            <div class="flex flex-wrap gap-2 mb-6">
                                ${interestsOptions
                                  .map(
                                    (interest) => `
                                    <label class="flex items-center space-x-2 p-2 border border-[var(--tg-theme-hint-color)] rounded-md cursor-pointer hover:border-[var(--tg-theme-link-color)] transition-colors">
                                        <input type="checkbox" value="${interest}" class="form-checkbox h-4 w-4 text-[var(--tg-theme-button-color)] rounded" ${
                                      prefs.interests.includes(interest)
                                        ? "checked"
                                        : ""
                                    } data-interest>
                                        <span>${interest}</span>
                                    </label>
                                `
                                  )
                                  .join("")}
                            </div>

                            <h3 class="text-lg font-semibold mb-2 mt-6">Settings</h3>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between p-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg">
                                    <span>Enable Location for Nearby Events</span>
                                    <input type="checkbox" id="pref-location" class="form-switch h-5 w-9 rounded-full bg-gray-300 checked:bg-[var(--tg-theme-button-color)] transition-colors duration-200 ease-in-out focus:ring-0" ${
                                      prefs.locationEnabled ? "checked" : ""
                                    }>
                                </label>
                                <label class="flex items-center justify-between p-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg">
                                    <span>Receive Event Notifications</span>
                                    <input type="checkbox" id="pref-notifications" class="form-switch h-5 w-9 rounded-full bg-gray-300 checked:bg-[var(--tg-theme-button-color)] transition-colors duration-200 ease-in-out focus:ring-0" ${
                                      prefs.notifications ? "checked" : ""
                                    }>
                                </label>
                                <div class="p-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg">
                                    <label for="pref-language" class="block text-sm font-medium mb-1">Language</label>
                                    <select id="pref-language" class="tg-select">
                                        <option value="en" ${
                                          prefs.language === "en"
                                            ? "selected"
                                            : ""
                                        }>English</option>
                                        <option value="am" ${
                                          prefs.language === "am"
                                            ? "selected"
                                            : ""
                                        }>  (Amharic - UI Placeholder)</option>
                                    </select>
                                    <p class="text-xs text-[var(--tg-theme-hint-color)] mt-1">Note: Full Amharic UI support is illustrative.</p>
                                </div>
                            </div>
                            <p class="text-xs text-center text-[var(--tg-theme-hint-color)] mt-8">App Version: 1.0.0 (MVP)</p>
                        </div>
                    `;
          },
          organizerDashboard: () => {
            // Highly simplified for MVP
            // Assuming current user is an organizer for demo purposes
            const organizer = AppState.organizers[0]; // Take the first organizer
            if (!organizer)
              return `<p class="p-4">No organizer data available.</p>`;

            const myEvents = AppState.events.filter(
              (e) => e.organizerId === organizer.id
            );

            return `
                        <div class="p-4">
                            <div class="flex items-center mb-6">
                                <img src="${organizer.logoUrl}" alt="${
              organizer.name
            }" class="w-16 h-16 rounded-full mr-4 object-cover">
                                <div>
                                    <h2 class="text-xl font-semibold">${
                                      organizer.name
                                    }</h2>
                                    <p class="text-sm text-[var(--tg-theme-hint-color)]">Organizer View</p>
                                </div>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">My Events</h3>
                            ${
                              myEvents.length > 0
                                ? myEvents
                                    .map((event) => {
                                      const totalSold = event.priceTiers.reduce(
                                        (sum, tier) => sum + tier.sold,
                                        0
                                      );
                                      const totalRevenue =
                                        event.priceTiers.reduce(
                                          (sum, tier) =>
                                            sum + tier.sold * tier.price,
                                          0
                                        );
                                      return `
                                <div class="event-card p-3 mb-3 rounded-lg shadow">
                                    <h4 class="font-medium">${event.title}</h4>
                                    <p class="text-sm text-[var(--tg-theme-hint-color)]">Category: ${
                                      event.category
                                    }</p>
                                    <p class="text-sm">Tickets Sold: ${totalSold} / ${
                                        event.capacity
                                      }</p>
                                    <p class="text-sm">Est. Revenue: ${totalRevenue.toLocaleString()} ${
                                        event.priceTiers[0]?.currency || "ETB"
                                      }</p>
                                    <div class="mt-2">
                                        ${event.priceTiers
                                          .map(
                                            (tier) => `
                                            <div class="text-xs">
                                                ${tier.type}: ${
                                              tier.sold
                                            } sold (${(
                                              (tier.sold / tier.available) *
                                                100 || 0
                                            ).toFixed(1)}%)
                                            </div>
                                        `
                                          )
                                          .join("")}
                                    </div>
                                    <button class="text-xs tg-button mt-2 py-1 px-2 text-[var(--tg-theme-link-color)] bg-transparent border border-[var(--tg-theme-link-color)] hover:bg-[var(--tg-theme-link-color)] hover:text-white" onclick="alert('Manage Event (Not Implemented)')">Manage</button>
                                </div>
                                `;
                                    })
                                    .join("")
                                : "<p>You have no active events.</p>"
                            }
                            
                            <button class="tg-button w-full mt-6" onclick="alert('Create New Event (Not Implemented)')">Create New Event</button>
                            <p class="text-xs text-center text-[var(--tg-theme-hint-color)] mt-4">Full event management and analytics are planned for future updates.</p>
                        </div>
                    `;
          },
          ticketPurchase: (event) => {
            if (!event)
              return '<p class="p-4 text-red-500">Error: Event details for purchase are missing.</p>';

            // Update MainButton for this specific page
            tg.MainButton.setText("Confirm Purchase (Mock)");
            tg.MainButton.onClick(() => UI.handleConfirmPurchase(event.id));
            tg.MainButton.show();

            return `
                        <div class="p-4">
                            <h2 class="text-2xl font-bold mb-1">${
                              event.title
                            }</h2>
                            <p class="text-sm text-[var(--tg-theme-hint-color)] mb-4">${Utils.formatDate(
                              event.dateTime
                            )}</p>

                            <h3 class="text-lg font-semibold mb-2">Select Ticket Type</h3>
                            <div id="ticket-type-selection" class="space-y-3 mb-4">
                                ${event.priceTiers
                                  .map(
                                    (tier, index) => `
                                    <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:border-[var(--tg-theme-button-color)] transition-all ${
                                      index === 0
                                        ? "border-[var(--tg-theme-button-color)] bg-[var(--tg-theme-button-color)] bg-opacity-10"
                                        : "border-[var(--tg-theme-hint-color)]"
                                    }">
                                        <div>
                                            <span class="font-medium">${
                                              tier.type
                                            }</span>
                                            <span class="text-xs block text-[var(--tg-theme-hint-color)]">${
                                              tier.available - tier.sold
                                            } remaining</span>
                                        </div>
                                        <div class="text-right">
                                            <span class="font-semibold text-lg">${
                                              tier.price
                                            } ${tier.currency}</span>
                                            <input type="radio" name="ticketTier" value="${
                                              tier.type
                                            }" class="form-radio ml-3 h-5 w-5 text-[var(--tg-theme-button-color)]" ${
                                      index === 0 ? "checked" : ""
                                    } data-price="${tier.price}">
                                        </div>
                                    </label>
                                `
                                  )
                                  .join("")}
                            </div>

                            <div class="mb-4">
                                <label for="ticket-quantity" class="block text-sm font-medium mb-1">Quantity</label>
                                <select id="ticket-quantity" class="tg-select">
                                    ${[1, 2, 3, 4, 5]
                                      .map(
                                        (q) =>
                                          `<option value="${q}">${q}</option>`
                                      )
                                      .join("")}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="promo-code" class="block text-sm font-medium mb-1">Promotional Code (Optional)</label>
                                <div class="flex">
                                    <input type="text" id="promo-code" placeholder="e.g., TECHSAVE20" class="tg-input rounded-r-none">
                                    <button id="apply-promo-btn" class="tg-button rounded-l-none px-4">Apply</button>
                                </div>
                                <p id="promo-status" class="text-xs mt-1"></p>
                            </div>

                            <div class="mt-6 pt-4 border-t border-[var(--tg-theme-hint-color)]">
                                <h3 class="text-lg font-semibold mb-2">Order Summary</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>Subtotal:</span> <span id="summary-subtotal">0 ETB</span></div>
                                    <div class="flex justify-between"><span>Discount:</span> <span id="summary-discount" class="text-green-600">0 ETB</span></div>
                                    <div class="flex justify-between font-bold text-base"><span>Total:</span> <span id="summary-total">0 ETB</span></div>
                                </div>
                            </div>
                            
                            <p class="text-xs text-center text-[var(--tg-theme-hint-color)] mt-6">
                                This is a mock purchase. No real payment will be processed.
                                In a real app, this would integrate with Telebirr, CBE Birr, etc.
                            </p>
                        </div>
                    `;
          },
        },

        Components: {
          eventCard: (event) => {
            const totalSold = event.priceTiers.reduce(
              (sum, tier) => sum + tier.sold,
              0
            );
            const availabilityPercentage =
              ((event.capacity - totalSold) / event.capacity) * 100;
            let availabilityText = "";
            if (availabilityPercentage <= 0) availabilityText = "Sold Out";
            else if (availabilityPercentage < 20)
              availabilityText = "Few Tickets Left!";

            return `
                        <div class="event-card mb-4 rounded-xl shadow-lg overflow-hidden cursor-pointer transition-all duration-300 ease-in-out hover:shadow-xl" data-event-id="${
                          event.id
                        }">
                            <img src="${event.posterImageUrl}" alt="${
              event.title
            }" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=Event+Image';">
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="text-lg font-semibold leading-tight">${Utils.truncateText(
                                      event.title,
                                      50
                                    )}</h3>
                                    <span class="text-xs bg-[var(--tg-theme-button-color)] bg-opacity-20 text-[var(--tg-theme-button-color)] px-2 py-1 rounded-full whitespace-nowrap">${
                                      event.category
                                    }</span>
                                </div>
                                <p class="text-xs text-[var(--tg-theme-hint-color)] mb-2 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 0 1 .75.75V3h6.5V2.5a.75.75 0 0 1 1.5 0V3H13a1 1 0 0 1 1 1v2.5H2V4a1 1 0 0 1 1-1h.25V2.5A.75.75 0 0 1 4 1.75ZM2 8.25v5a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-5H2Z" clip-rule="evenodd" /></svg>
                                    ${
                                      Utils.formatDate(event.dateTime).split(
                                        ","
                                      )[0]
                                    }, ${
              Utils.formatDate(event.dateTime).split(",")[2]
            }
                                </p>
                                <p class="text-xs text-[var(--tg-theme-hint-color)] mb-3 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M7.503 13.99A5.33 5.33 0 0 1 4.06 8.654a.75.75 0 0 0-1.06-1.061 6.83 6.83 0 0 0 8.998 9.214.75.75 0 0 0 .226-1.042A5.33 5.33 0 0 1 7.503 14Zm1.06-5.336a.75.75 0 0 0-1.061-1.06A5.33 5.33 0 0 1 11.94 2a.75.75 0 0 0 1.042-.226A6.83 6.83 0 0 0 3.768 1.006a.75.75 0 0 0-.226 1.042A5.33 5.33 0 0 1 8.564 8.653Z" clip-rule="evenodd" /><path d="M8.001.5a7.5 7.5 0 1 0 0 15 7.5 7.5 0 0 0 0-15ZM1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0Z" /></svg>
                                    ${event.venue.name}
                                </p>
                                <div class="flex justify-between items-center">
                                    <span class="text-md font-bold text-[var(--tg-theme-link-color)]">${
                                      event.priceTiers[0].price
                                    } ${event.priceTiers[0].currency}</span>
                                    ${
                                      availabilityText
                                        ? `<span class="text-xs font-medium ${
                                            availabilityPercentage <= 0
                                              ? "text-red-500"
                                              : "text-orange-500"
                                          }">${availabilityText}</span>`
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    `;
          },
          ticketCard: (ticket, event) => {
            if (!event) {
              return `
                        <div class="event-card p-4 rounded-lg shadow-md text-red-500">
                            Error: Event data for ticket ID ${ticket.ticketId} is missing.
                        </div>`;
            }
            return `
                        <div class="event-card p-4 rounded-lg shadow-md" data-ticket-id="${
                          ticket.ticketId
                        }">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-lg font-semibold">${
                                      event.title
                                    }</h4>
                                    <p class="text-sm text-[var(--tg-theme-hint-color)]">${
                                      ticket.tierType
                                    }</p>
                                    <p class="text-xs text-[var(--tg-theme-hint-color)]">Purchased: ${Utils.formatDate(
                                      ticket.purchaseDate
                                    )}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${
                                  ticket.status === "valid"
                                    ? "bg-green-100 text-green-700"
                                    : "bg-gray-100 text-gray-700"
                                }">${ticket.status}</span>
                            </div>
                            <div class="mt-3 pt-3 border-t border-[var(--tg-theme-hint-color)]">
                                <p class="text-xs mb-1">Event Date: ${Utils.formatDate(
                                  event.dateTime
                                )}</p>
                                <p class="text-xs mb-2">Venue: ${
                                  event.venue.name
                                }</p>
                                <button class="view-qr-code-btn tg-button w-full text-sm py-2">View QR Code</button>
                            </div>
                        </div>
                    `;
          },
          bottomNavItem: (id, label, iconSvg, isActive) => `
                    <button data-page="${id}" class="bottom-nav-item flex-1 flex flex-col items-center justify-center p-2 ${
            isActive ? "active" : ""
          } transition-colors">
                        ${iconSvg}
                        <span class="text-xs mt-1">${label}</span>
                    </button>
                `,
        },

        renderBottomNav: () => {
          const navItems = [
            {
              id: "discover",
              label: "Discover",
              icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            },
            {
              id: "myTickets",
              label: "My Tickets",
              icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" /></svg>',
            },
            {
              id: "organizerDashboard",
              label: "Organize",
              icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3m-16.5 0h16.5M3.75 0h16.5M3.75 3.75h16.5M3.75 7.5h16.5M3.75 11.25h16.5M3.75 15h16.5M3.75 18.75h16.5" /></svg>',
            }, // Simplified
            {
              id: "profile",
              label: "Profile",
              icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>',
            },
          ];
          bottomNavEl.innerHTML = navItems
            .map((item) =>
              UI.Components.bottomNavItem(
                item.id,
                item.label,
                item.icon,
                AppState.currentPage === item.id
              )
            )
            .join("");
          bottomNavEl.querySelectorAll(".bottom-nav-item").forEach((btn) => {
            btn.addEventListener("click", () => {
              tg.HapticFeedback.impactOccurred("light");
              Navigation.navigateTo(btn.dataset.page);
            });
          });
        },

        attachPageEventListeners: (pageId, params) => {
          if (pageId === "discover") {
            document
              .getElementById("search-input")
              ?.addEventListener("input", UI.handleFilterChange);
            document
              .getElementById("filter-category")
              ?.addEventListener("change", UI.handleFilterChange);
            document
              .getElementById("filter-date")
              ?.addEventListener("change", UI.handleFilterChange);
            document
              .querySelectorAll(".event-card[data-event-id]")
              .forEach((card) => {
                card.addEventListener("click", () =>
                  Navigation.navigateTo("eventDetail", {
                    eventId: card.dataset.eventId,
                  })
                );
              });
            document
              .getElementById("locate-me-btn")
              ?.addEventListener("click", UI.handleLocateMe);
          }
          if (pageId === "eventDetail" && params.eventId) {
            const event = Utils.getEventById(params.eventId);
            if (event) {
              document
                .getElementById("share-event-btn")
                ?.addEventListener("click", () =>
                  TelegramService.shareEvent(event)
                );
            }
          }
          if (pageId === "myTickets") {
            document.querySelectorAll(".view-qr-code-btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const ticketId = e.target.closest(".event-card[data-ticket-id]")
                  .dataset.ticketId;
                UI.handleViewQRCode(ticketId);
              });
            });
          }
          if (pageId === "profile") {
            // Event listeners for preference changes will be handled by handleSavePreferences
          }
          if (pageId === "ticketPurchase" && params.eventId) {
            UI.updatePurchaseSummary(params.eventId); // Initial summary
            document
              .querySelectorAll('input[name="ticketTier"], #ticket-quantity')
              .forEach((el) => {
                el.addEventListener("change", () =>
                  UI.updatePurchaseSummary(params.eventId)
                );
              });
            document
              .getElementById("apply-promo-btn")
              ?.addEventListener("click", () =>
                UI.applyPromoCode(params.eventId)
              );

            // Highlight selected ticket tier
            document
              .querySelectorAll('input[name="ticketTier"]')
              .forEach((radio) => {
                radio.addEventListener("change", (e) => {
                  document
                    .querySelectorAll('input[name="ticketTier"]')
                    .forEach((r) => {
                      r.closest("label").classList.remove(
                        "border-[var(--tg-theme-button-color)]",
                        "bg-[var(--tg-theme-button-color)]",
                        "bg-opacity-10"
                      );
                      r.closest("label").classList.add(
                        "border-[var(--tg-theme-hint-color)]"
                      );
                    });
                  if (e.target.checked) {
                    e.target
                      .closest("label")
                      .classList.add(
                        "border-[var(--tg-theme-button-color)]",
                        "bg-[var(--tg-theme-button-color)]",
                        "bg-opacity-10"
                      );
                    e.target
                      .closest("label")
                      .classList.remove("border-[var(--tg-theme-hint-color)]");
                  }
                });
              });
          }
        },

        handleFilterChange: () => {
          AppState.filters.searchTerm =
            document.getElementById("search-input")?.value || "";
          AppState.filters.category =
            document.getElementById("filter-category")?.value || "all";
          AppState.filters.date =
            document.getElementById("filter-date")?.value || "";
          UI.renderPage("discover"); // Re-render with new filters
          tg.HapticFeedback.selectionChanged();
        },
        handleGetTickets: (event) => {
          if (!event) return;
          tg.HapticFeedback.impactOccurred("medium");
          Navigation.navigateTo("ticketPurchase", { eventId: event.id });
        },
        updatePurchaseSummary: (eventId, discountPercentage = 0) => {
          const event = Utils.getEventById(eventId);
          if (!event) return;

          const selectedTierType = document.querySelector(
            'input[name="ticketTier"]:checked'
          )?.value;
          const quantity = parseInt(
            document.getElementById("ticket-quantity")?.value || "1"
          );

          const tier = event.priceTiers.find(
            (t) => t.type === selectedTierType
          );
          if (!tier) {
            document.getElementById("summary-subtotal").textContent = "N/A";
            document.getElementById("summary-discount").textContent = "0 ETB";
            document.getElementById("summary-total").textContent = "N/A";
            return;
          }

          const subtotal = tier.price * quantity;
          const discountAmount = subtotal * (discountPercentage / 100);
          const total = subtotal - discountAmount;

          document.getElementById(
            "summary-subtotal"
          ).textContent = `${subtotal.toLocaleString()} ETB`;
          document.getElementById(
            "summary-discount"
          ).textContent = `-${discountAmount.toLocaleString()} ETB`;
          document.getElementById(
            "summary-total"
          ).textContent = `${total.toLocaleString()} ETB`;
        },
        applyPromoCode: (eventId) => {
          const promoCodeInput = document.getElementById("promo-code");
          const promoStatusEl = document.getElementById("promo-status");
          const code = promoCodeInput.value.trim().toUpperCase();

          const promotion = SampleData.promotions.find(
            (p) => p.code === code && p.eventId === eventId && p.isActive
          );

          if (promotion) {
            UI.updatePurchaseSummary(eventId, promotion.discountPercentage);
            promoStatusEl.textContent = `"${promotion.code}" applied! ${promotion.discountPercentage}% off.`;
            promoStatusEl.className = "text-xs mt-1 text-green-600";
            tg.HapticFeedback.notificationOccurred("success");
          } else {
            UI.updatePurchaseSummary(eventId, 0); // Reset discount
            promoStatusEl.textContent = "Invalid or expired promo code.";
            promoStatusEl.className = "text-xs mt-1 text-red-500";
            tg.HapticFeedback.notificationOccurred("error");
          }
        },
        handleConfirmPurchase: (eventId) => {
          Utils.showLoading(true);
          tg.HapticFeedback.impactOccurred("heavy");

          const event = Utils.getEventById(eventId);
          const selectedTierType = document.querySelector(
            'input[name="ticketTier"]:checked'
          )?.value;
          const quantity = parseInt(
            document.getElementById("ticket-quantity")?.value || "1"
          );
          const tier = event.priceTiers.find(
            (t) => t.type === selectedTierType
          );

          if (!event || !tier) {
            Utils.showModal(
              "Purchase Error",
              "Could not find event or ticket type. Please try again."
            );
            Utils.showLoading(false);
            return;
          }

          // Simulate payment processing delay
          setTimeout(() => {
            // Create mock tickets
            for (let i = 0; i < quantity; i++) {
              const newTicket = {
                ticketId: `TKT-${Utils.generateGUID().substring(0, 8)}`,
                eventId: event.id,
                userId: AppState.currentUser.id,
                tierType: tier.type,
                purchaseDate: new Date().toISOString(),
                qrCodeData: `EVENT:${event.id};USER:${
                  AppState.currentUser.id
                };TIER:${tier.type};TID:${Utils.generateGUID().substring(
                  0,
                  4
                )}`, // Simple QR data
                status: "valid",
              };
              AppState.tickets.push(newTicket);
            }

            // Update event sales data (mock)
            tier.sold += quantity;

            Utils.showLoading(false);
            tg.HapticFeedback.notificationOccurred("success");
            Utils.showModal(
              "Purchase Successful!",
              `You've successfully acquired ${quantity} x ${tier.type} ticket(s) for "${event.title}". Your tickets are now in 'My Tickets'.`,
              [
                {
                  text: "View My Tickets",
                  action: () => Navigation.navigateTo("myTickets"),
                },
                { text: "OK" },
              ]
            );
            // Potentially save AppState.tickets and AppState.events to localStorage here
            Data.saveState();
          }, 1500);
        },
        handleViewQRCode: (ticketId) => {
          const ticket = Utils.getTicketById(ticketId);
          const event = Utils.getEventById(ticket.eventId);
          if (!ticket || !event) {
            Utils.showModal("Error", "Ticket or event details not found.");
            return;
          }
          tg.HapticFeedback.impactOccurred("light");
          // In a real app, generate a proper QR code image. Here, we'll show the data.
          // For a visual QR, you could use a library like qrcode.js and render to a canvas.
          // Example: <canvas id="qr-canvas"></canvas> then new QRCode(document.getElementById("qr-canvas"), ticket.qrCodeData);
          const qrContent = `
                    <div class="text-center">
                        <p class="font-semibold text-lg mb-2">${event.title}</p>
                        <p class="text-sm">${ticket.tierType}</p>
                        <div class="my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md break-all">
                            <p class="text-xs font-mono">${
                              ticket.qrCodeData
                            }</p>
                        </div>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(
                          ticket.qrCodeData
                        )}" alt="QR Code" class="mx-auto rounded-md border border-[var(--tg-theme-hint-color)]" onerror="this.alt='QR Code Placeholder'; this.src='https://placehold.co/150x150/eee/333?text=QR+Code'">
                        <p class="text-xs text-[var(--tg-theme-hint-color)] mt-3">Show this QR code at the event entrance.</p>
                    </div>
                `;
          Utils.showModal("Your Ticket QR Code", qrContent);
        },
        handleSavePreferences: () => {
          Utils.showLoading(true);
          tg.HapticFeedback.impactOccurred("medium");

          const selectedInterests = [];
          document
            .querySelectorAll("input[data-interest]:checked")
            .forEach((cb) => selectedInterests.push(cb.value));

          AppState.userPreferences = {
            interests: selectedInterests,
            locationEnabled: document.getElementById("pref-location").checked,
            notifications:
              document.getElementById("pref-notifications").checked,
            language: document.getElementById("pref-language").value,
          };

          Data.saveUserPreferences(); // Save to localStorage

          setTimeout(() => {
            Utils.showLoading(false);
            tg.HapticFeedback.notificationOccurred("success");
            Utils.showModal(
              "Preferences Saved",
              "Your settings have been updated."
            );
            // Potentially re-filter discover page if interests changed significantly
          }, 500);
        },
        handleLocateMe: () => {
          Utils.showLoading(true);
          const geoInfoEl = document.getElementById("geolocation-info");
          geoInfoEl.textContent = "Attempting to get your location...";
          geoInfoEl.className =
            "text-sm text-[var(--tg-theme-hint-color)] mb-3 block";

          TelegramService.requestLocation((response) => {
            Utils.showLoading(false);
            if (response.success) {
              geoInfoEl.textContent = `Location acquired: Lat ${response.coords.latitude.toFixed(
                2
              )}, Lon ${response.coords.longitude.toFixed(
                2
              )}. Filtering events... (mocked)`;
              geoInfoEl.className = "text-sm text-green-600 mb-3 block";
              // TODO: Implement actual location-based filtering or sorting of AppState.events
              // For now, it's just a message.
              // Example: sort AppState.events by distance to response.coords
              // Then re-render: UI.renderPage('discover');
              Utils.showModal(
                "Location Found",
                "Nearby event filtering is a planned feature. For now, your location has been noted (mocked)."
              );
            } else {
              geoInfoEl.textContent = `Could not get location: ${response.error}. Showing all events.`;
              geoInfoEl.className = "text-sm text-red-500 mb-3 block";
            }
          });
        },
      };

      // --- NAVIGATION ---
      const Navigation = {
        init: () => {
          UI.renderBottomNav();
          // Initial page load
          const initialPage =
            AppState.historyStack[AppState.historyStack.length - 1] ||
            "discover";
          Navigation.navigateTo(initialPage, {}, true); // true to replace history

          backButtonEl.addEventListener("click", Navigation.handleBack);
        },
        navigateTo: (pageId, params = {}, replace = false) => {
          if (
            AppState.currentPage === pageId &&
            JSON.stringify(params) === JSON.stringify(AppState.currentParams) &&
            !replace
          )
            return;

          AppState.currentPage = pageId;
          AppState.currentParams = params; // Store params for current page

          if (replace) {
            AppState.historyStack = [pageId];
          } else {
            // Avoid pushing same page consecutively if params are the same
            if (
              AppState.historyStack[AppState.historyStack.length - 1] !==
                pageId ||
              JSON.stringify(params) !==
                JSON.stringify(
                  AppState.historyStackParams[
                    AppState.historyStackParams.length - 1
                  ]
                )
            ) {
              AppState.historyStack.push(pageId);
              AppState.historyStackParams = AppState.historyStackParams || [];
              AppState.historyStackParams.push(params);
            }
          }

          UI.renderPage(pageId, params);
          UI.renderBottomNav(); // Update active state

          // Manage Telegram BackButton visibility
          if (AppState.historyStack.length > 1) {
            tg.BackButton.show();
            backButtonEl.classList.remove("hidden");
          } else {
            tg.BackButton.hide();
            backButtonEl.classList.add("hidden");
          }
        },
        handleBack: () => {
          tg.HapticFeedback.impactOccurred("light");
          if (AppState.historyStack.length > 1) {
            AppState.historyStack.pop();
            AppState.historyStackParams = AppState.historyStackParams || [];
            const previousParams = AppState.historyStackParams.pop() || {};
            const previousPage =
              AppState.historyStack[AppState.historyStack.length - 1];
            Navigation.navigateTo(previousPage, previousParams, true); // true to replace/not add to history again
          }
        },
      };

      // --- DATA MANAGEMENT (Client-Side JSON) ---
      const Data = {
        init: () => {
          // Load from localStorage if available
          const savedState = localStorage.getItem("addisEventsAppState");
          if (savedState) {
            try {
              const parsedState = JSON.parse(savedState);
              // Carefully merge, don't overwrite functions or initial structure
              AppState.events = parsedState.events || SampleData.events;
              AppState.organizers =
                parsedState.organizers || SampleData.organizers;
              AppState.tickets = parsedState.tickets || SampleData.userTickets; // Ensure this is user-specific
              AppState.userPreferences = {
                ...AppState.userPreferences,
                ...(parsedState.userPreferences || {}),
              };
            } catch (e) {
              console.error("Failed to parse saved state:", e);
              Data.loadSampleData(); // Fallback to sample data
            }
          } else {
            Data.loadSampleData();
          }
          // Ensure current user data is not overwritten by generic stored state if TG provides it
          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            // AppState.currentUser is already set by TelegramService.init
          }
        },
        loadSampleData: () => {
          AppState.events = JSON.parse(JSON.stringify(SampleData.events)); // Deep copy
          AppState.organizers = JSON.parse(
            JSON.stringify(SampleData.organizers)
          );
          AppState.tickets = JSON.parse(JSON.stringify(SampleData.userTickets));
          // User preferences might be loaded from a separate user-specific storage
        },
        saveState: () => {
          // Saves tickets and event modifications (like sales count)
          try {
            const stateToSave = {
              events: AppState.events, // This includes updated sales counts
              tickets: AppState.tickets, // User's purchased tickets
              // Do NOT save full AppState, only persistable parts
            };
            localStorage.setItem(
              "addisEventsAppState",
              JSON.stringify(stateToSave)
            );
          } catch (e) {
            console.error("Error saving state to localStorage:", e);
            Utils.showModal(
              "Storage Error",
              "Could not save your data. Local storage might be full or disabled."
            );
          }
        },
        saveUserPreferences: () => {
          try {
            const prefsToSave = { userPreferences: AppState.userPreferences };
            // Merge with existing state to not lose event/ticket data
            const existingState = JSON.parse(
              localStorage.getItem("addisEventsAppState") || "{}"
            );
            localStorage.setItem(
              "addisEventsAppState",
              JSON.stringify({ ...existingState, ...prefsToSave })
            );
          } catch (e) {
            console.error("Error saving user preferences:", e);
          }
        },
        // CRUD operations (examples, would be more complex with a backend)
        createEvent: (eventData) => {
          // For organizer - Not fully implemented in UI
          const newEvent = {
            ...eventData,
            id: `evt-${Utils.generateGUID()}`,
            status: "draft",
          };
          AppState.events.push(newEvent);
          Data.saveState();
          return newEvent;
        },
        updateEvent: (eventId, updatedData) => {
          // For organizer
          const eventIndex = AppState.events.findIndex((e) => e.id === eventId);
          if (eventIndex > -1) {
            AppState.events[eventIndex] = {
              ...AppState.events[eventIndex],
              ...updatedData,
            };
            Data.saveState();
            return AppState.events[eventIndex];
          }
          return null;
        },
        // getEvents, getEventById are already in Utils or implicitly used
      };

      // --- APP INITIALIZATION ---
       function initializeApp() {
        TelegramService.init(); // Initialize Telegram SDK integrations first
        Data.init(); // Load data (sample or localStorage)
        Navigation.init(); // Setup navigation and render initial page

        // Set initial theme based on Telegram settings
        TelegramService.applyTheme();

        console.log("Addis Events Mini App Initialized");
        console.log("Current User:", AppState.currentUser);
        console.log("Theme Params:", tg.themeParams);
        tg.HapticFeedback.notificationOccurred("success"); // App ready signal
      }

      // Wait for the DOM to be fully loaded before initializing
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
