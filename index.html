<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Direct Democracy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Tailwind configuration
        tailwind.config = {
            darkMode: 'class', // or 'media' if you prefer OS setting
            theme: {
                extend: {
                    colors: {
                        tg: {
                            bg: 'var(--tg-theme-bg-color, #ffffff)',
                            text: 'var(--tg-theme-text-color, #000000)',
                            hint: 'var(--tg-theme-hint-color, #999999)',
                            link: 'var(--tg-theme-link-color, #5D5CDE)',
                            button: 'var(--tg-theme-button-color, #5D5CDE)',
                            buttonText: 'var(--tg-theme-button-text-color, #ffffff)',
                            secondary: 'var(--tg-theme-secondary-bg-color, #f0f0f0)',
                        }
                    },
                    fontFamily: {
                        sans: ['"Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'],
                    }
                }
            }
        };
    </script>
    <style type="text/css">
        :root {
            --default-bg-color: #ffffff;
            --default-text-color: #000000;
            --default-hint-color: #999999;
            --default-link-color: #5D5CDE;
            --default-button-color: #5D5CDE;
            --default-button-text-color: #ffffff;
            --default-secondary-bg-color: #f0f0f0;
        }
        
        .dark {
            --default-bg-color: #212121;
            --default-text-color: #ffffff;
            --default-hint-color: #aaaaaa;
            --default-link-color: #8E8DFF;
            --default-button-color: #8E8DFF;
            --default-button-text-color: #ffffff;
            --default-secondary-bg-color: #303030;
        }
        
        body {
            background-color: var(--tg-theme-bg-color, var(--default-bg-color));
            color: var(--tg-theme-text-color, var(--default-text-color));
            min-height: 100vh;
            overflow-x: hidden;
        }

        .message-bubble {
            position: relative;
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 85%;
            margin-bottom: 8px;
            word-wrap: break-word; /* Ensure long words break */
        }
        
        .message-bubble.outgoing {
            background-color: var(--tg-theme-button-color, var(--default-button-color));
            color: var(--tg-theme-button-text-color, var(--default-button-text-color));
            margin-left: auto;
            border-bottom-right-radius: 4px; /* Adjusted for a more common bubble tail */
        }
        
        .message-bubble.incoming {
            background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));
            margin-right: auto;
            border-bottom-left-radius: 4px; /* Adjusted for a more common bubble tail */
        }

        /* Simple tail using border, adjust if a more complex SVG/CSS tail is needed */
        .message-bubble.outgoing::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: -7px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 0 8px; /* Triangle pointing left-up */
            border-color: transparent transparent transparent var(--tg-theme-button-color, var(--default-button-color));
        }

        .message-bubble.incoming::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -7px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 8px 0; /* Triangle pointing right-up */
            border-color: transparent var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)) transparent transparent;
        }


        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-hint-color, var(--default-hint-color));
            border-radius: 5px;
        }

        @keyframes vote-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); } /* Reduced pulse intensity */
            100% { transform: scale(1); }
        }
        
        .vote-animate {
            animation: vote-pulse 0.3s ease;
        }

        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255,255,255,0.5) 10%, transparent 10.01%); /* Softer ripple */
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active::after {
            transform: scale(0, 0);
            opacity: .3;
            transition: 0s;
        }
        .tab-button.active {
             border-bottom-width: 2px;
             border-bottom-style: solid;
        }
    </style>
</head>
<body class="font-sans">
    <div id="app" class="flex flex-col h-screen max-h-screen">
        <header class="sticky top-0 z-10 shadow-sm" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color))">
            <div class="flex items-center justify-between p-3 border-b" style="border-color: var(--tg-theme-hint-color, var(--default-hint-color)); border-opacity: 0.2;">
                <div class="flex items-center">
                    <button id="back-button" class="mr-3 text-lg font-bold hidden" style="color: var(--tg-theme-link-color, var(--default-link-color));">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                    <h1 class="text-lg font-bold" id="header-title">Digital Democracy</h1>
                </div>
                <div>
                    <button id="menu-button" class="text-lg" style="color: var(--tg-theme-link-color, var(--default-link-color));">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="tab-navigation" class="flex border-b overflow-x-auto" style="border-color: var(--tg-theme-hint-color, var(--default-hint-color)); border-opacity: 0.2;">
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap active" data-view="proposals">
                    Proposals
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="active-votes">
                    Active Votes
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="passed">
                    Passed
                </button>
                <button class="tab-button px-4 py-2 font-medium whitespace-nowrap" data-view="my-activities">
                    My Activities
                </button>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto" id="main-content">
            <div id="proposals-view" class="view-content">
                <div class="p-4">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-bold">Active Proposals</h2>
                            <button id="new-proposal-btn" class="ripple px-3 py-1 rounded-full text-sm" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                + New Proposal
                            </button>
                        </div>
                        <p class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            Proposals require 100 supporters to advance to voting
                        </p>
                    </div>
                    <div class="proposal-list space-y-3">
                        </div>
                </div>
            </div>

            <div id="active-votes-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Active Votes</h2>
                    <div class="active-votes-list space-y-3">
                        </div>
                </div>
            </div>

            <div id="passed-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Passed Legislation</h2>
                    <div class="passed-list space-y-3">
                        </div>
                </div>
            </div>

            <div id="my-activities-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">My Activities</h2>
                    <div class="activities-list space-y-3">
                        </div>
                </div>
            </div>

            <div id="proposal-detail-view" class="view-content hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h2 id="proposal-detail-title" class="text-xl font-bold mb-1"></h2>
                        <p id="proposal-detail-author" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                        <p id="proposal-detail-category" class="text-xs mt-1 p-1 inline-block rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));"></p>
                    </div>
                    
                    <div id="proposal-detail-content" class="mb-4 text-sm prose max-w-none" style="color: var(--tg-theme-text-color, var(--default-text-color));"></div>
                    
                    <div class="support-section mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span id="proposal-detail-support-count" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></span>
                            <button id="proposal-detail-support-button" class="ripple px-4 py-2 rounded-full text-sm" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                Support
                            </button>
                        </div>
                        <div class="w-full h-2 rounded-full overflow-hidden" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                            <div id="proposal-detail-support-bar" class="h-full transition-all duration-500 ease-out" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); width: 0%;"></div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold mb-2 mt-6">Discussion</h3>
                    <div id="proposal-detail-discussion-list" class="mb-4 space-y-3 max-h-60 overflow-y-auto">
                        </div>
                    
                    <div class="flex items-center gap-2 sticky bottom-0 py-2" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                        <input type="text" id="proposal-detail-discussion-input" placeholder="Add to the discussion..." class="flex-grow p-2 rounded-full text-base border" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color)); border-color: var(--tg-theme-hint-color, var(--default-hint-color));">
                        <button id="proposal-detail-send-discussion" class="ripple p-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="vote-detail-view" class="view-content hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h2 id="vote-detail-title" class="text-xl font-bold mb-1"></h2>
                         <p id="vote-detail-category" class="text-xs mb-1 p-1 inline-block rounded" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));"></p>
                        <p id="vote-detail-status" class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                    </div>
                    
                    <div id="vote-detail-content" class="mb-4 text-sm prose max-w-none" style="color: var(--tg-theme-text-color, var(--default-text-color));"></div>
                    
                    <div class="voting-section mb-4">
                        <h3 class="font-bold mb-2">Cast Your Vote</h3>
                        <div class="flex gap-3 mb-4">
                            <button data-vote-type="yes" class="vote-button ripple flex-1 py-2 rounded-full text-sm font-medium" style="background-color: #4CAF50; color: white;">Yes</button>
                            <button data-vote-type="no" class="vote-button ripple flex-1 py-2 rounded-full text-sm font-medium" style="background-color: #F44336; color: white;">No</button>
                            <button data-vote-type="abstain" class="vote-button ripple flex-1 py-2 rounded-full text-sm font-medium" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">Abstain</button>
                        </div>
                        
                        <div class="results-section">
                            <div class="flex justify-between mb-1 text-sm">
                                <span>Yes</span>
                                <span id="vote-detail-yes-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="vote-detail-yes-bar" class="h-full transition-all duration-500 ease-out" style="background-color: #4CAF50; width: 0%;"></div>
                            </div>
                            
                            <div class="flex justify-between mb-1 text-sm">
                                <span>No</span>
                                <span id="vote-detail-no-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="vote-detail-no-bar" class="h-full transition-all duration-500 ease-out" style="background-color: #F44336; width: 0%;"></div>
                            </div>
                            
                            <div class="flex justify-between mb-1 text-sm">
                                <span>Abstain</span>
                                <span id="vote-detail-abstain-percentage">0%</span>
                            </div>
                            <div class="w-full h-2 rounded-full overflow-hidden mb-2" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                                <div id="vote-detail-abstain-bar" class="h-full transition-all duration-500 ease-out" style="background-color: #9E9E9E; width: 0%;"></div>
                            </div>
                            
                            <p id="vote-detail-time-remaining" class="text-sm mt-2" style="color: var(--tg-theme-hint-color, var(--default-hint-color));"></p>
                        </div>
                    </div>
                    
                    <div class="discussion-section">
                        <h3 class="font-bold mb-2 mt-6">Discussion</h3>
                        <div id="vote-detail-discussion-list" class="mb-4 space-y-3 max-h-60 overflow-y-auto">
                            </div>
                        
                        <div class="flex items-center gap-2 sticky bottom-0 py-2" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                            <input type="text" id="vote-detail-discussion-input" placeholder="Add to the discussion..." class="flex-grow p-2 rounded-full text-base border" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color)); border-color: var(--tg-theme-hint-color, var(--default-hint-color));">
                            <button id="vote-detail-send-discussion" class="ripple p-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="new-proposal-view" class="view-content hidden">
                <div class="p-4">
                    <h2 class="text-lg font-bold mb-4">Create New Proposal</h2>
                    
                    <form id="proposal-form" class="space-y-4">
                        <div>
                            <label for="proposal-title-input" class="block mb-1 font-medium text-sm">Title</label>
                            <input type="text" id="proposal-title-input" class="w-full p-2 rounded text-base border" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color)); border-color: var(--tg-theme-hint-color, var(--default-hint-color));" placeholder="Enter a clear, concise title" required>
                        </div>
                        
                        <div>
                            <label for="proposal-content-input" class="block mb-1 font-medium text-sm">Content</label>
                            <textarea id="proposal-content-input" rows="8" class="w-full p-2 rounded text-base border" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color)); border-color: var(--tg-theme-hint-color, var(--default-hint-color));" placeholder="Describe your proposal in detail..." required></textarea>
                        </div>
                        
                        <div>
                            <label for="proposal-category-input" class="block mb-1 font-medium text-sm">Category</label>
                            <select id="proposal-category-input" class="w-full p-2 rounded text-base border" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color)); border-color: var(--tg-theme-hint-color, var(--default-hint-color));">
                                <option value="environment">Environment</option>
                                <option value="economy">Economy</option>
                                <option value="education">Education</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 pt-3">
                            <button type="button" id="cancel-proposal-btn" class="ripple flex-1 py-2 rounded-full" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color)); color: var(--tg-theme-text-color, var(--default-text-color));">Cancel</button>
                            <button type="submit" id="submit-proposal-btn" class="ripple flex-1 py-2 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color));">Submit Proposal</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram?.WebApp;
        let currentUser = {};
        let currentView = 'proposals'; // To track the current main list view
        let previousView = 'proposals'; // To track the view before detail view
        let currentDetailId = null; // To track the ID of the item in detail view

        // Sample data (to be replaced by actual data fetching in a real app)
        const mockData = {
            proposals: [
                {
                    id: 1,
                    title: "Urban Green Space Expansion",
                    author: "EcoAdvocate",
                    authorId: "eco123",
                    content: "Proposal to mandate that 15% of all new urban development must be dedicated to public green spaces, including parks, community gardens, and natural conservation areas. This will improve air quality, provide recreational opportunities, and support local ecosystems.",
                    supporters: 78,
                    requiredSupporters: 100,
                    category: "environment",
                    timestamp: new Date(Date.now() - 86400000 * 3).toISOString(), // 3 days ago
                    discussion: [
                        { id: 1, author: "UrbanPlanner", authorId: "urban456", content: "This proposal would significantly improve quality of life in urban areas while promoting biodiversity.", timestamp: new Date(Date.now() - 86400000 * 2).toISOString() },
                        { id: 2, author: "DevelopmentPro", authorId: "dev789", content: "While I support the goal, 15% may be excessive in dense urban areas. Perhaps we could consider a sliding scale based on population density?", timestamp: new Date(Date.now() - 86400000 * 1).toISOString() }
                    ],
                    supportedBy: [] // Array of user IDs who supported
                },
                {
                    id: 2,
                    title: "Digital Education Fund",
                    author: "TechEdu",
                    authorId: "tech456",
                    content: "Establish a dedicated fund to provide digital devices (laptops/tablets) and subsidized high-speed internet access to all students in public K-12 education systems. This aims to bridge the digital divide and ensure equal access to modern learning resources.",
                    supporters: 92,
                    requiredSupporters: 100,
                    category: "education",
                    timestamp: new Date(Date.now() - 86400000 * 2).toISOString(), // 2 days ago
                    discussion: [
                         { id: 1, author: "TeacherVoice", authorId: "teach123", content: "As a teacher, I've seen firsthand how the digital divide affects learning outcomes. This is desperately needed.", timestamp: new Date(Date.now() - 86400000 * 1).toISOString() }
                    ],
                    supportedBy: []
                },
                {
                    id: 3,
                    title: "Community Healthcare Centers Expansion",
                    author: "HealthAdvocate",
                    authorId: "health789",
                    content: "Fund the establishment and staffing of 50 new community healthcare centers in underserved urban and rural neighborhoods over the next 3 years. These centers will provide basic preventative care, vaccinations, health education, and mental health support.",
                    supporters: 65,
                    requiredSupporters: 100,
                    category: "healthcare",
                    timestamp: new Date(Date.now() - 86400000 * 1).toISOString(), // 1 day ago
                    discussion: [],
                    supportedBy: []
                }
            ],
            activeVotes: [
                {
                    id: 101,
                    title: "Renewable Energy Transition Act",
                    content: "Mandate that 50% of all national energy production must come from renewable sources (solar, wind, geothermal, hydroelectric) by the year 2035. The act includes provisions for investment in renewable infrastructure and retraining programs for workers in fossil fuel industries.",
                    yesVotes: 1245,
                    noVotes: 532,
                    abstainVotes: 89,
                    category: "environment",
                    endTime: new Date(Date.now() + 86400000 * 3).toISOString(), // Ends in 3 days
                    discussion: [
                        { id: 1, author: "EnergyExpert", authorId: "energy123", content: "The timeline is ambitious but achievable with proper investment. I support this transition.", timestamp: new Date(Date.now() - 86400000 * 2).toISOString() },
                        { id: 2, author: "EconomistView", authorId: "econ456", content: "We need to ensure that energy prices remain affordable during this transition. Has an economic impact study been conducted?", timestamp: new Date(Date.now() - 86400000 * 1).toISOString() }
                    ],
                    votedBy: {} // { userId: 'yes'/'no'/'abstain' }
                },
                {
                    id: 102,
                    title: "Universal Basic Income Pilot Program",
                    content: "Establish a 2-year pilot program providing a universal basic income (UBI) of $1,000 per month to 5,000 randomly selected adult citizens across five diverse regions. The program aims to study the economic, social, and health impacts of UBI.",
                    yesVotes: 983,
                    noVotes: 1024,
                    abstainVotes: 121,
                    category: "economy",
                    endTime: new Date(Date.now() + 86400000 * 5).toISOString(), // Ends in 5 days
                    discussion: [],
                    votedBy: {}
                }
            ],
            passedLegislation: [
                {
                    id: 201,
                    title: "National Parks Protection Act",
                    content: "Increased funding for national park maintenance and expansion of protected wilderness areas. This act passed with significant public support.",
                    category: "environment",
                    passedDate: new Date(Date.now() - 86400000 * 30).toISOString(), // Passed 30 days ago
                    finalVotes: { yes: 2500, no: 500, abstain: 100 }
                },
                 {
                    id: 202,
                    title: "Early Childhood Education Grant",
                    content: "Provided federal grants to states for expanding access to quality pre-kindergarten education programs for all four-year-olds.",
                    category: "education",
                    passedDate: new Date(Date.now() - 86400000 * 60).toISOString(), // Passed 60 days ago
                    finalVotes: { yes: 3100, no: 800, abstain: 150 }
                }
            ],
            myActivities: [] // Will be populated by user actions
        };

        let appData = JSON.parse(JSON.stringify(mockData)); // Deep copy for manipulation

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                tg.expand();
                tg.ready();
                currentUser = {
                    id: tg.initDataUnsafe.user.id.toString() || 'anonymous' + Date.now(),
                    first_name: tg.initDataUnsafe.user.first_name || 'Anonymous',
                    last_name: tg.initDataUnsafe.user.last_name || '',
                    username: tg.initDataUnsafe.user.username || ('user' + Date.now())
                };
                 // Apply Telegram theme variables
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#5D5CDE');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#5D5CDE');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');

                if (tg.colorScheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }


            } else {
                console.log("Telegram WebApp is not available. Using demo mode.");
                // Mock user for testing if Telegram is not available
                currentUser = {
                    id: 'demoUser' + Math.floor(Math.random() * 1000),
                    first_name: 'Demo',
                    last_name: 'User',
                    username: 'demouser'
                };
                 // Fallback styling if Telegram object is not available
                const isSystemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (isSystemDark) {
                    document.documentElement.classList.add('dark');
                }
                applyColorScheme(isSystemDark); // Apply initial scheme

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    document.documentElement.classList.toggle('dark', event.matches);
                    applyColorScheme(event.matches);
                });
            }
            
            initAppUI(); // Initialize UI elements that depend on theme
            initData();
            setupEventListeners();
            showView('proposals'); // Default view
        });

        function applyColorScheme(isDark) {
            if (isDark) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', 'var(--default-bg-color)');
                document.documentElement.style.setProperty('--tg-theme-text-color', 'var(--default-text-color)');
                // ... set other dark mode colors from :root .dark
            } else {
                 document.documentElement.style.setProperty('--tg-theme-bg-color', 'var(--default-bg-color)');
                document.documentElement.style.setProperty('--tg-theme-text-color', 'var(--default-text-color)');
                // ... set other light mode colors from :root
            }
        }
        
        function initAppUI() {
            // Set active tab style based on current theme
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.classList.contains('active')) {
                    button.style.borderBottomColor = `var(--tg-theme-button-color, var(--default-button-color))`;
                    button.style.color = `var(--tg-theme-button-color, var(--default-button-color))`;
                } else {
                    button.style.borderBottomColor = 'transparent'; // Or initial border color
                    button.style.color = `var(--tg-theme-text-color, var(--default-text-color))`;
                }
            });
        }


        // Data handling functions
        function initData() {
            renderProposals();
            renderActiveVotes();
            renderPassedLegislation();
            renderMyActivities();
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function timeAgo(isoString) {
            if (!isoString) return 'some time ago';
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `${seconds} sec ago`;
            if (minutes < 60) return `${minutes} min ago`;
            if (hours < 24) return `${hours} hr ago`;
            return `${days} day(s) ago`;
        }


        function renderProposals() {
            const list = document.querySelector('.proposal-list');
            list.innerHTML = ''; // Clear existing
            appData.proposals.forEach(p => {
                const card = `
                    <div class="proposal-card p-3 rounded-lg shadow hover:shadow-md transition-shadow cursor-pointer" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));" data-id="${p.id}">
                        <h3 class="font-bold text-md mb-1">${p.title}</h3>
                        <p class="text-xs mb-1" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">By ${p.author} • ${timeAgo(p.timestamp)}</p>
                        <p class="text-xs mb-2 truncate">${p.content.substring(0,100)}...</p>
                        <div class="flex justify-between items-center text-xs">
                            <span>${p.supporters}/${p.requiredSupporters} supporters</span>
                            <span class="px-2 py-0.5 rounded-full text-xs" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color)); opacity:0.7;">${p.category}</span>
                        </div>
                        <div class="w-full h-1 mt-2 rounded-full overflow-hidden" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                            <div class="h-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); width: ${Math.min(100, (p.supporters / p.requiredSupporters) * 100)}%;"></div>
                        </div>
                    </div>`;
                list.insertAdjacentHTML('beforeend', card);
            });
             // Add event listeners to newly created cards
            document.querySelectorAll('.proposal-card').forEach(card => {
                card.addEventListener('click', () => showProposalDetail(card.dataset.id));
            });
        }

        function renderActiveVotes() {
            const list = document.querySelector('.active-votes-list');
            list.innerHTML = '';
            appData.activeVotes.forEach(v => {
                const totalVoted = v.yesVotes + v.noVotes + v.abstainVotes;
                const yesPercent = totalVoted > 0 ? (v.yesVotes / totalVoted) * 100 : 0;
                const noPercent = totalVoted > 0 ? (v.noVotes / totalVoted) * 100 : 0;
                const timeRemaining = new Date(v.endTime) > new Date() ? `${Math.ceil((new Date(v.endTime) - new Date()) / (1000 * 60 * 60 * 24))} days remaining` : 'Voting ended';

                const card = `
                    <div class="vote-card p-3 rounded-lg shadow hover:shadow-md transition-shadow cursor-pointer" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));" data-id="${v.id}">
                        <h3 class="font-bold text-md mb-1">${v.title}</h3>
                        <p class="text-xs mb-2 truncate">${v.content.substring(0,100)}...</p>
                         <div class="text-xs mb-2">
                            <span class="px-2 py-0.5 rounded-full" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color)); opacity:0.7;">${v.category}</span>
                        </div>
                        <div class="mb-1">
                            <div class="flex justify-between text-xs"><span style="color: #4CAF50;">Yes</span> <span>${yesPercent.toFixed(1)}%</span></div>
                            <div class="w-full h-1 rounded-full overflow-hidden" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                                <div class="h-full" style="background-color: #4CAF50; width: ${yesPercent}%;"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs"><span style="color: #F44336;">No</span> <span>${noPercent.toFixed(1)}%</span></div>
                            <div class="w-full h-1 rounded-full overflow-hidden" style="background-color: var(--tg-theme-bg-color, var(--default-bg-color));">
                                <div class="h-full" style="background-color: #F44336; width: ${noPercent}%;"></div>
                            </div>
                        </div>
                        <p class="text-xs mt-2" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">${timeRemaining}</p>
                    </div>`;
                list.insertAdjacentHTML('beforeend', card);
            });
            document.querySelectorAll('.vote-card').forEach(card => {
                card.addEventListener('click', () => showVoteDetail(card.dataset.id));
            });
        }

        function renderPassedLegislation() {
            const list = document.querySelector('.passed-list');
            list.innerHTML = '';
            appData.passedLegislation.forEach(l => {
                const card = `
                    <div class="passed-card p-3 rounded-lg shadow" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <h3 class="font-bold text-md mb-1">${l.title}</h3>
                        <p class="text-xs mb-1" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">Passed on: ${formatDate(l.passedDate)}</p>
                        <p class="text-xs mb-2 truncate">${l.content.substring(0,150)}...</p>
                        <div class="text-xs">
                            Final Votes: <span style="color: #4CAF50;">Yes: ${l.finalVotes.yes}</span>, <span style="color: #F44336;">No: ${l.finalVotes.no}</span>, Abstain: ${l.finalVotes.abstain}
                        </div>
                         <span class="mt-1 px-2 py-0.5 rounded-full text-xs inline-block" style="background-color: var(--tg-theme-button-color, var(--default-button-color)); color: var(--tg-theme-button-text-color, var(--default-button-text-color)); opacity:0.7;">${l.category}</span>
                    </div>`;
                list.insertAdjacentHTML('beforeend', card);
            });
        }

        function renderMyActivities() {
            const list = document.querySelector('.activities-list');
            list.innerHTML = ''; // Clear existing
            if (appData.myActivities.length === 0) {
                list.innerHTML = `<p class="text-sm" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">No activities yet. Get involved!</p>`;
                return;
            }
            appData.myActivities.slice().reverse().forEach(activity => { // Show newest first
                let activityHtml = '';
                switch(activity.type) {
                    case 'created_proposal':
                        activityHtml = `Created proposal: <strong>"${activity.proposalTitle}"</strong>`;
                        break;
                    case 'supported_proposal':
                        activityHtml = `Supported proposal: <strong>"${activity.proposalTitle}"</strong>`;
                        break;
                    case 'commented_proposal':
                        activityHtml = `Commented on proposal <strong>"${activity.itemTitle}"</strong>: "${activity.comment.substring(0,50)}..."`;
                        break;
                    case 'voted':
                        activityHtml = `Voted <strong>${activity.voteType.toUpperCase()}</strong> on: <strong>"${activity.voteTitle}"</strong>`;
                        break;
                    case 'commented_vote':
                        activityHtml = `Commented on vote <strong>"${activity.itemTitle}"</strong>: "${activity.comment.substring(0,50)}..."`;
                        break;
                    default:
                        activityHtml = `Performed an activity.`;
                }
                const card = `
                    <div class="activity-card p-3 rounded-lg" style="background-color: var(--tg-theme-secondary-bg-color, var(--default-secondary-bg-color));">
                        <p class="text-sm">${activityHtml}</p>
                        <p class="text-xs mt-1" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">${timeAgo(activity.timestamp)}</p>
                    </div>`;
                list.insertAdjacentHTML('beforeend', card);
            });
        }

        function showView(viewId, detailId = null) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            
            const tabNav = document.getElementById('tab-navigation');
            const backButton = document.getElementById('back-button');
            const headerTitle = document.getElementById('header-title');

            if (viewId.includes('-detail') || viewId === 'new-proposal') {
                tabNav.classList.add('hidden');
                backButton.classList.remove('hidden');
                currentDetailId = detailId; // Store the ID for detail views
                if (viewId === 'proposal-detail') headerTitle.textContent = "Proposal Details";
                else if (viewId === 'vote-detail') headerTitle.textContent = "Vote Details";
                else if (viewId === 'new-proposal') headerTitle.textContent = "New Proposal";

            } else {
                tabNav.classList.remove('hidden');
                backButton.classList.add('hidden');
                headerTitle.textContent = "Digital Democracy";
                currentView = viewId; // Update current main list view
                currentDetailId = null;

                // Update active tab
                document.querySelectorAll('.tab-button').forEach(button => {
                    const isActive = button.dataset.view === viewId;
                    button.classList.toggle('active', isActive);
                     button.style.borderBottomColor = isActive ? `var(--tg-theme-button-color, var(--default-button-color))` : 'transparent';
                    button.style.color = isActive ? `var(--tg-theme-button-color, var(--default-button-color))` : `var(--tg-theme-text-color, var(--default-text-color))`;
                });
            }
        }

        function addRippleEffect(event) {
            const button = event.currentTarget;
            const ripple = document.createElement("span");
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            ripple.classList.add("ripple-effect"); // You might need a CSS class for this
            
            // Style for ripple-effect if not in main CSS
            const style = document.createElement('style');
            style.innerHTML = `
            .ripple-effect {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.5);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
            }
            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }`;
            document.head.appendChild(style);


            const existingRipple = button.querySelector(".ripple-effect");
            if (existingRipple) {
                existingRipple.remove();
            }
            button.appendChild(ripple);
        }
        document.querySelectorAll('.ripple').forEach(button => {
            button.addEventListener('click', addRippleEffect);
        });


        // CRUD and interaction functions
        function addProposal(title, content, category) {
            const newId = appData.proposals.length > 0 ? Math.max(...appData.proposals.map(p => p.id)) + 1 : 1;
            const newProposal = {
                id: newId,
                title,
                author: `${currentUser.first_name} ${currentUser.last_name} (@${currentUser.username})`,
                authorId: currentUser.id,
                content,
                supporters: 0,
                requiredSupporters: 100,
                category,
                timestamp: new Date().toISOString(),
                discussion: [],
                supportedBy: []
            };
            appData.proposals.unshift(newProposal); // Add to the beginning of the array
            addActivity('created_proposal', { proposalId: newId, proposalTitle: title });
            renderProposals();
            showView('proposals');
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        function addSupport(proposalId) {
            const proposal = appData.proposals.find(p => p.id === parseInt(proposalId));
            if (proposal && !proposal.supportedBy.includes(currentUser.id)) {
                proposal.supporters++;
                proposal.supportedBy.push(currentUser.id);
                addActivity('supported_proposal', { proposalId: proposal.id, proposalTitle: proposal.title });
                renderProposals(); // Re-render list to update card
                if (document.getElementById('proposal-detail-view').classList.contains('hidden') === false && currentDetailId == proposalId) {
                     // If detail view is active for this proposal, update it too
                    renderProposalDetail(proposalId);
                }
                if (tg) tg.HapticFeedback.impactOccurred('light');
            } else if (proposal && proposal.supportedBy.includes(currentUser.id)) {
                // User already supported, maybe allow unsupport or just do nothing
                console.log("Already supported");
                if (tg) tg.showAlert("You have already supported this proposal.");
            }
        }
        
        function addVote(voteId, voteType) {
            const vote = appData.activeVotes.find(v => v.id === parseInt(voteId));
            if (vote && (!vote.votedBy[currentUser.id] || vote.votedBy[currentUser.id] !== voteType)) {
                // If user previously voted differently, adjust old vote count
                if(vote.votedBy[currentUser.id]) {
                    const oldVoteType = vote.votedBy[currentUser.id];
                    if (oldVoteType === 'yes') vote.yesVotes--;
                    else if (oldVoteType === 'no') vote.noVotes--;
                    else if (oldVoteType === 'abstain') vote.abstainVotes--;
                }

                if (voteType === 'yes') vote.yesVotes++;
                else if (voteType === 'no') vote.noVotes++;
                else if (voteType === 'abstain') vote.abstainVotes++;
                
                vote.votedBy[currentUser.id] = voteType;

                addActivity('voted', { voteId: vote.id, voteTitle: vote.title, voteType: voteType });
                renderActiveVotes(); // Re-render list
                if (document.getElementById('vote-detail-view').classList.contains('hidden') === false && currentDetailId == voteId) {
                    renderVoteDetail(voteId); // Update detail view if active
                }
                 if (tg) tg.HapticFeedback.impactOccurred('medium');
            } else if (vote && vote.votedBy[currentUser.id] === voteType) {
                 if (tg) tg.showAlert(`You have already voted ${voteType.toUpperCase()} for this item.`);
            }
        }

        function addDiscussionMessage(itemId, itemType, content) {
            if (!content.trim()) return; 

            const item = itemType === 'proposal' 
                ? appData.proposals.find(p => p.id === parseInt(itemId))
                : appData.activeVotes.find(v => v.id === parseInt(itemId));

            if (item) {
                const newDiscussionId = item.discussion.length > 0 ? Math.max(...item.discussion.map(d => d.id)) + 1 : 1;
                const newMessage = {
                    id: newDiscussionId,
                    author: `${currentUser.first_name} (@${currentUser.username})`,
                    authorId: currentUser.id,
                    content,
                    timestamp: new Date().toISOString()
                };
                item.discussion.push(newMessage);
                addActivity(itemType === 'proposal' ? 'commented_proposal' : 'commented_vote', { itemId: item.id, itemTitle: item.title, comment: content });
                
                if (itemType === 'proposal' && document.getElementById('proposal-detail-view').classList.contains('hidden') === false && currentDetailId == itemId) {
                    renderDiscussionList(item.discussion, document.getElementById('proposal-detail-discussion-list'));
                    document.getElementById('proposal-detail-discussion-input').value = '';
                } else if (itemType === 'vote' && document.getElementById('vote-detail-view').classList.contains('hidden') === false && currentDetailId == itemId) {
                    renderDiscussionList(item.discussion, document.getElementById('vote-detail-discussion-list'));
                     document.getElementById('vote-detail-discussion-input').value = '';
                }
                 if (tg) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function addActivity(type, details) {
            const activity = {
                type,
                ...details,
                timestamp: new Date().toISOString(),
                id: appData.myActivities.length > 0 ? Math.max(...appData.myActivities.map(a => a.id)) + 1 : 1
            };
            appData.myActivities.push(activity);
            renderMyActivities(); // Update the My Activities view
        }

        function renderProposalDetail(proposalId) {
            const proposal = appData.proposals.find(p => p.id === parseInt(proposalId));
            if (!proposal) return;

            previousView = currentView; // Store the view we came from
            currentDetailId = proposal.id;

            document.getElementById('proposal-detail-title').textContent = proposal.title;
            document.getElementById('proposal-detail-author').textContent = `By ${proposal.author} • ${timeAgo(proposal.timestamp)}`;
            document.getElementById('proposal-detail-category').textContent = proposal.category;
            document.getElementById('proposal-detail-content').innerHTML = proposal.content.replace(/\n/g, '<br>'); // Basic formatting

            const supportCountEl = document.getElementById('proposal-detail-support-count');
            const supportBarEl = document.getElementById('proposal-detail-support-bar');
            const supportButtonEl = document.getElementById('proposal-detail-support-button');

            supportCountEl.textContent = `${proposal.supporters}/${proposal.requiredSupporters} supporters`;
            supportBarEl.style.width = `${Math.min(100, (proposal.supporters / proposal.requiredSupporters) * 100)}%`;
            
            if (proposal.supportedBy.includes(currentUser.id)) {
                supportButtonEl.textContent = 'Supported';
                supportButtonEl.disabled = true;
                supportButtonEl.style.opacity = '0.7';
            } else {
                supportButtonEl.textContent = 'Support';
                supportButtonEl.disabled = false;
                supportButtonEl.style.opacity = '1';
            }
            
            renderDiscussionList(proposal.discussion, document.getElementById('proposal-detail-discussion-list'));
            showView('proposal-detail', proposal.id);
        }

        function renderVoteDetail(voteId) {
            const vote = appData.activeVotes.find(v => v.id === parseInt(voteId));
            if (!vote) return;

            previousView = currentView;
            currentDetailId = vote.id;

            document.getElementById('vote-detail-title').textContent = vote.title;
            document.getElementById('vote-detail-category').textContent = vote.category;
            document.getElementById('vote-detail-content').innerHTML = vote.content.replace(/\n/g, '<br>');

            const endTime = new Date(vote.endTime);
            const now = new Date();
            let statusText = '';
            if (now < endTime) {
                const diff = endTime - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                statusText = `Voting ends in: ${days}d ${hours}h`;
            } else {
                statusText = 'Voting has ended.';
            }
            document.getElementById('vote-detail-status').textContent = statusText;
            document.getElementById('vote-detail-time-remaining').textContent = statusText; // Also update the one near bars

            updateVoteResultsUI(vote);
            renderDiscussionList(vote.discussion, document.getElementById('vote-detail-discussion-list'));
            
            // Highlight user's existing vote
            document.querySelectorAll('#vote-detail-view .vote-button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2'); // Clear previous highlights
                btn.style.borderColor = 'transparent';
                if (vote.votedBy[currentUser.id] === btn.dataset.voteType) {
                    btn.classList.add('ring-2', 'ring-offset-2');
                    btn.style.borderColor = `var(--tg-theme-link-color, var(--default-link-color))`;
                }
            });

            showView('vote-detail', vote.id);
        }
        
        function updateVoteResultsUI(vote) {
            const totalVoted = vote.yesVotes + vote.noVotes + vote.abstainVotes;
            const yesPercent = totalVoted > 0 ? (vote.yesVotes / totalVoted) * 100 : 0;
            const noPercent = totalVoted > 0 ? (vote.noVotes / totalVoted) * 100 : 0;
            const abstainPercent = totalVoted > 0 ? (vote.abstainVotes / totalVoted) * 100 : 0;

            document.getElementById('vote-detail-yes-percentage').textContent = `${yesPercent.toFixed(1)}% (${vote.yesVotes})`;
            document.getElementById('vote-detail-yes-bar').style.width = `${yesPercent}%`;
            document.getElementById('vote-detail-no-percentage').textContent = `${noPercent.toFixed(1)}% (${vote.noVotes})`;
            document.getElementById('vote-detail-no-bar').style.width = `${noPercent}%`;
            document.getElementById('vote-detail-abstain-percentage').textContent = `${abstainPercent.toFixed(1)}% (${vote.abstainVotes})`;
            document.getElementById('vote-detail-abstain-bar').style.width = `${abstainPercent}%`;
        }

        function renderDiscussionList(discussionData, listElement) {
            listElement.innerHTML = ''; // Clear existing
            if (discussionData.length === 0) {
                listElement.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--tg-theme-hint-color, var(--default-hint-color));">No discussion yet. Be the first!</p>`;
            }
            discussionData.forEach(msg => {
                const isOutgoing = msg.authorId === currentUser.id;
                const bubbleClass = isOutgoing ? 'outgoing' : 'incoming';
                const alignmentClass = isOutgoing ? 'ml-auto' : 'mr-auto';
                
                const messageHtml = `
                    <div class="message-container flex flex-col ${isOutgoing ? 'items-end' : 'items-start'}">
                        <div class="message-bubble ${bubbleClass} ${alignmentClass}">
                            <p class="font-medium text-xs ${isOutgoing ? '' : 'text-tg-link'}">${msg.author}</p>
                            <p>${msg.content}</p>
                            <p class="text-xs opacity-70 mt-1 text-right">${timeAgo(msg.timestamp)}</p>
                        </div>
                    </div>`;
                listElement.insertAdjacentHTML('beforeend', messageHtml);
            });
            listElement.scrollTop = listElement.scrollHeight; // Scroll to bottom
        }

        // Event listeners setup
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    showView(this.dataset.view);
                });
            });

            // New Proposal Button
            document.getElementById('new-proposal-btn').addEventListener('click', () => {
                previousView = currentView; // Store where we came from
                showView('new-proposal');
                document.getElementById('proposal-form').reset(); // Clear form
            });

            // Back button
            document.getElementById('back-button').addEventListener('click', () => {
                showView(previousView || 'proposals'); // Go back to stored previous list view or default
            });

            // Proposal Form
            document.getElementById('proposal-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const title = document.getElementById('proposal-title-input').value;
                const content = document.getElementById('proposal-content-input').value;
                const category = document.getElementById('proposal-category-input').value;
                if (title.trim() && content.trim()) {
                    addProposal(title, content, category);
                } else {
                    if (tg) tg.showAlert("Title and content cannot be empty.");
                    else alert("Title and content cannot be empty.");
                }
            });
            document.getElementById('cancel-proposal-btn').addEventListener('click', () => {
                 showView(previousView || 'proposals');
            });

            // Proposal Detail View Support Button
            document.getElementById('proposal-detail-support-button').addEventListener('click', function() {
                if (currentDetailId) {
                    addSupport(currentDetailId);
                    this.classList.add('vote-animate'); // Add animation
                    setTimeout(() => this.classList.remove('vote-animate'), 300);
                }
            });
            
            // Proposal Detail View Send Discussion
            document.getElementById('proposal-detail-send-discussion').addEventListener('click', () => {
                const input = document.getElementById('proposal-detail-discussion-input');
                if (currentDetailId && input.value.trim()) {
                    addDiscussionMessage(currentDetailId, 'proposal', input.value.trim());
                }
            });
             document.getElementById('proposal-detail-discussion-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('proposal-detail-send-discussion').click();
                }
            });


            // Vote Detail View Buttons
            document.querySelectorAll('#vote-detail-view .vote-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (currentDetailId) {
                        const voteType = this.dataset.voteType;
                        addVote(currentDetailId, voteType);
                        this.classList.add('vote-animate');
                        setTimeout(() => this.classList.remove('vote-animate'), 300);
                    }
                });
            });
            
            // Vote Detail View Send Discussion
            document.getElementById('vote-detail-send-discussion').addEventListener('click', () => {
                const input = document.getElementById('vote-detail-discussion-input');
                 if (currentDetailId && input.value.trim()) {
                    addDiscussionMessage(currentDetailId, 'vote', input.value.trim());
                }
            });
            document.getElementById('vote-detail-discussion-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('vote-detail-send-discussion').click();
                }
            });

            // Menu button (placeholder for future functionality)
            document.getElementById('menu-button').addEventListener('click', () => {
                if (tg) tg.showAlert("Menu options coming soon!");
                else alert("Menu options coming soon!");
            });
        }
    </script>
</body>
</html>
